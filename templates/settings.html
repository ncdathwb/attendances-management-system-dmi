<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cài đặt - DMI Attendance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/settings.css') }}?v=20260130">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/icons.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-cog me-2"></i>Cài đặt</h3>
        </div>
        <div class="user-profile">
            <div class="user-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="user-info">
                <h4>{{ user.name }}</h4>
                <p>{{ user.employee_id }}</p>
            </div>
        </div>
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="#profile-section" class="nav-link active" data-section="profile">
                    <i class="fas fa-user-circle"></i>
                    Thông tin cá nhân
                </a>
            </li>
            <li class="nav-item">
                <a href="#signature-section" class="nav-link" data-section="signature">
                    <i class="fas fa-signature"></i>
                    Chữ ký cá nhân
                </a>
            </li>
            <li class="nav-item">
                <a href="{{ url_for('change_password') }}" class="nav-link">
                    <i class="fas fa-key"></i>
                    Đổi mật khẩu
                </a>
            </li>
            <li class="nav-item mt-auto">
                <a href="{{ url_for('dashboard') }}" class="nav-link">
                    <i class="fas fa-arrow-left"></i>
                    Quay lại Dashboard
                </a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Toast Container -->
        <div class="toast-container" id="toast-container"></div>

        <!-- Flash Messages JSON -->
        <script id="flash-data" type="application/json">{{ get_flashed_messages(with_categories=true) | tojson }}</script>

        <form method="POST" id="settings-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <!-- Profile Section -->
            <section id="profile-section" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-user-circle me-2"></i>Thông tin cá nhân</h2>
                    <p class="text-muted mb-0">Xem thông tin tài khoản của bạn</p>
                </div>

                <div class="cards-grid">
                    <!-- Card: Thông tin cơ bản -->
                    <div class="info-card">
                        <div class="info-card-header">
                            <i class="fas fa-id-card"></i>
                            <span>Thông tin cơ bản</span>
                        </div>
                        <div class="info-card-body">
                            <div class="info-item">
                                <label>Mã nhân viên</label>
                                <span class="info-value">{{ user.employee_id }}</span>
                            </div>
                            <div class="info-item">
                                <label>Họ và tên</label>
                                <span class="info-value">{{ user.name }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Card: Phòng ban & Vai trò -->
                    <div class="info-card">
                        <div class="info-card-header">
                            <i class="fas fa-building"></i>
                            <span>Phòng ban & Vai trò</span>
                        </div>
                        <div class="info-card-body">
                            <div class="info-item">
                                <label>Phòng ban</label>
                                <span class="info-value">{{ user.department }}</span>
                            </div>
                            <div class="info-item">
                                <label>Vai trò</label>
                                <div class="role-badges">
                                    {% for role in user.roles.split(',') %}
                                    <span class="role-badge {% if role == 'ADMIN' %}admin{% elif role == 'MANAGER' %}manager{% elif role == 'TEAM_LEADER' %}leader{% else %}employee{% endif %}">
                                        {% if role == 'EMPLOYEE' %}Nhân viên{% elif role == 'TEAM_LEADER' %}Trưởng nhóm{% elif role == 'MANAGER' %}Quản lý{% elif role == 'ADMIN' %}Quản trị viên{% else %}{{ role }}{% endif %}
                                    </span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Card: Liên hệ -->
                    <div class="info-card">
                        <div class="info-card-header">
                            <i class="fas fa-address-book"></i>
                            <span>Thông tin liên hệ</span>
                        </div>
                        <div class="info-card-body">
                            <div class="info-item">
                                <label>Email</label>
                                <span class="info-value {% if not user.email %}text-muted{% endif %}">
                                    {{ user.email or 'Chưa cập nhật' }}
                                </span>
                            </div>
                            <div class="info-item">
                                <label>Số điện thoại</label>
                                <span class="info-value {% if not user.phone %}text-muted{% endif %}">
                                    {{ user.phone or 'Chưa cập nhật' }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Signature Section -->
            <section id="signature-section" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-signature me-2"></i>Chữ ký cá nhân</h2>
                    <p class="text-muted mb-0">Tạo và quản lý chữ ký điện tử của bạn</p>
                </div>

                <div class="signature-container">
                    <!-- Current Signature -->
                    {% if user.personal_signature %}
                    <div class="current-signature-card">
                        <div class="card-label">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Chữ ký hiện tại
                        </div>
                        <div class="signature-display">
                            <img src="{{ user.personal_signature }}" alt="Chữ ký cá nhân">
                        </div>
                    </div>
                    {% endif %}

                    <!-- Signature Methods -->
                    <div class="signature-methods">
                        <div class="method-tabs">
                            <button type="button" class="method-tab active" data-tab="draw">
                                <i class="fas fa-pen"></i>
                                <span>Vẽ chữ ký</span>
                            </button>
                            <button type="button" class="method-tab" data-tab="upload">
                                <i class="fas fa-upload"></i>
                                <span>Upload ảnh</span>
                            </button>
                        </div>

                        <!-- Draw Tab -->
                        <div class="method-content active" id="draw-content">
                            <div class="canvas-wrapper">
                                <canvas id="signature-pad" width="600" height="200"></canvas>
                                <div class="canvas-actions">
                                    <button type="button" class="btn-icon" onclick="clearSignature()" title="Xóa">
                                        <i class="fas fa-eraser"></i>
                                    </button>
                                </div>
                            </div>
                            <p class="helper-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Sử dụng chuột hoặc bút stylus để vẽ chữ ký của bạn
                            </p>
                        </div>

                        <!-- Upload Tab -->
                        <div class="method-content" id="upload-content">
                            <div class="upload-zone" id="upload-zone">
                                <input type="file" id="signature-image-input" accept="image/*" hidden>
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Kéo thả ảnh vào đây hoặc <span class="upload-link">chọn file</span></p>
                                <small>Hỗ trợ: JPG, PNG, GIF (tối đa 5MB)</small>
                            </div>

                            <!-- Image Preview -->
                            <div id="image-preview-container" class="image-preview" style="display: none;">
                                <img id="original-image-preview" alt="Ảnh gốc">
                            </div>

                            <!-- Processed Signature -->
                            <div id="processed-signature-container" class="processed-preview" style="display: none;">
                                <div class="preview-header">
                                    <span><i class="fas fa-magic me-2"></i>Chữ ký đã xử lý</span>
                                    <div id="processing-indicator" style="display: none;">
                                        <div class="spinner-border spinner-border-sm" role="status"></div>
                                        <span>Đang xử lý...</span>
                                    </div>
                                </div>
                                <div class="preview-body">
                                    <img id="processed-signature-preview" alt="Chữ ký đã xử lý">
                                </div>

                                <!-- Adjustment Sliders -->
                                <div class="adjustment-panel">
                                    <div class="adjustment-title">
                                        <i class="fas fa-sliders-h me-2"></i>Điều chỉnh
                                    </div>
                                    <div class="sliders-grid">
                                        <div class="slider-item">
                                            <label>Độ sáng</label>
                                            <input type="range" id="brightness-threshold" min="100" max="200" value="140">
                                            <span id="brightness-value">140</span>
                                        </div>
                                        <div class="slider-item">
                                            <label>Tương phản</label>
                                            <input type="range" id="contrast-threshold" min="5" max="30" value="15">
                                            <span id="contrast-value">15</span>
                                        </div>
                                        <div class="slider-item">
                                            <label>Độ đậm</label>
                                            <input type="range" id="intensity-threshold" min="10" max="50" value="20">
                                            <span id="intensity-value">20</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="preview-actions">
                                    <button type="button" class="btn btn-success" onclick="applyProcessedSignature()">
                                        <i class="fas fa-check me-2"></i>Áp dụng
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="clearImageSignature()">
                                        <i class="fas fa-times me-2"></i>Hủy
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" name="signature" id="signature-input" value="{{ user.personal_signature or '' }}">

                    <!-- Actions -->
                    <div class="signature-actions">
                        <button type="submit" class="btn btn-primary btn-lg" onclick="return saveSignature()">
                            <i class="fas fa-save me-2"></i>Lưu chữ ký
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="testSignaturePDF()">
                            <i class="fas fa-file-pdf me-2"></i>Xem trước PDF
                        </button>
                    </div>
                </div>
            </section>
        </form>
    </div>

    <script>
        // Tab switching for sidebar
        document.querySelectorAll('.nav-link[data-section]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const section = this.dataset.section;

                // Update active link
                document.querySelectorAll('.nav-link[data-section]').forEach(l => l.classList.remove('active'));
                this.classList.add('active');

                // Scroll to section
                document.getElementById(section + '-section').scrollIntoView({ behavior: 'smooth' });
            });
        });

        // Method tabs
        document.querySelectorAll('.method-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.dataset.tab;

                document.querySelectorAll('.method-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.method-content').forEach(c => c.classList.remove('active'));

                this.classList.add('active');
                document.getElementById(tabName + '-content').classList.add('active');
            });
        });

        // ========== SIGNATURE PAD - PROFESSIONAL IMPLEMENTATION ==========
        var canvas = document.getElementById('signature-pad');
        var signaturePad = new SignaturePad(canvas, {
            backgroundColor: 'rgb(255, 255, 255)',
            penColor: 'rgb(0, 0, 0)',
            minWidth: 0.5,
            maxWidth: 2.5,
            velocityFilterWeight: 0.7
        });

        // Store signature data before resize
        var savedSignatureData = null;

        // Resize canvas while preserving signature
        function resizeCanvas() {
            // Save current signature before resize
            if (!signaturePad.isEmpty()) {
                savedSignatureData = signaturePad.toDataURL();
            }

            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            const wrapper = canvas.parentElement;
            const newWidth = wrapper.offsetWidth;
            const newHeight = 200;

            canvas.width = newWidth * ratio;
            canvas.height = newHeight * ratio;
            canvas.style.width = newWidth + 'px';
            canvas.style.height = newHeight + 'px';
            canvas.getContext("2d").scale(ratio, ratio);

            // Restore signature after resize
            if (savedSignatureData) {
                const img = new Image();
                img.onload = function() {
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    // Draw centered and scaled
                    const scale = Math.min(newWidth / img.width, newHeight / img.height) * 0.9;
                    const x = (newWidth - img.width * scale) / 2;
                    const y = (newHeight - img.height * scale) / 2;
                    ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                };
                img.src = savedSignatureData;
            } else {
                signaturePad.clear();
            }
        }

        // Debounced resize
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(resizeCanvas, 150);
        });

        // Initial setup
        document.addEventListener('DOMContentLoaded', function() {
            resizeCanvas();

            // Load existing signature after canvas is ready
            var currentSignature = "{{ user.personal_signature|default('')|safe }}";
            if (currentSignature && currentSignature.startsWith('data:image')) {
                savedSignatureData = currentSignature;
                const img = new Image();
                img.onload = function() {
                    const ctx = canvas.getContext('2d');
                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                    const displayWidth = canvas.width / ratio;
                    const displayHeight = canvas.height / ratio;

                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    // Calculate scale to fit with padding
                    const scale = Math.min(displayWidth / img.width, displayHeight / img.height) * 0.85;
                    const x = (displayWidth - img.width * scale) / 2;
                    const y = (displayHeight - img.height * scale) / 2;
                    ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                };
                img.src = currentSignature;
            }
        });

        function clearSignature() {
            signaturePad.clear();
            savedSignatureData = null;
            document.getElementById('signature-input').value = '';
            showToast('Đã xóa chữ ký', 'info');
        }

        // ========== AUTO-CROP SIGNATURE ==========
        function autoCropSignature(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            let minX = canvas.width, minY = canvas.height, maxX = 0, maxY = 0;
            let hasContent = false;

            // Find bounding box of non-white pixels
            for (let y = 0; y < canvas.height; y++) {
                for (let x = 0; x < canvas.width; x++) {
                    const idx = (y * canvas.width + x) * 4;
                    // Check if pixel is not white (threshold for anti-aliasing)
                    if (data[idx] < 250 || data[idx + 1] < 250 || data[idx + 2] < 250) {
                        hasContent = true;
                        if (x < minX) minX = x;
                        if (x > maxX) maxX = x;
                        if (y < minY) minY = y;
                        if (y > maxY) maxY = y;
                    }
                }
            }

            if (!hasContent) return null;

            // Add padding (10% of the smaller dimension)
            const padding = Math.min(maxX - minX, maxY - minY) * 0.1;
            minX = Math.max(0, minX - padding);
            minY = Math.max(0, minY - padding);
            maxX = Math.min(canvas.width, maxX + padding);
            maxY = Math.min(canvas.height, maxY + padding);

            const croppedWidth = maxX - minX;
            const croppedHeight = maxY - minY;

            // Create cropped canvas
            const croppedCanvas = document.createElement('canvas');
            croppedCanvas.width = croppedWidth;
            croppedCanvas.height = croppedHeight;
            const croppedCtx = croppedCanvas.getContext('2d');

            // Fill with white background
            croppedCtx.fillStyle = 'white';
            croppedCtx.fillRect(0, 0, croppedWidth, croppedHeight);

            // Draw cropped region
            croppedCtx.drawImage(canvas, minX, minY, croppedWidth, croppedHeight, 0, 0, croppedWidth, croppedHeight);

            return croppedCanvas.toDataURL('image/png');
        }

        function saveSignature() {
            if (!signaturePad.isEmpty()) {
                // Create a temporary canvas with the signature
                const tempCanvas = document.createElement('canvas');
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.fillStyle = 'white';
                tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                tempCtx.drawImage(canvas, 0, 0);

                // Auto-crop the signature
                const croppedSignature = autoCropSignature(tempCanvas);
                if (croppedSignature) {
                    document.getElementById('signature-input').value = croppedSignature;
                } else {
                    document.getElementById('signature-input').value = signaturePad.toDataURL();
                }
            }
            return true;
        }

        // ========== TEST SIGNATURE PDF ==========
        function testSignaturePDF() {
            var signature = document.getElementById('signature-input').value;
            if (!signature) {
                // Try to save current drawing first
                if (!signaturePad.isEmpty()) {
                    saveSignature();
                    signature = document.getElementById('signature-input').value;
                }
            }

            if (!signature) {
                showToast('Bạn cần tạo chữ ký trước!', 'warning');
                return;
            }

            var formData = new FormData();
            formData.append('signature', signature);
            formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);

            showToast('Đang tạo PDF...', 'info');

            fetch('/settings/test-signature-pdf', {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => {
                if (!response.ok) throw new Error('Server error');
                return response.blob();
            })
            .then(blob => {
                var url = window.URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'Kiemtrachuky_' + new Date().toISOString().split('T')[0] + '.pdf';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                showToast('PDF đã được tải xuống!', 'success');
            })
            .catch(error => showToast('Có lỗi khi tải PDF: ' + error.message, 'error'));
        }

        // ========== TOAST NOTIFICATION ==========
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            const icons = { success: 'check-circle', error: 'times-circle', warning: 'exclamation-triangle', info: 'info-circle' };
            toast.innerHTML = `
                <i class="fas fa-${icons[type] || icons.success}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">×</button>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        // Flash messages
        document.addEventListener('DOMContentLoaded', function() {
            try {
                var messages = JSON.parse(document.getElementById('flash-data').textContent || '[]');
                messages.forEach(msg => {
                    if (Array.isArray(msg) && msg.length >= 2) showToast(msg[1], msg[0]);
                });
            } catch (e) {}
        });

        // ========== UPLOAD SIGNATURE IMAGE ==========
        const uploadZone = document.getElementById('upload-zone');
        const imageInput = document.getElementById('signature-image-input');

        uploadZone.addEventListener('click', () => imageInput.click());
        uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('dragover'); });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
        uploadZone.addEventListener('drop', e => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                imageInput.files = e.dataTransfer.files;
                imageInput.dispatchEvent(new Event('change'));
            }
        });

        // Supported image types (including JFIF)
        const validImageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/jfif', 'image/webp'];

        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Check file type (also check extension for JFIF)
            const isValidType = validImageTypes.includes(file.type) ||
                               file.name.toLowerCase().endsWith('.jfif');

            if (!isValidType) {
                showToast('Vui lòng chọn file ảnh hợp lệ (JPG, PNG, GIF, JFIF, WebP)', 'error');
                return;
            }

            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('File ảnh quá lớn (tối đa 5MB)', 'error');
                return;
            }

            showToast('Đang xử lý ảnh...', 'info');

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    document.getElementById('original-image-preview').src = e.target.result;
                    document.getElementById('image-preview-container').style.display = 'block';
                    window.originalImageData = img;
                    processSignatureImage(img);
                };
                img.onerror = function() {
                    showToast('Không thể đọc file ảnh này', 'error');
                };
                img.src = e.target.result;
            };
            reader.onerror = function() {
                showToast('Lỗi khi đọc file', 'error');
            };
            reader.readAsDataURL(file);
        });

        // ========== ADVANCED SIGNATURE EXTRACTION ==========
        function processSignatureImage(img, brightnessThreshold = 140, contrastThreshold = 15, intensityThreshold = 20) {
            const processingIndicator = document.getElementById('processing-indicator');
            if (processingIndicator) processingIndicator.style.display = 'flex';

            // Use setTimeout to allow UI to update
            setTimeout(() => {
                try {
                    const result = extractSignature(img, brightnessThreshold, contrastThreshold, intensityThreshold);
                    document.getElementById('processed-signature-preview').src = result;
                    document.getElementById('processed-signature-container').style.display = 'block';
                    window.processedSignatureData = result;
                    showToast('Xử lý ảnh hoàn tất!', 'success');
                } catch (error) {
                    showToast('Lỗi xử lý ảnh: ' + error.message, 'error');
                } finally {
                    if (processingIndicator) processingIndicator.style.display = 'none';
                }
            }, 50);
        }

        function extractSignature(img, brightnessThreshold, contrastThreshold, intensityThreshold) {
            // Calculate optimal canvas size while preserving aspect ratio
            const maxWidth = 1200, maxHeight = 600;
            let targetWidth = img.width;
            let targetHeight = img.height;

            if (targetWidth > maxWidth) {
                targetHeight = (maxWidth / targetWidth) * targetHeight;
                targetWidth = maxWidth;
            }
            if (targetHeight > maxHeight) {
                targetWidth = (maxHeight / targetHeight) * targetWidth;
                targetHeight = maxHeight;
            }

            targetWidth = Math.round(targetWidth);
            targetHeight = Math.round(targetHeight);

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = targetWidth;
            canvas.height = targetHeight;

            // Draw with white background first
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, targetWidth, targetHeight);
            ctx.drawImage(img, 0, 0, targetWidth, targetHeight);

            const imageData = ctx.getImageData(0, 0, targetWidth, targetHeight);
            const data = imageData.data;
            const brightnessMap = new Float32Array(targetWidth * targetHeight);

            // Calculate brightness for each pixel
            for (let i = 0; i < data.length; i += 4) {
                brightnessMap[i / 4] = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
            }

            const blockSize = 21;
            const C = 10;

            // Adaptive thresholding with local contrast analysis
            for (let y = 0; y < targetHeight; y++) {
                for (let x = 0; x < targetWidth; x++) {
                    const idx = y * targetWidth + x;
                    const pixelIdx = idx * 4;
                    const halfBlock = Math.floor(blockSize / 2);

                    // Calculate local mean
                    let sum = 0, count = 0;
                    for (let dy = -halfBlock; dy <= halfBlock; dy++) {
                        for (let dx = -halfBlock; dx <= halfBlock; dx++) {
                            const ny = y + dy, nx = x + dx;
                            if (ny >= 0 && ny < targetHeight && nx >= 0 && nx < targetWidth) {
                                sum += brightnessMap[ny * targetWidth + nx];
                                count++;
                            }
                        }
                    }

                    const localMean = sum / count;
                    const adaptiveThreshold = localMean - C;
                    const pixelBrightness = brightnessMap[idx];
                    const finalThreshold = Math.min(adaptiveThreshold, brightnessThreshold);

                    // Calculate local contrast
                    let maxLocal = 0, minLocal = 255;
                    for (let dy = -2; dy <= 2; dy++) {
                        for (let dx = -2; dx <= 2; dx++) {
                            const ny = y + dy, nx = x + dx;
                            if (ny >= 0 && ny < targetHeight && nx >= 0 && nx < targetWidth) {
                                const val = brightnessMap[ny * targetWidth + nx];
                                if (val > maxLocal) maxLocal = val;
                                if (val < minLocal) minLocal = val;
                            }
                        }
                    }
                    const localContrast = maxLocal - minLocal;
                    const isSignature = pixelBrightness < finalThreshold ||
                                       (localContrast > contrastThreshold && pixelBrightness < brightnessThreshold + 20);

                    if (isSignature && (255 - pixelBrightness) > intensityThreshold) {
                        data[pixelIdx] = data[pixelIdx + 1] = data[pixelIdx + 2] = 0;
                    } else {
                        data[pixelIdx] = data[pixelIdx + 1] = data[pixelIdx + 2] = 255;
                    }
                    data[pixelIdx + 3] = 255;
                }
            }

            ctx.putImageData(imageData, 0, 0);

            // Auto-crop the result
            const croppedResult = autoCropSignature(canvas);
            return croppedResult || canvas.toDataURL('image/png');
        }

        function applyProcessedSignature() {
            if (window.processedSignatureData) {
                document.getElementById('signature-input').value = window.processedSignatureData;
                savedSignatureData = window.processedSignatureData;
                showToast('Chữ ký đã được áp dụng!', 'success');

                // Switch to draw tab and show on canvas
                document.querySelector('.method-tab[data-tab="draw"]').click();
                const img = new Image();
                img.onload = function() {
                    const ctx = canvas.getContext('2d');
                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                    const displayWidth = canvas.width / ratio;
                    const displayHeight = canvas.height / ratio;

                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    const scale = Math.min(displayWidth / img.width, displayHeight / img.height) * 0.85;
                    const x = (displayWidth - img.width * scale) / 2;
                    const y = (displayHeight - img.height * scale) / 2;
                    ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                };
                img.src = window.processedSignatureData;
            }
        }

        function clearImageSignature() {
            document.getElementById('signature-image-input').value = '';
            document.getElementById('image-preview-container').style.display = 'none';
            document.getElementById('processed-signature-container').style.display = 'none';
            window.processedSignatureData = null;
            window.originalImageData = null;
        }

        // Slider auto-reprocess with debounce
        let reprocessTimeout = null;
        ['brightness', 'contrast', 'intensity'].forEach(name => {
            const slider = document.getElementById(name + '-threshold');
            const value = document.getElementById(name + '-value');
            if (slider && value) {
                slider.addEventListener('input', function() {
                    value.textContent = this.value;
                    if (reprocessTimeout) clearTimeout(reprocessTimeout);
                    reprocessTimeout = setTimeout(() => {
                        if (window.originalImageData) {
                            processSignatureImage(
                                window.originalImageData,
                                parseInt(document.getElementById('brightness-threshold').value),
                                parseInt(document.getElementById('contrast-threshold').value),
                                parseInt(document.getElementById('intensity-threshold').value)
                            );
                        }
                    }, 300);
                });
            }
        });
    </script>
</body>

</html>
