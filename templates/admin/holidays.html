{% extends "base/base_admin.html" %}

{% block title %}Quản Lý Ngày Lễ - Hệ Thống Quản Lý Chấm Công{% endblock %}

{% block extra_css %}
<style>
    .add-holiday-form .row {
        display: flex;
        flex-wrap: nowrap;
        align-items: flex-end;
        gap: 15px;
        margin: 0;
    }
    .add-holiday-form .col-md {
        flex: 1 1 0;
        min-width: 0;
        display: flex;
        flex-direction: column;
        padding: 0;
    }
    .add-holiday-form .col-md .form-label {
        margin-bottom: 8px;
        font-weight: 500;
        white-space: nowrap;
    }
    .add-holiday-form .col-md .form-control,
    .add-holiday-form .col-md .form-select {
        width: 100%;
        height: 38px;
    }
    .add-holiday-form .col-md.d-flex::before {
        content: '';
        height: 26px;
    }
    .add-holiday-form .col-md.d-flex .btn {
        width: 100%;
        height: 38px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    @media (max-width: 768px) {
        .add-holiday-form .row { flex-wrap: wrap; gap: 0; }
        .add-holiday-form .col-md { flex: 0 0 100%; max-width: 100%; margin-bottom: 15px; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h4 class="mb-4"><i class="fas fa-calendar-alt me-2"></i>Quản Lý Ngày Lễ</h4>

    <!-- Add Holiday Form -->
    <div class="card admin-card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-plus me-2"></i>Thêm Ngày Lễ Mới</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('admin_holidays') }}" class="add-holiday-form">
                <div class="row g-3">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="add">
                    <div class="col-md">
                        <label class="form-label"><i class="fas fa-calendar me-1"></i>Ngày *</label>
                        <input type="date" class="form-control" name="date" required>
                    </div>
                    <div class="col-md">
                        <label class="form-label"><i class="fas fa-flag me-1"></i>Loại ngày lễ *</label>
                        <select class="form-select" name="holiday_type" required>
                            <option value="">-- Chọn loại --</option>
                            <option value="vietnamese_holiday">Lễ Việt Nam</option>
                            <option value="japanese_holiday">Lễ Nhật Bản</option>
                        </select>
                    </div>
                    <div class="col-md">
                        <label class="form-label"><i class="fas fa-tag me-1"></i>Tên ngày lễ</label>
                        <input type="text" class="form-control" name="name" placeholder="VD: Tết Nguyên Đán">
                    </div>
                    <div class="col-md">
                        <label class="form-label"><i class="fas fa-info-circle me-1"></i>Mô tả</label>
                        <input type="text" class="form-control" name="description" placeholder="Mô tả ngày lễ">
                    </div>
                    <div class="col-md d-flex align-items-end">
                        <button type="submit" class="btn btn-success w-100"><i class="fas fa-plus me-1"></i>Thêm Ngày Lễ</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Holiday List -->
    <div class="card admin-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Danh Sách Ngày Lễ ({{ holidays|length }})</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover admin-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>Ngày</th>
                            <th>Loại ngày lễ</th>
                            <th>Tên ngày lễ</th>
                            <th>Mô tả</th>
                            <th style="width: 200px;">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for holiday in holidays %}
                        <tr id="holiday-row-{{ holiday.id }}">
                            <td>{{ loop.index }}</td>
                            <td><strong>{{ holiday.date.strftime('%d/%m/%Y') }}</strong></td>
                            <td>
                                {% if holiday.holiday_type == 'vietnamese_holiday' %}
                                <span class="badge bg-danger badge-holiday">Lễ Việt Nam</span>
                                {% elif holiday.holiday_type == 'japanese_holiday' %}
                                <span class="badge bg-warning text-dark badge-holiday">Lễ Nhật Bản</span>
                                {% endif %}
                            </td>
                            <td>{{ holiday.name or '-' }}</td>
                            <td>{{ holiday.description or '-' }}</td>
                            <td>
                                <button class="btn btn-warning btn-sm btn-action edit-holiday-btn"
                                    data-holiday-id="{{ holiday.id }}"
                                    data-holiday-date="{{ holiday.date.strftime('%Y-%m-%d') }}"
                                    data-holiday-type="{{ holiday.holiday_type }}"
                                    data-holiday-name="{{ holiday.name or '' }}"
                                    data-holiday-description="{{ holiday.description or '' }}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm btn-action delete-holiday-btn"
                                    data-holiday-id="{{ holiday.id }}"
                                    data-holiday-date="{{ holiday.date.strftime('%d/%m/%Y') }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center text-muted">Chưa có ngày lễ nào</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('admin_holidays') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action" value="edit">
                <input type="hidden" name="holiday_id" id="edit_holiday_id">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Sửa Ngày Lễ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Ngày *</label>
                        <input type="date" class="form-control" name="date" id="edit_date" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Loại ngày lễ *</label>
                        <select class="form-select" name="holiday_type" id="edit_holiday_type" required>
                            <option value="">-- Chọn loại --</option>
                            <option value="vietnamese_holiday">Lễ Việt Nam</option>
                            <option value="japanese_holiday">Lễ Nhật Bản</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tên ngày lễ</label>
                        <input type="text" class="form-control" name="name" id="edit_name" placeholder="VD: Tết Nguyên Đán">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                        <input type="text" class="form-control" name="description" id="edit_description" placeholder="Mô tả ngày lễ">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('admin_holidays') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="holiday_id" id="delete_holiday_id">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Xác nhận xóa</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Bạn có chắc chắn muốn xóa ngày lễ <strong id="delete_holiday_date"></strong>?</p>
                    <p class="text-danger mb-0"><small>Lưu ý: Thao tác này không thể hoàn tác!</small></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-danger">Xóa</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Xử lý nút edit
        document.querySelectorAll('.edit-holiday-btn').forEach(function (btn) {
            btn.addEventListener('click', function () {
                document.getElementById('edit_holiday_id').value = this.getAttribute('data-holiday-id');
                document.getElementById('edit_date').value = this.getAttribute('data-holiday-date');
                document.getElementById('edit_holiday_type').value = this.getAttribute('data-holiday-type');
                document.getElementById('edit_name').value = this.getAttribute('data-holiday-name') || '';
                document.getElementById('edit_description').value = this.getAttribute('data-holiday-description') || '';
                new bootstrap.Modal(document.getElementById('editModal')).show();
            });
        });

        // Xử lý nút delete
        document.querySelectorAll('.delete-holiday-btn').forEach(function (btn) {
            btn.addEventListener('click', function () {
                document.getElementById('delete_holiday_id').value = this.getAttribute('data-holiday-id');
                document.getElementById('delete_holiday_date').textContent = this.getAttribute('data-holiday-date');
                new bootstrap.Modal(document.getElementById('deleteModal')).show();
            });
        });
    });
</script>
{% endblock %}
