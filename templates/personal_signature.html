<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chữ ký cá nhân - DMI Attendance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
    <style>
        .signature-quality-indicator {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .quality-excellent { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .quality-good { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .quality-fair { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .quality-poor { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        
        .signature-preview {
            border: 2px dashed #dee2e6;
            padding: 15px;
            text-align: center;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-top: 15px;
        }
        
        .quality-score {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .recommendations {
            margin-top: 10px;
            font-size: 0.9em;
        }
        
        .recommendations ul {
            margin-bottom: 0;
            padding-left: 20px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header">
                        <h4><i class="fas fa-signature me-2"></i>Quản lý chữ ký cá nhân</h4>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Hướng dẫn:</strong> Chữ ký cá nhân sẽ được sử dụng tự động khi bạn phê duyệt các bản ghi chấm công. 
                            Hệ thống sẽ tự động tối ưu hóa chất lượng chữ ký để đảm bảo hiển thị rõ ràng trên các tài liệu.
                        </div>
                        
                        <form method="POST" id="signature-form">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Vùng ký tên:</label>
                                        <div class="border rounded p-3 bg-white">
                                            <canvas id="signature-pad" width="600" height="200" style="border: 1px solid #ccc; background-color: white;"></canvas>
                                        </div>
                                        <div class="mt-2">
                                            <button type="button" class="btn btn-secondary btn-sm" onclick="clearSignature()">
                                                <i class="fas fa-eraser me-1"></i>Xóa chữ ký
                                            </button>
                                            <button type="button" class="btn btn-info btn-sm" onclick="validateSignature()">
                                                <i class="fas fa-check-circle me-1"></i>Kiểm tra chất lượng
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="signature-preview" id="signature-preview">
                                        <h6 class="text-muted">Xem trước chữ ký</h6>
                                        <div id="preview-content">
                                            <i class="fas fa-signature fa-3x text-muted"></i>
                                            <p class="text-muted mt-2">Ký tên để xem trước</p>
                                        </div>
                                    </div>
                                    
                                    <div id="quality-indicator" class="signature-quality-indicator" style="display: none;">
                                        <h6><i class="fas fa-chart-line me-2"></i>Chất lượng chữ ký</h6>
                                        <div class="quality-score" id="quality-score"></div>
                                        <div class="recommendations" id="recommendations"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <input type="hidden" name="signature" id="signature-input">
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="submit" class="btn btn-primary" onclick="return saveSignature()">
                                    <i class="fas fa-save me-2"></i>Lưu chữ ký cá nhân
                                </button>
                                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Quay lại Dashboard
                                </a>
                            </div>
                        </form>
                        
                        {% if user.personal_signature %}
                        <div class="mt-4">
                            <h5><i class="fas fa-history me-2"></i>Chữ ký hiện tại:</h5>
                            <div class="border rounded p-3 bg-light">
                                <img src="{{ user.personal_signature }}" alt="Chữ ký cá nhân" style="max-width: 300px; max-height: 100px;">
                                <div class="mt-2">
                                    <small class="text-muted">Chữ ký này sẽ được sử dụng tự động cho tất cả các lần phê duyệt</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        var canvas = document.getElementById('signature-pad');
        var signaturePad = new SignaturePad(canvas, {
            backgroundColor: 'rgb(255, 255, 255)',
            penColor: 'rgb(0, 0, 0)',
            minWidth: 1,
            maxWidth: 2.5,
            throttle: 16
        });
        
        // 监听签名变化
        signaturePad.addEventListener("endStroke", function() {
            updatePreview();
        });
        
        function clearSignature() {
            signaturePad.clear();
            document.getElementById('signature-input').value = '';
            document.getElementById('signature-preview').style.display = 'block';
            document.getElementById('quality-indicator').style.display = 'none';
            document.getElementById('preview-content').innerHTML = `
                <i class="fas fa-signature fa-3x text-muted"></i>
                <p class="text-muted mt-2">Ký tên để xem trước</p>
            `;
        }
        
        function updatePreview() {
            if (!signaturePad.isEmpty()) {
                var signature = signaturePad.toDataURL();
                document.getElementById('preview-content').innerHTML = `
                    <img src="${signature}" alt="Xem trước chữ ký" style="max-width: 100%; max-height: 80px;">
                `;
            }
        }
        
        function validateSignature() {
            if (signaturePad.isEmpty()) {
                alert('Vui lòng ký tên trước khi kiểm tra chất lượng!');
                return;
            }
            
            var signature = signaturePad.toDataURL();
            
            // 显示加载状态
            document.getElementById('quality-indicator').style.display = 'block';
            document.getElementById('quality-score').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang kiểm tra...';
            document.getElementById('recommendations').innerHTML = '';
            
            // 发送到服务器验证
            fetch('/api/signature/validate-quality', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                body: JSON.stringify({
                    signature: signature
                })
            })
            .then(response => response.json())
            .then(data => {
                displayQualityResult(data);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('quality-score').innerHTML = '<span class="text-danger">Lỗi kiểm tra chất lượng</span>';
            });
        }
        
        function displayQualityResult(data) {
            var qualityIndicator = document.getElementById('quality-indicator');
            var qualityScore = document.getElementById('quality-score');
            var recommendations = document.getElementById('recommendations');
            
            // 移除所有质量类
            qualityIndicator.className = 'signature-quality-indicator';
            
            if (data.valid) {
                var score = Math.round(data.score * 100);
                var qualityClass = '';
                var qualityText = '';
                
                if (score >= 80) {
                    qualityClass = 'quality-excellent';
                    qualityText = 'Xuất sắc';
                } else if (score >= 60) {
                    qualityClass = 'quality-good';
                    qualityText = 'Tốt';
                } else if (score >= 40) {
                    qualityClass = 'quality-fair';
                    qualityText = 'Khá';
                } else {
                    qualityClass = 'quality-poor';
                    qualityText = 'Cần cải thiện';
                }
                
                qualityIndicator.classList.add(qualityClass);
                qualityScore.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span>${qualityText}</span>
                        <span>${score}%</span>
                    </div>
                    <div class="progress mt-2" style="height: 8px;">
                        <div class="progress-bar" role="progressbar" style="width: ${score}%"></div>
                    </div>
                `;
                
                if (data.recommendations && data.recommendations.length > 0) {
                    recommendations.innerHTML = `
                        <h6 class="mt-3 mb-2"><i class="fas fa-lightbulb me-1"></i>Gợi ý cải thiện:</h6>
                        <ul>
                            ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    `;
                } else {
                    recommendations.innerHTML = '<p class="text-success mt-2"><i class="fas fa-check-circle me-1"></i>Chữ ký có chất lượng tốt!</p>';
                }
            } else {
                qualityIndicator.classList.add('quality-poor');
                qualityScore.innerHTML = `<span class="text-danger">${data.error}</span>`;
                recommendations.innerHTML = '';
            }
        }
        
        function saveSignature() {
            if (signaturePad.isEmpty()) {
                alert('Vui lòng ký tên trước khi lưu!');
                return false;
            }
            
            var signature = signaturePad.toDataURL();
            document.getElementById('signature-input').value = signature;
            return true;
        }
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 添加CSRF token meta标签
            var meta = document.createElement('meta');
            meta.name = 'csrf-token';
            meta.content = '{{ csrf_token() }}';
            document.head.appendChild(meta);
        });
    </script>
</body>
</html> 