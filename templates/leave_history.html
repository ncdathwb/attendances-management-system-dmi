{% extends "base/base_leave.html" %}

{% block title %}Lịch sử nghỉ phép - Hệ thống quản lý chấm công{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/leave-history.css') }}" rel="stylesheet">
<style>
    .badge-approved { background: var(--success-color); color: #fff; }
    .badge-rejected { background: var(--danger-color); color: #fff; }
    .badge-pending-admin { background: #60a5fa; color: #fff; }
    .badge-pending-manager { background: var(--warning-color); color: #000; }
    .badge-pending-leader { background: #94a3b8; color: #fff; }

    .table th:first-child, .table td:first-child {
        position: sticky; left: 0; background-color: var(--card-bg);
        z-index: 10; box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
    }
    .table th:last-child, .table td:last-child {
        position: sticky; right: 0; background-color: var(--card-bg);
        z-index: 10; box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-3">
    <div class="page-header mb-3">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="section-title"><i class="fas fa-history"></i> Lịch sử nghỉ phép</h4>
        </div>
    </div>

    <!-- Bộ lọc -->
    <div class="filter-card filter-row p-3 mb-3">
        <form class="row g-2" method="get" action="{{ url_for('leave_history') }}">
            <div class="col-md-3">
                <label class="form-label small text-muted">Tên/Mã nhân viên</label>
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="form-control modern-search" name="q" placeholder="Nhập tên hoặc mã NV" value="{{ (current_filters.q if current_filters else '') or '' }}">
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted">Phòng ban</label>
                <select name="department" class="form-select modern-select" {% if current_role != 'ADMIN' %}disabled title="Chỉ Admin mới có thể lọc theo phòng ban"{% endif %}>
                    <option value="">Tất cả phòng ban</option>
                    {% for dept in departments or [] %}
                    <option value="{{ dept }}" {% if current_filters and current_filters.department==dept %}selected{% endif %}>{{ dept }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted">Loại đơn</label>
                <select name="request_type" class="form-select modern-select">
                    <option value="">Tất cả loại đơn</option>
                    <option value="leave" {% if current_filters and current_filters.request_type=='leave' %}selected{% endif %}>Nghỉ phép</option>
                    <option value="late_early" {% if current_filters and current_filters.request_type=='late_early' %}selected{% endif %}>Đi trễ/Về sớm</option>
                    <option value="30min_break" {% if current_filters and current_filters.request_type=='30min_break' %}selected{% endif %}>Nghỉ 30 phút</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted">Trạng thái</label>
                <select name="status" class="form-select modern-select">
                    <option value="">Tất cả</option>
                    <option value="approved" {% if current_filters and current_filters.status=='approved' %}selected{% endif %}>Đã phê duyệt</option>
                    <option value="pending" {% if current_filters and current_filters.status=='pending' %}selected{% endif %}>Chờ trưởng nhóm</option>
                    <option value="pending_manager" {% if current_filters and current_filters.status=='pending_manager' %}selected{% endif %}>Chờ quản lý</option>
                    <option value="pending_admin" {% if current_filters and current_filters.status=='pending_admin' %}selected{% endif %}>Chờ admin</option>
                    <option value="rejected" {% if current_filters and current_filters.status=='rejected' %}selected{% endif %}>Bị từ chối</option>
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label small text-muted">Từ ngày nghỉ</label>
                <input type="date" class="form-control modern-date" name="from_date" value="{{ (current_filters.from_date if current_filters else '') or '' }}">
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted">Đến ngày nghỉ</label>
                <input type="date" class="form-control modern-date" name="to_date" value="{{ (current_filters.to_date if current_filters else '') or '' }}">
            </div>
            <div class="col-md-6 d-flex gap-2 align-items-end">
                <button class="btn btn-primary btn-search flex-fill" type="submit" style="height: 38px;">
                    <i class="fas fa-filter me-2"></i>Lọc
                </button>
                <a class="btn btn-outline-secondary flex-fill" href="{{ url_for('leave_history') }}" style="height: 38px;">
                    <i class="fas fa-rotate-right me-2"></i>Đặt lại
                </a>
                {% if current_role == 'ADMIN' %}
                <button type="button" class="btn btn-success flex-fill" onclick="exportToExcel()" style="height: 38px;">
                    <i class="fas fa-file-excel me-2"></i>Tải Excel
                </button>
                {% endif %}
            </div>
        </form>
    </div>

    <!-- Table -->
    <div class="table-responsive table-card p-2" style="overflow-x: auto; width: 100%;">
        <table class="table table-striped table-hover align-middle" style="width: 100%;">
            <thead class="styled">
                <tr>
                    <th class="text-nowrap" style="min-width: 70px;">ID</th>
                    <th class="text-nowrap" style="min-width: 140px;">Nhân viên</th>
                    <th class="text-nowrap" style="min-width: 140px;">Thời gian nghỉ</th>
                    <th style="min-width: 200px;">Lý do</th>
                    <th style="min-width: 150px;">Loại nghỉ</th>
                    <th class="text-nowrap" style="min-width: 120px;">Trạng thái</th>
                    <th class="text-nowrap" style="min-width: 120px;">Chứng từ</th>
                    <th class="text-nowrap" style="min-width: 140px;">Người thay thế</th>
                    <th class="text-nowrap" style="min-width: 120px;">Ngày cập nhật</th>
                    <th class="text-nowrap" style="min-width: 100px;">Chi tiết</th>
                </tr>
            </thead>
            <tbody>
                {% if leave_requests and leave_requests|length > 0 %}
                {% for request in leave_requests %}
                <tr>
                    <td class="text-nowrap"><span class="fw-semibold text-primary">#{{ request.id }}</span></td>
                    <td class="text-nowrap">
                        <div>
                            <div class="fw-semibold">{{ request.employee_name }}</div>
                            <small class="text-muted">{{ request.employee_code }}</small>
                        </div>
                    </td>
                    <td class="text-nowrap">
                        <div class="small">
                            <div><strong>Từ:</strong> {{ request.get_leave_from_datetime().strftime('%d/%m/%Y %H:%M') }}</div>
                            <div><strong>Đến:</strong> {{ request.get_leave_to_datetime().strftime('%d/%m/%Y %H:%M') }}</div>
                        </div>
                    </td>
                    <td style="min-width: 200px; max-width: 300px; overflow-wrap: anywhere;">
                        <small>{{ request.get_reason_text() }}</small>
                    </td>
                    <td style="min-width: 150px; white-space: pre-line;">
                        <small>{{ request.get_leave_type_text().replace(', ', '\n') }}</small>
                    </td>
                    <td>
                        {% if request.status == 'approved' %}
                        <span class="badge badge-approved">Đã phê duyệt</span>
                        {% elif request.status == 'rejected' %}
                        <span class="badge badge-rejected">Bị từ chối</span>
                        {% elif request.status == 'pending_admin' %}
                        <span class="badge badge-pending-admin">Chờ Admin</span>
                        {% elif request.status == 'pending_manager' %}
                        <span class="badge badge-pending-manager">Chờ Quản lý</span>
                        {% elif request.status == 'pending' %}
                        <span class="badge badge-pending-leader">Chờ Trưởng nhóm</span>
                        {% else %}
                        <span class="badge bg-light text-dark">{{ request.status }}</span>
                        {% endif %}
                    </td>
                    <td class="text-nowrap">
                        {% set has_docs = (request.attachments) or request.hospital_confirmation or request.wedding_invitation or request.death_birth_certificate %}
                        {% if has_docs %}
                        <a href="{{ url_for('download_all_leave_attachments', request_id=request.id) }}" class="btn btn-sm btn-outline-success">
                            <i class="fas fa-download"></i> Tải chứng từ
                        </a>
                        {% else %}
                        <span class="text-muted">Không</span>
                        {% endif %}
                    </td>
                    <td style="min-width: 150px;">
                        <div class="small">
                            <div>{{ request.substitute_name or '-' }}</div>
                            <div class="text-muted">{{ request.substitute_employee_id or '-' }}</div>
                        </div>
                    </td>
                    <td class="text-nowrap">
                        {% set display_dt = request.get_display_updated_at() or request.created_at %}
                        {{ display_dt.strftime('%d/%m/%Y %H:%M') }}
                    </td>
                    <td class="text-nowrap">
                        <a href="{{ url_for('view_leave_request', request_id=request.id) }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i> Xem
                        </a>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="10" class="text-center py-5">
                        <div class="d-flex flex-column align-items-center text-muted">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <div class="fw-semibold">Chưa có đơn nghỉ phép nào</div>
                            <div class="small">Các đơn nghỉ phép đã tạo sẽ hiển thị tại đây</div>
                        </div>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    {% if pagination and pagination.pages > 1 %}
    <nav aria-label="Page navigation" class="mt-3">
        <ul class="pagination justify-content-center">
            {% if pagination.has_prev %}
            <li class="page-item"><a class="page-link" href="{{ url_for('leave_history', page=pagination.prev_num) }}">Trước</a></li>
            {% endif %}
            {% for page_num in pagination.iter_pages() %}
            {% if page_num %}
            {% if page_num != pagination.page %}
            <li class="page-item"><a class="page-link" href="{{ url_for('leave_history', page=page_num) }}">{{ page_num }}</a></li>
            {% else %}
            <li class="page-item active"><span class="page-link">{{ page_num }}</span></li>
            {% endif %}
            {% else %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
            {% endif %}
            {% endfor %}
            {% if pagination.has_next %}
            <li class="page-item"><a class="page-link" href="{{ url_for('leave_history', page=pagination.next_num) }}">Sau</a></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="{{ url_for('static', filename='js/global-email-notification.js') }}"></script>
<script>
    async function exportToExcel() {
        Swal.fire({
            title: 'Đang tạo file Excel...',
            text: 'Vui lòng chờ trong giây lát',
            allowOutsideClick: false,
            showConfirmButton: false,
            willOpen: () => { Swal.showLoading(); }
        });

        const urlParams = new URLSearchParams(window.location.search);
        const csrfToken = getCSRFToken();
        if (csrfToken) urlParams.append('csrf_token', csrfToken);

        let exportUrl = '{{ url_for("export_leave_history_excel") }}';
        if (urlParams.toString()) exportUrl += '?' + urlParams.toString();

        try {
            const response = await fetch(exportUrl);
            if (!response.ok) throw new Error('Lỗi từ máy chủ: ' + response.statusText);

            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = 'Lich_su_nghi_phep.xlsx';
            if (contentDisposition) {
                const match = contentDisposition.match(/filename="?([^"]+)"?/);
                if (match && match.length === 2) filename = match[1];
            }

            const blob = await response.blob();
            const downloadUrl = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(downloadUrl);

            Swal.close();
            Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 }).fire({ icon: 'success', title: 'File đã sẵn sàng tải xuống' });
        } catch (error) {
            console.error('Export error:', error);
            Swal.fire({ title: 'Lỗi!', text: 'Không thể tạo file Excel. Vui lòng thử lại sau.', icon: 'error' });
        }
    }
</script>
{% endblock %}
