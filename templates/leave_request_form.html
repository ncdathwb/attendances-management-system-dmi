{% extends "base/base_leave.html" %}

{% block title %}{% if is_edit %}S·ª≠a ƒë∆°n{% else %}ƒêƒÉng k√Ω{% endif %} {% if leave_request and leave_request.request_type == 'late_early' %}ƒëi tr·ªÖ/v·ªÅ s·ªõm{% elif leave_request and leave_request.request_type == '30min_break' %}ngh·ªâ 30 ph√∫t{% else %}ngh·ªâ ph√©p{% endif %} - H·ªá th·ªëng qu·∫£n l√Ω ch·∫•m c√¥ng{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/leave-request-form.css') }}">
{% endblock %}

{% block sidebar %}
{% include 'includes/leave_form_sidebar.html' %}
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <!-- Page Header -->
    <div class="page-header-card d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h4><i class="fas fa-calendar-plus"></i>{% if is_edit %}S·ª≠a ƒë∆°n ngh·ªâ ph√©p{% else %}ƒêƒÉng k√Ω ngh·ªâ ph√©p{% endif %}</h4>
        <a href="{{ url_for('leave_requests_list') }}" class="btn btn-cancel">
            <i class="fas fa-arrow-left me-1"></i> Quay l·∫°i
        </a>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
        <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' if category == 'success' else 'info-circle' }} me-2"></i>
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- Request Type Selector -->
    <div class="request-type-card">
        <div class="d-flex align-items-center flex-wrap gap-3">
            <div class="card-icon">
                <i class="fas fa-list-alt"></i>
            </div>
            <div class="flex-grow-1">
                <div class="card-title">Lo·∫°i ƒë∆°n</div>
                <div class="card-subtitle">Ch·ªçn lo·∫°i ƒë∆°n b·∫°n mu·ªën t·∫°o</div>
            </div>
            <div style="min-width: 250px;">
                <select class="form-select" id="requestTypeSelect">
                    <option value="leave" {% if not leave_request or leave_request.request_type=='leave' %}selected{% endif %}>üìÖ Ngh·ªâ ph√©p</option>
                    <option value="late_early" {% if leave_request and leave_request.request_type=='late_early' %}selected{% endif %}>‚è∞ ƒêi tr·ªÖ / V·ªÅ s·ªõm</option>
                    <option value="30min_break" {% if leave_request and leave_request.request_type=='30min_break' %}selected{% endif %}>‚òï Ngh·ªâ 30 ph√∫t (d√†nh cho n·ªØ)</option>
                </select>
            </div>
        </div>
    </div>

    <form method="POST" id="leaveRequestForm" enctype="multipart/form-data"
        action="{% if is_edit %}{{ url_for('edit_leave_request', request_id=leave_request.id) }}{% else %}{{ url_for('submit_leave_request') }}{% endif %}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="request_type" id="requestType"
            value="{% if leave_request %}{{ leave_request.request_type }}{% else %}leave{% endif %}">
        <!-- Hidden inputs for excluded days data -->
        <input type="hidden" name="excluded_days_json" id="excluded_days_json" value="">
        <input type="hidden" name="total_calendar_days" id="total_calendar_days_input" value="0">
        <input type="hidden" name="total_excluded_days" id="total_excluded_days_input" value="0">
        <input type="hidden" name="total_working_days" id="total_working_days_input" value="0">
        <input type="hidden" name="weekend_count" id="weekend_count_input" value="0">
        <input type="hidden" name="vietnamese_holiday_count" id="vietnamese_holiday_count_input" value="0">
        <input type="hidden" name="japanese_holiday_count" id="japanese_holiday_count_input" value="0">

        {% if leave_request %}
        <!-- Status Section -->
        <div class="form-section status-section">
            <h4 class="section-title">
                <i class="fas fa-clipboard-check"></i> T√¨nh tr·∫°ng ƒë∆°n
            </h4>
            <div class="d-flex flex-wrap gap-4 align-items-center">
                <div>
                    <small class="text-muted d-block mb-1">Tr·∫°ng th√°i</small>
                    {% if leave_request.status == 'pending' %}
                    <span class="status-badge pending"><i class="fas fa-clock"></i> Ch·ªù ph√™ duy·ªát</span>
                    {% elif leave_request.status == 'approved' %}
                    <span class="status-badge approved"><i class="fas fa-check"></i> ƒê√£ ph√™ duy·ªát</span>
                    {% elif leave_request.status == 'rejected' %}
                    <span class="status-badge rejected"><i class="fas fa-times"></i> T·ª´ ch·ªëi</span>
                    {% else %}
                    <span class="badge bg-secondary">{{ leave_request.status }}</span>
                    {% endif %}
                </div>
                <div>
                    <small class="text-muted d-block mb-1">Ng√†y t·∫°o</small>
                    <strong>{{ leave_request.created_at.strftime('%d/%m/%Y %H:%M') }}</strong>
                </div>
                <div>
                    <small class="text-muted d-block mb-1">C·∫≠p nh·∫≠t g·∫ßn nh·∫•t</small>
                    <strong>{{ (leave_request.updated_at or leave_request.created_at).strftime('%d/%m/%Y %H:%M') }}</strong>
                </div>
            </div>
            {% if leave_request.notes %}
            <div class="status-timeline">
                <div class="timeline-item">
                    <div class="timeline-icon"><i class="fas fa-sticky-note"></i></div>
                    <div class="timeline-content">
                        <div class="timeline-title">Ghi ch√∫</div>
                        <div class="text-muted">{{ leave_request.notes | filter_leave_notes }}</div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Employee Info -->
        <div class="form-section">
            <h4 class="section-title">
                <i class="fas fa-user"></i> Th√¥ng tin nh√¢n vi√™n
            </h4>
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="employee_name" class="form-label">H·ªç v√† t√™n <span class="required">*</span></label>
                    <input type="text" class="form-control" id="employee_name" name="employee_name"
                        value="{{ leave_request.employee_name if leave_request else (user.name if user else '') }}"
                        required readonly>
                </div>
                <div class="col-md-4">
                    <label for="team" class="form-label">Nh√≥m <span class="required">*</span></label>
                    <input type="text" class="form-control" id="team" name="team"
                        value="{{ leave_request.team if leave_request else (user.department if user else '') }}"
                        required readonly>
                </div>
                <div class="col-md-4">
                    <label for="employee_code" class="form-label">M√£ nh√¢n vi√™n <span class="required">*</span></label>
                    <input type="text" class="form-control" id="employee_code" name="employee_code"
                        value="{{ leave_request.employee_code if leave_request else (user.employee_id if user else '') }}"
                        required readonly>
                </div>
            </div>
            <!-- Dynamic team fields -->
            <div class="row g-3 mt-2" id="team-dynamic-row" style="display:none;">
                <div class="col-md-4" id="scope-days-wrapper" style="display:none;">
                    <label for="scope_leave_days" class="form-label">S·ªë ng√†y ngh·ªâ Scope</label>
                    <input type="number" min="0" step="0.5" class="form-control" id="scope_leave_days" name="scope_leave_days" placeholder="0, 0.5, 1...">
                </div>
                <div class="col-md-4" id="york-days-wrapper" style="display:none;">
                    <label for="japan_holiday_days" class="form-label">S·ªë ng√†y ngh·ªâ l·ªÖ Nh·∫≠t</label>
                    <input type="number" min="0" step="0.5" class="form-control" id="japan_holiday_days" name="japan_holiday_days" placeholder="0, 0.5, 1...">
                </div>
            </div>
        </div>

        <!-- Reason & Attachments -->
        <div class="form-section">
            <h4 class="section-title" id="reasonSectionTitle">
                <i class="fas fa-clipboard-list"></i> L√Ω do & Ch·ª©ng t·ª´
            </h4>

            <!-- Attachment Guidelines -->
            <div class="attachment-guidelines" id="attachmentGuidelinesSection">
                <h6><i class="fas fa-info-circle"></i> C√°c tr∆∞·ªùng h·ª£p c·∫ßn ch·ª©ng t·ª´</h6>
                <ul>
                    <li><strong>·ªêm / Con ·ªëm / Ng∆∞·ªùi nh√† ·ªëm:</strong> Gi·∫•y x√°c nh·∫≠n b·ªánh vi·ªán</li>
                    <li><strong>ƒê√°m c∆∞·ªõi / K·∫øt h√¥n:</strong> Thi·ªáp m·ªùi ho·∫∑c gi·∫•y ƒëƒÉng k√Ω</li>
                    <li><strong>Tang l·ªÖ:</strong> Gi·∫•y ch·ª©ng t·ª≠</li>
                    <li><strong>Sinh con:</strong> Gi·∫•y ch·ª©ng sinh</li>
                </ul>
            </div>

            <div class="row g-3">
                <!-- Late/Early Type (hidden by default) -->
                <div class="col-md-6" id="lateEarlyTypeSection" style="display: none;">
                    <label for="late_early_type" class="form-label">Lo·∫°i <span class="required">*</span></label>
                    <select class="form-select" id="late_early_type" name="late_early_type">
                        <option value="">-- Ch·ªçn lo·∫°i --</option>
                        <option value="late" {% if leave_request and leave_request.late_early_type=='late' %}selected{% endif %}>‚è∞ ƒêi tr·ªÖ</option>
                        <option value="early" {% if leave_request and leave_request.late_early_type=='early' %}selected{% endif %}>üèÉ V·ªÅ s·ªõm</option>
                    </select>
                </div>

                <!-- Reason -->
                <div class="col-md-6">
                    <label for="leave_reason" class="form-label" id="reasonLabel">L√Ω do <span class="required">*</span></label>
                    <textarea class="form-control" id="leave_reason" name="leave_reason" rows="4"
                        placeholder="M√¥ t·∫£ chi ti·∫øt l√Ω do..." required>{{ leave_request.leave_reason if leave_request else '' }}</textarea>
                </div>

                <!-- File Upload -->
                <div class="col-md-6" id="attachmentsSection">
                    <label class="form-label">Ch·ª©ng t·ª´ ƒë√≠nh k√®m</label>

                    {% if is_edit and leave_request.attachments %}
                    <div class="mb-3">
                        <small class="text-muted d-block mb-2"><i class="fas fa-paperclip me-1"></i>Ch·ª©ng t·ª´ hi·ªán c√≥:</small>
                        <div class="list-group list-group-flush">
                            {% set existing_attachments = existing_attachments_list %}
                            {% for attachment in existing_attachments %}
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span><i class="fas fa-file me-2 text-muted"></i>{{ attachment.original_name }}</span>
                                <a href="{{ url_for('download_leave_attachment', request_id=leave_request.id, filename=attachment.saved_name) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-download"></i>
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <div class="file-upload-area" onclick="document.getElementById('attachments').click()">
                        <i class="fas fa-cloud-upload-alt d-block"></i>
                        <p class="mb-1">Nh·∫•p ƒë·ªÉ ch·ªçn file ho·∫∑c k√©o th·∫£ v√†o ƒë√¢y</p>
                        <small>PDF, JPG, PNG, DOC, DOCX (t·ªëi ƒëa 10MB)</small>
                    </div>
                    <input type="file" class="d-none" id="attachments" name="attachments" multiple
                        accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" onchange="previewFiles(this)">

                    <div id="file-preview" class="mt-3" style="display: none;">
                        <h6><i class="fas fa-file me-2"></i>Files ƒë√£ ch·ªçn:</h6>
                        <div id="file-list" class="list-group"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Time Selection -->
        <div class="form-section">
            <h4 class="section-title">
                <i class="fas fa-calendar-check"></i> Th·ªùi gian
            </h4>

            <!-- Shift Selection -->
            <div class="row g-3 mb-4" id="shiftSelectionSection">
                <div class="col-md-4">
                    <label for="leave_shift_code" class="form-label">Ca l√†m vi·ªác <span class="required">*</span></label>
                    <select id="leave_shift_code" name="leave_shift_code" class="form-select" required>
                        <option value="" {% if not leave_request or not leave_request.shift_code %}selected{% endif %}>-- Ch·ªçn ca --</option>
                        <option value="1" {% if leave_request and leave_request.shift_code=='1' %}selected{% endif %}>Ca 1 (07:30 - 16:30)</option>
                        <option value="2" {% if leave_request and leave_request.shift_code=='2' %}selected{% endif %}>Ca 2 (09:00 - 18:00)</option>
                        <option value="3" {% if leave_request and leave_request.shift_code=='3' %}selected{% endif %}>Ca 3 (11:00 - 20:00)</option>
                        <option value="4" {% if leave_request and leave_request.shift_code=='4' %}selected{% endif %}>Ca 4 (08:00 - 17:00)</option>
                    </select>
                    <div class="invalid-feedback">Vui l√≤ng ch·ªçn ca l√†m vi·ªác</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Khung gi·ªù ca</label>
                    <div class="shift-time-display" id="leave_shift_window">-- Ch·ªçn ca ƒë·ªÉ xem --</div>
                </div>
            </div>

            <!-- Date Time Grid -->
            <div class="datetime-grid">
                <div class="datetime-card from-date">
                    <h6><i class="fas fa-play-circle"></i> <span id="fromDateLabel">T·ª´ ng√†y</span> <span class="required">*</span></h6>
                    <div class="datetime-inputs">
                        <div>
                            <label for="leave_from_date" class="form-label small">Ng√†y</label>
                            <input type="date" class="form-control" id="leave_from_date" name="leave_from_date" required
                                value="{{ ('%04d-%02d-%02d' % (leave_request.leave_from_year, leave_request.leave_from_month, leave_request.leave_from_day)) if leave_request else '' }}">
                        </div>
                        <div>
                            <label for="leave_from_time" class="form-label small">Gi·ªù</label>
                            <input type="time" class="form-control" id="leave_from_time" name="leave_from_time" required
                                value="{{ ('%02d:%02d' % (leave_request.leave_from_hour, leave_request.leave_from_minute)) if leave_request else '' }}">
                        </div>
                    </div>
                </div>
                <div class="datetime-card to-date">
                    <h6><i class="fas fa-stop-circle"></i> <span id="toDateLabel">ƒê·∫øn ng√†y</span> <span class="required">*</span></h6>
                    <div class="datetime-inputs">
                        <div>
                            <label for="leave_to_date" class="form-label small">Ng√†y</label>
                            <input type="date" class="form-control" id="leave_to_date" name="leave_to_date" required
                                value="{{ ('%04d-%02d-%02d' % (leave_request.leave_to_year, leave_request.leave_to_month, leave_request.leave_to_day)) if leave_request else '' }}">
                        </div>
                        <div>
                            <label for="leave_to_time" class="form-label small">Gi·ªù</label>
                            <input type="time" class="form-control" id="leave_to_time" name="leave_to_time" required
                                value="{{ ('%02d:%02d' % (leave_request.leave_to_hour, leave_request.leave_to_minute)) if leave_request else '' }}">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Excluded Days Info -->
            <div id="excludedDaysSection" class="mt-4" style="display: none;">
                <div class="excluded-days-alert">
                    <div class="d-flex align-items-start gap-3">
                        <div class="excluded-icon">
                            <i class="fas fa-calendar-times"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-2"><i class="fas fa-info-circle me-1"></i> Th√¥ng tin ng√†y lo·∫°i tr·ª´</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="excluded-summary mb-2">
                                        <span class="summary-item"><i class="fas fa-calendar-day text-primary"></i> T·ªïng ng√†y: <strong id="totalCalendarDays">0</strong></span>
                                        <span class="summary-item"><i class="fas fa-minus-circle text-danger"></i> Lo·∫°i tr·ª´: <strong id="totalExcludedDays">0</strong></span>
                                        <span class="summary-item"><i class="fas fa-briefcase text-success"></i> Ng√†y l√†m vi·ªác: <strong id="totalWorkingDays">0</strong></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="excluded-breakdown" id="excludedBreakdown">
                                        <!-- Will be populated by JS -->
                                    </div>
                                </div>
                            </div>
                            <div id="excludedDaysList" class="excluded-days-list mt-2" style="display: none;">
                                <!-- Will be populated by JS -->
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="toggleExcludedDetails">
                                <i class="fas fa-chevron-down me-1"></i> Xem chi ti·∫øt
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Leave Days Section -->
            <div id="leaveDaysSection" class="mt-4">
                <div class="info-alert">
                    <h6><i class="fas fa-lightbulb"></i> H∆∞·ªõng d·∫´n nh·∫≠p s·ªë ng√†y ngh·ªâ</h6>
                    <p class="mb-1"><strong>L∆∞u √Ω:</strong> T·ªïng s·ªë ng√†y ph·∫£i <strong>b·∫±ng ch√≠nh x√°c</strong> s·ªë ng√†y l√†m vi·ªác th·ª±c t·∫ø (ƒë√£ lo·∫°i tr·ª´ cu·ªëi tu·∫ßn v√† l·ªÖ).</p>
                    <p class="mb-0">H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t√≠nh to√°n. Ch·ªâ ch·∫•p nh·∫≠n b·ªôi s·ªë c·ªßa 0.5 (v√≠ d·ª•: 0.5, 1, 1.5, 2...)</p>
                </div>

                <div class="row g-3">
                    <div class="col-6 col-md-3">
                        <div class="leave-day-card annual">
                            <div class="day-label">Ph√©p nƒÉm</div>
                            <input type="number" class="form-control" id="annual_leave_days" name="annual_leave_days"
                                value="{{ leave_request.annual_leave_days if leave_request else 0 }}" min="0" step="0.5">
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="leave-day-card unpaid">
                            <div class="day-label">Kh√¥ng l∆∞∆°ng</div>
                            <input type="number" class="form-control" id="unpaid_leave_days" name="unpaid_leave_days"
                                value="{{ leave_request.unpaid_leave_days if leave_request else 0 }}" min="0" step="0.5">
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="leave-day-card special">
                            <div class="day-label">ƒê·∫∑c bi·ªát</div>
                            <input type="number" class="form-control" id="special_leave_days" name="special_leave_days"
                                value="{{ leave_request.special_leave_days if leave_request else 0 }}" min="0" step="0.5">
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="total-display">
                            <div class="total-label">T·ªïng c·ªông</div>
                            <div class="total-value"><span id="total-days-display">0</span></div>
                            <div class="total-unit">ng√†y</div>
                            <div class="days-status-text" id="days-status">Ch·ªçn th·ªùi gian ƒë·ªÉ xem</div>
                        </div>
                    </div>
                </div>

                <!-- Dynamic team fields inline -->
                <div class="row g-3 mt-2">
                    <div class="col-md-3 {% if not ((leave_request and leave_request.team and 'scope' in leave_request.team|lower) or (user and user.department and 'scope' in user.department|lower)) %}d-none{% endif %}" id="scope-days-wrapper-inline">
                        <div class="leave-day-card">
                            <div class="day-label">Ngh·ªâ Scope</div>
                            <input type="number" min="0" step="0.5" class="form-control" id="scope_leave_days_inline" name="scope_leave_days" placeholder="0">
                        </div>
                    </div>
                    <div class="col-md-3 {% if not ((leave_request and leave_request.team and 'york' in leave_request.team|lower) or (user and user.department and 'york' in user.department|lower)) %}d-none{% endif %}" id="york-days-wrapper-inline">
                        <div class="leave-day-card">
                            <div class="day-label">Ngh·ªâ l·ªÖ Nh·∫≠t</div>
                            <input type="number" min="0" step="0.5" class="form-control" id="japan_holiday_days_inline" name="japan_holiday_days" placeholder="0">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Replacement Person -->
        <div class="form-section" id="replacementSection">
            <h4 class="section-title">
                <i class="fas fa-user-friends"></i> Ng∆∞·ªùi thay th·∫ø
            </h4>
            <div class="replacement-grid">
                <div>
                    <label for="substitute_name" class="form-label">T√™n ng∆∞·ªùi thay th·∫ø</label>
                    <input type="text" class="form-control" id="substitute_name" name="substitute_name"
                        value="{{ leave_request.substitute_name if leave_request else '' }}" placeholder="Nh·∫≠p t√™n...">
                </div>
                <div>
                    <label for="substitute_employee_id" class="form-label">M√£ nh√¢n vi√™n</label>
                    <input type="text" class="form-control" id="substitute_employee_id" name="substitute_employee_id"
                        value="{{ leave_request.substitute_employee_id if leave_request else '' }}" placeholder="Nh·∫≠p m√£ NV...">
                </div>
            </div>
        </div>

        <!-- Notes -->
        <div class="form-section">
            <h4 class="section-title">
                <i class="fas fa-sticky-note"></i> Ghi ch√∫
            </h4>
            <textarea class="form-control notes-textarea" id="notes" name="notes" rows="3"
                placeholder="Ghi ch√∫ th√™m (n·∫øu c√≥)...">{{ (leave_request.notes | filter_leave_notes) if leave_request else '' }}</textarea>
        </div>

        <!-- Action Buttons -->
        <div class="form-actions">
            <a href="{{ url_for('leave_requests_list') }}" class="btn btn-cancel">
                <i class="fas fa-times me-1"></i> H·ªßy
            </a>
            <button type="submit" class="btn btn-submit">
                <i class="fas fa-paper-plane me-1"></i> {% if is_edit %}C·∫≠p nh·∫≠t{% else %}G·ª≠i ƒë∆°n{% endif %}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Global Email Notification -->
<script src="{{ url_for('static', filename='js/global-email-notification.js') }}?v=20241201"></script>
<script src="{{ url_for('static', filename='js/leave-request-form.js') }}"></script>
{% endblock %}
