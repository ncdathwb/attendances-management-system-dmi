{% extends "base/base_leave.html" %}

{% block title %}Danh s√°ch ƒë∆°n ngh·ªâ ph√©p - H·ªá th·ªëng qu·∫£n l√Ω ch·∫•m c√¥ng{% endblock %}

{% block sidebar %}
{% include 'includes/leave_list_sidebar.html' %}
{% endblock %}

{% block main_content_class %}{% if current_role in ['TEAM_LEADER','MANAGER','ADMIN'] %}approval-mode{% endif %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/leave-requests-list.css') }}">
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <h1 class="page-title">
            <i class="fas fa-clipboard-list"></i>
            Danh s√°ch ƒë∆°n ngh·ªâ ph√©p
        </h1>
    </div>
</div>

<!-- Token Status Banner (Admin Only) -->
<div id="tokenStatusBanner"
    style="display: none; margin: 20px 15px; position: sticky; top: 10px; z-index: 1000;">
    <div class="alert alert-info alert-dismissible fade show shadow-sm" role="alert" id="tokenStatusAlert"
        style="margin-bottom: 0;">
        <div class="d-flex align-items-center flex-wrap">
            <i class="fas fa-spinner fa-spin me-2" id="tokenStatusIcon" style="font-size: 1.2rem;"></i>
            <div class="flex-grow-1 me-3">
                <strong id="tokenStatusTitle" style="font-size: 1rem;">ƒêang ki·ªÉm tra tr·∫°ng th√°i Token Google
                    API...</strong>
                <div id="tokenStatusMessage" class="mt-1" style="font-size: 0.9rem;">Vui l√≤ng ƒë·ª£i trong gi√¢y
                    l√°t...</div>
            </div>
            <div class="d-flex align-items-center gap-2">
                {% if current_role == 'ADMIN' %}
                <button type="button" class="btn btn-sm btn-primary" id="btnRefreshToken"
                    style="display: none !important; white-space: nowrap;">
                    <i class="fas fa-sync-alt me-1"></i>Refresh Token
                </button>
                {% endif %}
                <button type="button" class="btn-close" aria-label="Close"></button>
            </div>
        </div>
    </div>
</div>

{% if current_role in ['TEAM_LEADER','MANAGER','ADMIN'] %}
<div class="approval-banner">
    <i class="fas fa-shield-check"></i>
    <div><strong>Ch·∫ø ƒë·ªô ph√™ duy·ªát</strong> ‚Äî B·∫°n c√≥ th·ªÉ ph√™ duy·ªát ho·∫∑c t·ª´ ch·ªëi c√°c ƒë∆°n ƒëang ch·ªù.</div>
</div>
{% endif %}

<!-- Filter Section -->
<div class="filter-section filter-row">
    <div class="d-flex flex-wrap gap-3 align-items-end">
        <div class="flex-grow-1" style="min-width: 200px;">
            <label class="form-label fw-semibold mb-1">Tr·∫°ng th√°i</label>
            <select class="form-select modern-select" id="statusFilter">
                <option value="">üìã T·∫•t c·∫£ tr·∫°ng th√°i</option>
                <option value="pending" {% if request.args.get('status')=='pending' %}selected{% endif %}>Ch·ªù
                    ph√™ duy·ªát</option>
                <option value="approved" {% if request.args.get('status')=='approved' %}selected{% endif %}>ƒê√£
                    ph√™ duy·ªát</option>
                <option value="rejected" {% if request.args.get('status')=='rejected' %}selected{% endif %}>T·ª´
                    ch·ªëi</option>
            </select>
        </div>
        <div class="flex-grow-1" style="min-width: 200px;">
            <label class="form-label fw-semibold mb-1">T√¨m ki·∫øm</label>
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="form-control modern-search" id="employeeFilter"
                    placeholder="T√¨m theo t√™n/m√£ NV" value="{{ request.args.get('employee', '') }}">
            </div>
        </div>
        <div class="flex-grow-1" style="min-width: 180px;">
            <label class="form-label fw-semibold mb-1">Ph√≤ng ban</label>
            <select class="form-select modern-select" id="departmentFilter" {% if current_role not in
                ['ADMIN', 'MANAGER' ] %}disabled title="Ch·ªâ Admin/Manager m·ªõi c√≥ th·ªÉ l·ªçc theo ph√≤ng ban" {%
                endif %}>
                <option value="">üè¢ T·∫•t c·∫£ ph√≤ng ban</option>
                {% for dept in departments or [] %}
                <option value="{{ dept }}" {% if request.args.get('department')==dept %}selected{% endif %}>{{
                    dept }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="flex-grow-1" style="min-width: 180px;">
            <label class="form-label fw-semibold mb-1">Lo·∫°i ƒë∆°n</label>
            <select class="form-select modern-select" id="requestTypeFilter">
                <option value="">üìù T·∫•t c·∫£ lo·∫°i ƒë∆°n</option>
                <option value="leave" {% if request.args.get('request_type')=='leave' %}selected{% endif %}>Ngh·ªâ
                    ph√©p</option>
                <option value="late_early" {% if request.args.get('request_type')=='late_early' %}selected{%
                    endif %}>ƒêi tr·ªÖ/V·ªÅ s·ªõm</option>
                <option value="30min_break" {% if request.args.get('request_type')=='30min_break' %}selected{%
                    endif %}>Ngh·ªâ 30 ph√∫t</option>
            </select>
        </div>
        <div class="flex-grow-1" style="min-width: 150px;">
            <label class="form-label fw-semibold mb-1">T·ª´ ng√†y ngh·ªâ</label>
            <input type="date" class="form-control modern-date" id="dateFromFilter"
                value="{{ request.args.get('date_from', '') }}" title="L·ªçc theo ng√†y b·∫Øt ƒë·∫ßu ngh·ªâ ph√©p">
        </div>
        <div class="flex-grow-1" style="min-width: 150px;">
            <label class="form-label fw-semibold mb-1">ƒê·∫øn ng√†y ngh·ªâ</label>
            <input type="date" class="form-control modern-date" id="dateToFilter"
                value="{{ request.args.get('date_to', '') }}" title="L·ªçc theo ng√†y k·∫øt th√∫c ngh·ªâ ph√©p">
        </div>
        <div class="flex-grow-1 filter-buttons-container" style="min-width: 200px;">
            <div class="d-flex gap-2" style="align-items: flex-end; height: 100%;">
                <button class="btn btn-filter btn-search" onclick="applyFilters()" id="filterButton">
                    <i class="fas fa-search me-1"></i> L·ªçc
                </button>
                <button class="btn btn-outline-secondary" onclick="clearFilters()" title="X√≥a t·∫•t c·∫£ b·ªô l·ªçc"
                    style="height: 50px; min-width: 80px; display: inline-flex; align-items: center; justify-content: center; white-space: nowrap;">
                    <i class="fas fa-times me-1"></i> X√≥a
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Active Filters Display -->
{% if request.args.get('status') or request.args.get('employee') or request.args.get('date_from') or
request.args.get('date_to') %}
<div class="alert alert-info d-flex align-items-center justify-content-between" style="margin-bottom: 1rem;">
    <div class="d-flex align-items-center">
        <i class="fas fa-filter me-2"></i>
        <span><strong>B·ªô l·ªçc ƒëang √°p d·ª•ng:</strong></span>
        <div class="ms-2">
            {% if request.args.get('status') %}
            <span class="badge bg-primary me-1">Tr·∫°ng th√°i: {{ request.args.get('status')|title }}</span>
            {% endif %}
            {% if request.args.get('employee') %}
            <span class="badge bg-info me-1">T√¨m ki·∫øm: {{ request.args.get('employee') }}</span>
            {% endif %}
            {% if request.args.get('department') %}
            <span class="badge bg-secondary me-1">Ph√≤ng ban: {{ request.args.get('department') }}</span>
            {% endif %}
            {% if request.args.get('date_from') %}
            <span class="badge bg-success me-1">T·ª´ ng√†y ngh·ªâ: {{ request.args.get('date_from') }}</span>
            {% endif %}
            {% if request.args.get('date_to') %}
            <span class="badge bg-success me-1">ƒê·∫øn ng√†y ngh·ªâ: {{ request.args.get('date_to') }}</span>
            {% endif %}
        </div>
    </div>
    <button class="btn btn-sm btn-outline-secondary" onclick="clearFilters()">
        <i class="fas fa-times"></i> X√≥a b·ªô l·ªçc
    </button>
</div>
{% endif %}

<div class="table-container">
    <div class="table-responsive">
        <table class="table data-table" style="width: 100%;">
            <thead>
                <tr>
                    <th style="min-width: 80px;">ID</th>
                    <th style="min-width: 150px;">Nh√¢n vi√™n</th>
                    <th style="min-width: 200px;">L√Ω do ngh·ªâ</th>
                    <th style="min-width: 200px;">Th·ªùi gian</th>
                    <th style="min-width: 120px;">S·ªë ng√†y</th>
                    <th style="min-width: 150px;">Ch·ª©ng t·ª´</th>
                    <th style="min-width: 120px;">Ng∆∞·ªùi thay th·∫ø</th>
                    <th style="min-width: 150px;">Ghi ch√∫</th>
                    <th style="min-width: 120px;">Tr·∫°ng th√°i</th>
                    <th style="min-width: 120px;">Ng√†y t·∫°o</th>
                    <th style="min-width: 150px;">
                        <div class="d-flex align-items-center justify-content-between gap-2">
                            <span>Thao t√°c</span>
                            {% if current_role in ['TEAM_LEADER', 'MANAGER', 'ADMIN'] %}
                            <button class="btn btn-success btn-sm btn-bulk-approve-header"
                                onclick="showBulkApproveModal()"
                                id="btnBulkApprove"
                                style="display: none;"
                                title="Ph√™ duy·ªát t·∫•t c·∫£ ƒë∆°n ƒëang ch·ªù">
                                <i class="fas fa-check-double me-1"></i>
                                <span class="d-none d-lg-inline">T·∫•t c·∫£</span>
                                <span class="badge bg-white text-success ms-1" id="pendingCountBadge">0</span>
                            </button>
                            {% endif %}
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% if leave_requests and leave_requests|length > 0 %}
                {% for request in leave_requests %}
                <tr
                    class="{% if request.status == 'pending' %}pending{% elif request.status == 'rejected' %}rejected{% endif %}">
                    <td>
                        <span class="fw-semibold text-primary">#{{ request.id }}</span>
                    </td>
                    <td>
                        <div>
                            <div class="fw-semibold">{{ request.employee_name }}</div>
                            <small class="text-muted">{{ request.employee_code }}</small>
                        </div>
                    </td>
                    <td style="min-width: 200px;">
                        <div class="text-truncate" style="max-width: 250px;"
                            title="{% if request.request_type == 'late_early' %}{% if request.late_early_type == 'late' %}[ƒêi tr·ªÖ]: {{ request.leave_reason }}{% elif request.late_early_type == 'early' %}[V·ªÅ s·ªõm]: {{ request.leave_reason }}{% else %}{{ request.leave_reason }}{% endif %}{% else %}{{ request.leave_reason }}{% endif %}"
                            role="button" tabindex="0">
                            {% if request.request_type == 'late_early' %}
                            {% if request.late_early_type == 'late' %}
                            <strong>[ƒêi tr·ªÖ]:</strong> {{ request.leave_reason }}
                            {% elif request.late_early_type == 'early' %}
                            <strong>[V·ªÅ s·ªõm]:</strong> {{ request.leave_reason }}
                            {% else %}
                            {{ request.leave_reason }}
                            {% endif %}
                            {% elif request.request_type == '30min_break' %}
                            <strong>[Ngh·ªâ 30 ph√∫t]:</strong> {{ request.leave_reason }}
                            {% else %}
                            {{ request.leave_reason }}
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <div class="small">
                            <div><strong>T·ª´:</strong> {{ request.leave_from_day }}/{{ request.leave_from_month
                                }}/{{ request.leave_from_year }} {{ '%02d'|format(request.leave_from_hour|int)
                                }}:{{ '%02d'|format(request.leave_from_minute|int) }}</div>
                            <div><strong>ƒê·∫øn:</strong> {{ request.leave_to_day }}/{{ request.leave_to_month
                                }}/{{ request.leave_to_year }} {{ '%02d'|format(request.leave_to_hour|int) }}:{{
                                '%02d'|format(request.leave_to_minute|int) }}</div>
                        </div>
                    </td>
                    <td>
                        <div class="d-flex flex-column gap-1">
                            {% if request.request_type == 'late_early' %}
                            {# T√≠nh th·ªùi l∆∞·ª£ng HH:MM #}
                            {% set from_total = (request.leave_from_hour|int) * 60 +
                            (request.leave_from_minute|int) %}
                            {% set to_total = (request.leave_to_hour|int) * 60 + (request.leave_to_minute|int)
                            %}
                            {% set duration = to_total - from_total %}
                            {% if duration < 0 %}{% set duration=0 %}{% endif %} {% set dur_h=(duration //
                                60)|int %} {% set dur_m=(duration % 60)|int %} <span
                                class="badge bg-info text-white"><i class="fas fa-clock me-1"></i>{{ dur_h }}:{{
                                '%02d'|format(dur_m) }}</span>
                                {% elif request.request_type == '30min_break' %}
                                {# T√≠nh th·ªùi l∆∞·ª£ng HH:MM cho ngh·ªâ 30 ph√∫t #}
                                {% set from_total = (request.leave_from_hour|int) * 60 +
                                (request.leave_from_minute|int) %}
                                {% set to_total = (request.leave_to_hour|int) * 60 +
                                (request.leave_to_minute|int) %}
                                {% set duration = to_total - from_total %}
                                {% if duration < 0 %}{% set duration=0 %}{% endif %} {% set dur_h=(duration //
                                    60)|int %} {% set dur_m=(duration % 60)|int %} <span
                                    class="badge bg-success text-white"><i class="fas fa-clock me-1"></i>{{
                                    dur_h }}:{{ '%02d'|format(dur_m) }}</span>
                                    {% else %}
                                    {% if request.annual_leave_days > 0 %}
                                    <span class="badge bg-info text-white">{{ request.annual_leave_days }} ng√†y
                                        ph√©p</span>
                                    {% endif %}
                                    {% if request.unpaid_leave_days > 0 %}
                                    <span class="badge bg-warning text-dark">{{ request.unpaid_leave_days }}
                                        ng√†y kh√¥ng l∆∞∆°ng</span>
                                    {% endif %}
                                    {% if request.special_leave_days > 0 %}
                                    <span class="badge bg-success text-white">{{ request.special_leave_days }}
                                        ng√†y ƒë·∫∑c bi·ªát</span>
                                    {% endif %}
                                    {% if request.japan_holiday_days > 0 %}
                                    <span class="badge bg-danger text-white">{{ request.japan_holiday_days }}
                                        ng√†y l·ªÖ Nh·∫≠t</span>
                                    {% endif %}
                                    {% if request.scope_leave_days > 0 %}
                                    <span class="badge bg-purple text-white" style="background-color: #6f42c1 !important;">{{ request.scope_leave_days }}
                                        ng√†y Scope</span>
                                    {% endif %}
                                    {% endif %}
                        </div>
                    </td>
                    <td>
                        {% if request.attachments_list and request.attachments_list|length > 0 %}
                        <button type="button" class="btn btn-sm btn-outline-primary download-all-btn"
                            data-request-id="{{ request.id }}"
                            data-attachments="{{ request.attachments_list | tojson | replace('\"', ' &quot;') }}"
                            title="T·∫£i xu·ªëng t·∫•t c·∫£ {{ request.attachments_list|length }} ch·ª©ng t·ª´">
                            <i class="fas fa-download"></i>
                            {% if request.attachments_list|length > 1 %}
                            <span class="ms-2">{{ request.attachments_list|length }} files</span>
                            {% endif %}
                        </button>
                        {% else %}
                        {% set has_docs = (request.attachments) or request.hospital_confirmation or
                        request.wedding_invitation or request.death_birth_certificate %}
                        <small>{{ 'C√≥' if has_docs else 'Kh√¥ng' }}</small>
                        {% endif %}
                    </td>
                    <td>
                        <div class="small">
                            <div>{{ request.substitute_name or '-' }}</div>
                            <div class="text-muted">{{ request.substitute_employee_id or '-' }}</div>
                        </div>
                    </td>
                    <td style="min-width: 150px;">
                        {% if request.notes %}
                        {% set filtered_notes = request.notes | filter_leave_notes %}
                        {% if filtered_notes %}
                        {% if 'L√Ω do t·ª´ ch·ªëi:' in filtered_notes %}
                        {% set parts = filtered_notes.split(':', 1) %}
                        {% set reason_text = (parts[1] if parts|length > 1 else '') %}
                        <div class="text-truncate" style="max-width: 220px;" title="{{ filtered_notes }}"
                            role="button" tabindex="0">
                            <strong>L√Ω do t·ª´ ch·ªëi:</strong><br>{{ reason_text.strip() }}
                        </div>
                        {% else %}
                        <div class="text-truncate" style="max-width: 220px;" title="{{ filtered_notes }}"
                            role="button" tabindex="0">
                            {{ filtered_notes }}
                        </div>
                        {% endif %}
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if request.status == 'pending' %}
                        <span class="status-badge status-pending">Ch·ªù tr∆∞·ªüng nh√≥m</span>
                        {% elif request.status == 'pending_manager' %}
                        <span class="status-badge bg-warning text-dark">Ch·ªù qu·∫£n l√Ω</span>
                        {% elif request.status == 'pending_admin' %}
                        <span class="status-badge bg-info text-white">Ch·ªù admin</span>
                        {% elif request.status == 'approved' %}
                        <span class="status-badge status-approved">ƒê√£ ph√™ duy·ªát</span>
                        {% elif request.status == 'rejected' %}
                        <span class="status-badge status-rejected">T·ª´ ch·ªëi</span>
                        {% else %}
                        <span class="status-badge bg-secondary text-white">{{ request.status }}</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="small text-muted">
                            <div><strong>Ng√†y:</strong> {{ request.created_at|vn_datetime('%d/%m/%Y') }}</div>
                            <div><strong>Gi·ªù:</strong> {{ request.created_at|vn_datetime('%H:%M') }}</div>
                        </div>
                    </td>
                    <td>
                        <div class="d-flex flex-nowrap align-items-center gap-1" style="white-space: nowrap;">
                            <!-- N√∫t Xem - ch·ªâ hi·ªÉn th·ªã cho vai tr√≤ kh√¥ng ph·∫£i ph√™ duy·ªát -->
                            {% if current_role not in ['TEAM_LEADER', 'MANAGER', 'ADMIN'] %}
                            <a href="{{ url_for('view_leave_request', request_id=request.id) }}"
                                class="btn btn-outline-primary btn-action">
                                <i class="fas fa-eye"></i> Xem
                            </a>
                            {% endif %}

                            <!-- N√∫t S·ª≠a/X√≥a - ch·ªâ hi·ªÉn th·ªã cho ng∆∞·ªùi t·∫°o ƒë∆°n khi ƒë∆°n ch∆∞a ƒë∆∞·ª£c ph√™ duy·ªát V√Ä kh√¥ng ph·∫£i vai tr√≤ ph√™ duy·ªát -->
                            {% if request.status in ['pending', 'rejected'] and user.id == request.user_id and
                            current_role not in ['TEAM_LEADER', 'MANAGER', 'ADMIN'] %}
                            <a href="{{ url_for('edit_leave_request', request_id=request.id) }}"
                                class="btn btn-outline-warning btn-action">
                                <i class="fas fa-edit"></i> S·ª≠a
                            </a>
                            <button type="button" class="btn btn-outline-danger btn-action btn-delete"
                                data-request-id="{{ request.id }}"
                                data-employee-name="{{ request.employee_name|e }}">
                                <i class="fas fa-trash"></i> X√≥a
                            </button>
                            {% endif %}

                            <!-- N√∫t Ph√™ duy·ªát/T·ª´ ch·ªëi - ch·ªâ hi·ªÉn th·ªã cho vai tr√≤ c√≥ quy·ªÅn -->
                            {% if request.status in ['pending', 'pending_manager', 'pending_admin'] %}

                            <!-- TEAM_LEADER: ch·ªâ ph√™ duy·ªát ƒë∆°n pending v√† c√πng ph√≤ng ban -->
                            {% if current_role == 'TEAM_LEADER' and request.status == 'pending' %}
                            {% set request_user = request.user %}
                            {% set can_approve = (user.department == request_user.department) %}
                            {% if can_approve %}
                            <button type="button" class="btn btn-success btn-action btn-approve"
                                data-request-id="{{ request.id }}">
                                <i class="fas fa-check"></i> Ph√™ duy·ªát
                            </button>
                            <button type="button" class="btn btn-danger btn-action btn-reject"
                                data-request-id="{{ request.id }}">
                                <i class="fas fa-times"></i> T·ª´ ch·ªëi
                            </button>
                            {% else %}
                            <small class="text-muted">Kh√°c ph√≤ng ban</small>
                            {% endif %}
                            {% endif %}

                            <!-- MANAGER: ph√™ duy·ªát ƒë∆°n pending_manager -->
                            {% if current_role == 'MANAGER' and request.status == 'pending_manager' %}
                            <button type="button" class="btn btn-success btn-action btn-approve"
                                data-request-id="{{ request.id }}">
                                <i class="fas fa-check"></i> Ph√™ duy·ªát
                            </button>
                            <button type="button" class="btn btn-danger btn-action btn-reject"
                                data-request-id="{{ request.id }}">
                                <i class="fas fa-times"></i> T·ª´ ch·ªëi
                            </button>
                            {% elif current_role == 'MANAGER' and request.status != 'pending_manager' %}
                            <small class="text-muted">Ch·ªù tr∆∞·ªüng nh√≥m</small>
                            {% endif %}

                            <!-- ADMIN: ph√™ duy·ªát ƒë∆°n pending_admin -->
                            {% if current_role == 'ADMIN' and request.status == 'pending_admin' %}
                            <button type="button" class="btn btn-success btn-action btn-approve"
                                data-request-id="{{ request.id }}">
                                <i class="fas fa-check"></i> Ph√™ duy·ªát
                            </button>
                            <button type="button" class="btn btn-danger btn-action btn-reject"
                                data-request-id="{{ request.id }}">
                                <i class="fas fa-times"></i> T·ª´ ch·ªëi
                            </button>
                            {% elif current_role == 'ADMIN' and request.status != 'pending_admin' %}
                            <small class="text-muted">Ch·ªù qu·∫£n l√Ω</small>
                            {% endif %}

                            {% if current_role not in ['TEAM_LEADER', 'MANAGER', 'ADMIN'] %}
                            {% endif %}
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="11" class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h4>Kh√¥ng c√≥ ƒë∆°n ngh·ªâ ph√©p n√†o</h4>
                        <p>Ch∆∞a c√≥ ƒë∆°n ngh·ªâ ph√©p n√†o ƒë∆∞·ª£c t·∫°o ho·∫∑c ph√π h·ª£p v·ªõi b·ªô l·ªçc hi·ªán t·∫°i.</p>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
{% if pagination and pagination.pages > 1 %}
<nav aria-label="Page navigation">
    <ul class="pagination">
        {% if pagination.has_prev %}
        <li class="page-item">
            <a class="page-link"
                href="{{ url_for_page(pagination.prev_num) }}">
                <i class="fas fa-chevron-left"></i> Tr∆∞·ªõc
            </a>
        </li>
        {% endif %}

        {% for page_num in pagination.iter_pages() %}
        {% if page_num %}
        {% if page_num != pagination.page %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for_page(page_num) }}">{{
                page_num }}</a>
        </li>
        {% else %}
        <li class="page-item active">
            <span class="page-link">{{ page_num }}</span>
        </li>
        {% endif %}
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">...</span>
        </li>
        {% endif %}
        {% endfor %}

        {% if pagination.has_next %}
        <li class="page-item">
            <a class="page-link"
                href="{{ url_for_page(pagination.next_num) }}">
                Sau <i class="fas fa-chevron-right"></i>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- Modal for rejection reason -->
<div class="modal fade" id="rejectReasonModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content"
            style="border-radius: var(--radius-lg); border: none; box-shadow: var(--shadow-lg);">
            <div class="modal-header" style="border-bottom: 1px solid var(--border-color); padding: 1.5rem;">
                <h5 class="modal-title fw-semibold">
                    <i class="fas fa-times-circle text-danger me-2"></i>
                    L√Ω do t·ª´ ch·ªëi
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <p class="text-muted mb-3">Vui l√≤ng nh·∫≠p l√Ω do t·ª´ ch·ªëi ƒë∆°n ngh·ªâ ph√©p n√†y:</p>
                <textarea class="form-control" id="rejectionReasonInput" rows="4"
                    placeholder="Nh·∫≠p l√Ω do t·ª´ ch·ªëi chi ti·∫øt..."
                    style="border-radius: var(--radius-md); border: 1px solid var(--border-color);"></textarea>
                <div class="mt-3 p-2 bg-light rounded" style="font-size: 0.875rem;">
                    <i class="fas fa-info-circle text-info me-1"></i>
                    <strong>L∆∞u √Ω:</strong> Vai tr√≤ ng∆∞·ªùi t·ª´ ch·ªëi s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông th√™m v√†o l√Ω do t·ª´ ch·ªëi.
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border-color); padding: 1.5rem;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                    style="border-radius: var(--radius-md);">
                    <i class="fas fa-times me-1"></i> H·ªßy
                </button>
                <button type="button" class="btn btn-danger" id="confirmRejectBtn"
                    style="border-radius: var(--radius-md);">
                    <i class="fas fa-ban me-1"></i> T·ª´ ch·ªëi
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Approve Modal -->
<div class="modal fade" id="bulkApproveModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-double me-2"></i>X√°c nh·∫≠n ph√™ duy·ªát t·∫•t c·∫£
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ph√™ duy·ªát <strong>T·∫§T C·∫¢ <span id="bulkApproveCount">0</span> ƒë∆°n</strong> ngh·ªâ ph√©p ƒëang ch·ªù?</p>
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>L∆∞u √Ω:</strong> H·ªá th·ªëng s·∫Ω ph√™ duy·ªát t·∫•t c·∫£ c√°c ƒë∆°n ƒëang ch·ªù b·∫°n ph√™ duy·ªát, bao g·ªìm c·∫£ c√°c ƒë∆°n ·ªü c√°c trang kh√°c (kh√¥ng ch·ªâ trang hi·ªán t·∫°i).
                </div>
                <div class="alert alert-warning mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-success" onclick="bulkApproveLeaveRequests()">
                    <i class="fas fa-check me-2"></i>Ph√™ duy·ªát
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Reject Modal -->
<div class="modal fade" id="bulkRejectModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-times-circle me-2"></i>X√°c nh·∫≠n t·ª´ ch·ªëi h√†ng lo·∫°t
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën t·ª´ ch·ªëi <strong id="bulkRejectCount">0</strong> ƒë∆°n ngh·ªâ ph√©p?
                </p>
                <div class="mb-3">
                    <label class="form-label">L√Ω do t·ª´ ch·ªëi <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="bulkRejectReason" rows="3"
                        placeholder="Nh·∫≠p l√Ω do t·ª´ ch·ªëi..." required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">X√°c nh·∫≠n m·∫≠t kh·∫©u <span class="text-danger">*</span></label>
                    <input type="password" class="form-control" id="bulkRejectPassword"
                        placeholder="Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ x√°c nh·∫≠n t·ª´ ch·ªëi t·∫•t c·∫£" required>
                    <small class="text-muted">Nh·∫≠p m·∫≠t kh·∫©u c·ªßa b·∫°n ƒë·ªÉ x√°c nh·∫≠n h√†nh ƒë·ªông n√†y</small>
                </div>
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>C·∫£nh b√°o:</strong> H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c! T·∫•t c·∫£ c√°c ƒë∆°n s·∫Ω b·ªã t·ª´ ch·ªëi.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-danger" onclick="bulkRejectLeaveRequests()">
                    <i class="fas fa-times me-2"></i>T·ª´ ch·ªëi
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Data block for admin check -->
<script type="application/json" id="admin-check-data">{{ 'true' if current_role == 'ADMIN' else 'false' }}</script>
<!-- Initialize global variables for JS -->
<script>
    window.leaveRequestsListUrl = '{{ url_for("leave_requests_list") }}';
    window.currentRole = '{{ current_role }}';
    window.userDepartment = '{{ user.department }}';
</script>
<!-- External JS file -->
<script src="{{ url_for('static', filename='js/leave-requests-list.js') }}"></script>
{% endblock %}
