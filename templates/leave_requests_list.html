<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Danh s√°ch ƒë∆°n ngh·ªâ ph√©p - H·ªá th·ªëng qu·∫£n l√Ω ch·∫•m c√¥ng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/search-filter.css') }}" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --success-color: #2ecc71;
            --warning-color: #f1c40f;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
            --card-bg: #ffffff;
            --dark-text: #2c3e50;
            --light-text: #7f8c8d;
            --border-color: #dee2e6;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
        }

        * {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-bg);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Sidebar Styling - Consistent with Dashboard */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 220px;
            background-color: var(--primary-color);
            padding: 15px;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .sidebar-header {
            padding: 20px 0;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 10px;
        }

        .sidebar-header h5 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            color: white;
        }

        .sidebar-header .user-info {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.875rem;
            margin-top: 5px;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.8) !important;
            padding: 0.875rem 1rem;
            margin: 0.25rem 0;
            border-radius: var(--radius-md);
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white !important;
            transform: translateX(4px);
        }

        .nav-link.active {
            background: rgba(255, 255, 255, 0.15);
            color: white !important;
            box-shadow: var(--shadow-sm);
        }

        .nav-link i {
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }

        /* Main Content */
        .main-content {
            margin-left: 220px;
            padding: 1.5rem;
            min-height: 100vh;
        }

        /* Header Section */
        .page-header {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            padding: 1.25rem 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .page-title i {
            color: var(--accent-color);
            font-size: 1.25rem;
        }

        .btn-create {
            background-color: var(--accent-color);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: 600;
            color: white;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .btn-create:hover {
            background-color: #2980b9;
            color: white;
        }

        /* Filter Section */
        .filter-section {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            padding: 1rem 1.25rem;
            margin-bottom: 1.25rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .filter-section .form-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--primary-color);
            margin-bottom: 0.375rem;
        }

        .filter-section .form-control,
        .filter-section .form-select {
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-sm);
        }

        .form-control,
        .form-select {
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn-filter {
            background-color: var(--accent-color);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            min-width: 80px;
        }

        .btn-filter:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        /* Table Styling */
        .table-container {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .data-table {
            margin: 0;
            font-size: 0.8rem;
        }

        .data-table thead th {
            background: #f8fafc;
            color: var(--primary-color);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            padding: 0.75rem 0.5rem;
            border: none;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        .data-table tbody tr {
            transition: all 0.2s ease;
            border-bottom: 1px solid #f1f5f9;
        }

        .data-table tbody tr:hover {
            background-color: #f8fafc;
        }

        .data-table tbody tr.pending {
            background: #fef3c7;
        }

        .data-table tbody tr.rejected {
            background: #fff5f5;
        }

        .data-table tbody td {
            padding: 0.75rem 0.5rem;
            vertical-align: middle;
            border: none;
            font-size: 0.8rem;
        }

        /* Enhanced table responsiveness */
        .table-responsive {
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            background: var(--card-bg);
            overflow-x: hidden;
        }

        .data-table th,
        .data-table td {
            white-space: normal;
            vertical-align: middle;
            padding: 0.75rem;
        }

        .data-table th:first-child,
        .data-table td:first-child {
            position: sticky;
            left: 0;
            background-color: var(--card-bg);
            z-index: 10;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }

        .data-table th:last-child,
        .data-table td:last-child {
            position: sticky;
            right: 0;
            background-color: var(--card-bg);
            z-index: 10;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
        }

        .data-table tbody tr:hover {
            background-color: #f8fafc;
            transform: scale(1.01);
        }

        /* Status Badges */
        .status-badge {
            font-size: 0.7rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            display: inline-block;
            min-width: 60px;
            text-align: center;
        }

        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #fbbf24;
        }

        .status-approved {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .status-rejected {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        /* Action Buttons */
        .btn-action {
            min-width: 50px;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            text-decoration: none;
        }

        .btn-approve {
            background-color: #10b981;
            border: 1px solid #10b981;
            color: white;
        }

        .btn-approve:hover {
            background-color: #059669;
            border-color: #059669;
            color: white;
        }

        .btn-reject {
            background-color: #ef4444;
            border: 1px solid #ef4444;
            color: white;
        }

        .btn-reject:hover {
            background-color: #dc2626;
            border-color: #dc2626;
            color: white;
        }

        .btn-outline-primary {
            border: 1px solid #3b82f6;
            color: #3b82f6;
            background: transparent;
        }

        .btn-outline-primary:hover {
            background-color: #3b82f6;
            color: white;
        }

        .btn-outline-warning {
            border: 1px solid #f59e0b;
            color: #f59e0b;
            background: transparent;
        }

        .btn-outline-warning:hover {
            background-color: #f59e0b;
            color: white;
        }

        .btn-outline-danger {
            border: 1px solid #ef4444;
            color: #ef4444;
            background: transparent;
        }

        .btn-outline-danger:hover {
            background-color: #ef4444;
            color: white;
        }

        /* Approval Banner */
        .approval-banner {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: var(--radius-sm);
            padding: 0.75rem 1rem;
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .approval-banner i {
            color: #0ea5e9;
            font-size: 1rem;
        }

        .approval-banner strong {
            color: #0c4a6e;
            font-weight: 600;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--light-text);
        }

        .empty-state i {
            font-size: 3rem;
            color: #cbd5e1;
            margin-bottom: 1rem;
        }

        .empty-state h4 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        /* Click-to-expand helper */
        .text-truncate {
            cursor: pointer;
        }

        /* Pagination */
        .pagination {
            justify-content: center;
            margin-top: 2rem;
        }

        .page-link {
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            margin: 0 0.25rem;
            border-radius: var(--radius-md);
            transition: all 0.3s ease;
        }

        .page-link:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .page-item.active .page-link {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        /* Responsive */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 1rem;
            }

            .page-header {
                padding: 1.5rem;
            }

            .page-title {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .data-table {
                font-size: 0.8rem;
            }

            .data-table th,
            .data-table td {
                padding: 0.75rem 0.5rem;
            }

            .btn-action {
                min-width: 60px;
                padding: 0.375rem 0.75rem;
                font-size: 0.75rem;
            }

            .filter-section .d-flex {
                flex-direction: column;
                align-items: stretch !important;
            }

            .filter-section .d-flex>div {
                min-width: 100% !important;
                margin-bottom: 0.75rem;
            }

            .filter-section .d-flex>div:last-child {
                margin-bottom: 0;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Smooth Transitions */
        * {
            transition: all 0.3s ease;
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h5><i class="fas fa-clock me-2"></i>Ch·∫•m c√¥ng</h5>
            <div class="user-info">{{ user.name }}</div>
        </div>
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('dashboard') }}" onclick="return handleNavigation(this)">
                    <i class="fas fa-home"></i> Trang ch·ªß
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('leave_request_form') }}">
                    <i class="fas fa-plus"></i> T·∫°o ƒë∆°n m·ªõi
                </a>
            </li>
            <li class="nav-item position-relative">
                <a class="nav-link active" href="{{ url_for('leave_requests_list') }}">
                    <i class="fas fa-list"></i> Danh s√°ch ƒë∆°n
                    {% set rejected_count = leave_requests|selectattr('status','equalto','rejected')|list|length %}
                    {% if rejected_count > 0 %}
                    <span class="badge bg-danger position-absolute translate-middle" style="top:8px; left: 145px;">{{
                        rejected_count }}</span>
                    {% endif %}
                </a>
            </li>
        </ul>
    </div>

    <!-- Main content -->
    <main class="main-content {% if current_role in ['TEAM_LEADER','MANAGER','ADMIN'] %}approval-mode{% endif %}">
        <!-- Page Header -->
        <div class="page-header">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="page-title">
                    <i class="fas fa-clipboard-list"></i>
                    Danh s√°ch ƒë∆°n ngh·ªâ ph√©p
                </h1>
            </div>
        </div>

        <!-- Token Status Banner (Admin Only) -->
        <div id="tokenStatusBanner"
            style="display: none; margin: 20px 15px; position: sticky; top: 10px; z-index: 1000;">
            <div class="alert alert-info alert-dismissible fade show shadow-sm" role="alert" id="tokenStatusAlert"
                style="margin-bottom: 0;">
                <div class="d-flex align-items-center flex-wrap">
                    <i class="fas fa-spinner fa-spin me-2" id="tokenStatusIcon" style="font-size: 1.2rem;"></i>
                    <div class="flex-grow-1 me-3">
                        <strong id="tokenStatusTitle" style="font-size: 1rem;">ƒêang ki·ªÉm tra tr·∫°ng th√°i Token Google
                            API...</strong>
                        <div id="tokenStatusMessage" class="mt-1" style="font-size: 0.9rem;">Vui l√≤ng ƒë·ª£i trong gi√¢y
                            l√°t...</div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        {% if current_role == 'ADMIN' %}
                        <button type="button" class="btn btn-sm btn-primary" id="btnRefreshToken"
                            style="display: none !important; white-space: nowrap;">
                            <i class="fas fa-sync-alt me-1"></i>Refresh Token
                        </button>
                        {% endif %}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                </div>
            </div>
        </div>

        {% if current_role in ['TEAM_LEADER','MANAGER','ADMIN'] %}
        <div class="approval-banner">
            <i class="fas fa-shield-check"></i>
            <div><strong>Ch·∫ø ƒë·ªô ph√™ duy·ªát</strong> ‚Äî B·∫°n c√≥ th·ªÉ ph√™ duy·ªát ho·∫∑c t·ª´ ch·ªëi c√°c ƒë∆°n ƒëang ch·ªù.</div>
        </div>
        {% endif %}

        <!-- Filter Section -->
        <div class="filter-section filter-row">
            <div class="d-flex flex-wrap gap-3 align-items-end">
                <div class="flex-grow-1" style="min-width: 200px;">
                    <label class="form-label fw-semibold mb-1">Tr·∫°ng th√°i</label>
                    <select class="form-select modern-select" id="statusFilter">
                        <option value="">üìã T·∫•t c·∫£ tr·∫°ng th√°i</option>
                        <option value="pending" {% if request.args.get('status')=='pending' %}selected{% endif %}>Ch·ªù
                            ph√™ duy·ªát</option>
                        <option value="approved" {% if request.args.get('status')=='approved' %}selected{% endif %}>ƒê√£
                            ph√™ duy·ªát</option>
                        <option value="rejected" {% if request.args.get('status')=='rejected' %}selected{% endif %}>T·ª´
                            ch·ªëi</option>
                    </select>
                </div>
                <div class="flex-grow-1" style="min-width: 200px;">
                    <label class="form-label fw-semibold mb-1">T√¨m ki·∫øm</label>
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="form-control modern-search" id="employeeFilter"
                            placeholder="T√¨m theo t√™n/m√£ NV" value="{{ request.args.get('employee', '') }}">
                    </div>
                </div>
                <div class="flex-grow-1" style="min-width: 180px;">
                    <label class="form-label fw-semibold mb-1">Ph√≤ng ban</label>
                    <select class="form-select modern-select" id="departmentFilter" {% if current_role not in
                        ['ADMIN', 'MANAGER' ] %}disabled title="Ch·ªâ Admin/Manager m·ªõi c√≥ th·ªÉ l·ªçc theo ph√≤ng ban" {%
                        endif %}>
                        <option value="">üè¢ T·∫•t c·∫£ ph√≤ng ban</option>
                        {% for dept in departments or [] %}
                        <option value="{{ dept }}" {% if request.args.get('department')==dept %}selected{% endif %}>{{
                            dept }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="flex-grow-1" style="min-width: 180px;">
                    <label class="form-label fw-semibold mb-1">Lo·∫°i ƒë∆°n</label>
                    <select class="form-select modern-select" id="requestTypeFilter">
                        <option value="">üìù T·∫•t c·∫£ lo·∫°i ƒë∆°n</option>
                        <option value="leave" {% if request.args.get('request_type')=='leave' %}selected{% endif %}>Ngh·ªâ
                            ph√©p</option>
                        <option value="late_early" {% if request.args.get('request_type')=='late_early' %}selected{%
                            endif %}>ƒêi tr·ªÖ/V·ªÅ s·ªõm</option>
                        <option value="30min_break" {% if request.args.get('request_type')=='30min_break' %}selected{%
                            endif %}>Ngh·ªâ 30 ph√∫t</option>
                    </select>
                </div>
                <div class="flex-grow-1" style="min-width: 150px;">
                    <label class="form-label fw-semibold mb-1">T·ª´ ng√†y ngh·ªâ</label>
                    <input type="date" class="form-control modern-date" id="dateFromFilter"
                        value="{{ request.args.get('date_from', '') }}" title="L·ªçc theo ng√†y b·∫Øt ƒë·∫ßu ngh·ªâ ph√©p">
                </div>
                <div class="flex-grow-1" style="min-width: 150px;">
                    <label class="form-label fw-semibold mb-1">ƒê·∫øn ng√†y ngh·ªâ</label>
                    <input type="date" class="form-control modern-date" id="dateToFilter"
                        value="{{ request.args.get('date_to', '') }}" title="L·ªçc theo ng√†y k·∫øt th√∫c ngh·ªâ ph√©p">
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-filter btn-search" onclick="applyFilters()">
                        <i class="fas fa-search me-1"></i> L·ªçc
                    </button>
                    <button class="btn btn-outline-secondary" onclick="clearFilters()" title="X√≥a t·∫•t c·∫£ b·ªô l·ªçc">
                        <i class="fas fa-times me-1"></i> X√≥a
                    </button>
                </div>
            </div>
        </div>

        <!-- Active Filters Display -->
        {% if request.args.get('status') or request.args.get('employee') or request.args.get('date_from') or
        request.args.get('date_to') %}
        <div class="alert alert-info d-flex align-items-center justify-content-between" style="margin-bottom: 1rem;">
            <div class="d-flex align-items-center">
                <i class="fas fa-filter me-2"></i>
                <span><strong>B·ªô l·ªçc ƒëang √°p d·ª•ng:</strong></span>
                <div class="ms-2">
                    {% if request.args.get('status') %}
                    <span class="badge bg-primary me-1">Tr·∫°ng th√°i: {{ request.args.get('status')|title }}</span>
                    {% endif %}
                    {% if request.args.get('employee') %}
                    <span class="badge bg-info me-1">T√¨m ki·∫øm: {{ request.args.get('employee') }}</span>
                    {% endif %}
                    {% if request.args.get('department') %}
                    <span class="badge bg-secondary me-1">Ph√≤ng ban: {{ request.args.get('department') }}</span>
                    {% endif %}
                    {% if request.args.get('date_from') %}
                    <span class="badge bg-success me-1">T·ª´ ng√†y ngh·ªâ: {{ request.args.get('date_from') }}</span>
                    {% endif %}
                    {% if request.args.get('date_to') %}
                    <span class="badge bg-success me-1">ƒê·∫øn ng√†y ngh·ªâ: {{ request.args.get('date_to') }}</span>
                    {% endif %}
                </div>
            </div>
            <button class="btn btn-sm btn-outline-secondary" onclick="clearFilters()">
                <i class="fas fa-times"></i> X√≥a b·ªô l·ªçc
            </button>
        </div>
        {% endif %}

        <div class="table-container">
            <div class="table-responsive">
                <table class="table data-table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th style="min-width: 80px;">ID</th>
                            <th style="min-width: 150px;">Nh√¢n vi√™n</th>
                            <th style="min-width: 200px;">L√Ω do ngh·ªâ</th>
                            <th style="min-width: 200px;">Th·ªùi gian</th>
                            <th style="min-width: 120px;">S·ªë ng√†y</th>
                            <th style="min-width: 150px;">Ch·ª©ng t·ª´</th>
                            <th style="min-width: 120px;">Ng∆∞·ªùi thay th·∫ø</th>
                            <th style="min-width: 150px;">Ghi ch√∫</th>
                            <th style="min-width: 120px;">Tr·∫°ng th√°i</th>
                            <th style="min-width: 120px;">Ng√†y t·∫°o</th>
                            <th style="min-width: 150px;">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if leave_requests and leave_requests|length > 0 %}
                        {% for request in leave_requests %}
                        <tr
                            class="{% if request.status == 'pending' %}pending{% elif request.status == 'rejected' %}rejected{% endif %}">
                            <td>
                                <span class="fw-semibold text-primary">#{{ request.id }}</span>
                            </td>
                            <td>
                                <div>
                                    <div class="fw-semibold">{{ request.employee_name }}</div>
                                    <small class="text-muted">{{ request.employee_code }}</small>
                                </div>
                            </td>
                            <td style="min-width: 200px;">
                                <div class="text-truncate" style="max-width: 250px;"
                                    title="{% if request.request_type == 'late_early' %}{% if request.late_early_type == 'late' %}[ƒêi tr·ªÖ]: {{ request.leave_reason }}{% elif request.late_early_type == 'early' %}[V·ªÅ s·ªõm]: {{ request.leave_reason }}{% else %}{{ request.leave_reason }}{% endif %}{% else %}{{ request.leave_reason }}{% endif %}"
                                    role="button" tabindex="0">
                                    {% if request.request_type == 'late_early' %}
                                    {% if request.late_early_type == 'late' %}
                                    <strong>[ƒêi tr·ªÖ]:</strong> {{ request.leave_reason }}
                                    {% elif request.late_early_type == 'early' %}
                                    <strong>[V·ªÅ s·ªõm]:</strong> {{ request.leave_reason }}
                                    {% else %}
                                    {{ request.leave_reason }}
                                    {% endif %}
                                    {% elif request.request_type == '30min_break' %}
                                    <strong>[Ngh·ªâ 30 ph√∫t]:</strong> {{ request.leave_reason }}
                                    {% else %}
                                    {{ request.leave_reason }}
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div class="small">
                                    <div><strong>T·ª´:</strong> {{ request.leave_from_day }}/{{ request.leave_from_month
                                        }}/{{ request.leave_from_year }} {{ '%02d'|format(request.leave_from_hour|int)
                                        }}:{{ '%02d'|format(request.leave_from_minute|int) }}</div>
                                    <div><strong>ƒê·∫øn:</strong> {{ request.leave_to_day }}/{{ request.leave_to_month
                                        }}/{{ request.leave_to_year }} {{ '%02d'|format(request.leave_to_hour|int) }}:{{
                                        '%02d'|format(request.leave_to_minute|int) }}</div>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex flex-column gap-1">
                                    {% if request.request_type == 'late_early' %}
                                    {# T√≠nh th·ªùi l∆∞·ª£ng HH:MM #}
                                    {% set from_total = (request.leave_from_hour|int) * 60 +
                                    (request.leave_from_minute|int) %}
                                    {% set to_total = (request.leave_to_hour|int) * 60 + (request.leave_to_minute|int)
                                    %}
                                    {% set duration = to_total - from_total %}
                                    {% if duration < 0 %}{% set duration=0 %}{% endif %} {% set dur_h=(duration //
                                        60)|int %} {% set dur_m=(duration % 60)|int %} <span
                                        class="badge bg-info text-white"><i class="fas fa-clock me-1"></i>{{ dur_h }}:{{
                                        '%02d'|format(dur_m) }}</span>
                                        {% elif request.request_type == '30min_break' %}
                                        {# T√≠nh th·ªùi l∆∞·ª£ng HH:MM cho ngh·ªâ 30 ph√∫t #}
                                        {% set from_total = (request.leave_from_hour|int) * 60 +
                                        (request.leave_from_minute|int) %}
                                        {% set to_total = (request.leave_to_hour|int) * 60 +
                                        (request.leave_to_minute|int) %}
                                        {% set duration = to_total - from_total %}
                                        {% if duration < 0 %}{% set duration=0 %}{% endif %} {% set dur_h=(duration //
                                            60)|int %} {% set dur_m=(duration % 60)|int %} <span
                                            class="badge bg-success text-white"><i class="fas fa-clock me-1"></i>{{
                                            dur_h }}:{{ '%02d'|format(dur_m) }}</span>
                                            {% else %}
                                            {% if request.annual_leave_days > 0 %}
                                            <span class="badge bg-info text-white">{{ request.annual_leave_days }} ng√†y
                                                ph√©p</span>
                                            {% endif %}
                                            {% if request.unpaid_leave_days > 0 %}
                                            <span class="badge bg-warning text-dark">{{ request.unpaid_leave_days }}
                                                ng√†y kh√¥ng l∆∞∆°ng</span>
                                            {% endif %}
                                            {% if request.special_leave_days > 0 %}
                                            <span class="badge bg-success text-white">{{ request.special_leave_days }}
                                                ng√†y ƒë·∫∑c bi·ªát</span>
                                            {% endif %}
                                            {% endif %}
                                </div>
                            </td>
                            <td>
                                {% if request.attachments_list and request.attachments_list|length > 0 %}
                                <button type="button" class="btn btn-sm btn-outline-primary download-all-btn"
                                    data-request-id="{{ request.id }}"
                                    data-attachments="{{ request.attachments_list | tojson | replace('"', ' &quot;') }}"
                                    title="T·∫£i xu·ªëng t·∫•t c·∫£ {{ request.attachments_list|length }} ch·ª©ng t·ª´">
                                    <i class="fas fa-download"></i>
                                    {% if request.attachments_list|length > 1 %}
                                    <span class="ms-2">{{ request.attachments_list|length }} files</span>
                                    {% endif %}
                                </button>
                                {% else %}
                                {% set has_docs = (request.attachments) or request.hospital_confirmation or
                                request.wedding_invitation or request.death_birth_certificate %}
                                <small>{{ 'C√≥' if has_docs else 'Kh√¥ng' }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <div class="small">
                                    <div>{{ request.substitute_name or '-' }}</div>
                                    <div class="text-muted">{{ request.substitute_employee_id or '-' }}</div>
                                </div>
                            </td>
                            <td style="min-width: 150px;">
                                {% if request.notes %}
                                {% set filtered_notes = request.notes | filter_leave_notes %}
                                {% if filtered_notes %}
                                {% if 'L√Ω do t·ª´ ch·ªëi:' in filtered_notes %}
                                {% set parts = filtered_notes.split(':', 1) %}
                                {% set reason_text = (parts[1] if parts|length > 1 else '') %}
                                <div class="text-truncate" style="max-width: 220px;" title="{{ filtered_notes }}"
                                    role="button" tabindex="0">
                                    <strong>L√Ω do t·ª´ ch·ªëi:</strong><br>{{ reason_text.strip() }}
                                </div>
                                {% else %}
                                <div class="text-truncate" style="max-width: 220px;" title="{{ filtered_notes }}"
                                    role="button" tabindex="0">
                                    {{ filtered_notes }}
                                </div>
                                {% endif %}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if request.status == 'pending' %}
                                <span class="status-badge status-pending">Ch·ªù tr∆∞·ªüng nh√≥m</span>
                                {% elif request.status == 'pending_manager' %}
                                <span class="status-badge bg-warning text-dark">Ch·ªù qu·∫£n l√Ω</span>
                                {% elif request.status == 'pending_admin' %}
                                <span class="status-badge bg-info text-white">Ch·ªù admin</span>
                                {% elif request.status == 'approved' %}
                                <span class="status-badge status-approved">ƒê√£ ph√™ duy·ªát</span>
                                {% elif request.status == 'rejected' %}
                                <span class="status-badge status-rejected">T·ª´ ch·ªëi</span>
                                {% else %}
                                <span class="status-badge bg-secondary text-white">{{ request.status }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="small text-muted">
                                    <div><strong>Ng√†y:</strong> {{ request.created_at|vn_datetime('%d/%m/%Y') }}</div>
                                    <div><strong>Gi·ªù:</strong> {{ request.created_at|vn_datetime('%H:%M') }}</div>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex flex-nowrap align-items-center gap-1" style="white-space: nowrap;">


                                    <!-- N√∫t Xem - ch·ªâ hi·ªÉn th·ªã cho vai tr√≤ kh√¥ng ph·∫£i ph√™ duy·ªát -->
                                    {% if current_role not in ['TEAM_LEADER', 'MANAGER', 'ADMIN'] %}
                                    <a href="{{ url_for('view_leave_request', request_id=request.id) }}"
                                        class="btn btn-outline-primary btn-action">
                                        <i class="fas fa-eye"></i> Xem
                                    </a>
                                    {% endif %}

                                    <!-- N√∫t S·ª≠a/X√≥a - ch·ªâ hi·ªÉn th·ªã cho ng∆∞·ªùi t·∫°o ƒë∆°n khi ƒë∆°n ch∆∞a ƒë∆∞·ª£c ph√™ duy·ªát V√Ä kh√¥ng ph·∫£i vai tr√≤ ph√™ duy·ªát -->
                                    {% if request.status in ['pending', 'rejected'] and user.id == request.user_id and
                                    current_role not in ['TEAM_LEADER', 'MANAGER', 'ADMIN'] %}
                                    <a href="{{ url_for('edit_leave_request', request_id=request.id) }}"
                                        class="btn btn-outline-warning btn-action">
                                        <i class="fas fa-edit"></i> S·ª≠a
                                    </a>
                                    <button type="button" class="btn btn-outline-danger btn-action btn-delete"
                                        data-request-id="{{ request.id }}"
                                        data-employee-name="{{ request.employee_name|e }}">
                                        <i class="fas fa-trash"></i> X√≥a
                                    </button>
                                    {% endif %}

                                    <!-- N√∫t Ph√™ duy·ªát/T·ª´ ch·ªëi - ch·ªâ hi·ªÉn th·ªã cho vai tr√≤ c√≥ quy·ªÅn -->
                                    <!-- T·∫†M TH·ªúI B·ªé ƒêI·ªÄU KI·ªÜN user.id != request.user_id ƒê·ªÇ TEST -->
                                    {% if request.status in ['pending', 'pending_manager', 'pending_admin'] %}


                                    <!-- TEAM_LEADER: ch·ªâ ph√™ duy·ªát ƒë∆°n pending v√† c√πng ph√≤ng ban -->
                                    {% if current_role == 'TEAM_LEADER' and request.status == 'pending' %}
                                    {% set request_user = request.user %}
                                    {% set can_approve = (user.department == request_user.department) %}
                                    {% if can_approve %}
                                    <button type="button" class="btn btn-success btn-action btn-approve"
                                        data-request-id="{{ request.id }}">
                                        <i class="fas fa-check"></i> Ph√™ duy·ªát
                                    </button>
                                    <button type="button" class="btn btn-danger btn-action btn-reject"
                                        data-request-id="{{ request.id }}">
                                        <i class="fas fa-times"></i> T·ª´ ch·ªëi
                                    </button>
                                    {% else %}
                                    <small class="text-muted">Kh√°c ph√≤ng ban</small>
                                    {% endif %}
                                    {% endif %}

                                    <!-- MANAGER: ph√™ duy·ªát ƒë∆°n pending_manager -->
                                    {% if current_role == 'MANAGER' and request.status == 'pending_manager' %}
                                    <button type="button" class="btn btn-success btn-action btn-approve"
                                        data-request-id="{{ request.id }}">
                                        <i class="fas fa-check"></i> Ph√™ duy·ªát
                                    </button>
                                    <button type="button" class="btn btn-danger btn-action btn-reject"
                                        data-request-id="{{ request.id }}">
                                        <i class="fas fa-times"></i> T·ª´ ch·ªëi
                                    </button>
                                    {% elif current_role == 'MANAGER' and request.status != 'pending_manager' %}
                                    <small class="text-muted">Ch·ªù tr∆∞·ªüng nh√≥m</small>
                                    {% endif %}

                                    <!-- ADMIN: ph√™ duy·ªát ƒë∆°n pending_admin -->
                                    {% if current_role == 'ADMIN' and request.status == 'pending_admin' %}
                                    <button type="button" class="btn btn-success btn-action btn-approve"
                                        data-request-id="{{ request.id }}">
                                        <i class="fas fa-check"></i> Ph√™ duy·ªát
                                    </button>
                                    <button type="button" class="btn btn-danger btn-action btn-reject"
                                        data-request-id="{{ request.id }}">
                                        <i class="fas fa-times"></i> T·ª´ ch·ªëi
                                    </button>
                                    {% elif current_role == 'ADMIN' and request.status != 'pending_admin' %}
                                    <small class="text-muted">Ch·ªù qu·∫£n l√Ω</small>
                                    {% endif %}

                                    {% if current_role not in ['TEAM_LEADER', 'MANAGER', 'ADMIN'] %}

                                    {% endif %}
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="11" class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <h4>Kh√¥ng c√≥ ƒë∆°n ngh·ªâ ph√©p n√†o</h4>
                                <p>Ch∆∞a c√≥ ƒë∆°n ngh·ªâ ph√©p n√†o ƒë∆∞·ª£c t·∫°o ho·∫∑c ph√π h·ª£p v·ªõi b·ªô l·ªçc hi·ªán t·∫°i.</p>
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        {% if pagination and pagination.pages > 1 %}
        <nav aria-label="Page navigation">
            <ul class="pagination">
                {% if pagination.has_prev %}
                <li class="page-item">
                    <a class="page-link"
                        href="{{ url_for('leave_requests_list', page=pagination.prev_num, **request.args) }}">
                        <i class="fas fa-chevron-left"></i> Tr∆∞·ªõc
                    </a>
                </li>
                {% endif %}

                {% for page_num in pagination.iter_pages() %}
                {% if page_num %}
                {% if page_num != pagination.page %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('leave_requests_list', page=page_num, **request.args) }}">{{
                        page_num }}</a>
                </li>
                {% else %}
                <li class="page-item active">
                    <span class="page-link">{{ page_num }}</span>
                </li>
                {% endif %}
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">...</span>
                </li>
                {% endif %}
                {% endfor %}

                {% if pagination.has_next %}
                <li class="page-item">
                    <a class="page-link"
                        href="{{ url_for('leave_requests_list', page=pagination.next_num, **request.args) }}">
                        Sau <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </main>

    <!-- Modal for rejection reason -->
    <div class="modal fade" id="rejectReasonModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content"
                style="border-radius: var(--radius-lg); border: none; box-shadow: var(--shadow-lg);">
                <div class="modal-header" style="border-bottom: 1px solid var(--border-color); padding: 1.5rem;">
                    <h5 class="modal-title fw-semibold">
                        <i class="fas fa-times-circle text-danger me-2"></i>
                        L√Ω do t·ª´ ch·ªëi
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="padding: 1.5rem;">
                    <p class="text-muted mb-3">Vui l√≤ng nh·∫≠p l√Ω do t·ª´ ch·ªëi ƒë∆°n ngh·ªâ ph√©p n√†y:</p>
                    <textarea class="form-control" id="rejectionReasonInput" rows="4"
                        placeholder="Nh·∫≠p l√Ω do t·ª´ ch·ªëi chi ti·∫øt..."
                        style="border-radius: var(--radius-md); border: 1px solid var(--border-color);"></textarea>
                    <div class="mt-3 p-2 bg-light rounded" style="font-size: 0.875rem;">
                        <i class="fas fa-info-circle text-info me-1"></i>
                        <strong>L∆∞u √Ω:</strong> Vai tr√≤ ng∆∞·ªùi t·ª´ ch·ªëi s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông th√™m v√†o l√Ω do t·ª´ ch·ªëi.
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--border-color); padding: 1.5rem;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                        style="border-radius: var(--radius-md);">
                        <i class="fas fa-times me-1"></i> H·ªßy
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmRejectBtn"
                        style="border-radius: var(--radius-md);">
                        <i class="fas fa-ban me-1"></i> T·ª´ ch·ªëi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Data block for admin check - prevents VS Code Jinja2 syntax errors -->
    <script type="application/json" id="admin-check-data">{{ 'true' if current_role == 'ADMIN' else 'false' }}</script>
    <script>
        // Navigation handler to prevent errors
        function handleNavigation(element) {
            try {
                // console.log('Navigating to:', element.href);
                // Clear any pending operations
                if (window.pendingOperations) {
                    window.pendingOperations.forEach(op => {
                        if (op && typeof op.abort === 'function') {
                            op.abort();
                        }
                    });
                    window.pendingOperations = [];
                }
                return true; // Allow navigation
            } catch (error) {
                console.error('Navigation error:', error);
                // Still allow navigation even if there's an error
                return true;
            }
        }

        // Enhanced Toast Notification
        function showToast(message, type = 'info') {
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 4000,
                timerProgressBar: true,
                background: 'var(--card-bg)',
                color: 'var(--text-primary)',
                customClass: {
                    popup: 'swal2-toast-custom'
                },
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer)
                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                }
            });

            let icon = type;
            let iconColor = '';

            if (type === 'success') {
                icon = 'success';
                iconColor = 'var(--success-color)';
            } else if (type === 'error') {
                icon = 'error';
                iconColor = 'var(--danger-color)';
            } else if (type === 'warning') {
                icon = 'warning';
                iconColor = 'var(--warning-color)';
            } else {
                icon = 'info';
                iconColor = 'var(--primary-color)';
            }

            Toast.fire({
                icon: icon,
                title: message,
                iconColor: iconColor
            });
        }

        // Loading state for buttons
        function setButtonLoading(button, loading = true) {
            if (loading) {
                button.disabled = true;
                button.innerHTML = '<span class="loading"></span> ƒêang x·ª≠ l√Ω...';
            } else {
                button.disabled = false;
                button.innerHTML = button.getAttribute('data-original-text') || button.innerHTML;
            }
        }

        // Apply filters with loading state
        function applyFilters() {
            const filterBtn = document.querySelector('.btn-filter');
            const originalText = filterBtn.innerHTML;

            setButtonLoading(filterBtn, true);

            const status = document.getElementById('statusFilter').value;
            const employee = document.getElementById('employeeFilter').value;
            const department = document.getElementById('departmentFilter').value;
            const requestType = document.getElementById('requestTypeFilter').value;
            const dateFrom = document.getElementById('dateFromFilter').value;
            const dateTo = document.getElementById('dateToFilter').value;

            const params = new URLSearchParams();
            if (status) params.append('status', status);
            if (employee) params.append('employee', employee);
            if (department) params.append('department', department);
            if (requestType) params.append('request_type', requestType);
            if (dateFrom) params.append('date_from', dateFrom);
            if (dateTo) params.append('date_to', dateTo);

            setTimeout(() => {
                window.location.href = '{{ url_for("leave_requests_list") }}?' + params.toString();
            }, 500);
        }

        // Clear all filters
        function clearFilters() {
            // Show confirmation dialog
            Swal.fire({
                title: 'X√≥a b·ªô l·ªçc',
                text: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ b·ªô l·ªçc?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: 'var(--secondary-color)',
                cancelButtonColor: 'var(--primary-color)',
                confirmButtonText: '<i class="fas fa-check me-1"></i> X√≥a',
                cancelButtonText: '<i class="fas fa-times me-1"></i> H·ªßy',
                customClass: {
                    popup: 'swal2-popup-custom'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('statusFilter').value = '';
                    document.getElementById('employeeFilter').value = '';
                    document.getElementById('departmentFilter').value = '';
                    document.getElementById('requestTypeFilter').value = '';
                    document.getElementById('dateFromFilter').value = '';
                    document.getElementById('dateToFilter').value = '';

                    // Redirect to clean URL
                    window.location.href = '{{ url_for("leave_requests_list") }}';
                }
            });
        }

        // Approve leave request with enhanced UX
        document.addEventListener('click', function (e) {
            const btn = e.target.closest('.btn-approve');
            if (!btn) return;

            const requestId = btn.getAttribute('data-request-id');
            const originalText = btn.innerHTML;

            // Show confirmation dialog
            Swal.fire({
                title: 'X√°c nh·∫≠n ph√™ duy·ªát',
                text: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ph√™ duy·ªát ƒë∆°n ngh·ªâ ph√©p n√†y?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: 'var(--success-color)',
                cancelButtonColor: 'var(--secondary-color)',
                confirmButtonText: '<i class="fas fa-check me-1"></i> Ph√™ duy·ªát',
                cancelButtonText: '<i class="fas fa-times me-1"></i> H·ªßy',
                customClass: {
                    popup: 'swal2-popup-custom'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    setButtonLoading(btn, true);

                    const controller = new AbortController();
                    if (!window.pendingOperations) window.pendingOperations = [];
                    window.pendingOperations.push(controller);

                    // L·∫•y CSRF token t·ª´ meta tag
                    const csrfToken = document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
                    console.log('CSRF Token:', csrfToken);
                    if (!csrfToken) {
                        showToast('Kh√¥ng t√¨m th·∫•y CSRF token. Vui l√≤ng refresh trang.', 'error');
                        setButtonLoading(btn, false);
                        return;
                    }

                    fetch(`/leave-request/${requestId}/approve`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({
                            action: 'approve',
                            csrf_token: csrfToken
                        }),
                        signal: controller.signal
                    }).then(async r => {
                        console.log('=== DEBUG APPROVAL RESPONSE ===');
                        console.log('Response status:', r.status);
                        console.log('Response URL:', r.url);
                        console.log('Response headers:', Object.fromEntries(r.headers.entries()));

                        const text = await r.text();
                        console.log('Response text (first 500 chars):', text.substring(0, 500));

                        if (text.trim().startsWith('<!doctype') || text.trim().startsWith('<html')) {
                            console.error('Server returned HTML instead of JSON!');
                            throw new Error('Server returned HTML: ' + text.substring(0, 200));
                        }

                        try {
                            const data = JSON.parse(text);
                            // console.log('Parsed JSON data:', data);
                            return { response: r, data };
                        } catch (e) {
                            console.error('JSON parse error:', e);
                            throw new Error('Invalid JSON response: ' + text.substring(0, 200));
                        }
                    }).then(({ response, data }) => {
                        if (response.ok) {
                            showToast(data.message || 'ƒê√£ ph√™ duy·ªát ƒë∆°n ngh·ªâ ph√©p th√†nh c√¥ng!', 'success');
                            setTimeout(() => window.location.reload(), 1000);
                        } else {
                            throw data;
                        }
                    }).catch(error => {
                        console.error('=== APPROVAL ERROR ===');
                        console.error('Error:', error);
                        showToast(error.error || error.message || 'C√≥ l·ªói x·∫£y ra khi ph√™ duy·ªát', 'error');
                        setButtonLoading(btn, false);
                    });
                }
            });
        });

        // Reject leave request with enhanced modal
        let pendingRejectRequestId = null;
        document.addEventListener('click', function (e) {
            const btn = e.target.closest('.btn-reject');
            if (!btn) return;

            pendingRejectRequestId = btn.getAttribute('data-request-id');
            document.getElementById('rejectionReasonInput').value = '';

            const modal = new bootstrap.Modal(document.getElementById('rejectReasonModal'));
            modal.show();
        });

        // Confirm rejection with enhanced UX
        document.getElementById('confirmRejectBtn').addEventListener('click', function () {
            if (!pendingRejectRequestId) return;

            const reason = document.getElementById('rejectionReasonInput').value.trim();
            const confirmBtn = document.getElementById('confirmRejectBtn');

            if (!reason) {
                showToast('Vui l√≤ng nh·∫≠p l√Ω do t·ª´ ch·ªëi', 'warning');
                return;
            }

            setButtonLoading(confirmBtn, true);

            // L·∫•y CSRF token t·ª´ meta tag
            const csrfToken = document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
            if (!csrfToken) {
                showToast('Kh√¥ng t√¨m th·∫•y CSRF token. Vui l√≤ng refresh trang.', 'error');
                return;
            }

            fetch(`/leave-request/${pendingRejectRequestId}/approve`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    action: 'reject',
                    rejection_reason: reason,
                    csrf_token: csrfToken
                })
            }).then(r => {
                if (r.ok) {
                    showToast('ƒê√£ t·ª´ ch·ªëi ƒë∆°n ngh·ªâ ph√©p th√†nh c√¥ng!', 'success');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('rejectReasonModal'));
                    modal.hide();
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showToast('C√≥ l·ªói x·∫£y ra khi t·ª´ ch·ªëi', 'error');
                    setButtonLoading(confirmBtn, false);
                }
            }).catch(() => {
                showToast('C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i', 'error');
                setButtonLoading(confirmBtn, false);
            });
        });

        // Delete leave request with enhanced confirmation
        document.addEventListener('click', function (e) {
            const btn = e.target.closest('.btn-delete');
            if (!btn) return;

            const requestId = btn.getAttribute('data-request-id');
            const employeeName = btn.getAttribute('data-employee-name');

            Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a',
                html: `
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒë∆°n ngh·ªâ ph√©p c·ªßa <strong>${employeeName}</strong>?</p>
                        <p class="text-muted small">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</p>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: 'var(--danger-color)',
                cancelButtonColor: 'var(--secondary-color)',
                confirmButtonText: '<i class="fas fa-trash me-1"></i> X√≥a',
                cancelButtonText: '<i class="fas fa-times me-1"></i> H·ªßy',
                customClass: {
                    popup: 'swal2-popup-custom'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    setButtonLoading(btn, true);

                    fetch(`/leave-request/${requestId}/delete`, {
                        method: 'GET'
                    }).then(r => {
                        if (r.ok) {
                            showToast('ƒê√£ x√≥a ƒë∆°n ngh·ªâ ph√©p th√†nh c√¥ng!', 'success');
                            setTimeout(() => window.location.reload(), 1000);
                        } else {
                            showToast('C√≥ l·ªói x·∫£y ra khi x√≥a', 'error');
                            setButtonLoading(btn, false);
                        }
                    }).catch(() => {
                        showToast('C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i', 'error');
                        setButtonLoading(btn, false);
                    });
                }
            });
        });

        // Enhanced tooltip for truncated content
        function showFullTextFrom(el) {
            const fullText = el.getAttribute('title') || '';
            if (!fullText) return;
            Swal.fire({
                title: 'Chi ti·∫øt',
                html: `<div style='text-align:left;max-width:600px;word-break:break-word;padding:1rem;background:#f8f9fa;border-radius:0.5rem;'>${fullText}</div>`,
                confirmButtonText: '<i class="fas fa-check me-1"></i> ƒê√≥ng',
                confirmButtonColor: 'var(--primary-color)'
            });
        }
        document.addEventListener('click', function (e) {
            const target = e.target.closest('.text-truncate');
            if (target) { showFullTextFrom(target); }
        });
        document.addEventListener('keydown', function (e) {
            if ((e.key === 'Enter' || e.key === ' ') && e.target.classList && e.target.classList.contains('text-truncate')) {
                e.preventDefault();
                showFullTextFrom(e.target);
            }
        });

        // Function to download all attachments for a leave request
        function downloadAllAttachments(requestId, attachments) {
            try {
                if (!attachments || attachments.length === 0) {
                    showToast('Kh√¥ng c√≥ ch·ª©ng t·ª´ ƒë·ªÉ t·∫£i xu·ªëng', 'warning');
                    return;
                }

                showToast(`ƒêang t·∫°o file ZIP v·ªõi ${attachments.length} file(s)...`, 'info');

                // Download ZIP file containing all attachments
                const downloadUrl = `/leave-request/${requestId}/download-all`;
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = `Ch·ª©ng_t·ª´_ngh·ªâ_ph√©p_${requestId}.zip`;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // console.log(`Downloaded ZIP with ${attachments.length} files`);

                // Show completion message
                setTimeout(() => {
                    showToast(`ƒê√£ t·∫£i xu·ªëng file ZIP v·ªõi ${attachments.length} file(s)`, 'success');
                }, 1000);

            } catch (error) {
                console.error('Error downloading attachments:', error);
                showToast('C√≥ l·ªói khi t·∫£i xu·ªëng ch·ª©ng t·ª´', 'error');
            }
        }

        // Add event listeners for download all buttons
        document.addEventListener('click', function (e) {
            if (e.target.closest('.download-all-btn')) {
                const btn = e.target.closest('.download-all-btn');
                const requestId = btn.getAttribute('data-request-id');
                const attachmentsJson = btn.getAttribute('data-attachments');

                try {
                    // Clean and parse JSON
                    let cleanJson = attachmentsJson;
                    if (typeof cleanJson === 'string') {
                        // Remove any potential HTML entities or extra quotes
                        cleanJson = cleanJson.replace(/&quot;/g, '"').replace(/&amp;/g, '&');
                    }

                    const attachments = JSON.parse(cleanJson);
                    downloadAllAttachments(requestId, attachments);
                } catch (error) {
                    console.error('Error parsing attachments:', error);
                    console.error('Raw JSON string:', attachmentsJson);
                    showToast('C√≥ l·ªói khi t·∫£i xu·ªëng ch·ª©ng t·ª´', 'error');
                }
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {

            // Add smooth animations
            const rows = document.querySelectorAll('.data-table tbody tr');
            rows.forEach((row, index) => {
                row.style.opacity = '0';
                row.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    row.style.transition = 'all 0.3s ease';
                    row.style.opacity = '1';
                    row.style.transform = 'translateY(0)';
                }, index * 50);
            });

            // Th√¥ng b√°o nhanh n·∫øu c√≥ ƒë∆°n b·ªã t·ª´ ch·ªëi trong danh s√°ch
            // T·∫Øt th√¥ng b√°o toast v·ªÅ s·ªë ƒë∆°n b·ªã t·ª´ ch·ªëi theo y√™u c·∫ßu
        });

        // ========== TOKEN STATUS MANAGEMENT (Admin Only) ==========
        let tokenStatus = null;
        let tokenEventSource = null;
        let isAdmin = false;

        // Ki·ªÉm tra xem user c√≥ ph·∫£i admin kh√¥ng
        function checkIfAdmin() {
            // ƒê·ªçc role t·ª´ data attribute thay v√¨ inline Jinja2
            const adminCheckEl = document.getElementById('admin-check-data');
            if (adminCheckEl) {
                try {
                    isAdmin = JSON.parse(adminCheckEl.textContent.trim());
                } catch (e) {
                    isAdmin = false;
                }
            }
            return isAdmin;
        }

        // C·∫≠p nh·∫≠t UI d·ª±a tr√™n token status
        function updateTokenStatusUI(status) {
            tokenStatus = status;
            const isLicenseWarning = status && typeof status.message === 'string' &&
                (status.message.includes('·ª®NG D·ª§NG CH·∫§M C√îNG') || status.message.includes('LICENSE'));

            const banner = document.getElementById('tokenStatusBanner');
            const alert = document.getElementById('tokenStatusAlert');
            const title = document.getElementById('tokenStatusTitle');
            const message = document.getElementById('tokenStatusMessage');
            const icon = document.getElementById('tokenStatusIcon');
            const refreshBtn = document.getElementById('btnRefreshToken');

            if (!banner) {
                console.warn('Token status banner not found');
                return;
            }

            // N·∫øu l√† c·∫£nh b√°o LICENSE v√† user v·ª´a t·∫Øt banner trong v√≤ng 60s th√¨ kh√¥ng hi·ªÉn th·ªã l·∫°i
            if (isLicenseWarning) {
                try {
                    const lastDismiss = localStorage.getItem('licenseBannerDismissedAt');
                    const lastTs = lastDismiss ? parseInt(lastDismiss, 10) : 0;
                    const now = Date.now();
                    if (lastTs && (now - lastTs) < 60000) {
                        banner.style.display = 'none';
                        return;
                    }
                } catch (e) {
                    console.warn('Could not read license banner dismiss state:', e);
                }

                // Tr∆∞·ªùng h·ª£p c·∫£nh b√°o LICENSE: hi·ªÉn th·ªã cho T·∫§T C·∫¢ ng∆∞·ªùi d√πng, kh√¥ng kh√≥a ch·ª©c nƒÉng
                banner.style.display = 'block';
                alert.className = 'alert alert-warning alert-dismissible fade show shadow-sm';
                icon.className = 'fas fa-exclamation-circle me-2';
                icon.style.color = '#856404';
                title.textContent = '‚ö†Ô∏è ·ª®ng d·ª•ng s·∫Øp h·∫øt h·∫°n LICENSE';
                title.style.color = '#856404';

                const rawMsg = status.message || '';
                message.innerHTML = rawMsg.replace(/\n/g, '<br>');
                message.style.color = '#856404';

                // ·∫®n ho√†n to√†n n√∫t Refresh Token v√¨ ƒë√¢y l√† c·∫£nh b√°o LICENSE, kh√¥ng ph·∫£i l·ªói token Google
                if (refreshBtn) {
                    refreshBtn.style.display = 'none';
                }

                // Kh√¥ng v√¥ hi·ªáu h√≥a c√°c n√∫t ph√™ duy·ªát cho c·∫£nh b√°o license s·∫Øp h·∫øt h·∫°n
                return;
            }

            // C√°c tr·∫°ng th√°i token Google kh√°c: ch·ªâ d√†nh cho admin nh∆∞ c≈©
            if (!isAdmin) {
                banner.style.display = 'none';
                return;
            }

            // Lu√¥n hi·ªÉn th·ªã banner cho admin khi token c√≥ v·∫•n ƒë·ªÅ
            banner.style.display = 'block';

            const isValid = status.valid && status.can_approve;
            const needsReauth = status.needs_reauth;

            if (!isValid) {
                // Token h·∫øt h·∫°n ho·∫∑c kh√¥ng h·ª£p l·ªá - HI·ªÇN TH·ªä banner
                banner.style.display = 'block';
                alert.className = 'alert alert-danger alert-dismissible fade show shadow-sm';
                icon.className = 'fas fa-exclamation-triangle me-2';
                icon.style.color = '#dc3545';
                title.textContent = '‚ö†Ô∏è Token Google API h·∫øt h·∫°n';
                title.style.color = '#721c24';
                message.textContent = status.message || 'Token kh√¥ng h·ª£p l·ªá. Vui l√≤ng refresh token tr∆∞·ªõc khi ph√™ duy·ªát.';
                message.style.color = '#721c24';
                // CH·ªà hi·ªÉn th·ªã n√∫t refresh khi token h·∫øt h·∫°n
                if (refreshBtn) {
                    refreshBtn.style.display = 'inline-flex';
                    refreshBtn.className = 'btn btn-sm btn-primary';
                }

                // V√¥ hi·ªáu h√≥a c√°c n√∫t ph√™ duy·ªát
                disableApprovalButtons(true);
            } else {
                // Token h·ª£p l·ªá - ·∫®N banner ho√†n to√†n
                banner.style.display = 'none';

                // K√≠ch ho·∫°t l·∫°i c√°c n√∫t ph√™ duy·ªát
                disableApprovalButtons(false);
            }
        }

        // V√¥ hi·ªáu h√≥a/k√≠ch ho·∫°t c√°c n√∫t ph√™ duy·ªát (n·∫øu c√≥)
        function disableApprovalButtons(disable) {
            const approveButtons = document.querySelectorAll('.btn-approve, .approve-btn, [onclick*="approve"]');
            approveButtons.forEach(btn => {
                if (disable) {
                    btn.disabled = true;
                    btn.classList.add('disabled');
                    btn.title = 'Token Google API h·∫øt h·∫°n. Vui l√≤ng refresh token tr∆∞·ªõc khi ph√™ duy·ªát.';
                } else {
                    btn.disabled = false;
                    btn.classList.remove('disabled');
                    btn.title = btn.getAttribute('data-original-title') || 'Ph√™ duy·ªát';
                }
            });
        }

        // K·∫øt n·ªëi SSE ƒë·ªÉ nh·∫≠n c·∫≠p nh·∫≠t token status real-time
        function connectTokenStatusSSE() {
            if (tokenEventSource) {
                tokenEventSource.close();
            }

            tokenEventSource = new EventSource('/sse/token-status');

            tokenEventSource.addEventListener('token_status', function (event) {
                try {
                    const status = JSON.parse(event.data);
                    updateTokenStatusUI(status);
                } catch (error) {
                    console.error('Error parsing token status:', error);
                }
            });

            tokenEventSource.onerror = function (error) {
                console.error('SSE connection error:', error);
                // Th·ª≠ k·∫øt n·ªëi l·∫°i sau 5 gi√¢y
                setTimeout(connectTokenStatusSSE, 5000);
            };
        }

        // L·∫•y token status ban ƒë·∫ßu
        async function fetchTokenStatus() {
            // Ki·ªÉm tra l·∫°i admin status
            checkIfAdmin();

            if (!isAdmin) {
                const banner = document.getElementById('tokenStatusBanner');
                if (banner) {
                    banner.style.display = 'none';
                }
                return;
            }

            // Kh√¥ng hi·ªÉn th·ªã banner khi ƒëang loading, ch·ªâ hi·ªÉn th·ªã khi c√≥ k·∫øt qu·∫£
            const banner = document.getElementById('tokenStatusBanner');
            if (banner && isAdmin) {
                // ·∫®n banner khi ƒëang loading
                banner.style.display = 'none';
            }

            try {
                const response = await fetch('/api/token/status');
                if (response.ok) {
                    const status = await response.json();
                    console.log('Token status received:', status);
                    updateTokenStatusUI(status);
                } else {
                    // N·∫øu API l·ªói, hi·ªÉn th·ªã c·∫£nh b√°o
                    updateTokenStatusUI({
                        valid: false,
                        can_approve: false,
                        needs_reauth: true,
                        message: 'Kh√¥ng th·ªÉ ki·ªÉm tra tr·∫°ng th√°i token. Vui l√≤ng th·ª≠ l·∫°i.'
                    });
                }
            } catch (error) {
                console.error('Error fetching token status:', error);
                // Hi·ªÉn th·ªã l·ªói
                updateTokenStatusUI({
                    valid: false,
                    can_approve: false,
                    needs_reauth: true,
                    message: 'L·ªói k·∫øt n·ªëi khi ki·ªÉm tra token. Vui l√≤ng th·ª≠ l·∫°i.'
                });
            }
        }

        // Refresh token - M·ªü Chrome ƒë·ªÉ ·ªßy quy·ªÅn
        async function refreshToken() {
            // Ki·ªÉm tra token status tr∆∞·ªõc khi m·ªü Chrome
            if (tokenStatus && tokenStatus.valid && tokenStatus.can_approve) {
                if (typeof showToast === 'function') {
                    showToast('Token v·∫´n c√≤n hi·ªáu l·ª±c, kh√¥ng c·∫ßn refresh.', 'info');
                } else {
                    alert('Token v·∫´n c√≤n hi·ªáu l·ª±c, kh√¥ng c·∫ßn refresh.');
                }
                return;
            }

            const refreshBtn = document.getElementById('btnRefreshToken');
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang m·ªü Chrome...';
            }

            try {
                // L·∫•y CSRF token
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

                // G·ªçi API ƒë·ªÉ m·ªü Chrome cho OAuth authorization
                const response = await fetch('/api/token/authorize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                });

                // Ki·ªÉm tra content-type tr∆∞·ªõc khi parse JSON
                const contentType = response.headers.get('content-type');
                let data;

                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Non-JSON response:', text.substring(0, 200));
                    throw new Error('Server tr·∫£ v·ªÅ response kh√¥ng h·ª£p l·ªá. Vui l√≤ng th·ª≠ l·∫°i.');
                }

                if (response.ok && data.success) {
                    if (typeof showToast === 'function') {
                        showToast(data.message || 'ƒê√£ m·ªü Chrome ƒë·ªÉ ·ªßy quy·ªÅn. Vui l√≤ng ho√†n t·∫•t qu√° tr√¨nh ·ªßy quy·ªÅn trong Chrome.', 'info');
                    } else {
                        alert(data.message || 'ƒê√£ m·ªü Chrome ƒë·ªÉ ·ªßy quy·ªÅn. Vui l√≤ng ho√†n t·∫•t qu√° tr√¨nh ·ªßy quy·ªÅn trong Chrome.');
                    }

                    // N·∫øu c√≥ URL, m·ªü trong tab m·ªõi
                    if (data.auth_url) {
                        window.open(data.auth_url, '_blank');
                    }

                    // Sau khi m·ªü Chrome, ƒë·ª£i m·ªôt ch√∫t r·ªìi check l·∫°i status
                    setTimeout(async () => {
                        await fetchTokenStatus();
                    }, 2000);
                } else {
                    const errorMsg = data.message || data.error || 'Kh√¥ng th·ªÉ m·ªü Chrome ƒë·ªÉ ·ªßy quy·ªÅn. Vui l√≤ng th·ª≠ l·∫°i.';
                    if (typeof showToast === 'function') {
                        showToast(errorMsg, 'error');
                    } else {
                        alert(errorMsg);
                    }
                }
            } catch (error) {
                console.error('Error opening Chrome for authorization:', error);
                const errorMsg = error.message || 'L·ªói khi m·ªü Chrome ƒë·ªÉ ·ªßy quy·ªÅn. Vui l√≤ng th·ª≠ l·∫°i.';
                if (typeof showToast === 'function') {
                    showToast(errorMsg, 'error');
                } else {
                    alert(errorMsg);
                }
            } finally {
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Refresh Token';
                }
            }
        }

        // Kh·ªüi t·∫°o token status management khi trang load
        document.addEventListener('DOMContentLoaded', function () {
            // ·∫®n banner m·∫∑c ƒë·ªãnh
            const banner = document.getElementById('tokenStatusBanner');
            if (banner) {
                banner.style.display = 'none';
            }

            // Ki·ªÉm tra admin ngay khi load
            checkIfAdmin();

            // 1) K·∫øt n·ªëi SSE CHO T·∫§T C·∫¢ USER ƒë·ªÉ m·ªçi ng∆∞·ªùi ƒë·ªÅu nh·∫≠n ƒë∆∞·ª£c c·∫£nh b√°o LICENSE realtime
            connectTokenStatusSSE();

            // 2) G·ªçi API l·∫•y tr·∫°ng th√°i LICENSE g·∫ßn nh·∫•t ƒë·ªÉ hi·ªÉn th·ªã NGAY khi load (kh√¥ng ƒë·ª£i SSE)
            (async function initLicenseWarning() {
                try {
                    const resp = await fetch('/api/license/warning-status');
                    if (!resp.ok) return;
                    const data = await resp.json();
                    if (data && data.active && data.payload) {
                        updateTokenStatusUI(data.payload);
                    }
                } catch (e) {
                    console.warn('Could not fetch initial license warning status:', e);
                }
            })();

            if (isAdmin) {
                console.log('Admin detected, initializing token status management...');
                // Fetch token status ban ƒë·∫ßu (ch·ªâ admin m·ªõi c·∫ßn check token Google)
                fetchTokenStatus();

                // L·∫Øng nghe s·ª± ki·ªán refresh token button
                const refreshBtn = document.getElementById('btnRefreshToken');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', refreshToken);
                }
            }

            // 3) Khi ng∆∞·ªùi d√πng b·∫•m n√∫t ƒë√≥ng (X), l∆∞u th·ªùi gian ƒë·ªÉ ·∫©n banner trong 60 gi√¢y
            const closeBtn = document.querySelector('#tokenStatusBanner .btn-close');
            if (closeBtn) {
                closeBtn.addEventListener('click', function () {
                    try {
                        // L∆∞u th·ªùi gian user t·∫Øt banner
                        localStorage.setItem('licenseBannerDismissedAt', Date.now().toString());
                    } catch (e) {
                        console.warn('Could not store license banner dismiss time:', e);
                    }

                    // Sau 60 gi√¢y, t·ª± ƒë·ªông g·ªçi l·∫°i updateTokenStatusUI v·ªõi tr·∫°ng th√°i m·ªõi nh·∫•t
                    setTimeout(function () {
                        try {
                            // H·∫øt 60s th√¨ xo√° tr·∫°ng th√°i dismiss ƒë·ªÉ kh√¥ng b·ªã ch·∫∑n n·ªØa
                            localStorage.removeItem('licenseBannerDismissedAt');
                            if (tokenStatus) {
                                updateTokenStatusUI(tokenStatus);
                            }
                        } catch (e) {
                            console.warn('Could not re-show license banner after 60s:', e);
                        }
                    }, 60000);
                });
            }
        });

        // Cleanup khi trang ƒë√≥ng
        window.addEventListener('beforeunload', function () {
            if (tokenEventSource) {
                tokenEventSource.close();
            }
        });
    </script>
</body>

</html>