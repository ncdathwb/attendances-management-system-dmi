<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <script>
        console.log('DEBUG: CSRF Token from template:', '{{ csrf_token() }}');
    </script>
    <!-- Data block for admin check - prevents VS Code Jinja2 syntax errors -->
    <script type="application/json"
        id="admin-check-data">{{ 'true' if 'ADMIN' in session.get('roles', []) else 'false' }}</script>
    <!-- Preloaded LICENSE warning state to show banner immediately on first load -->
    <script type="application/json" id="license-warning-init">
        {{ license_warning_state_json | safe }}
    </script>
    <title>Dashboard - Hệ thống Chấm công</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- SweetAlert2 -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <!-- Enhanced Error Handler -->
    <script src="{{ url_for('static', filename='js/error-handler.js') }}"></script>
    <!-- Global Email Notification -->
    <script src="{{ url_for('static', filename='js/global-email-notification.js') }}"></script>
    <!-- Thêm flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Role Switch Controls CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/role-switch-controls.css') }}?v=20250107003">
    <!-- Search Filter CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/search-filter.css') }}">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --success-color: #2ecc71;
            --warning-color: #f1c40f;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
            --dark-text: #2c3e50;
        }

        /* Ensure consistent table row heights */
        table tr {
            height: 50px !important;
        }

        table td {
            vertical-align: middle !important;
            height: 50px !important;
            padding: 8px !important;
            box-sizing: border-box !important;
        }

        /* Cố định chiều cao tối thiểu cho bảng chấm công */
        .attendance-history .table-responsive {
            min-height: 320px !important;
            /* Bao gồm thead và tbody */
        }

        /* Đảm bảo tất cả các dòng có height cố định */
        .attendance-history table tr {
            height: 50px !important;
        }

        /* Điều chỉnh bảng chính */
        .attendance-history table {
            border-collapse: collapse;
            width: 100%;
            table-layout: fixed;
        }

        /* Đảm bảo cột trạng thái hiển thị đúng */
        .badge.bg-success,
        .badge.bg-warning {
            display: inline-block;
            min-width: 125px;
            padding: 8px 0;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Đảm bảo dòng rỗng hiển thị đúng */
        .attendance-history tr.empty-row td {
            background-color: #f8fafc !important;
        }

        /* Thiết lập box-sizing cho mọi phần tử bảng */
        table tr,
        table td,
        table td * {
            box-sizing: border-box !important;
        }

        /* Chuẩn hóa các nút và placeholder */
        .btn-sm,
        td span {
            height: 30px !important;
            line-height: 30px !important;
            padding: 0 10px !important;
            margin: 0 !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        /* Đảm bảo bảng lịch sử chấm công hiển thị đúng */
        .attendance-history .table-responsive {
            overflow-x: auto !important;
            max-width: 100% !important;
        }

        .attendance-history table {
            min-width: 1200px !important;
            width: 100% !important;
        }


        .attendance-history th,
        .attendance-history td {
            white-space: nowrap !important;
            padding: 8px 4px !important;
            vertical-align: middle !important;
        }

        /* Custom styles for professional look */
        .form-control:focus,
        .form-select:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }

        .input-group-text {
            background-color: #f8f9fa;
        }

        /* Moon toggle styles */
        .moon-toggle {
            transition: all 0.3s ease;
        }

        .moon-toggle:hover {
            transform: scale(1.1);
        }

        .moon-toggle.active #moonIcon {
            color: #dc3545 !important;
            /* đỏ */
            background: linear-gradient(135deg, #fdecea 0%, #f8d7da 100%);
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }

        .moon-toggle:not(.active) #moonIcon {
            color: #6c757d !important;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Giảm khoảng cách giữa đồng hồ và mặt trăng xuống 50% */
        .moon-toggle {
            top: -4px !important;
            /* Giảm từ -8px xuống -4px */
            right: -4px !important;
            /* Giảm từ -8px xuống -4px */
        }

        /* Force override tất cả CSS khác */
        #moonToggle.moon-toggle {
            top: -4px !important;
            right: -4px !important;
        }

        /* Đảm bảo inline style không ghi đè */
        .moon-toggle[style*="top"],
        .moon-toggle[style*="right"] {
            top: -4px !important;
            right: -4px !important;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .moon-toggle {
                top: -3px !important;
                /* Giảm từ -6px xuống -3px */
                right: -3px !important;
                /* Giảm từ -6px xuống -3px */
            }

            .moon-toggle #moonIcon {
                font-size: 1rem !important;
                padding: 3px !important;
            }
        }

        .form-control:focus {
            border-color: #dee2e6;
        }

        .form-check-input:checked {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
            border: none;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #0b5ed7 0%, #0a58ca 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
        }

        /* Đảm bảo các cột có kích thước phù hợp */
        .attendance-history th:nth-child(1) {
            width: 80px !important;
        }

        /* Ngày */
        .attendance-history th:nth-child(2) {
            width: 60px !important;
        }

        /* Giờ vào */
        .attendance-history th:nth-child(3) {
            width: 60px !important;
        }

        /* Giờ ra */
        .attendance-history th:nth-child(4) {
            width: 40px !important;
        }

        /* Nghỉ */
        .attendance-history th:nth-child(5) {
            width: 50px !important;
        }

        /* Đối ứng */
        .attendance-history td:nth-child(5) {
            width: 50px !important;
            min-width: 50px !important;
            max-width: 50px !important;
            overflow: visible !important;
            white-space: nowrap !important;
        }

        /* Đối ứng */
        .attendance-history th:nth-child(6) {
            width: 70px !important;
        }

        /* Tổng giờ làm */
        .attendance-history th:nth-child(7) {
            width: 60px !important;
        }

        /* Giờ công */
        .attendance-history th:nth-child(8) {
            width: 60px !important;
        }

        /* Tăng ca trước 22h */
        .attendance-history th:nth-child(9) {
            width: 60px !important;
        }

        /* Tăng ca sau 22h */
        .attendance-history th:nth-child(10) {
            width: 90px !important;
        }

        /* Loại ngày */
        .attendance-history th:nth-child(11) {
            width: 100px !important;
        }

        /* Nhân viên */
        .attendance-history th:nth-child(12) {
            width: 100px !important;
        }

        /* Phòng ban */
        .attendance-history th:nth-child(13) {
            width: 90px !important;
        }

        /* Trạng thái */
        .attendance-history th:nth-child(14) {
            width: 80px !important;
        }

        /* Chữ ký */
        .attendance-history th:nth-child(15) {
            width: 120px !important;
        }

        /* Thao tác */
        .attendance-history th:nth-child(16) {
            width: 120px !important;
        }

        /* Ghi chú */

        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--dark-text);
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 220px;
            background-color: var(--primary-color);
            padding: 15px;
            color: white;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 20px 0;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .user-profile {
            padding: 20px 0;
            text-align: center;
        }

        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            margin: 0 auto 15px;
        }

        .user-info h4 {
            margin: 0;
            font-size: 1.1rem;
        }

        .user-info p {
            margin: 5px 0;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .nav-menu {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }

        .nav-item {
            margin-bottom: 5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .nav-link:hover,
        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        /* Main Content Styles */
        .main-content {
            margin-left: 220px;
            padding: 15px;
            max-width: calc(100% - 220px);
            overflow-x: hidden;
            box-sizing: border-box;
        }

        .page-header {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }

        .page-title {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .stat-card .icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            margin-bottom: 15px;
        }

        .stat-card .title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-card .value {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }

        /* Attendance Form Styles */
        .attendance-form {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
            max-width: 100%;
            overflow: hidden;
        }

        @media (max-width: 767px) {
            .form-row {
                flex-direction: column;
            }

            .form-row>div {
                margin-bottom: 10px;
            }

            .attendance-form .row .col-6 {
                flex: 0 0 100%;
                max-width: 100%;
            }
        }

        .form-label {
            font-weight: 500;
            margin-bottom: 8px;
        }

        .btn-primary {
            background-color: var(--accent-color);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .attendance-history {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            max-width: 100%;
            margin: 0;
        }

        .attendance-history .table-responsive {
            overflow-x: auto;
            min-width: 100%;
            max-width: 100%;
        }

        .table {
            width: 100%;
            table-layout: fixed;
            font-size: 0.9rem;
            margin: 0;
            border-collapse: collapse;
        }

        .table th {
            font-weight: 600;
            color: #666;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: 500;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 0;
                padding: 0;
            }

            .main-content {
                margin-left: 0;
                max-width: 100%;
            }
        }

        .holiday-section {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 10px;
        }

        #holidayTypeWrapper {
            display: none;
            min-width: 200px;
        }

        #holidayTypeWrapper.show {
            display: block;
        }

        .form-check {
            margin-bottom: 0;
        }

        /* Thêm CSS để giới hạn chiều rộng của cột ghi chú và hiển thị tooltip */
        .note-cell {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            cursor: pointer;
        }

        /* Đảm bảo các cột có kích thước phù hợp */
        .table th,
        .table td {
            vertical-align: middle;
            word-break: break-word;
            padding: 6px 4px !important;
        }

        /* Thiết lập độ rộng và căn chỉnh cho từng cột */
        .table th:nth-child(1),
        .table td:nth-child(1) {
            width: 80px;
        }

        /* Ngày */
        .table th:nth-child(2),
        .table td:nth-child(2) {
            width: 60px;
        }

        /* Giờ vào */
        .table th:nth-child(3),
        .table td:nth-child(3) {
            width: 60px;
        }

        /* Giờ ra */
        .table th:nth-child(4),
        .table td:nth-child(4) {
            width: 40px;
        }

        /* Nghỉ */
        .table th:nth-child(5),
        .table td:nth-child(5) {
            width: 50px;
        }

        /* Giờ công */
        .table th:nth-child(6),
        .table td:nth-child(6) {
            width: 55px;
        }

        /* Tăng ca trước 22h */
        .table th:nth-child(7),
        .table td:nth-child(7) {
            width: 55px;
        }

        /* Tăng ca sau 22h */
        .table th:nth-child(8),
        .table td:nth-child(8) {
            width: 80px;
        }

        /* Loại ngày */
        .table th:nth-child(9),
        .table td:nth-child(9) {
            width: 90px;
        }

        /* Trạng thái */
        .table th:nth-child(10),
        .table td:nth-child(10) {
            width: 90px;
        }

        /* Thao tác */
        .table th:nth-child(11),
        .table td:nth-child(11) {
            width: 90px;
        }

        /* Ghi chú */

        /* Cải thiện giao diện phân trang */
        .pagination {
            margin-top: 20px;
        }

        .pagination .page-item {
            margin: 0 3px;
        }

        .pagination .page-link {
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            color: var(--accent-color);
            border: 1px solid #dee2e6;
            transition: all 0.2s;
        }

        .pagination .page-item.active .page-link {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            color: white;
            box-shadow: 0 2px 5px rgba(52, 152, 219, 0.3);
        }

        .pagination .page-link:hover {
            background-color: #e9ecef;
            border-color: #dee2e6;
            color: var(--accent-color);
        }

        .pagination .page-item.active .page-link:hover {
            background-color: var(--accent-color);
            color: white;
        }

        /* Cải thiện responsive */
        @media (max-width: 1200px) {
            .attendance-history .table-responsive {
                overflow-x: auto;
            }

            .table th,
            .table td {
                white-space: nowrap;
            }
        }

        @media (min-width: 1201px) {
            .attendance-history .table-responsive {
                overflow-x: hidden;
            }
        }

        /* Cải thiện font size trong bảng khi màn hình nhỏ */
        @media (max-width: 992px) {
            .table {
                font-size: 0.85rem;
            }

            .badge.bg-success,
            .badge.bg-warning {
                font-size: 0.8rem;
                min-width: 100px;
            }
        }

        /* Thêm scrollbar tùy chỉnh để tối ưu không gian */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        html,
        body {
            max-width: 100%;
            overflow-x: hidden;
        }

        /* Giảm padding cho các phần tử con */
        .page-header {
            padding: 15px;
            margin-bottom: 15px;
        }

        .attendance-form {
            padding: 15px;
            margin-bottom: 15px;
        }

        .form-control {
            padding: 0.375rem 0.5rem;
        }

        /* Bỏ các style không cần thiết cho badges */
        .badge.bg-success,
        .badge.bg-warning {
            display: none;
        }

        /* Thêm style cho trạng thái text */
        .status-approved {
            color: #198754;
            /* màu xanh lá */
            font-weight: 500;
        }

        .status-pending {
            color: #ffc107;
            /* màu vàng */
            font-weight: 500;
        }

        .status-rejected {
            color: #dc3545;
            /* màu đỏ */
            font-weight: 500;
        }

        /* Căn chỉnh cho các cột */
        .table th,
        .table td {
            text-align: center;
            vertical-align: middle;
        }

        /* Ghi chú căn trái */
        .table th:last-child,
        .table td:last-child {
            text-align: left;
        }

        /* Thiết lập style cho header của bảng */
        .table thead th {
            font-weight: 600;
            color: #495057;
            background-color: #f8f9fa;
            border-top: none;
            text-align: center;
            vertical-align: middle;
            padding: 10px 5px;
        }

        /* Thiết lập style cho các hàng trong bảng */
        .table tbody td {
            padding: 8px 4px;
            vertical-align: middle;
        }

        /* Tiêu đề cuối cùng (ghi chú) được căn trái */
        .table th:last-child {
            text-align: left;
            padding-left: 10px;
        }

        /* Tiêu đề cột trạng thái */
        .table th:nth-child(9) {
            text-align: center;
        }

        /* Tiêu đề cột thao tác */
        .table th:nth-child(10) {
            text-align: center;
        }

        /* Thêm style cho empty-row */
        .empty-row td {
            height: 50px;
            padding: 0;
        }

        /* Style cho tất cả các hàng */
        .table tr {
            height: 50px;
        }

        /* Các thẻ th và td đều có height cố định */
        .table th,
        .table td {
            height: 50px !important;
        }

        /* Điều chỉnh CSS cho cột trạng thái để nhất quán */
        .status-approved,
        .status-pending,
        .status-rejected {
            display: inline-block;
            width: 100%;
            text-align: center;
        }

        /* Thiết lập style cho nút thao tác */
        .edit-attendance-btn {
            width: auto !important;
            min-width: 60px !important;
            height: 32px !important;
            padding: 4px 8px !important;
            border: 1px solid rgba(0, 0, 0, 0.2) !important;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1) !important;
            font-size: 12px !important;
            white-space: nowrap !important;
        }

        .delete-attendance-btn {
            width: auto !important;
            min-width: 60px !important;
            height: 32px !important;
            padding: 4px 8px !important;
            border: 1px solid rgba(0, 0, 0, 0.2) !important;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1) !important;
            font-size: 12px !important;
            white-space: nowrap !important;
        }

        .edit-attendance-btn i,
        .delete-attendance-btn i {
            font-size: 12px !important;
        }

        /* Thiết lập style cho nút phê duyệt và từ chối */
        .approve-attendance-btn,
        .reject-attendance-btn {
            width: auto !important;
            min-width: 90px !important;
            height: 32px !important;
            padding: 4px 8px !important;
            border: 1px solid rgba(0, 0, 0, 0.2) !important;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1) !important;
            font-size: 12px !important;
            white-space: nowrap !important;
        }

        .approve-attendance-btn i,
        .reject-attendance-btn i {
            font-size: 12px !important;
        }

        /* Tăng khoảng cách trong container */
        .action-container {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            height: 32px !important;
            gap: 8px !important;
        }

        /* Điều chỉnh các nút thao tác */
        .btn-action-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
            gap: 6px;
        }

        .btn-sm {
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
        }

        .btn-sm:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.2);
        }

        /* Đặt CSS !important để ghi đè mọi thiết lập khác */
        .btn.btn-warning.btn-sm.edit-attendance-btn,
        .btn.btn-danger.btn-sm.delete-attendance-btn {
            width: 38px !important;
            height: 32px !important;
            margin: 0 !important;
            padding: 0 !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        .table td.note-cell {
            background-color: #f8fafc !important;
            max-width: 120px;
            cursor: pointer;
        }

        .attendance-history .empty-row td {
            background-color: #f8fafc !important;
        }

        /* Thêm vào phần <style> */
        .no-data-row {
            font-weight: 600 !important;
            font-size: 1.05rem !important;
            color: #888 !important;
            text-align: center !important;
            background: #f8fafc !important;
            height: 50px !important;
            vertical-align: middle !important;
        }

        #signature-pad {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: border 0.2s;
        }

        .signature-status {
            display: flex;
            flex-direction: column;
            gap: 2px;
            align-items: center;
        }

        .signature-status .badge {
            font-size: 0.65rem;
            padding: 0 2px;
            white-space: nowrap;
            margin: 0 !important;
            display: block;
            line-height: 1.2;
        }

        .signature-status .badge.bg-success {
            background-color: #28a745 !important;
        }

        .signature-status .badge.bg-warning {
            background-color: #ffc107 !important;
            color: #212529 !important;
        }

        .signature-status .badge.bg-secondary {
            background-color: #6c757d !important;
        }

        @media (max-width: 600px) {
            #signature-pad {
                width: 100% !important;
                min-width: 220px;
                max-width: 100%;
                height: 90px !important;
            }

            .signature-status {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-clock me-2"></i>Chấm công</h3>
        </div>
        <div class="user-profile">
            <div class="user-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="user-info">
                <h4>{{ user.name }}</h4>
                <p>Mã NV: {{ user.employee_id }}</p>
                <p>{{ user.department }}</p>
                <!-- Hidden element for JavaScript to get current user name -->
                <span id="current-user-name" style="display: none;">{{ user.name }}</span>
                <div class="role-switcher" style="margin-top:10px;">
                    <label for="role-select" style="font-weight:500;">Vai trò hiện tại:</label>
                    <select id="role-select" class="form-select form-select-sm" style="margin-top:4px;">
                        {% set current_role = session.get('current_role', user.roles.split(',')[0]) %}
                        <!-- DEBUG: current_role = {{ current_role }}, user.roles = {{ user.roles }} -->
                        {% for role in user.roles.split(',') %}
                        <option value="{{ role }}" {% if role==current_role %}selected{% endif %}>
                            {% if role == 'EMPLOYEE' %}Nhân viên{% elif role == 'TEAM_LEADER' %}Trưởng nhóm{% elif role
                            == 'MANAGER' %}Quản lý{% elif role == 'ADMIN' %}Quản trị viên{% else %}{{ role }}{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="#" class="nav-link active">
                    <i class="fas fa-home"></i>
                    Trang chủ
                </a>
            </li>
            {% if 'ADMIN' in session.get('roles', []) %}
            <li class="nav-item" id="adminUsersMenu" style="display: none;">
                <a href="{{ url_for('admin_users') }}" class="nav-link">
                    <i class="fas fa-users"></i>
                    Quản lý người dùng
                </a>
            </li>
            <li class="nav-item" id="adminHolidaysMenu" style="display: none;">
                <a href="{{ url_for('admin_holidays') }}" class="nav-link">
                    <i class="fas fa-calendar-alt"></i>
                    Quản lý ngày lễ
                </a>
            </li>
            <li class="nav-item" id="adminLeaveHistoryAllMenu" style="display: none;">
                <a href="{{ url_for('leave_history') }}" class="nav-link">
                    <i class="fas fa-clipboard-list"></i>
                    Lịch sử nghỉ phép
                </a>
            </li>
            {% endif %}
            <li class="nav-item" id="attendanceHistoryMenuWrapper" style="display: none;">
                <a href="#" class="nav-link" id="attendanceHistoryMenu">
                    <i class="fas fa-calendar-alt"></i>
                    Lịch sử chấm công
                </a>
            </li>
            <!-- Menu nghỉ phép cho nhân viên -->
            <li class="nav-item" id="employeeLeaveMenu" style="display: none;">
                <a href="{{ url_for('leave_request_form') }}" class="nav-link">
                    <i class="fas fa-calendar-plus"></i>
                    Đăng ký nghỉ phép
                </a>
            </li>
            <li class="nav-item position-relative" id="employeeLeaveStatusMenu" style="display: none;">
                <a href="{{ url_for('leave_requests_list') }}" class="nav-link">
                    <i class="fas fa-list-alt"></i>
                    Theo dõi tình trạng
                    {% if leave_requests %}
                    {% set rejected_count_sidebar = leave_requests|selectattr('status','equalto','rejected')|list|length
                    %}
                    {% if rejected_count_sidebar > 0 %}
                    <span class="badge bg-danger position-absolute" style="right: 12px; top: 8px;">{{
                        rejected_count_sidebar }}</span>
                    {% endif %}
                    {% endif %}
                </a>
            </li>
            <li class="nav-item" id="employeeLeaveHistoryMenu" style="display: none;">
                <a href="{{ url_for('leave_history') }}" class="nav-link">
                    <i class="fas fa-history"></i>
                    Lịch sử nghỉ phép
                </a>
            </li>

            <!-- Menu nghỉ phép cần phê duyệt cho trưởng nhóm/quản lý/quản trị viên -->
            <li class="nav-item" id="managerLeaveMenu" style="display: none;">
                <a href="{{ url_for('leave_requests_list') }}" class="nav-link position-relative">
                    <i class="fas fa-calendar-check"></i>
                    Nghỉ phép cần phê duyệt
                    <span id="pendingLeaveCount"
                        class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                        style="display: none;">
                        0
                    </span>
                </a>
            </li>

            <!-- Menu danh sách đơn nghỉ phép và báo cáo đã được ẩn theo yêu cầu -->
            <li class="nav-item">
                <a href="{{ url_for('settings') }}" class="nav-link">
                    <i class="fas fa-user-cog"></i>
                    Cài đặt
                </a>
            </li>





            <li class="nav-item">
                <a href="/logout" class="nav-link">
                    <i class="fas fa-sign-out-alt"></i>
                    Đăng xuất
                </a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container-fluid p-0">
            <div class="page-header">
                <h1 class="page-title">Bảng điều khiển</h1>
            </div>

            <!-- Token Status Banner (Admin Only) -->
            <div id="tokenStatusBanner"
                style="display: none; margin: 20px 15px; position: sticky; top: 10px; z-index: 1000;">
                <div class="alert alert-info alert-dismissible fade show shadow-sm" role="alert" id="tokenStatusAlert"
                    style="margin-bottom: 0;">
                    <div class="d-flex align-items-center flex-wrap">
                        <i class="fas fa-spinner fa-spin me-2" id="tokenStatusIcon" style="font-size: 1.2rem;"></i>
                        <div class="flex-grow-1 me-3">
                            <strong id="tokenStatusTitle" style="font-size: 1rem;">Đang kiểm tra trạng thái Token Google
                                API...</strong>
                            <div id="tokenStatusMessage" class="mt-1" style="font-size: 0.9rem;">Vui lòng đợi trong giây
                                lát...</div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            {# 
                                Nút Refresh Token chỉ xuất hiện khi:
                                - ĐANG Ở VAI TRÒ ADMIN (current_role == 'ADMIN')
                                - Và ở phía JS, chỉ hiển thị khi token Google hết hạn / không hợp lệ.
                                Điều này giữ nguyên logic cũ: nhân viên hoặc khi token còn hạn sẽ không thấy nút.
                             #}
                            {% if current_role == 'ADMIN' %}
                            <button type="button" class="btn btn-sm btn-primary" id="btnRefreshToken"
                                style="display: none; white-space: nowrap;">
                                <i class="fas fa-sync-alt me-1"></i>Refresh Token
                            </button>
                            {% endif %}
                            <button type="button" class="btn-close" aria-label="Close"></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-cards" style="display:none;">
                <div class="stat-card">
                    <div class="icon" style="background-color: rgba(52, 152, 219, 0.1); color: var(--accent-color);">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="title">Ngày làm việc trong tháng</div>
                    <div class="value">22</div>
                </div>
                <div class="stat-card">
                    <div class="icon" style="background-color: rgba(46, 204, 113, 0.1); color: var(--success-color);">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="title">Giờ làm việc trong tháng</div>
                    <div class="value">176</div>
                </div>
                <div class="stat-card">
                    <div class="icon" style="background-color: rgba(241, 196, 15, 0.1); color: var(--warning-color);">
                        <i class="fas fa-calendar-minus"></i>
                    </div>
                    <div class="title">Ngày nghỉ còn lại</div>
                    <div class="value">12</div>
                </div>
            </div>

            <!-- Attendance Form - Hiển thị động theo vai trò -->
            <div class="attendance-form" id="attendanceFormSection" style="display: none;">
                <h4 class="mb-4"><i class="fas fa-clock me-2"></i>Đăng ký chấm công</h4>
                <form id="attendanceForm">
                    <div class="row g-3 align-items-end">
                        <div class="col-6 col-md">
                            <label for="attendanceDate" class="form-label">Ngày</label>
                            <input type="text" class="form-control form-control-sm" id="attendanceDate" required>
                        </div>
                        <div class="col-6 col-md">
                            <label for="dayType" class="form-label">
                                <i class="fas fa-calendar-day me-1"></i>Loại ngày
                            </label>
                            <select class="form-control form-control-sm" id="dayType">
                                <option value="" selected>-- Chọn loại ngày --</option>
                                <option value="normal">Ngày thường</option>
                                <option value="weekend">Cuối tuần</option>
                                <option value="vietnamese_holiday">Lễ Việt Nam</option>
                                <option value="japanese_holiday">Lễ Nhật Bản</option>
                            </select>
                        </div>
                        <div class="col-4 col-md">
                            <label for="shiftSelect" class="form-label">
                                <i class="fas fa-calendar-alt me-1"></i>Ca
                            </label>
                            <select class="form-control form-control-sm" id="shiftSelect">
                                <option value="">-- Chọn ca --</option>
                                <option value="1">Ca 1 (07:30 - 16:30)</option>
                                <option value="2">Ca 2 (09:00 - 18:00)</option>
                                <option value="3">Ca 3 (11:00 - 20:00)</option>
                                <option value="4">Ca 4 (08:00 - 17:00)</option>
                                <option value="5">Ca tự do</option>
                            </select>
                        </div>
                        <div class="col-6 col-md">
                            <label for="checkInTime" class="form-label">
                                <i class="fas fa-sign-in-alt me-1"></i>Giờ vào
                            </label>
                            <input type="time" class="form-control form-control-sm" id="checkInTime" required>
                        </div>
                        <div class="col-6 col-md">
                            <label for="checkOutTime" class="form-label">
                                <i class="fas fa-clock me-1"></i>Giờ ra
                            </label>
                            <div class="position-relative">
                                <input type="time" class="form-control form-control-sm" id="checkOutTime" required
                                    style="padding-right: 45px;">
                                <div class="moon-toggle position-absolute" id="moonToggle"
                                    style="top: -4px; right: -4px; cursor: pointer; z-index: 10;">
                                    <i class="fas fa-moon" id="moonIcon"
                                        style="font-size: 1.2rem; color: #6c757d; background: white; padding: 4px; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.3s ease;"></i>
                                </div>
                                <input type="hidden" id="nextDayCheckout" value="false">
                            </div>
                        </div>
                        <div class="col-6 col-md">
                            <label for="breakTime" class="form-label">
                                <i class="fas fa-coffee me-1"></i>Giờ nghỉ
                            </label>
                            <input type="text" class="form-control form-control-sm" id="breakTime" value="01:00"
                                required pattern="^\\d{1,2}:[0-5]\\d$" inputmode="numeric" placeholder="HH:MM"
                                title="Định dạng HH:MM">
                        </div>
                        <div class="col-6 col-md">
                            <label for="compTimeType" class="form-label">
                                <i class="fas fa-exchange-alt me-1"></i>Loại đối ứng
                            </label>
                            <select id="compTimeType" class="form-control form-control-sm">
                                <option value="">-- Chọn loại đối ứng --</option>
                                <option value="regular">Trong ca làm việc</option>
                                <option value="ot_before">Tăng ca trước 22h</option>
                                <option value="ot_after">Tăng ca sau 22h</option>
                            </select>
                        </div>
                        <div class="col-6 col-md comp-group comp-regular" style="display: none;">
                            <label for="compTimeRegular" class="form-label">
                                <i class="fas fa-clock me-1"></i>Đối ứng trong ca
                            </label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="compTimeRegular" value="00:00"
                                    pattern="^\\d{1,2}:[0-5]\\d$" inputmode="numeric" placeholder="HH:MM"
                                    title="Định dạng HH:MM">
                                <div class="input-group-append">
                                    <span class="input-group-text">
                                        <i class="fas fa-hourglass-half"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md comp-group comp-ot-before" style="display: none;">
                            <label for="compTimeBefore22" class="form-label">
                                <i class="fas fa-sun me-1"></i>Đối ứng trước 22h
                            </label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="compTimeBefore22" value="00:00"
                                    pattern="^\\d{1,2}:[0-5]\\d$" inputmode="numeric" placeholder="HH:MM"
                                    title="Định dạng HH:MM">
                                <div class="input-group-append">
                                    <span class="input-group-text">
                                        <i class="fas fa-hourglass-start"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md comp-group comp-ot-after" style="display: none;">
                            <label for="compTimeAfter22" class="form-label">
                                <i class="fas fa-moon me-1"></i>Đối ứng sau 22h
                            </label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="compTimeAfter22" value="00:00"
                                    pattern="^\\d{1,2}:[0-5]\\d$" inputmode="numeric" placeholder="HH:MM"
                                    title="Định dạng HH:MM">
                                <div class="input-group-append">
                                    <span class="input-group-text">
                                        <i class="fas fa-hourglass-end"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <label for="attendanceNote" class="form-label">
                                <i class="fas fa-sticky-note me-1"></i>Ghi chú
                            </label>
                            <textarea class="form-control" id="attendanceNote" rows="3"
                                placeholder="Nhập ghi chú của bạn (tùy chọn)...">Chưa hoàn thành công việc</textarea>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-info border-0 shadow-sm" role="alert"
                                style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-signature me-2 text-primary" style="font-size: 1.2rem;"></i>
                                    <div>
                                        <strong class="text-primary">Chữ ký tự động:</strong>
                                        <span class="text-muted">Hệ thống sẽ tự động sử dụng chữ ký có sẵn từ database
                                            của bạn.</span>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" name="signature" id="signature-input">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary btn-lg shadow-sm"
                                        id="saveAttendanceBtn" style="min-width: 140px;">
                                        <i class="fas fa-save me-2"></i>
                                        <span class="fw-semibold">Lưu đăng ký</span>
                                    </button>
                                    <button type="button" id="cancelEditBtn" onclick="resetForm()"
                                        style="display: none !important;" class="btn btn-danger btn-lg shadow-sm">
                                        <i class="fas fa-times me-2"></i>
                                        <span class="fw-semibold">Hủy sửa</span>
                                    </button>
                                </div>
                                <div class="text-muted small">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <span>Hệ thống sẽ tự động tính toán giờ làm việc</span>
                                </div>
                                <input type="hidden" id="editAttendanceId">
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Attendance History - Hiển thị động theo vai trò -->
            <div class="attendance-history" id="attendanceHistorySection" style="display: none;">
                <h4 class="mb-4"><i class="fas fa-history me-2"></i>Lịch sử đăng ký chấm công tháng <span
                        id="currentMonth">6</span></h4>
                <div class="table-responsive" style="max-width: 100%; overflow-x: auto;">
                    <table class="table table-striped" style="table-layout: fixed;">
                        <thead>
                            <tr>
                                <th style="width: 70px;">Ngày</th>
                                <th style="width: 55px;">Giờ vào</th>
                                <th style="width: 55px;">Giờ ra</th>
                                <th style="width: 40px;">Ca</th>
                                <th style="width: 36px;">Nghỉ</th>
                                <th style="width: 50px;">Đối ứng</th>
                                <th style="width: 60px;">Tổng giờ làm</th>
                                <th style="width: 50px;">Giờ công</th>
                                <th style="width: 50px;">Tăng ca<br />trước 22h</th>
                                <th style="width: 50px;">Tăng ca<br />sau 22h</th>
                                <th style="width: 80px;">Loại ngày</th>
                                <th style="width: 80px;">Trạng thái</th>
                                <th style="width: 120px;">Thao tác</th>
                                <th style="width: 120px;">Ghi chú</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceHistory">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <nav>
                    <ul class="pagination justify-content-center" id="attendancePagination"></ul>
                </nav>
            </div>

            <!-- Section: Lịch sử chấm công toàn bộ (chỉ ADMIN) -->
            <div class="attendance-history" id="allAttendanceHistorySection" style="display:none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4><i class="fas fa-history me-2"></i>Lịch sử chấm công đã phê duyệt</h4>
                    <button class="btn btn-secondary btn-sm" id="btnBackToDashboard">
                        <i class="fas fa-arrow-left me-2"></i>Trở về
                    </button>
                </div>
                <!-- Filter Section -->
                <div class="row mb-3">
                    <div class="col-auto">
                        <input type="text" id="allHistorySearchName" class="form-control form-control-sm"
                            placeholder="Tìm theo mã nhân viên...">
                    </div>
                    <div class="col-auto">
                        <select id="allHistoryDepartment" class="form-select form-select-sm">
                            <option value="">-- Phòng ban --</option>
                            <option value="BUD A">BUD A</option>
                            <option value="BUD B">BUD B</option>
                            <option value="BUD C">BUD C</option>
                            <option value="SCOPE">SCOPE</option>
                            <option value="KIRI">KIRI</option>
                            <option value="CREEK&RIVER">CREEK&RIVER</option>
                            <option value="COMO">COMO</option>
                            <option value="OFFICE">OFFICE</option>
                            <option value="YORK">YORK</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <input type="text" id="allHistoryDateFrom" class="form-control form-control-sm"
                            placeholder="Từ ngày">
                    </div>
                    <div class="col-auto">
                        <input type="text" id="allHistoryDateTo" class="form-control form-control-sm"
                            placeholder="Đến ngày">
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-primary btn-sm" id="btnAllHistoryFilter">Lọc</button>
                        <button class="btn btn-secondary btn-sm" id="btnAllHistoryReset">Đặt lại</button>
                    </div>
                </div>
                <!-- Bulk Export Section -->
                <div class="row mb-3" id="bulkExportSection" style="display: none;">
                    <div class="col-12">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-download me-2"></i>Xuất tăng ca hàng loạt</h6>
                            </div>
                            <div class="card-body">
                                <div class="row align-items-end">
                                    <div class="col-md-2">
                                        <label for="bulkExportType" class="form-label">Loại xuất</label>
                                        <select id="bulkExportType" class="form-select form-select-sm">
                                            <option value="month">Theo tháng</option>
                                            <option value="year">Theo năm</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2" id="monthSelection">
                                        <label for="bulkExportMonth" class="form-label">Tháng</label>
                                        <select id="bulkExportMonth" class="form-select form-select-sm">
                                            <option value="1">Tháng 1</option>
                                            <option value="2">Tháng 2</option>
                                            <option value="3">Tháng 3</option>
                                            <option value="4">Tháng 4</option>
                                            <option value="5">Tháng 5</option>
                                            <option value="6">Tháng 6</option>
                                            <option value="7">Tháng 7</option>
                                            <option value="8">Tháng 8</option>
                                            <option value="9">Tháng 9</option>
                                            <option value="10">Tháng 10</option>
                                            <option value="11">Tháng 11</option>
                                            <option value="12">Tháng 12</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label for="bulkExportYear" class="form-label">Năm</label>
                                        <select id="bulkExportYear" class="form-select form-select-sm">
                                            <!-- Will be populated by JavaScript -->
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-success btn-sm" id="btnBulkExport">
                                            <i class="fas fa-file-archive me-2"></i>Tải ZIP
                                        </button>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            <span id="bulkExportDescription">Xuất tất cả giấy tăng ca của tháng được
                                                chọn</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive" style="max-width: 100%; overflow-x: auto;">
                    <table class="table table-striped" style="table-layout: auto;">
                        <thead>
                            <tr>
                                <th style="width: 70px;">Ngày</th>
                                <th style="width: 55px;">Giờ vào</th>
                                <th style="width: 55px;">Giờ ra</th>
                                <th style="width: 36px;">Nghỉ</th>
                                <th style="width: 50px;">Đối ứng</th>
                                <th style="width: 60px;">Tổng giờ làm</th>
                                <th style="width: 50px;">Giờ công</th>
                                <th style="width: 50px;">Tăng ca<br />trước 22h</th>
                                <th style="width: 50px;">Tăng ca<br />sau 22h</th>
                                <th style="width: 80px;">Loại ngày</th>
                                <th style="width: 80px;">Nhân viên</th>
                                <th style="width: 80px;">Phòng ban</th>
                                <th style="width: 80px;">Trạng thái</th>
                                <th style="width: 100px;">Chữ ký</th>
                                <th style="width: 120px;">Thao tác</th>
                                <th style="width: 120px;">Ghi chú</th>
                            </tr>
                        </thead>
                        <tbody id="allAttendanceHistoryBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <nav>
                    <ul class="pagination justify-content-center" id="allAttendancePagination"></ul>
                </nav>
            </div>

            <!-- Approval Section - Hiển thị động theo vai trò -->
            <div class="attendance-history" id="approvalSection" style="display: none;">
                <h4 class="mb-4"><i class="fas fa-user-check me-2"></i>Phê duyệt chấm công</h4>
                <div class="filter-row row mb-3 g-3 align-items-end">
                    <div class="col-auto">
                        <div class="search-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="approvalSearchName" class="form-control modern-search"
                                placeholder="Tìm theo mã NV, tên...">
                        </div>
                    </div>
                    <div class="col-auto" id="departmentFilterContainer" style="display: none;">
                        <select id="approvalDepartment" class="form-select modern-select">
                            <option value="">🏢 Tất cả phòng ban</option>
                            <option value="BUD A">BUD A</option>
                            <option value="BUD B">BUD B</option>
                            <option value="BUD C">BUD C</option>
                            <option value="SCOPE">SCOPE</option>
                            <option value="KIRI">KIRI</option>
                            <option value="CREEK&RIVER">CREEK&RIVER</option>
                            <option value="COMO">COMO</option>
                            <option value="OFFICE">OFFICE</option>
                            <option value="YORK">YORK</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <input type="text" id="approvalDateFrom" class="form-control modern-date"
                            placeholder="📅 Từ ngày">
                    </div>
                    <div class="col-auto">
                        <input type="text" id="approvalDateTo" class="form-control modern-date"
                            placeholder="📅 Đến ngày">
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-primary btn-search" id="btnApprovalFilter">
                            <i class="fas fa-filter me-1"></i>Lọc
                        </button>
                        <button class="btn btn-outline-secondary" id="btnApprovalReset">
                            <i class="fas fa-redo me-1"></i>Đặt lại
                        </button>
                    </div>
                    <div class="col-auto" id="bulkApprovalContainer" style="display: none;">
                        <button class="btn btn-success" id="btnBulkApprove" title="Phê duyệt tất cả bản ghi đang chờ">
                            <i class="fas fa-check-double me-2"></i>Phê duyệt hết
                        </button>
                    </div>
                </div>
                <div class="table-responsive" style="max-width: 100%; overflow-x: auto;">
                    <table class="table table-striped" style="table-layout: fixed;">
                        <thead>
                            <tr>
                                <th style="width: 70px;">Ngày</th>
                                <th style="width: 55px;">Giờ vào</th>
                                <th style="width: 55px;">Giờ ra</th>
                                <th style="width: 36px;">Nghỉ</th>
                                <th style="width: 50px;">Đối ứng</th>
                                <th style="width: 60px;">Tổng giờ làm</th>
                                <th style="width: 50px;">Giờ công</th>
                                <th style="width: 50px;">Tăng ca<br />trước 22h</th>
                                <th style="width: 50px;">Tăng ca<br />sau 22h</th>
                                <th style="width: 80px;">Loại ngày</th>
                                <th style="width: 80px;">Nhân viên</th>
                                <th style="width: 80px;">Phòng ban</th>
                                <th style="width: 80px;">Trạng thái</th>
                                <th style="width: 100px;">Chữ ký</th>
                                <th style="width: 120px;">Thao tác</th>
                                <th style="width: 120px;">Ghi chú</th>
                            </tr>
                        </thead>
                        <tbody id="approvalAttendanceBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <nav>
                    <ul class="pagination justify-content-center" id="approvalPagination"></ul>
                </nav>

                <!-- Nút Test hiển thị chữ ký - chỉ hiển thị cho nhân viên -->
                <div class="mt-3 text-end" id="testSignatureButtonContainer" style="display: none;">
                    <button type="button" class="btn btn-info btn-sm" onclick="testSignatureDisplay()">
                        <i class="fas fa-vial me-2"></i>Test hiển thị chữ ký
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js?v=1.0.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11?v=1.0.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr?v=1.0.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/vn.js?v=1.0.2"></script>
    <!-- Custom Dashboard JS with cache busting -->
    <script src="{{ url_for('static', filename='js/dashboard.js') }}?v=20250107001"></script>
    <!-- Role Switch Optimizer for real-time updates -->
    <script src="{{ url_for('static', filename='js/role-switch-optimizer.js') }}?v=20250107002"></script>
    <!-- Smooth Transitions for better UX -->
    <script src="{{ url_for('static', filename='js/smooth-transitions.js') }}?v=20250107004"></script>
    <!-- Signature pad script for approval only -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>

    <!-- Embedded data for JS (avoids template braces inside JS code) -->
    <script id="has-signature-data" type="application/json">{{ (has_signature | default(false) | tojson) }}</script>
    <script>
        // Moon toggle functionality for overnight shift
        document.addEventListener('DOMContentLoaded', function () {
            const moonToggle = document.getElementById('moonToggle');
            const moonIcon = document.getElementById('moonIcon');
            const nextDayCheckout = document.getElementById('nextDayCheckout');

            if (moonToggle && moonIcon && nextDayCheckout) {
                // Force set vị trí mặt trăng
                moonToggle.style.top = '-4px';
                moonToggle.style.right = '-4px';

                moonToggle.addEventListener('click', function () {
                    const isActive = moonToggle.classList.contains('active');

                    if (isActive) {
                        // Turn off overnight mode
                        moonToggle.classList.remove('active');
                        nextDayCheckout.value = 'false';
                        console.log('🌙 Overnight mode: OFF');
                    } else {
                        // Turn on overnight mode
                        moonToggle.classList.add('active');
                        nextDayCheckout.value = 'true';
                        console.log('🌙 Overnight mode: ON');
                    }
                });

                // Add tooltip
                moonToggle.title = 'Bật/tắt chế độ tăng ca qua đêm';
            }
        });

        // Auto signature feature - no manual signature pad needed for registration
        // Signature will be automatically retrieved from database

        function clearSignature() {
            // This function is no longer needed but kept for compatibility
            console.log('Auto signature feature: clearSignature() called but not needed');
        }

        // Form submission is handled in dashboard.js to avoid conflicts

        // Function to show toast notification
        function showToast(message, type = 'success') {
            console.log('Showing toast:', message, type);  // Debug log
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer)
                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                }
            });

            let icon = type;
            if (type === 'success') icon = 'success';
            else if (type === 'error') icon = 'error';
            else if (type === 'warning') icon = 'warning';
            else if (type === 'info') icon = 'info';

            Toast.fire({
                icon: icon,
                title: message
            });
        }

        // Use the same variable names as dashboard.js to avoid conflicts
        let dashboardAttendanceData = [];
        let currentPage = 1;
        const rowsPerPage = 5;
        let approvalPage = 1;
        let approvalPerPage = 10;

        // Function to get overtime print button
        function getOvertimePrintButton(attendanceId, approved, isAdmin) {
            if (!approved || !isAdmin) return '';
            return `<a href="/admin/attendance/${attendanceId}/export-overtime-pdf" class="btn btn-outline-primary btn-sm ms-1"><i class="fas fa-print"></i> In giấy tăng ca</a>`;
        }

        function getOvertimeTestButton(attendanceId, approved, isAdmin) {
            if (!approved || !isAdmin) return '';
            return `<a href="/admin/attendance/${attendanceId}/test-signature-pdf" class="btn btn-outline-info btn-sm ms-1"><i class="fas fa-vial"></i> Test chữ ký</a>`;
        }

        function renderAttendancePage(page) {
            console.log('🎨 Rendering attendance page:', page);
            const tbody = document.getElementById('attendanceHistory');
            if (!tbody) {
                console.log('❌ attendanceHistory element not found, skipping render');
                return;
            }

            // Lấy vai trò hiện tại để kiểm tra quyền admin
            const roleSelect = document.getElementById('role-select');
            const isAdmin = roleSelect ? roleSelect.value === 'ADMIN' : false;

            console.log('📊 Data for rendering:', {
                dataLength: dashboardAttendanceData?.length || 0,
                isAdmin: isAdmin,
                page: page
            });

            tbody.innerHTML = '';

            // Đảm bảo bảng hiển thị đúng cấu trúc
            if (tbody.parentElement) {
                tbody.parentElement.classList.add('attendance-table');
            }

            if (!dashboardAttendanceData || dashboardAttendanceData.length === 0) {
                const totalRows = rowsPerPage;
                const middleRow = Math.floor(totalRows / 2);
                for (let i = 0; i < totalRows; i++) {
                    const row = document.createElement('tr');
                    row.style.height = '50px';
                    row.className = 'empty-row';
                    if (i === middleRow) {
                        row.innerHTML = `<td colspan="14" class="no-data-row">Không có dữ liệu chấm công</td>`;
                    } else {
                        row.innerHTML = `
                            <td style="height: 50px; width: 70px;"></td>
                            <td style="height: 50px; width: 55px;"></td>
                            <td style="height: 50px; width: 55px;"></td>
                            <td style="height: 50px; width: 40px;"></td>
                            <td style="height: 50px; width: 36px;"></td>
                            <td style="height: 50px; width: 50px;"></td>
                            <td style="height: 50px; width: 60px;"></td>
                            <td style="height: 50px; width: 50px;"></td>
                            <td style="height: 50px; width: 50px;"></td>
                            <td style="height: 50px; width: 50px;"></td>
                            <td style="height: 50px; width: 80px;"></td>
                            <td style="height: 50px; width: 80px;"></td>
                            <td style="height: 50px; width: 120px;"></td>
                            <td style="height: 50px; width: 120px;" class="note-cell"></td>
                        `;
                    }
                    tbody.appendChild(row);
                }
                return;
            }

            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = dashboardAttendanceData.slice(start, end);

            // Tính số dòng trống cần thêm để đạt đủ 5 dòng
            const emptyRowsNeeded = Math.max(0, rowsPerPage - pageData.length);

            pageData.forEach(record => {
                const row = document.createElement('tr');
                row.style.height = '50px'; // Set fixed height for all rows
                let statusText = record.approved ? 'Đã phê duyệt' : 'Chờ phê duyệt';

                // Xử lý hiển thị loại ngày
                let holidayTypeText = translateHolidayType(record.holiday_type);

                // Xác định class cho trạng thái
                let statusClass = record.approved ? 'status-approved' : 'status-pending';
                if (record.status === 'rejected') {
                    statusText = 'Từ chối';
                    statusClass = 'status-rejected';
                }

                // Xử lý hiển thị thông tin ca
                let shiftText = '-';
                if (record.shift_code) {
                    switch (record.shift_code) {
                        case '1':
                            shiftText = 'Ca 1';
                            break;
                        case '2':
                            shiftText = 'Ca 2';
                            break;
                        case '3':
                            shiftText = 'Ca 3';
                            break;
                        case '4':
                            shiftText = 'Ca 4';
                            break;
                        case '5':
                            shiftText = 'Ca 5';
                            break;
                        default:
                            shiftText = `Ca ${record.shift_code}`;
                    }
                }

                row.innerHTML = `
                    <td style="height: 50px; width: 70px;">${formatDate(record.date)}</td>
                    <td style="height: 50px; width: 55px;">${record.check_in || '--:--'}</td>
                    <td style="height: 50px; width: 55px;">${record.check_out || '--:--'}</td>
                    <td style="height: 50px; width: 40px;">${shiftText}</td>
                    <td style="height: 50px; width: 36px;">${formatHourMinute(record.break_time) || '-'}</td>
                    <td style="height: 50px; width: 50px;">${formatHourMinute(calculateTotalCompTime(record)) || '-'}</td>
                    <td style="height: 50px; width: 60px;">${record.total_work_hours || '-'}</td>
                    <td style="height: 50px; width: 50px;">${record.work_hours_display || '-'}</td>
                    <td style="height: 50px; width: 50px;">${record.overtime_before_22 && record.overtime_before_22 !== 'NaN:NaN' ? record.overtime_before_22 : '0:00'}</td>
                    <td style="height: 50px; width: 50px;" title="${record.overtime_after_22 && record.overtime_after_22 !== 'NaN:NaN' ? `Giá trị gốc: ${record.overtime_after_22}` : '0 giờ'}">${record.overtime_after_22 && record.overtime_after_22 !== 'NaN:NaN' ? record.overtime_after_22 : '0:00'}</td>
                    <td style="height: 50px; width: 80px;">${holidayTypeText}</td>
                    <td style="height: 50px; width: 80px;">
                        <span class="${statusClass}">${statusText}</span>
                    </td>
                    <td style="height: 50px; width: 120px; padding: 0 !important;">
                        <div class="action-container">
                        ${!record.approved ? `
                            <div class="btn-action-container">
                                <button class='btn btn-warning btn-sm edit-attendance-btn' data-id='${record.id}'>
                                    <i class='fas fa-edit me-1'></i>Sửa
                                </button>
                                <button class='btn btn-danger btn-sm delete-attendance-btn' data-id='${record.id}'>
                                    <i class='fas fa-trash me-1'></i>Xóa
                                </button>
                            </div>
                        ` : `
                            <div class="btn-action-container">
                                ${getOvertimePrintButton(record.id, record.approved, isAdmin)}
                                ${getOvertimeTestButton(record.id, record.approved, isAdmin)}
                            </div>
                        `}
                        </div>
                    </td>
                    <td style="height: 50px;" class="note-cell" data-full-note="${record.note || ''}">
                        ${record.note || '-'}
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Thêm các dòng trống nếu cần để đủ 5 dòng
            for (let i = 0; i < emptyRowsNeeded; i++) {
                const emptyRow = document.createElement('tr');
                emptyRow.className = 'empty-row';
                emptyRow.innerHTML = `
                    <td style="height: 50px; width: 70px;"></td>
                    <td style="height: 50px; width: 55px;"></td>
                    <td style="height: 50px; width: 55px;"></td>
                    <td style="height: 50px; width: 40px;"></td>
                    <td style="height: 50px; width: 36px;"></td>
                    <td style="height: 50px; width: 50px;"></td>
                    <td style="height: 50px; width: 60px;"></td>
                    <td style="height: 50px; width: 50px;"></td>
                    <td style="height: 50px; width: 50px;"></td>
                    <td style="height: 50px; width: 50px;"></td>
                    <td style="height: 50px; width: 80px;"></td>
                    <td style="height: 50px; width: 80px;"></td>
                    <td style="height: 50px; width: 120px;"></td>
                    <td style="height: 50px; width: 120px;" class="note-cell"></td>
                `;
                tbody.appendChild(emptyRow);
            }

            // Gắn lại sự kiện cho nút sửa và xóa
            document.querySelectorAll('.edit-attendance-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    handleEditAttendance(this.getAttribute('data-id'));
                });
            });

            document.querySelectorAll('.delete-attendance-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    const id = this.getAttribute('data-id');
                    Swal.fire({
                        title: 'Xác nhận xóa',
                        text: 'Bạn có chắc chắn muốn xóa bản ghi chấm công này?',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Xóa',
                        cancelButtonText: 'Hủy'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            deleteAttendance(id);
                        }
                    });
                });
            });

            // Gán sự kiện click cho note-cell
            bindNoteCellClick();
        }

        function renderAttendancePagination() {
            const totalPages = Math.ceil(dashboardAttendanceData.length / rowsPerPage);
            const pagination = document.getElementById('attendancePagination');
            if (!pagination) {
                console.log('attendancePagination element not found, skipping pagination render');
                return;
            }

            pagination.innerHTML = '';
            function createPageItem(i, active = false) {
                const li = document.createElement('li');
                li.className = 'page-item' + (active ? ' active' : '');
                const a = document.createElement('a');
                a.className = 'page-link';
                a.href = '#';
                a.textContent = i;
                a.addEventListener('click', function (e) {
                    e.preventDefault();
                    currentPage = i;
                    renderAttendancePage(currentPage);
                    renderAttendancePagination();
                });
                li.appendChild(a);
                pagination.appendChild(li);
            }
            if (totalPages <= 7) {
                for (let i = 1; i <= totalPages; i++) createPageItem(i, i === currentPage);
            } else {
                createPageItem(1, currentPage === 1);
                if (currentPage > 4) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(li);
                }
                for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) {
                    createPageItem(i, i === currentPage);
                }
                if (currentPage < totalPages - 3) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(li);
                }
                createPageItem(totalPages, currentPage === totalPages);
            }
        }

        // Biến để tránh gọi API trùng lặp
        let isUpdatingAttendance = false;
        let lastUpdateTime = 0;
        const UPDATE_THROTTLE_MS = 1000; // Chỉ cho phép gọi API mỗi 1 giây

        function updateAttendanceHistory() {
            // Kiểm tra xem có đang update không và thời gian từ lần update cuối
            const now = Date.now();
            if (isUpdatingAttendance || (now - lastUpdateTime) < UPDATE_THROTTLE_MS) {
                console.log('Skipping duplicate updateAttendanceHistory call');
                return;
            }

            console.log('🔄 Fetching attendance history...');  // Debug log

            // Kiểm tra xem element attendanceHistory có tồn tại và hiển thị không
            const attendanceHistoryElement = document.getElementById('attendanceHistory');
            const attendanceHistorySection = document.getElementById('attendanceHistorySection');

            console.log('🔍 Element check:', {
                attendanceHistoryElement: !!attendanceHistoryElement,
                attendanceHistorySection: !!attendanceHistorySection,
                sectionDisplay: attendanceHistorySection ? attendanceHistorySection.style.display : 'not found'
            });

            if (!attendanceHistoryElement) {
                console.log('❌ attendanceHistory element not found, skipping update');
                return;
            }

            // Kiểm tra xem section có được hiển thị không
            if (attendanceHistorySection && attendanceHistorySection.style.display === 'none') {
                console.log('❌ attendanceHistorySection is hidden, skipping update');
                return;
            }

            // Đánh dấu đang update
            isUpdatingAttendance = true;
            lastUpdateTime = Date.now();

            // Lấy tháng và năm hiện tại
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth() + 1; // Tháng trong JS bắt đầu từ 0
            const currentYear = currentDate.getFullYear();

            fetch(`/api/attendance/history?month=${currentMonth}&year=${currentYear}`)
                .then(response => {
                    console.log('📡 Response status:', response.status);  // Debug log
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('📊 Received data:', data);  // Debug log
                    if (data.error) {
                        console.error('❌ API Error:', data.error);
                        showToast(data.error, 'error');
                        return;
                    }
                    dashboardAttendanceData = data;
                    console.log('✅ Data processed, length:', dashboardAttendanceData?.length || 0);
                    // Giữ nguyên trang hiện tại nếu còn hợp lệ
                    const totalPages = Math.max(1, Math.ceil((dashboardAttendanceData?.length || 0) / (rowsPerPage || 5)));
                    if (!currentPage || currentPage < 1) currentPage = 1;
                    if (currentPage > totalPages) currentPage = totalPages;
                    console.log('📄 Rendering page:', currentPage, 'of', totalPages);
                    renderAttendancePage(currentPage);
                    renderAttendancePagination();
                })
                .catch(error => {
                    console.error('❌ Error fetching attendance history:', error);
                    showToast('Không thể tải lịch sử chấm công. Vui lòng thử lại sau.', 'error');
                })
                .finally(() => {
                    // Đánh dấu đã update xong
                    isUpdatingAttendance = false;
                });
        }

        // Function to handle edit attendance - moved to dashboard.js to avoid conflicts

        // Function to format date for display (DD/MM/YYYY) - moved to dashboard.js to avoid conflicts

        // Function to format time for input - moved to dashboard.js to avoid conflicts

        // Event listeners - Đã được xử lý trong dashboard.js
        // document.getElementById('saveAttendanceBtn')?.addEventListener('click', handleAttendanceSubmit);
        // document.getElementById('cancelEditBtn')?.addEventListener('click', resetForm);

        // Xử lý sự kiện khi chọn ca làm việc
        document.getElementById('shiftSelect')?.addEventListener('change', function () {
            const shiftValue = this.value;

            if (shiftValue === '1') {
                // Ca 1: 7:30 - 16:30
                document.getElementById('checkInTime').value = '07:30';
                document.getElementById('checkOutTime').value = '16:30';
            }
            else if (shiftValue === '2') {
                // Ca 2: 9:00 - 18:00
                document.getElementById('checkInTime').value = '09:00';
                document.getElementById('checkOutTime').value = '18:00';
            }
            else if (shiftValue === '3') {
                // Ca 3: 11:00 - 20:00
                document.getElementById('checkInTime').value = '11:00';
                document.getElementById('checkOutTime').value = '20:00';
            }
            else if (shiftValue === '4') {
                // Ca 4: 8:00 - 17:00
                document.getElementById('checkInTime').value = '08:00';
                document.getElementById('checkOutTime').value = '17:00';
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM loaded - initializing...');

            // Đợi một chút để đảm bảo DOM được render hoàn toàn
            setTimeout(function () {
                // Lấy vai trò hiện tại
                const roleSelect = document.getElementById('role-select');
                const currentRole = roleSelect ? roleSelect.value : 'EMPLOYEE';
                console.log('DEBUG JS: roleSelect.value =', roleSelect ? roleSelect.value : 'null');
                console.log('DEBUG JS: currentRole =', currentRole);

                // Cập nhật giao diện theo vai trò hiện tại
                console.log('🚀 Initial role setup - currentRole:', currentRole);
                updateUIForRole(currentRole);

                // Cập nhật số lượng đơn nghỉ phép cần phê duyệt nếu là quản lý
                if (['TEAM_LEADER', 'MANAGER', 'ADMIN'].includes(currentRole)) {
                    updatePendingLeaveCount();
                }

                // Handler cho nút phê duyệt hàng loạt
                const btnBulkApprove = document.getElementById('btnBulkApprove');
                if (btnBulkApprove) {
                    btnBulkApprove.addEventListener('click', async function () {
                        const currentRole = document.getElementById('role-select')?.value || 'EMPLOYEE';

                        // Kiểm tra token nếu là ADMIN
                        if (currentRole === 'ADMIN' && tokenStatus && !tokenStatus.valid) {
                            Swal.fire({
                                title: '⚠️ Token Google API hết hạn',
                                html: `
                                <div style="text-align: center;">
                                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #e74c3c; margin-bottom: 1rem;"></i>
                                    <p style="font-size: 1.1rem; margin-bottom: 1rem; color: #2c3e50;">
                                        <strong>Token Google API đã hết hạn!</strong>
                                    </p>
                                    <p style="font-size: 1rem; margin-bottom: 1rem; color: #34495e;">
                                        ${tokenStatus.message || 'Vui lòng refresh token trước khi phê duyệt.'}
                                    </p>
                                </div>
                            `,
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonText: 'Refresh Token',
                                cancelButtonText: 'Hủy',
                                confirmButtonColor: '#3498db'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    refreshToken();
                                }
                            });
                            return;
                        }

                        // Xác nhận phê duyệt hàng loạt
                        const { isConfirmed } = await Swal.fire({
                            title: 'Xác nhận phê duyệt hàng loạt',
                            text: 'Bạn có chắc chắn muốn phê duyệt tất cả các bản ghi đang chờ?',
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonText: 'Phê duyệt',
                            cancelButtonText: 'Hủy',
                            confirmButtonColor: '#28a745'
                        });

                        if (!isConfirmed) return;

                        // Gọi API phê duyệt hàng loạt
                        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                        Swal.fire({
                            title: 'Đang xử lý...',
                            html: '<i class="fas fa-spinner fa-spin me-2"></i>Đang phê duyệt hàng loạt',
                            allowOutsideClick: false,
                            allowEscapeKey: false,
                            showConfirmButton: false
                        });

                        try {
                            const response = await fetch('/api/attendance/approve-all', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': csrfToken
                                },
                                body: JSON.stringify({ action: 'approve' })
                            });

                            const data = await response.json();
                            Swal.close();

                            if (data.error) {
                                if (data.error_code === 'token_expired') {
                                    Swal.fire({
                                        title: '⚠️ Token Google API hết hạn',
                                        html: `
                                        <div style="text-align: center;">
                                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #e74c3c; margin-bottom: 1rem;"></i>
                                            <p style="font-size: 1.1rem; margin-bottom: 1rem; color: #2c3e50;">
                                                <strong>Token Google API đã hết hạn!</strong>
                                            </p>
                                            <p style="font-size: 1rem; margin-bottom: 1rem; color: #34495e;">
                                                ${data.error}
                                            </p>
                                        </div>
                                    `,
                                        icon: 'warning',
                                        showCancelButton: true,
                                        confirmButtonText: 'Refresh Token',
                                        cancelButtonText: 'Hủy',
                                        confirmButtonColor: '#3498db'
                                    }).then((result) => {
                                        if (result.isConfirmed) {
                                            refreshToken();
                                        }
                                    });
                                } else {
                                    showToast(data.error, 'error');
                                }
                            } else {
                                showToast(data.message || 'Phê duyệt hàng loạt thành công!', 'success');
                                loadApprovalAttendance();
                            }
                        } catch (error) {
                            console.error('Error in bulk approval:', error);
                            Swal.close();
                            showToast('Đã xảy ra lỗi khi phê duyệt hàng loạt', 'error');
                        }
                    });
                }

                // Cập nhật tháng hiện tại trong tiêu đề
                const currentMonthElement = document.getElementById('currentMonth');
                if (currentMonthElement) {
                    const currentMonth = new Date().getMonth() + 1; // Tháng trong JS bắt đầu từ 0
                    currentMonthElement.textContent = currentMonth;
                }

                // Đảm bảo nút hủy sửa luôn ẩn khi mới load trang
                const cancelEditBtn = document.getElementById('cancelEditBtn');
                if (cancelEditBtn) {
                    cancelEditBtn.style.cssText = "display: none !important;";
                }

                const dateInput = document.getElementById('attendanceDate');

                // Khởi tạo flatpickr cho input ngày với định dạng Việt Nam
                if (dateInput) {
                    // Hàm xác định loại ngày (tách ra để tái sử dụng)
                    async function determineDayType(dateStr) {
                        if (!dateStr) return;
                        
                        try {
                            const url = `/api/get-day-type?date=${dateStr}`;
                            console.log(`🔍 Gọi API: ${url}`);
                            
                            const response = await fetch(url, {
                                method: 'GET',
                                headers: {
                                    'Accept': 'application/json',
                                    'Content-Type': 'application/json'
                                },
                                credentials: 'same-origin'
                            });
                            
                            console.log(`📡 Response status: ${response.status}, Content-Type: ${response.headers.get('content-type')}`);
                            
                            // Kiểm tra content-type để đảm bảo là JSON
                            const contentType = response.headers.get('content-type');
                            if (!contentType || !contentType.includes('application/json')) {
                                // Thử đọc response text để debug
                                const text = await response.text();
                                console.warn('⚠️ API trả về không phải JSON:', {
                                    status: response.status,
                                    contentType: contentType,
                                    responsePreview: text.substring(0, 200)
                                });
                                return;
                            }
                            
                            if (response.ok) {
                                const data = await response.json();
                                console.log('✅ API response:', data);
                                const dayTypeSelect = document.getElementById('dayType');
                                if (dayTypeSelect && data.day_type) {
                                    dayTypeSelect.value = data.day_type;
                                    // Trigger change event để cập nhật UI
                                    dayTypeSelect.dispatchEvent(new Event('change', { bubbles: true }));
                                    
                                    // Hiển thị thông báo nếu có
                                    if (data.reason) {
                                        const reasonText = data.holiday_name 
                                            ? `${data.reason}: ${data.holiday_name}` 
                                            : data.reason;
                                        console.log(`✅ Đã tự động chọn loại ngày: ${reasonText}`);
                                    }
                                }
                            } else {
                                // Xử lý lỗi từ server
                                try {
                                    const errorData = await response.json();
                                    console.warn('⚠️ Lỗi khi lấy loại ngày:', response.status, errorData);
                                } catch (e) {
                                    const text = await response.text();
                                    console.warn('⚠️ Lỗi khi lấy loại ngày (không phải JSON):', response.status, text.substring(0, 200));
                                }
                            }
                        } catch (error) {
                            console.error('❌ Lỗi khi lấy loại ngày:', error);
                        }
                    }
                    
                    const flatpickrInstance = flatpickr("#attendanceDate", {
                        dateFormat: "Y-m-d", // Format backend cần
                        locale: "vn",
                        allowInput: false, // Ngăn người dùng nhập tay
                        altInput: true,
                        altFormat: "d/m/Y",
                        placeholder: "Chọn ngày...",
                        defaultDate: new Date(), // <-- tự động set ngày hôm nay
                        onChange: async function (selectedDates, dateStr, instance) {
                            if (dateStr === '') {
                                instance.input.placeholder = 'Chọn ngày...';
                                return;
                            }
                            
                            // Tự động xác định loại ngày khi chọn ngày
                            await determineDayType(dateStr);
                        }
                    });
                    
                    // Tự động xác định loại ngày cho ngày mặc định (hôm nay)
                    // Sử dụng setTimeout để đảm bảo flatpickr đã khởi tạo xong
                    setTimeout(() => {
                        if (flatpickrInstance.selectedDates.length > 0) {
                            const today = flatpickrInstance.selectedDates[0];
                            const todayStr = flatpickrInstance.formatDate(today, 'Y-m-d');
                            // Gọi hàm xác định loại ngày
                            determineDayType(todayStr);
                        }
                    }, 100);
                }

                // Khởi tạo flatpickr cho các ô lọc ngày trong phần phê duyệt
                flatpickr("#approvalDateFrom", {
                    altInput: true,
                    altFormat: "d/m/Y",
                    dateFormat: "Y-m-d",
                    locale: "vn",
                    placeholder: "Từ ngày"
                });

                flatpickr("#approvalDateTo", {
                    altInput: true,
                    altFormat: "d/m/Y",
                    dateFormat: "Y-m-d",
                    locale: "vn",
                    placeholder: "Đến ngày"
                });

                // Khởi tạo flatpickr cho các ô lọc ngày trong phần lịch sử chấm công đã phê duyệt
                flatpickr("#allHistoryDateFrom", {
                    altInput: true,
                    altFormat: "d/m/Y",
                    dateFormat: "Y-m-d",
                    locale: "vn",
                    placeholder: "Từ ngày"
                });

                flatpickr("#allHistoryDateTo", {
                    altInput: true,
                    altFormat: "d/m/Y",
                    dateFormat: "Y-m-d",
                    locale: "vn",
                    placeholder: "Đến ngày"
                });

                // Initial load of attendance history (chỉ khi là nhân viên)
                if (currentRole === 'EMPLOYEE') {
                    console.log('🚀 Initial load for EMPLOYEE role');
                    // Đợi một chút để đảm bảo DOM được render hoàn toàn
                    setTimeout(() => {
                        console.log('🔄 Initial load timeout triggered');
                        const attendanceHistoryElement = document.getElementById('attendanceHistory');
                        if (attendanceHistoryElement) {
                            console.log('✅ Initial load: attendanceHistory element found');
                            // Chỉ gọi API nếu chưa có dữ liệu
                            if (!dashboardAttendanceData || dashboardAttendanceData.length === 0) {
                                console.log('📡 Initial load: calling updateAttendanceHistory()');
                                updateAttendanceHistory();
                            } else {
                                console.log('📊 Initial load: data already exists');
                            }
                        } else {
                            console.log('❌ Initial load: attendanceHistory element not found');
                            // Force reload after another delay
                            setTimeout(() => {
                                console.log('🔄 Force reload attempt');
                                updateAttendanceHistory();
                            }, 200);
                        }
                    }, 150); // Tăng thời gian chờ để đảm bảo DOM được cập nhật
                }

                // Setup form event listeners
                if (typeof setupFormEventListeners === 'function') {
                    setupFormEventListeners();
                }

                // Đảm bảo "Loại đối ứng" luôn mặc định là "-- chọn loại đối ứng --"
                const compTimeTypeSelect = document.getElementById('compTimeType');
                if (compTimeTypeSelect) {
                    compTimeTypeSelect.value = '';
                }

                // Initialize tooltips
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });

                if (roleSelect) {
                    roleSelect.addEventListener('change', function (e) {
                        // Disable select during role switch to prevent rapid changes
                        roleSelect.disabled = true;

                        // Use optimized role switch
                        if (typeof window.roleSwitchOptimizer !== 'undefined') {
                            window.roleSwitchOptimizer.switchRole(e.target.value);
                        } else {
                            switchRole(e.target.value);
                        }

                        // Re-enable select after optimized delay
                        setTimeout(() => {
                            roleSelect.disabled = false;
                        }, 1200); // Reduced from 2000ms to 1200ms for better UX
                    });
                }

                // Khởi tạo năm cho filter
                const yearSelect = document.getElementById('filterYear');
                if (yearSelect) {
                    // Thêm tùy chọn placeholder
                    const placeholder = document.createElement('option');
                    placeholder.value = '';
                    placeholder.textContent = '-- Năm --';
                    yearSelect.appendChild(placeholder);

                    const currentYear = new Date().getFullYear();
                    for (let year = currentYear; year >= currentYear - 5; year--) {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        yearSelect.appendChild(option);
                    }
                }
            }, 100); // Đợi 100ms để đảm bảo DOM được render hoàn toàn
        });
        // Function to delete attendance
        function deleteAttendance(id) {
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
            fetch(`/api/attendance/${id}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
                .then(response => {
                    const contentType = response.headers.get('content-type') || '';
                    if (contentType.includes('application/json')) {
                        return response.json();
                    } else {
                        return response.text().then(text => { throw new Error('Server trả về dữ liệu không phải JSON: ' + text); });
                    }
                })
                .then(data => {
                    if (data.error) {
                        showToast(data.error, 'error');
                    } else {
                        showToast('Đã xóa thành công!', 'success');
                        // Chỉ cập nhật nếu đang ở trang lịch sử chấm công
                        const currentRole = document.getElementById('role-select')?.value || 'EMPLOYEE';
                        if (currentRole === 'EMPLOYEE') {
                            updateAttendanceHistory();
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Lỗi server khi xóa! ' + error.message, 'error');
                });
        }

        function bindNoteCellClick() {
            document.querySelectorAll('.note-cell').forEach(function (cell) {
                cell.addEventListener('click', function (e) {
                    const note = this.dataset.fullNote;
                    if (note && note.trim() !== '') {
                        Swal.fire({
                            title: 'Ghi chú',
                            html: `<div style='text-align:left;max-width:400px;word-break:break-word;'>${note}</div>`,
                            confirmButtonText: 'Đóng',
                            width: 500
                        });
                    }
                });
            });
        }

        // Ẩn toast lỗi khi người dùng bắt đầu nhập lại giờ vào/ra
        document.getElementById('checkInTime')?.addEventListener('input', function () {
            Swal.close(); // Đóng toast nếu đang hiển thị
        });
        document.getElementById('checkOutTime')?.addEventListener('input', function () {
            Swal.close(); // Đóng toast nếu đang hiển thị
        });

        // Sự kiện bấm vào menu Lịch sử chấm công
        document.getElementById('attendanceHistoryMenu')?.addEventListener('click', function (e) {
            e.preventDefault();
            const roleSelect = document.getElementById('role-select');
            const currentRole = roleSelect ? roleSelect.value : 'EMPLOYEE';

            // Chỉ ADMIN mới có thể xem lịch sử toàn bộ
            if (currentRole === 'ADMIN') {
                // Ẩn các section khác và chỉ hiển thị lịch sử toàn bộ
                const attendanceFormSection = document.getElementById('attendanceFormSection');
                const attendanceHistorySection = document.getElementById('attendanceHistorySection');
                const approvalSection = document.getElementById('approvalSection');
                const allAttendanceHistorySection = document.getElementById('allAttendanceHistorySection');

                if (attendanceFormSection) attendanceFormSection.style.display = 'none';
                if (attendanceHistorySection) attendanceHistorySection.style.display = 'none';
                if (approvalSection) approvalSection.style.display = 'none';
                if (allAttendanceHistorySection) allAttendanceHistorySection.style.display = 'block';

                // Mặc định là tháng và năm hiện tại khi vào
                const filterMonth = document.getElementById('filterMonth');
                const filterYear = document.getElementById('filterYear');
                const filterDate = new Date();

                if (filterMonth) filterMonth.value = filterDate.getMonth() + 1;
                if (filterYear) filterYear.value = filterDate.getFullYear();

                loadAllAttendanceHistory();
            } else {
                showToast('Chỉ quản trị viên mới có thể xem lịch sử chấm công đã phê duyệt', 'warning');
            }
        });

        // Sự kiện bấm vào menu Trang chủ
        document.getElementById('homeMenu')?.addEventListener('click', function (e) {
            e.preventDefault();
            const roleSelect = document.getElementById('role-select');
            const currentRole = roleSelect ? roleSelect.value : 'EMPLOYEE';

            // Load lại dashboard theo vai trò hiện tại
            updateUIForRole(currentRole);

            // Reset form nếu đang ở chế độ edit
            const editIdInput = document.getElementById('editAttendanceId');
            if (editIdInput && editIdInput.value) {
                resetForm();
            }

            // Cập nhật active state cho menu
            const menuItems = document.querySelectorAll('.nav-link');
            menuItems.forEach(item => {
                item.classList.remove('active');
            });
            this.classList.add('active');

            showToast('Đã tải lại trang chủ', 'success');
        });

        // Phân trang cho lịch sử toàn bộ (chỉ ADMIN)
        let allAttendanceData = [];
        let allCurrentPage = 1;
        const allRowsPerPage = 10;

        // Function tính tổng thời gian đối ứng - LOGIC MỚI: CỘNG TẤT CẢ CÁC LOẠI ĐỐI ỨNG
        function calculateTotalCompTime(record) {
            // Debug: Log dữ liệu đầu vào - SỬ DỤNG CỘT MINUTES MỚI
            console.log('🔍 DEBUG calculateTotalCompTime - Input record:', {
                comp_time_regular: record.comp_time_regular,
                comp_time_overtime: record.comp_time_overtime,
                comp_time_ot_before_22: record.comp_time_ot_before_22,
                comp_time_ot_after_22: record.comp_time_ot_after_22
            });

            // Cộng tất cả đối ứng theo PHÚT để tránh số thập phân
            function parseTimeToMinutes(v) {
                if (!v || v === '0:00' || v === 'NaN:NaN') return 0;
                if (typeof v === 'string' && v.includes(':')) {
                    const [h, m] = v.split(':').map(Number);
                    return (isNaN(h) ? 0 : h) * 60 + (isNaN(m) ? 0 : m);
                }
                const f = parseFloat(v);
                return isNaN(f) ? 0 : Math.round(f * 60);
            }
            function minutesToHHMM(mins) {
                const m = Math.max(0, Math.round(mins || 0));
                const h = Math.floor(m / 60);
                const mm = m % 60;
                return `${h}:${String(mm).padStart(2, '0')}`;
            }
            const totalMinutes =
                parseTimeToMinutes(record.comp_time_regular) +
                parseTimeToMinutes(record.comp_time_overtime) +
                parseTimeToMinutes(record.comp_time_ot_before_22) +
                parseTimeToMinutes(record.comp_time_ot_after_22);
            console.log('🔍 DEBUG calculateTotalCompTime - Total minutes:', totalMinutes, '=>', minutesToHHMM(totalMinutes));
            return minutesToHHMM(totalMinutes);
        }

        function loadAllAttendanceHistory(page = 1) {
            const tbody = document.getElementById('allAttendanceHistoryBody');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="16">Đang tải dữ liệu...</td></tr>';

            // Lấy các filter
            const search = document.getElementById('allHistorySearchName')?.value || '';
            const department = document.getElementById('allHistoryDepartment')?.value || '';
            const dateFrom = document.getElementById('allHistoryDateFrom')?.value || '';
            const dateTo = document.getElementById('allHistoryDateTo')?.value || '';

            let url = `/api/attendance/history?all=1&page=${page}&per_page=10`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (department) url += `&department=${encodeURIComponent(department)}`;
            if (dateFrom) url += `&date_from=${encodeURIComponent(dateFrom)}`;
            if (dateTo) url += `&date_to=${encodeURIComponent(dateTo)}`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data.data && data.data.length > 0) {
                        tbody.innerHTML = '';
                        data.data.forEach(record => {
                            // Debug logging để kiểm tra dữ liệu
                            console.log('Debug - Processing record:', record);
                            console.log('Debug - Comp time fields:', {
                                comp_time_regular: record.comp_time_regular,
                                comp_time_overtime: record.comp_time_overtime,
                                comp_time_ot_before_22: record.comp_time_ot_before_22,
                                comp_time_ot_after_22: record.comp_time_ot_after_22
                            });

                            const totalCompTime = calculateTotalCompTime(record);
                            console.log('Debug - Total comp time for display:', totalCompTime);

                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${formatDate(record.date) || '-'}</td>
                                <td>${record.check_in || '--:--'}</td>
                                <td>${record.check_out || '--:--'}</td>
                                <td>${formatHourMinute(record.break_time) || '-'}</td>
                                <td>${formatHourMinute(totalCompTime) || '-'}</td>
                                <td>${record.total_work_hours || '-'}</td>
                                <td>${record.work_hours_display || '-'}</td>
                                <td>${record.overtime_before_22 || '-'}</td>
                                <td>${record.overtime_after_22 || '-'}</td>
                                <td>${translateHolidayType(record.holiday_type)}</td>
                                <td>${record.user_name || '-'}</td>
                                <td>${record.department || '-'}</td>
                                <td>${translateStatus(record.status) || '-'}</td>
                                <td>${record.signature ? '<i class="fas fa-check text-success"></i> Có' : '<i class="fas fa-times text-muted"></i> Không'}</td>
                                <td><a href="/admin/attendance/${record.id}/export-overtime-pdf" class="btn btn-outline-primary btn-sm ms-1"><i class="fas fa-print"></i> In giấy tăng ca</a></td>
                                <td>${record.note || '-'}</td>
                            `;
                            tbody.appendChild(row);
                        });

                        // Cập nhật phân trang
                        if (data.total && data.total > 0) {
                            const totalPages = Math.ceil(data.total / 10);
                            renderAllAttendancePagination(page, totalPages);
                        }
                    } else {
                        tbody.innerHTML = '<tr><td colspan="16" class="no-data-row">Không có dữ liệu chấm công đã phê duyệt</td></tr>';
                        renderAllAttendancePagination(1, 1);
                    }
                })
                .catch(() => {
                    tbody.innerHTML = '<tr><td colspan="16" class="no-data-row">Lỗi tải dữ liệu</td></tr>';
                });
        }

        function renderAllAttendancePagination(currentPage, totalPages) {
            const pagination = document.getElementById('allAttendancePagination');
            pagination.innerHTML = '';

            function createPageItem(i, active = false) {
                const li = document.createElement('li');
                li.className = 'page-item' + (active ? ' active' : '');
                const a = document.createElement('a');
                a.className = 'page-link';
                a.href = '#';
                a.textContent = i;
                a.addEventListener('click', function (e) {
                    e.preventDefault();
                    allCurrentPage = i;
                    loadAllAttendanceHistory(allCurrentPage);
                });
                li.appendChild(a);
                pagination.appendChild(li);
            }

            if (totalPages <= 7) {
                for (let i = 1; i <= totalPages; i++) createPageItem(i, i === currentPage);
            } else {
                createPageItem(1, currentPage === 1);
                if (currentPage > 4) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(li);
                }
                for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) {
                    createPageItem(i, i === currentPage);
                }
                if (currentPage < totalPages - 3) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(li);
                }
                createPageItem(totalPages, currentPage === totalPages);
            }
        }

        function renderAllAttendancePage(pageData) {
            const tbody = document.getElementById('allAttendanceHistoryBody');
            tbody.innerHTML = '';
            if (!pageData || pageData.length === 0) {
                const totalRows = allRowsPerPage;
                const middleRow = Math.floor(totalRows / 2);
                for (let i = 0; i < totalRows; i++) {
                    const emptyRow = document.createElement('tr');
                    emptyRow.className = 'empty-row';
                    if (i === middleRow) {
                        emptyRow.innerHTML = `<td colspan="12" class="no-data-row">Không có dữ liệu chấm công</td>`;
                    } else {
                        emptyRow.innerHTML = `
                            <td style="height: 50px;"></td> <td style="height: 50px;"></td> <td style="height: 50px;"></td>
                            <td style="height: 50px;"></td> <td style="height: 50px;"></td> <td style="height: 50px;"></td>
                            <td style="height: 50px;"></td> <td style="height: 50px;"></td> <td style="height: 50px;"></td>
                            <td style="height: 50px;"></td> <td style="height: 50px;"></td> <td style="height: 50px;"></td>
                            <td style="height: 50px;"></td>
                        `;
                    }
                    tbody.appendChild(emptyRow);
                }
                return;
            }

            pageData.forEach(record => {
                let statusText = record.approved ? 'Đã phê duyệt' : 'Chờ phê duyệt';
                if (record.status === 'rejected') statusText = 'Từ chối';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(record.date)}</td>
                    <td>${record.check_in || '--:--'}</td>
                    <td>${record.check_out || '--:--'}</td>
                    <td>${formatHourMinute(record.break_time) || '-'}</td>
                                                    <td>${formatHourMinute(calculateTotalCompTime(record)) || '-'}</td>
                    <td>${formatHourMinute(record.comp_time_overtime) || '-'}</td>
                    <td>${record.total_work_hours || '-'}</td>
                    <td>${record.work_hours_display || '-'}</td>
                    <td>${record.overtime_before_22 || '0:00'}</td>
                    <td>${record.overtime_after_22 || '0:00'}</td>
                    <td>${translateHolidayType(record.holiday_type)}</td>
                    <td>${record.user_name || '-'}</td>
                    <td>${record.department || '-'}</td>
                    <td>${statusText}</td>
                    <td style="height: 50px; width: 120px; padding: 0 !important;">
                        <div class="action-container">
                            ${(() => { const adminNow = document.getElementById('role-select')?.value === 'ADMIN'; return (record.approved && adminNow) ? `<a href="/admin/attendance/${record.id}/export-overtime-pdf" class="btn btn-outline-primary btn-sm ms-1"><i class='fas fa-print'></i> In giấy tăng ca</a>` : ''; })()}
                        </div>
                    </td>
                    <td class="note-cell" data-full-note="${record.note || ''}">${record.note || '-'}</td>
                `;
                tbody.appendChild(row);
            });

            const emptyRowsNeeded = Math.max(0, allRowsPerPage - pageData.length);
            for (let i = 0; i < emptyRowsNeeded; i++) {
                const emptyRow = document.createElement('tr');
                emptyRow.className = 'empty-row';
                emptyRow.innerHTML = `
                    <td style="height: 50px;"></td> <td style="height: 50px;"></td> <td style="height: 50px;"></td>
                    <td style="height: 50px;"></td> <td style="height: 50px;"></td> <td style="height: 50px;"></td>
                    <td style="height: 50px;"></td> <td style="height: 50px;"></td> <td style="height: 50px;"></td>
                    <td style="height: 50px;"></td> <td style="height: 50px;"></td> <td style="height: 50px;"></td>
                    <td style="height: 50px;"></td>
                `;
                tbody.appendChild(emptyRow);
            }
        }

        function getApprovalFilters() {
            return {
                search: document.getElementById('approvalSearchName')?.value || '',
                department: document.getElementById('approvalDepartment')?.value || '',
                date_from: document.getElementById('approvalDateFrom')?.value || '',
                date_to: document.getElementById('approvalDateTo')?.value || ''
            };
        }
        async function loadApprovalAttendance(page = 1) {
            const approvalBody = document.getElementById('approvalAttendanceBody');
            if (!approvalBody) return;
            approvalBody.innerHTML = '<tr><td colspan="16" class="no-data-row">Đang tải dữ liệu...</td></tr>';

            // Lấy vai trò hiện tại để kiểm tra quyền admin
            const roleSelect = document.getElementById('role-select');
            const isAdmin = roleSelect ? roleSelect.value === 'ADMIN' : false;

            const filters = getApprovalFilters();
            let url = `/api/attendance/pending?page=${page}&per_page=${approvalPerPage}`;
            if (filters.search) url += `&search=${encodeURIComponent(filters.search)}`;
            if (filters.department) url += `&department=${encodeURIComponent(filters.department)}`;
            if (filters.date_from) url += `&date_from=${encodeURIComponent(filters.date_from)}`;
            if (filters.date_to) url += `&date_to=${encodeURIComponent(filters.date_to)}`;
            try {
                const response = await fetch(url);
                const result = await response.json();
                approvalBody.innerHTML = '';
                if (!result.data || result.data.length === 0) {
                    approvalBody.innerHTML = '<tr><td colspan="16" class="no-data-row">Không có bản ghi chấm công chờ phê duyệt</td></tr>';
                    renderApprovalPagination(1, 1);
                    return;
                }
                result.data.forEach(record => {
                    const row = document.createElement('tr');

                    row.innerHTML = `
                        <td>${formatDate(record.date)}</td>
                        <td>${record.check_in || '--:--'}</td>
                        <td>${record.check_out || '--:--'}</td>
                        <td>${formatHourMinute(record.break_time) || '-'}</td>
                        <td>${formatHourMinute(calculateTotalCompTime(record)) || '-'}</td>
                        <td>${record.total_work_hours || '-'}</td>
                        <td>${record.work_hours_display || '-'}</td>
                        <td>${record.overtime_before_22 || '0:00'}</td>
                        <td>${record.overtime_after_22 || '0:00'}</td>
                        <td>${translateHolidayType(record.holiday_type)}</td>
                        <td>${record.user_name || '-'}</td>
                        <td>${record.department || '-'}</td>
                        <td>${translateStatus(record.status)}</td>
                        <td style="height: 50px; width: 100px; text-align: center;">
                            <div class="signature-status">
                                ${getSignatureStatus(record)}
                            </div>
                        </td>
                        <td style="height: 50px; width: 120px; padding: 0 !important;">
                            <div class="action-container">
                            ${['pending', 'pending_manager', 'pending_admin'].includes(record.status) ? `
                                    <div class="btn-action-container">
                                        <button class='btn btn-success btn-sm approve-attendance-btn' data-id='${record.id}' title="Phê duyệt">
                                            <i class='fas fa-check me-1'></i>Phê duyệt
                                        </button>
                                        <button class='btn btn-danger btn-sm reject-attendance-btn' data-id='${record.id}' title="Từ chối">
                                            <i class='fas fa-times me-1'></i>Từ chối
                                        </button>
                            ` : `
                                <div class="btn-action-container">
                                    ${getOvertimePrintButton(record.id, record.approved, isAdmin)}
                                    ${getOvertimeTestButton(record.id, record.approved, isAdmin)}
                                    ${isAdmin ? `<button class='btn btn-info btn-sm debug-signature-btn' data-id='${record.id}' title="Debug chữ ký"><i class='fas fa-bug me-1'></i>Debug</button>` : ''}
                                </div>
                            `}
                            </div>
                        </td>
                        <td style="height: 50px; width: 120px;" class="note-cell" data-full-note="${record.note || ''}">
                            ${record.note || '-'}
                        </td>
                    `;
                    approvalBody.appendChild(row);
                });
                bindNoteCellClick(); // Kích hoạt popup cho ghi chú
                renderApprovalPagination(result.page, Math.ceil(result.total / result.per_page));

                // Gắn event listeners cho các nút phê duyệt và từ chối
                document.querySelectorAll('.approve-attendance-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const id = this.getAttribute('data-id');
                        approveAttendance(id, 'approve');
                    });
                });

                document.querySelectorAll('.reject-attendance-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const id = this.getAttribute('data-id');
                        approveAttendance(id, 'reject');
                    });
                });

                // Gắn event listeners cho nút debug chữ ký
                document.querySelectorAll('.debug-signature-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const id = this.getAttribute('data-id');
                        debugSignature(id);
                    });
                });
            } catch (e) {
                approvalBody.innerHTML = '<tr><td colspan="16" class="no-data-row">Lỗi tải dữ liệu</td></tr>';
                renderApprovalPagination(1, 1);
            }
        }
        function renderApprovalPagination(current, total) {
            const pag = document.getElementById('approvalPagination');
            pag.innerHTML = '';
            if (total <= 1) return;
            function createPageItem(i, active = false) {
                const li = document.createElement('li');
                li.className = 'page-item' + (active ? ' active' : '');
                const a = document.createElement('a');
                a.className = 'page-link';
                a.href = '#';
                a.textContent = i;
                a.addEventListener('click', function (e) {
                    e.preventDefault();
                    approvalPage = i;
                    loadApprovalAttendance(approvalPage);
                });
                li.appendChild(a);
                pag.appendChild(li);
            }
            if (total <= 7) {
                for (let i = 1; i <= total; i++) createPageItem(i, i === current);
            } else {
                createPageItem(1, current === 1);
                if (current > 4) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = '<span class="page-link">...</span>';
                    pag.appendChild(li);
                }
                for (let i = Math.max(2, current - 1); i <= Math.min(total - 1, current + 1); i++) {
                    createPageItem(i, i === current);
                }
                if (current < total - 3) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = '<span class="page-link">...</span>';
                    pag.appendChild(li);
                }
                createPageItem(total, current === total);
            }
        }

        function translateHolidayType(holidayType) {
            if (!holidayType) return '-';
            const types = {
                'Ngày thường': 'Ngày thường',
                'Cuối tuần': 'Cuối tuần',
                'Lễ Việt Nam': 'Lễ Việt Nam',
                'Lễ Nhật Bản': 'Lễ Nhật Bản',
                'normal': 'Ngày thường',
                'weekend': 'Cuối tuần',
                'vietnamese_holiday': 'Lễ Việt Nam',
                'japanese_holiday': 'Lễ Nhật Bản'
            };
            return types[holidayType] || holidayType;
        }

        function translateStatus(status) {
            const translations = {
                'approved': 'Đã phê duyệt',
                'pending': 'Chờ phê duyệt',
                'pending_manager': 'Chờ quản lý duyệt',
                'pending_admin': 'Chờ admin duyệt',
                'rejected': 'Từ chối'
            };
            return translations[status] || status;
        }

        function getSignatureStatus(record) {
            // 3 trạng thái: NV, TL, QL
            const hasEmployeeSignature = record.signature && record.signature.trim() !== '';
            // Chỉ hiển thị dấu V khi thực sự đã phê duyệt, không chỉ dựa vào có chữ ký
            const hasTeamLeaderApproved = (record.team_leader_signature && record.team_leader_signature.trim() !== '') &&
                !['pending'].includes(record.status);
            const hasManagerApproved = (record.manager_signature && record.manager_signature.trim() !== '') &&
                !['pending', 'pending_manager'].includes(record.status);

            // Màu: xanh lá #219653 (đã ký), xám #888 (chưa ký)
            const circles = [
                {
                    signed: hasEmployeeSignature,
                    label: 'Nhân viên',
                    tooltip: hasEmployeeSignature ? 'Nhân viên đã ký' : 'Nhân viên chưa ký',
                    icon: hasEmployeeSignature ? 'fa-check' : 'fa-clock'
                },
                {
                    signed: hasTeamLeaderApproved,
                    label: 'Trưởng nhóm',
                    tooltip: hasTeamLeaderApproved ? 'Trưởng nhóm đã phê duyệt' : 'Trưởng nhóm chưa phê duyệt',
                    icon: hasTeamLeaderApproved ? 'fa-check' : 'fa-clock'
                },
                {
                    signed: hasManagerApproved,
                    label: 'Quản lý',
                    tooltip: hasManagerApproved ? 'Quản lý đã phê duyệt' : 'Quản lý chưa phê duyệt',
                    icon: hasManagerApproved ? 'fa-check' : 'fa-clock'
                }
            ];
            let html = '<div class="signature-circles-row">';
            circles.forEach(c => {
                html += `<span class="signature-circle${c.signed ? ' signed' : ''}" title="${c.tooltip}"><i class="fas ${c.icon}"></i></span>`;
            });
            html += '</div>';
            return html;
        }

        // Gọi khi trang load nếu có approval section
        if (document.getElementById('approvalAttendanceBody')) {
            loadApprovalAttendance();
        }
        document.getElementById('btnApprovalFilter')?.addEventListener('click', function () {
            approvalPage = 1;
            loadApprovalAttendance(approvalPage);
        });
        document.getElementById('btnApprovalReset')?.addEventListener('click', function () {
            document.getElementById('approvalSearchName').value = '';
            if (document.getElementById('approvalDepartment')) document.getElementById('approvalDepartment').value = '';
            document.getElementById('approvalDateFrom').value = '';
            document.getElementById('approvalDateTo').value = '';
            approvalPage = 1;
            loadApprovalAttendance(approvalPage);
        });

        // Xử lý sự kiện cho các nút filter trong lịch sử toàn bộ
        document.getElementById('btnFilterAttendance')?.addEventListener('click', function () {
            loadAllAttendanceHistory(1);
        });

        document.getElementById('btnResetFilter')?.addEventListener('click', function () {
            document.getElementById('filterMonth').value = '';
            document.getElementById('filterYear').value = '';
            loadAllAttendanceHistory();
        });

        // Xử lý nút "Trở về" từ lịch sử toàn bộ
        document.getElementById('btnBackToDashboard')?.addEventListener('click', function () {
            const roleSelect = document.getElementById('role-select');
            const currentRole = roleSelect ? roleSelect.value : 'EMPLOYEE';

            if (currentRole === 'ADMIN') {
                // Hiển thị lại giao diện quản trị viên mặc định
                updateUIForRole(currentRole);
            }
        });

        function switchRole(role) {
            // Lấy CSRF token
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

            fetch('/switch-role', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ role })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        showToast(data.error, 'error');
                    } else {
                        // Tránh hiển thị toast ở đây vì role-switch-optimizer đã hiển thị
                        updateUIForRole(role);
                    }
                })
                .catch(error => {
                    console.error('Error switching role:', error);
                    showToast('Lỗi khi chuyển vai trò', 'error');
                });
        }

        function updateUIForRole(role) {
            console.log('🔍 updateUIForRole called with role:', role);

            const attendanceFormSection = document.getElementById('attendanceFormSection');
            const attendanceHistorySection = document.getElementById('attendanceHistorySection');
            const approvalSection = document.getElementById('approvalSection');
            const allAttendanceHistorySection = document.getElementById('allAttendanceHistorySection');
            const departmentFilterContainer = document.getElementById('departmentFilterContainer');
            const adminUsersMenu = document.getElementById('adminUsersMenu');
            const adminHolidaysMenu = document.getElementById('adminHolidaysMenu');
            const adminLeaveHistoryAllMenu = document.getElementById('adminLeaveHistoryAllMenu');
            const attendanceHistoryMenuWrapper = document.getElementById('attendanceHistoryMenuWrapper');

            console.log('🔍 Admin menu elements found:', {
                adminUsersMenu: !!adminUsersMenu,
                adminHolidaysMenu: !!adminHolidaysMenu,
                adminLeaveHistoryAllMenu: !!adminLeaveHistoryAllMenu,
                attendanceHistoryMenuWrapper: !!attendanceHistoryMenuWrapper
            });

            // Menu nghỉ phép
            const employeeLeaveMenu = document.getElementById('employeeLeaveMenu');
            const employeeLeaveStatusMenu = document.getElementById('employeeLeaveStatusMenu');
            const employeeLeaveHistoryMenu = document.getElementById('employeeLeaveHistoryMenu');
            const managerLeaveMenu = document.getElementById('managerLeaveMenu');

            const testSignatureButtonContainer = document.getElementById('testSignatureButtonContainer');
            const pageTitle = document.querySelector('.page-title');

            // Ẩn tất cả các section trước
            if (attendanceFormSection) attendanceFormSection.style.display = 'none';
            if (attendanceHistorySection) attendanceHistorySection.style.display = 'none';
            if (approvalSection) approvalSection.style.display = 'none';
            if (allAttendanceHistorySection) allAttendanceHistorySection.style.display = 'none';

            // Ẩn filter phòng ban mặc định
            if (departmentFilterContainer) departmentFilterContainer.style.display = 'none';

            // Ẩn menu quản lý users mặc định
            console.log('🔍 Hiding admin menus by default');
            if (adminUsersMenu) {
                adminUsersMenu.style.display = 'none';
                console.log('✅ adminUsersMenu hidden');
            } else {
                console.log('❌ adminUsersMenu not found for hiding');
            }
            if (adminHolidaysMenu) {
                adminHolidaysMenu.style.display = 'none';
                console.log('✅ adminHolidaysMenu hidden');
            } else {
                console.log('❌ adminHolidaysMenu not found for hiding');
            }
            if (adminLeaveHistoryAllMenu) {
                adminLeaveHistoryAllMenu.style.display = 'none';
                console.log('✅ adminLeaveHistoryAllMenu hidden');
            } else {
                console.log('❌ adminLeaveHistoryAllMenu not found for hiding');
            }
            // Ẩn menu lịch sử chấm công mặc định
            if (attendanceHistoryMenuWrapper) attendanceHistoryMenuWrapper.style.display = 'none';

            // Ẩn menu nghỉ phép mặc định
            if (employeeLeaveMenu) employeeLeaveMenu.style.display = 'none';
            if (employeeLeaveStatusMenu) employeeLeaveStatusMenu.style.display = 'none';
            if (employeeLeaveHistoryMenu) employeeLeaveHistoryMenu.style.display = 'none';
            if (managerLeaveMenu) managerLeaveMenu.style.display = 'none';

            // Ẩn nút test chữ ký mặc định
            if (testSignatureButtonContainer) testSignatureButtonContainer.style.display = 'none';

            if (role === 'EMPLOYEE') {
                // Hiển thị form chấm công và lịch sử cho nhân viên
                if (attendanceFormSection) attendanceFormSection.style.display = 'block';
                if (attendanceHistorySection) attendanceHistorySection.style.display = 'block';
                // Hiển thị nút test chữ ký cho nhân viên
                if (testSignatureButtonContainer) testSignatureButtonContainer.style.display = 'block';
                // Hiển thị menu đăng ký nghỉ phép cho nhân viên
                if (employeeLeaveMenu) employeeLeaveMenu.style.display = 'block';
                if (employeeLeaveStatusMenu) employeeLeaveStatusMenu.style.display = 'block';
                if (employeeLeaveHistoryMenu) employeeLeaveHistoryMenu.style.display = 'block';

                // Đợi một chút để đảm bảo DOM được cập nhật trước khi gọi API
                setTimeout(() => {
                    console.log('🔄 Attempting to load attendance history for EMPLOYEE role');
                    const attendanceHistoryElement = document.getElementById('attendanceHistory');
                    if (attendanceHistoryElement) {
                        console.log('✅ attendanceHistory element found');
                        // Chỉ gọi API nếu chưa có dữ liệu hoặc dữ liệu cũ
                        if (!dashboardAttendanceData || dashboardAttendanceData.length === 0) {
                            console.log('📡 Calling updateAttendanceHistory()');
                            updateAttendanceHistory();
                        } else {
                            console.log('📊 Data already exists, length:', dashboardAttendanceData.length);
                        }
                    } else {
                        console.log('❌ attendanceHistory element not found, retrying...');
                        // Nếu element chưa sẵn sàng, thử lại sau 100ms
                        setTimeout(() => {
                            const retryElement = document.getElementById('attendanceHistory');
                            if (retryElement) {
                                console.log('✅ Retry successful, element found');
                                if (!dashboardAttendanceData || dashboardAttendanceData.length === 0) {
                                    console.log('📡 Calling updateAttendanceHistory() on retry');
                                    updateAttendanceHistory();
                                }
                            } else {
                                console.log('❌ Retry failed, element still not found');
                            }
                        }, 100);
                    }
                }, 50);
                if (pageTitle) pageTitle.textContent = 'Bảng điều khiển';
            } else if (['TEAM_LEADER', 'MANAGER', 'ADMIN'].includes(role)) {
                // Hiển thị phần phê duyệt cho quản lý và admin
                if (approvalSection) approvalSection.style.display = 'block';
                // Hiển thị filter phòng ban cho MANAGER và ADMIN
                if (['MANAGER', 'ADMIN'].includes(role) && departmentFilterContainer) {
                    departmentFilterContainer.style.display = 'block';
                }
                // Chỉ hiển thị menu quản lý users cho ADMIN
                if (role === 'ADMIN') {
                    console.log('🔍 Setting ADMIN menus to visible');
                    if (adminUsersMenu) {
                        adminUsersMenu.style.display = 'block';
                        console.log('✅ adminUsersMenu set to block');
                    } else {
                        console.log('❌ adminUsersMenu not found');
                    }
                    if (adminHolidaysMenu) {
                        adminHolidaysMenu.style.display = 'block';
                        console.log('✅ adminHolidaysMenu set to block');
                    } else {
                        console.log('❌ adminHolidaysMenu not found');
                    }
                    if (adminLeaveHistoryAllMenu) {
                        adminLeaveHistoryAllMenu.style.display = 'block';
                        console.log('✅ adminLeaveHistoryAllMenu set to block');
                    } else {
                        console.log('❌ adminLeaveHistoryAllMenu not found');
                    }
                } else {
                    console.log('🔍 Not ADMIN role, hiding admin menus. Current role:', role);
                }
                // Chỉ hiển thị menu lịch sử chấm công cho ADMIN
                if (role === 'ADMIN' && attendanceHistoryMenuWrapper) {
                    attendanceHistoryMenuWrapper.style.display = 'block';
                }
                // Hiển thị menu nghỉ phép cần phê duyệt cho trưởng nhóm/quản lý/quản trị viên
                if (managerLeaveMenu) managerLeaveMenu.style.display = 'block';
                // Cập nhật số lượng đơn nghỉ phép cần phê duyệt
                updatePendingLeaveCount();

                // Hiển thị bulk export section cho ADMIN
                const bulkExportSection = document.getElementById('bulkExportSection');
                if (role === 'ADMIN' && bulkExportSection) {
                    bulkExportSection.style.display = 'block';
                } else if (bulkExportSection) {
                    bulkExportSection.style.display = 'none';
                }
                // Load dữ liệu phê duyệt
                loadApprovalAttendance();
                if (pageTitle) pageTitle.textContent = 'Quản lý chấm công';

                // Hiển thị nút phê duyệt hàng loạt
                if (typeof toggleBulkApprovalButton === 'function') {
                    toggleBulkApprovalButton();
                }
            }

            // Cập nhật active state cho menu
            updateMenuActiveState(role);
        }

        function updateMenuActiveState(role) {
            // Cập nhật active state cho các menu item
            const menuItems = document.querySelectorAll('.nav-link');
            menuItems.forEach(item => {
                item.classList.remove('active');
            });

            // Set active cho menu phù hợp
            if (role === 'EMPLOYEE') {
                const homeMenu = document.querySelector('.nav-link');
                if (homeMenu) homeMenu.classList.add('active');
            } else {
                // Tìm menu phê duyệt hoặc tạo mới
                const approvalMenu = document.querySelector('.nav-link[data-role="approval"]');
                if (approvalMenu) {
                    approvalMenu.classList.add('active');
                } else {
                    // Nếu không có menu phê duyệt, set active cho trang chủ
                    const homeMenu = document.querySelector('.nav-link');
                    if (homeMenu) homeMenu.classList.add('active');
                }
            }
        }

        // Hàm phê duyệt chấm công với hệ thống chữ ký thông minh
        async function approveAttendance(attendanceId, action) {
            console.log('approveAttendance called with:', { attendanceId, action });

            // Lấy CSRF token
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
            console.log('CSRF Token:', csrfToken);

            if (action === 'approve') {
                console.log('Processing approval...');

                // Kiểm tra trạng thái chữ ký trước
                const signatureStatus = await checkSignatureStatus(attendanceId);
                console.log('Signature status:', signatureStatus);

                if (!signatureStatus) {
                    console.error('Signature status check failed - API returned null');
                    showToast('Lỗi kiểm tra trạng thái chữ ký', 'error');
                    return;
                }

                if (signatureStatus.is_admin) {
                    // Admin không cần chữ ký, phê duyệt trực tiếp
                    await processApproval(attendanceId, '', 'admin');
                    return;
                }

                // Kiểm tra xem có cần chữ ký không
                if (signatureStatus.need_signature) {
                    console.log('❌ SIGNATURE REQUIRED: User needs to set up personal signature');
                    Swal.fire({
                        title: 'Thiết lập chữ ký cá nhân',
                        html: `
                            <div style="text-align: center;">
                                <i class="fas fa-signature" style="font-size: 3rem; color: #e74c3c; margin-bottom: 1rem;"></i>
                                <p style="font-size: 1.1rem; margin-bottom: 1rem; color: #2c3e50;">
                                    <strong>Bạn chưa có chữ ký cá nhân!</strong>
                                </p>
                                <p style="font-size: 1rem; margin-bottom: 1rem; color: #34495e;">
                                    Chữ ký cá nhân là bắt buộc để phê duyệt các bản ghi chấm công.
                                </p>
                                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 15px 0;">
                                    <p style="margin: 0; color: #856404; font-weight: 600;">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        Vui lòng thiết lập chữ ký ngay để có thể sử dụng chức năng phê duyệt.
                                    </p>
                                </div>
                            </div>
                        `,
                        icon: 'warning',
                        showCancelButton: false,
                        confirmButtonText: 'Thiết lập ngay',
                        confirmButtonColor: '#e74c3c',
                        allowOutsideClick: false,
                        allowEscapeKey: false
                    }).then((result) => {
                        // Chuyển hướng đến trang settings
                        window.location.href = '/settings';
                    });
                    return;
                }

                // Xử lý chữ ký cho non-admin users
                const signature = await handleSignatureFlow(signatureStatus, attendanceId);
                if (signature !== false) { // false means user cancelled
                    await processApproval(attendanceId, signature, 'user');
                }
            } else if (action === 'reject') {
                // Xử lý từ chối
                await handleRejection(attendanceId);
            }
        }

        // Kiểm tra trạng thái chữ ký
        async function checkSignatureStatus(attendanceId) {
            try {
                // Thử nhiều cách để lấy CSRF token
                let csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                if (!csrfToken) {
                    csrfToken = document.querySelector('input[name="csrf_token"]')?.value || '';
                }
                console.log('DEBUG: CSRF Token for signature check:', csrfToken);

                const response = await fetch('/api/signature/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ attendance_id: attendanceId })
                });

                // Kiểm tra response type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.error('API returned non-JSON response:', contentType);
                    return { need_signature: true, is_admin: false };
                }

                const data = await response.json();
                console.log('Signature status:', data);
                console.log('DEBUG: Signature status details:', {
                    need_signature: data.need_signature,
                    is_admin: data.is_admin,
                    has_session_signature: data.has_session_signature,
                    has_db_signature: data.has_db_signature,
                    should_use_session: data.should_use_session,
                    session_signature_available: data.session_signature_available,
                    is_reused_signature: data.is_reused_signature,
                    message: data.message
                });
                return data;
            } catch (error) {
                console.error('Error checking signature status:', error);
                return { need_signature: true, is_admin: false };
            }
        }

        // Xử lý luồng chữ ký thông minh
        async function handleSignatureFlow(signatureStatus, attendanceId) {
            const {
                has_personal_signature,
                has_session_signature,
                should_use_session,
                has_db_signature,
                session_signature_available,
                is_reused_signature,
                message
            } = signatureStatus;

            console.log('DEBUG: handleSignatureFlow called with:', {
                has_personal_signature,
                has_session_signature,
                should_use_session,
                has_db_signature,
                session_signature_available,
                is_reused_signature,
                message,
                attendanceId
            });

            // Lấy thông tin người dùng hiện tại
            const currentRole = document.getElementById('role-select')?.value || 'EMPLOYEE';
            const currentUserName = document.getElementById('current-user-name')?.textContent || 'Unknown User';
            console.log('DEBUG: Current user info:', { role: currentRole, name: currentUserName });

            // Ưu tiên 1: Chữ ký cá nhân - tự động sử dụng
            if (has_personal_signature) {
                console.log('✅ PERSONAL SIGNATURE: User', currentUserName, `(${currentRole}) using personal signature automatically`);
                return 'personal_signature';
            }

            // Nếu không có chữ ký cá nhân, không thể tiếp tục
            console.log('❌ NO PERSONAL SIGNATURE: User', currentUserName, `(${currentRole}) has no personal signature`);
            return false;



            // Ưu tiên 2: Chữ ký từ session (nếu có và được phép sử dụng)
            if (session_signature_available) {
                console.log('DEBUG: Session signature available, showing reuse dialog');
                console.log('🔍 SIGNATURE REUSE INFO: User', currentUserName, `(${currentRole}) is reusing signature from current session`);
                const useSession = await Swal.fire({
                    title: '<i class="fas fa-signature me-2"></i>Sử dụng chữ ký đã lưu',
                    html: `
                        <div style="text-align: center;">
                            <p>Bạn có muốn sử dụng lại chữ ký đã ký trong phiên này không?</p>
                            <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #2196f3;">
                                <small style="color: #1976d2;">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Chữ ký của: <strong>${currentUserName}</strong> (${currentRole})
                                </small>
                            </div>
                            <div style="margin-top: 15px;">
                                <label style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <input type="checkbox" id="dont-ask-again" style="margin: 0;">
                                    <span>Không hỏi lại trong phiên này</span>
                                </label>
                            </div>
                        </div>
                    `,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Có, sử dụng',
                    cancelButtonText: 'Không, ký lại',
                    reverseButtons: true
                });

                if (useSession.isConfirmed) {
                    console.log('DEBUG: User confirmed using session signature');
                    console.log('✅ SIGNATURE REUSE CONFIRMED: User', currentUserName, `(${currentRole}) confirmed reusing session signature`);
                    const dontAskAgain = document.getElementById('dont-ask-again').checked;
                    // Lưu flag không hỏi lại
                    if (dontAskAgain) {
                        await saveSignatureToSession('', 'session_reused', true);
                    }
                    return 'session_reused';
                }
            }

            // Ưu tiên 3: Chữ ký từ database (bao gồm cả chữ ký từ vai trò thấp hơn)
            if (has_db_signature) {
                console.log('DEBUG: DB signature available, showing reuse dialog');
                console.log('🔍 SIGNATURE REUSE INFO: User', currentUserName, `(${currentRole}) found saved signature in database`);

                // Tạo message phù hợp dựa trên việc có phải chữ ký tái sử dụng không
                let reuseMessage = 'Bạn có muốn sử dụng lại chữ ký đã lưu trước đó không?';
                let infoBoxStyle = 'background: #fff3e0; padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #ff9800;';
                let infoBoxColor = 'color: #e65100;';
                let infoIcon = 'fas fa-database';

                if (is_reused_signature) {
                    reuseMessage = 'Bạn có muốn sử dụng lại chữ ký từ vai trò thấp hơn không?';
                    infoBoxStyle = 'background: #e8f5e8; padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #4caf50;';
                    infoBoxColor = 'color: #2e7d32;';
                    infoIcon = 'fas fa-recycle';
                }

                const useDbSignature = await Swal.fire({
                    title: '<i class="fas fa-database me-2"></i>Chữ ký đã lưu',
                    html: `
                        <div style="text-align: center;">
                            <p>${reuseMessage}</p>
                            <div style="${infoBoxStyle}">
                                <small style="${infoBoxColor}">
                                    <i class="${infoIcon} me-1"></i>
                                    ${message}
                                </small>
                            </div>
                            <div style="margin-top: 15px;">
                                <label style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <input type="checkbox" id="dont-ask-again" style="margin: 0;">
                                    <span>Không hỏi lại trong phiên này</span>
                                </label>
                            </div>
                        </div>
                    `,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Có, sử dụng',
                    cancelButtonText: 'Không, ký mới',
                    reverseButtons: true
                });

                if (useDbSignature.isConfirmed) {
                    const dontAskAgain = document.getElementById('dont-ask-again').checked;
                    console.log('DEBUG: User confirmed using DB signature');
                    console.log('✅ SIGNATURE REUSE CONFIRMED: User', currentUserName, `(${currentRole}) confirmed reusing database signature`);

                    // Lấy chữ ký từ database
                    const dbSignature = await getSignatureFromDatabase(attendanceId);
                    console.log('DEBUG: DB signature result:', dbSignature ? 'Found' : 'Not found');
                    if (dbSignature) {
                        console.log('DEBUG: Saving DB signature to session...');
                        const signatureType = is_reused_signature ? 'role_reused' : 'database_reused';
                        await saveSignatureToSession(dbSignature, signatureType, dontAskAgain);
                        console.log('DEBUG: Returning DB signature for approval');
                        return dbSignature;
                    } else {
                        console.log('DEBUG: No DB signature found, will show signature modal');
                    }
                }
            }

            // Ưu tiên 4: Ký mới
            console.log('DEBUG: No reusable signature found, showing signature modal');
            console.log('🆕 NEW SIGNATURE: User', currentUserName, `(${currentRole}) will create new signature`);
            return await showSignatureModal(attendanceId);
        }

        // Lấy chữ ký từ database
        async function getSignatureFromDatabase(attendanceId) {
            try {
                console.log('DEBUG: Getting signature from database for attendance:', attendanceId);
                const response = await fetch(`/api/attendance/${attendanceId}`);
                const data = await response.json();
                console.log('DEBUG: Attendance data:', data);

                const currentRole = document.getElementById('role-select')?.value || 'EMPLOYEE';
                console.log('DEBUG: Current role:', currentRole);

                let signature = null;
                let signatureSource = null;

                // Logic tái sử dụng chữ ký từ vai trò thấp hơn
                if (currentRole === 'TEAM_LEADER') {
                    // Kiểm tra chữ ký team leader trước
                    if (data.team_leader_signature) {
                        signature = data.team_leader_signature;
                        signatureSource = 'team_leader_original';
                        console.log('DEBUG: Team leader signature (original): Found');
                    } else if (data.signature) {
                        // Sử dụng chữ ký employee (vai trò thấp hơn)
                        signature = data.signature;
                        signatureSource = 'employee_reused';
                        console.log('DEBUG: Employee signature (reused): Found');
                    }
                } else if (currentRole === 'MANAGER') {
                    // Kiểm tra chữ ký manager trước
                    if (data.manager_signature) {
                        signature = data.manager_signature;
                        signatureSource = 'manager_original';
                        console.log('DEBUG: Manager signature (original): Found');
                    } else if (data.team_leader_signature) {
                        // Sử dụng chữ ký team leader (vai trò thấp hơn)
                        signature = data.team_leader_signature;
                        signatureSource = 'team_leader_reused';
                        console.log('DEBUG: Team leader signature (reused): Found');
                    } else if (data.signature) {
                        // Sử dụng chữ ký employee (vai trò thấp nhất)
                        signature = data.signature;
                        signatureSource = 'employee_reused';
                        console.log('DEBUG: Employee signature (reused): Found');
                    }
                } else {
                    // EMPLOYEE - chỉ sử dụng chữ ký employee
                    signature = data.signature;
                    signatureSource = 'employee_original';
                    console.log('DEBUG: Employee signature (original):', signature ? 'Found' : 'Not found');
                }

                console.log('DEBUG: Final signature result:', signature ? 'Found' : 'Not found', 'Source:', signatureSource);
                return signature;
            } catch (error) {
                console.error('Error getting signature from database:', error);
                return null;
            }
        }

        // Lấy chữ ký từ session
        async function getSignatureFromSession() {
            try {
                // Thử nhiều cách để lấy CSRF token
                let csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                if (!csrfToken) {
                    csrfToken = document.querySelector('input[name="csrf_token"]')?.value || '';
                }
                console.log('DEBUG: CSRF Token for getSignatureFromSession:', csrfToken);

                const response = await fetch('/api/signature/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ check_session: true })
                });

                // Kiểm tra response type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.error('API returned non-JSON response:', contentType);
                    return null;
                }

                const data = await response.json();
                return data.session_signature || null;
            } catch (error) {
                console.error('Error getting signature from session:', error);
                return null;
            }
        }

        // Lưu chữ ký vào session
        async function saveSignatureToSession(signature, type, dontAskAgain = false) {
            try {
                // Nếu signature quá lớn, chỉ lưu flag thay vì toàn bộ chữ ký
                let signatureToSave = signature;
                if (signature && signature.length > 1000) {
                    // Tạo hash đơn giản cho chữ ký lớn
                    signatureToSave = 'signature_hash_' + btoa(signature.substring(0, 100)).replace(/[^a-zA-Z0-9]/g, '');
                }

                const response = await fetch('/api/signature/save-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                    },
                    body: JSON.stringify({
                        signature: signatureToSave,
                        type: type,
                        dont_ask_again: dontAskAgain
                    })
                });

                const data = await response.json();
                if (data.success) {
                    console.log(`✅ SIGNATURE SAVED: ${type} signature saved to session${dontAskAgain ? ' with dont_ask_again flag' : ''}`);
                } else {
                    console.error('❌ SIGNATURE SAVE FAILED:', data.error);
                }
                return data.success;
            } catch (error) {
                console.error('❌ ERROR SAVING SIGNATURE:', error);
                return false;
            }
        }

        // Hiển thị modal ký tên
        async function showSignatureModal(attendanceId) {
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
            const { value: signature } = await Swal.fire({
                title: '<i class="fas fa-signature me-2"></i>Ký tên phê duyệt',
                html: `
                        <div style="text-align: center;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <p style="margin: 0; font-weight: 600; color: #495057;">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Vui lòng ký tên để xác nhận phê duyệt bản ghi chấm công
                                </p>
                            </div>
                            <div style="border: 2px dashed #dee2e6; border-radius: 8px; padding: 10px; margin-bottom: 15px;">
                                <canvas id="approval-signature-pad" width="400" height="200" style="border: 1px solid #ccc; border-radius: 5px; background: #fff;"></canvas>
                            </div>
                            <div style="display: flex; justify-content: center; gap: 10px;">
                                <button type="button" id="clear-approval-signature" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-eraser me-1"></i>Xóa chữ ký
                                </button>
                                <button type="button" id="preview-approval-signature" class="btn btn-outline-info btn-sm">
                                    <i class="fas fa-eye me-1"></i>Xem chữ ký
                                </button>
                            </div>
                            <div id="signature-preview" style="display: none; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                <img id="preview-image" style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 3px;">
                            </div>
                        </div>
                    `,
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-check me-2"></i>Phê duyệt',
                cancelButtonText: '<i class="fas fa-times me-2"></i>Hủy',
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                width: '500px',
                allowOutsideClick: false,
                allowEscapeKey: false,
                didOpen: () => {
                    // Khởi tạo signature pad
                    const canvas = document.getElementById('approval-signature-pad');
                    const signaturePad = new SignaturePad(canvas, {
                        backgroundColor: 'rgb(255, 255, 255)',
                        penColor: 'rgb(0, 0, 0)',
                        minWidth: 1,
                        maxWidth: 2.5
                    });

                    // Xử lý nút xóa chữ ký
                    document.getElementById('clear-approval-signature').addEventListener('click', () => {
                        signaturePad.clear();
                        document.getElementById('signature-preview').style.display = 'none';
                    });

                    // Xử lý nút xem chữ ký
                    document.getElementById('preview-approval-signature').addEventListener('click', () => {
                        if (!signaturePad.isEmpty()) {
                            const previewDiv = document.getElementById('signature-preview');
                            const previewImg = document.getElementById('preview-image');
                            previewImg.src = signaturePad.toDataURL();
                            previewDiv.style.display = 'block';
                        } else {
                            Swal.showValidationMessage('Chưa có chữ ký để xem!');
                        }
                    });

                    // Lưu signature pad để sử dụng sau
                    window.approvalSignaturePad = signaturePad;

                    // Thêm hướng dẫn sử dụng
                    setTimeout(() => {
                        Swal.showValidationMessage('Vui lòng ký tên vào ô bên trên để tiếp tục');
                    }, 100);
                },
                preConfirm: () => {
                    const signaturePad = window.approvalSignaturePad;
                    if (signaturePad.isEmpty()) {
                        Swal.showValidationMessage('<i class="fas fa-exclamation-triangle me-2"></i>Vui lòng ký tên để xác nhận phê duyệt!');
                        return false;
                    }
                    return signaturePad.toDataURL();
                }
            });

            if (signature) {
                // Lưu chữ ký vào session nếu là ký mới
                await saveSignatureToSession(signature, 'new');
                return signature;
            }
            return false; // User cancelled
        }


        // Xử lý phê duyệt
        async function processApproval(attendanceId, signature, userType) {
            console.log('DEBUG: processApproval called with:', { attendanceId, signature, userType });
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

            // Lấy thông tin người dùng hiện tại
            const currentRole = document.getElementById('role-select')?.value || 'EMPLOYEE';
            const currentUserName = document.getElementById('current-user-name')?.textContent || 'Unknown User';

            // Kiểm tra token nếu là ADMIN
            if (currentRole === 'ADMIN' && tokenStatus && !tokenStatus.valid) {
                Swal.fire({
                    title: '⚠️ Token Google API hết hạn',
                    html: `
                        <div style="text-align: center;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #e74c3c; margin-bottom: 1rem;"></i>
                            <p style="font-size: 1.1rem; margin-bottom: 1rem; color: #2c3e50;">
                                <strong>Token Google API đã hết hạn!</strong>
                            </p>
                            <p style="font-size: 1rem; margin-bottom: 1rem; color: #34495e;">
                                ${tokenStatus.message || 'Vui lòng refresh token trước khi phê duyệt.'}
                            </p>
                        </div>
                    `,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Refresh Token',
                    cancelButtonText: 'Hủy',
                    confirmButtonColor: '#3498db'
                }).then((result) => {
                    if (result.isConfirmed) {
                        refreshToken();
                    }
                });
                return;
            }

            // Xử lý chữ ký từ session
            let finalSignature = signature;
            let signatureSource = 'new';

            if (signature === 'personal_signature') {
                console.log('✅ SIGNATURE SOURCE: User', currentUserName, `(${currentRole}) is using personal signature`);
                signatureSource = 'personal_signature';
                // Backend sẽ tự động lấy chữ ký cá nhân
                finalSignature = null;
            } else if (signature === 'session_reused') {
                console.log('DEBUG: Getting signature from session...');
                console.log('🔄 SIGNATURE SOURCE: User', currentUserName, `(${currentRole}) is reusing signature from current session`);
                const sessionSignature = await getSignatureFromSession();
                console.log('DEBUG: Session signature result:', sessionSignature ? 'Found' : 'Not found');
                finalSignature = sessionSignature;
                signatureSource = 'session_reused';
            } else if (signature && signature.startsWith('data:image')) {
                console.log('🆕 SIGNATURE SOURCE: User', currentUserName, `(${currentRole}) is using newly created signature`);
                signatureSource = 'new';
            } else if (signature) {
                console.log('🔄 SIGNATURE SOURCE: User', currentUserName, `(${currentRole}) is reusing signature from database`);
                signatureSource = 'database_reused';
            } else if (userType === 'admin') {
                console.log('👑 SIGNATURE SOURCE: Admin', currentUserName, `(${currentRole}) - no signature required`);
                signatureSource = 'admin_no_signature';
            }

            console.log('DEBUG: Final signature for approval:', finalSignature ? 'Has signature' : 'No signature');
            console.log('📝 APPROVAL SUMMARY: User', currentUserName, `(${currentRole}) approving attendance ${attendanceId} with signature source: ${signatureSource}`);

            // Hiển thị loading
            Swal.fire({
                title: 'Đang xử lý...',
                html: '<i class="fas fa-spinner fa-spin me-2"></i>Đang gửi yêu cầu phê duyệt',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false
            });

            try {
                const response = await fetch(`/api/attendance/${attendanceId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        action: 'approve',
                        reason: '',
                        signature: finalSignature
                    })
                });

                const data = await response.json();
                Swal.close(); // Đóng loading

                if (data.error) {
                    console.log('❌ APPROVAL FAILED: User', currentUserName, `(${currentRole}) failed to approve attendance ${attendanceId}:`, data.error);

                    // Kiểm tra token expired
                    if (data.error_code === 'token_expired' || (data.error && data.error.includes('Token Google API hết hạn'))) {
                        // Cập nhật token status
                        if (tokenStatus) {
                            tokenStatus.valid = false;
                            tokenStatus.can_approve = false;
                            updateTokenStatusUI(tokenStatus);
                        }
                        Swal.fire({
                            title: '⚠️ Token Google API hết hạn',
                            html: `
                                <div style="text-align: center;">
                                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #e74c3c; margin-bottom: 1rem;"></i>
                                    <p style="font-size: 1.1rem; margin-bottom: 1rem; color: #2c3e50;">
                                        <strong>Token Google API đã hết hạn!</strong>
                                    </p>
                                    <p style="font-size: 1rem; margin-bottom: 1rem; color: #34495e;">
                                        ${data.error}
                                    </p>
                                </div>
                            `,
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Refresh Token',
                            cancelButtonText: 'Hủy',
                            confirmButtonColor: '#3498db'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                refreshToken();
                            }
                        });
                        return;
                    }

                    // Kiểm tra xem có cần chuyển hướng đến settings không
                    if (data.redirect_to_settings) {
                        Swal.fire({
                            title: 'Thiết lập chữ ký cá nhân',
                            html: `
                                <div style="text-align: center;">
                                    <i class="fas fa-signature" style="font-size: 3rem; color: #e74c3c; margin-bottom: 1rem;"></i>
                                    <p style="font-size: 1.1rem; margin-bottom: 1rem; color: #2c3e50;">
                                        <strong>Bạn chưa có chữ ký cá nhân!</strong>
                                    </p>
                                    <p style="font-size: 1rem; margin-bottom: 1rem; color: #34495e;">
                                        ${data.error}
                                    </p>
                                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 15px 0;">
                                        <p style="margin: 0; color: #856404; font-weight: 600;">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            Vui lòng thiết lập chữ ký ngay để có thể phê duyệt các bản ghi chấm công.
                                        </p>
                                    </div>
                                </div>
                            `,
                            icon: 'warning',
                            showCancelButton: false,
                            confirmButtonText: 'Thiết lập ngay',
                            confirmButtonColor: '#e74c3c',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        }).then((result) => {
                            // Chuyển hướng đến trang settings
                            window.location.href = '/settings';
                        });
                    } else {
                        showToast(data.error, 'error');
                    }
                } else {
                    console.log('✅ APPROVAL SUCCESS: User', currentUserName, `(${currentRole}) successfully approved attendance ${attendanceId} with signature source: ${signatureSource}`);
                    showToast(data.message, 'success');
                    // Refresh danh sách phê duyệt và lịch sử nhân viên để loại bỏ "Chờ phê duyệt" ngay lập tức
                    loadApprovalAttendance();
                    try { updateAttendanceHistory(); } catch (e) { /* ignore */ }
                }
            } catch (error) {
                console.error('Error:', error);
                console.log('❌ APPROVAL ERROR: User', currentUserName, `(${currentRole}) encountered error while approving attendance ${attendanceId}:`, error);
                Swal.close(); // Đóng loading
                showToast('Đã xảy ra lỗi khi phê duyệt', 'error');
            }
        }

        // Xử lý từ chối
        async function handleRejection(attendanceId) {
            console.log('Processing rejection...');
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
            // Hiển thị popup để nhập lý do từ chối
            const { value: reason } = await Swal.fire({
                title: '<i class="fas fa-times-circle me-2"></i>Xác nhận từ chối',
                html: `
                        <div style="text-align: center;">
                            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ffeaa7;">
                                <p style="margin: 0; font-weight: 600; color: #856404;">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Vui lòng nhập lý do từ chối bản ghi chấm công
                                </p>
                            </div>
                            <div style="text-align: left;">
                                <label for="reject-reason" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                                    <i class="fas fa-comment me-2"></i>Lý do từ chối:
                                </label>
                                <textarea id="reject-reason" 
                                          style="width: 100%; min-height: 120px; padding: 12px; border: 1px solid #ced4da; border-radius: 5px; font-size: 14px; resize: vertical;"
                                          placeholder="Nhập lý do từ chối chi tiết ở đây..."></textarea>
                            </div>
                        </div>
                    `,
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-check me-2"></i>Xác nhận từ chối',
                cancelButtonText: '<i class="fas fa-times me-2"></i>Hủy',
                confirmButtonColor: '#e74c3c',
                cancelButtonColor: '#6c757d',
                width: '500px',
                allowOutsideClick: false,
                allowEscapeKey: false,
                didOpen: () => {
                    // Focus vào textarea
                    document.getElementById('reject-reason').focus();
                },
                preConfirm: () => {
                    const reason = document.getElementById('reject-reason').value.trim();
                    if (!reason) {
                        Swal.showValidationMessage('<i class="fas fa-exclamation-triangle me-2"></i>Vui lòng nhập lý do từ chối!');
                        return false;
                    }
                    // Chỉ yêu cầu có nội dung, không bắt buộc tối thiểu 10 ký tự
                    return reason;
                }
            });

            if (reason) {
                console.log('Sending rejection with reason:', reason);
                // Hiển thị loading
                Swal.fire({
                    title: 'Đang xử lý...',
                    html: '<i class="fas fa-spinner fa-spin me-2"></i>Đang gửi yêu cầu từ chối',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showConfirmButton: false
                });

                // Gửi yêu cầu từ chối với lý do
                fetch(`/api/attendance/${attendanceId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ action: 'reject', reason: reason })
                })
                    .then(response => {
                        console.log('Rejection response status:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Rejection response data:', data);
                        Swal.close(); // Đóng loading
                        if (data.error) {
                            showToast(data.error, 'error');
                        } else {
                            showToast(data.message, 'success');
                            loadApprovalAttendance();
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.close(); // Đóng loading
                        showToast('Đã xảy ra lỗi khi từ chối', 'error');
                    });
            }
        }


        window.switchRole = switchRole;
        window.approveAttendance = approveAttendance;

        // Set default value for attendanceDate to today - handled by flatpickr

        // Function formatHourMinute is defined below

        function extractTime(str) {
            if (!str) return '--:--';
            // Hỗ trợ cả dạng 'YYYY-MM-DD HH:MM:SS' và 'YYYY-MM-DDTHH:MM:SS'
            const match = str.match(/T?(\d{2}:\d{2})/);
            return match ? match[1] : '--:--';
        }

        function formatHourMinute(hours) {
            if (hours == null || hours === '') return '';
            if (typeof hours === 'string' && hours.includes(':')) return hours;
            let h = Math.floor(Number(hours));
            let m = Math.round((Number(hours) - h) * 60);
            if (m === 60) { h += 1; m = 0; }
            return `${h}:${m.toString().padStart(2, '0')}`;
        }

        // Function to format date consistently
        function formatDate(dateString) {
            if (!dateString) return '--/--/----';
            // Nếu là dạng DD/MM/YYYY thì parse thủ công
            if (typeof dateString === 'string' && dateString.includes('/')) {
                const [d, m, y] = dateString.split('/');
                return `${d.padStart(2, '0')}/${m.padStart(2, '0')}/${y}`;
            }
            // Nếu là dạng ISO hoặc object Date
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '--/--/----';
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Event listeners cho filter lịch sử chấm công đã phê duyệt
        document.addEventListener('DOMContentLoaded', function () {
            // Filter button
            const btnAllHistoryFilter = document.getElementById('btnAllHistoryFilter');
            if (btnAllHistoryFilter) {
                btnAllHistoryFilter.addEventListener('click', function () {
                    allCurrentPage = 1;
                    loadAllAttendanceHistory(allCurrentPage);
                });
            }

            // Reset button
            const btnAllHistoryReset = document.getElementById('btnAllHistoryReset');
            if (btnAllHistoryReset) {
                btnAllHistoryReset.addEventListener('click', function () {
                    // Reset các filter
                    document.getElementById('allHistorySearchName').value = '';
                    document.getElementById('allHistoryDepartment').value = '';
                    document.getElementById('allHistoryDateFrom').value = '';
                    document.getElementById('allHistoryDateTo').value = '';

                    // Reload dữ liệu
                    allCurrentPage = 1;
                    loadAllAttendanceHistory(allCurrentPage);
                });
            }

            // Enter key trong ô tìm kiếm
            const allHistorySearchName = document.getElementById('allHistorySearchName');
            if (allHistorySearchName) {
                allHistorySearchName.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        allCurrentPage = 1;
                        loadAllAttendanceHistory(allCurrentPage);
                    }
                });
            }
        });

        // Lấy thông tin chi tiết về chữ ký trong database
        async function getSignatureInfoFromDatabase(attendanceId) {
            try {
                console.log('DEBUG: Getting signature info from database for attendance:', attendanceId);
                const response = await fetch(`/api/attendance/${attendanceId}`);
                const data = await response.json();

                const currentRole = document.getElementById('role-select')?.value || 'EMPLOYEE';
                const currentUserName = document.getElementById('current-user-name')?.textContent || 'Unknown User';

                let signatureInfo = {
                    signerName: currentUserName,
                    signerRole: currentRole,
                    signDate: null,
                    hasSignature: false,
                    signatureType: null,
                    isReusedSignature: false,
                    userInfo: data.user_name ? {
                        name: data.user_name,
                        employee_id: data.user_employee_id,
                        department: data.user_department
                    } : null,
                    approverInfo: data.approver_info
                };

                // Xác định loại chữ ký và thông tin người ký
                if (currentRole === 'TEAM_LEADER') {
                    // Kiểm tra chữ ký team leader trước
                    if (data.team_leader_signature) {
                        signatureInfo.hasSignature = true;
                        signatureInfo.signatureType = 'team_leader_signature';
                        signatureInfo.isReusedSignature = false;
                        // Nếu có thông tin người phê duyệt và là TEAM_LEADER, lấy thông tin đó
                        if (data.approver_info && data.approver_info.roles && data.approver_info.roles.includes('TEAM_LEADER')) {
                            signatureInfo.signerName = data.approver_info.name;
                            signatureInfo.signerRole = 'TEAM_LEADER';
                            signatureInfo.signerEmployeeId = data.approver_info.employee_id;
                            signatureInfo.signerDepartment = data.approver_info.department;
                        }
                    } else if (data.signature) {
                        // Sử dụng chữ ký employee (vai trò thấp hơn)
                        signatureInfo.hasSignature = true;
                        signatureInfo.signatureType = 'employee_signature';
                        signatureInfo.isReusedSignature = true;
                        signatureInfo.signerName = data.user_name || currentUserName;
                        signatureInfo.signerRole = 'EMPLOYEE';
                        signatureInfo.signerEmployeeId = data.user_employee_id;
                        signatureInfo.signerDepartment = data.user_department;
                    }
                } else if (currentRole === 'MANAGER') {
                    // Kiểm tra chữ ký manager trước
                    if (data.manager_signature) {
                        signatureInfo.hasSignature = true;
                        signatureInfo.signatureType = 'manager_signature';
                        signatureInfo.isReusedSignature = false;
                        // Nếu có thông tin người phê duyệt và là MANAGER, lấy thông tin đó
                        if (data.approver_info && data.approver_info.roles && data.approver_info.roles.includes('MANAGER')) {
                            signatureInfo.signerName = data.approver_info.name;
                            signatureInfo.signerRole = 'MANAGER';
                            signatureInfo.signerEmployeeId = data.approver_info.employee_id;
                            signatureInfo.signerDepartment = data.approver_info.department;
                        }
                    } else if (data.team_leader_signature) {
                        // Sử dụng chữ ký team leader (vai trò thấp hơn)
                        signatureInfo.hasSignature = true;
                        signatureInfo.signatureType = 'team_leader_signature';
                        signatureInfo.isReusedSignature = true;
                        signatureInfo.signerName = data.approver_info?.name || currentUserName;
                        signatureInfo.signerRole = 'TEAM_LEADER';
                        signatureInfo.signerEmployeeId = data.approver_info?.employee_id;
                        signatureInfo.signerDepartment = data.approver_info?.department;
                    } else if (data.signature) {
                        // Sử dụng chữ ký employee (vai trò thấp nhất)
                        signatureInfo.hasSignature = true;
                        signatureInfo.signatureType = 'employee_signature';
                        signatureInfo.isReusedSignature = true;
                        signatureInfo.signerName = data.user_name || currentUserName;
                        signatureInfo.signerRole = 'EMPLOYEE';
                        signatureInfo.signerEmployeeId = data.user_employee_id;
                        signatureInfo.signerDepartment = data.user_department;
                    }
                } else {
                    // EMPLOYEE - chỉ sử dụng chữ ký employee
                    signatureInfo.hasSignature = !!data.signature;
                    signatureInfo.signatureType = 'employee_signature';
                    signatureInfo.isReusedSignature = false;
                    // Đối với EMPLOYEE, lấy thông tin từ user
                    if (data.user_name) {
                        signatureInfo.signerName = data.user_name;
                        signatureInfo.signerRole = 'EMPLOYEE';
                        signatureInfo.signerEmployeeId = data.user_employee_id;
                        signatureInfo.signerDepartment = data.user_department;
                    }
                }

                // Lấy thời gian phê duyệt nếu có
                if (data.approved_at) {
                    const approvedDate = new Date(data.approved_at);
                    signatureInfo.signDate = approvedDate.toLocaleDateString('vi-VN') + ' ' + approvedDate.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                }

                console.log('DEBUG: Signature info result:', signatureInfo);
                console.log('🔍 SIGNATURE DETAILS: Found signature for', signatureInfo.signerName, `(${signatureInfo.signerRole})`, signatureInfo.hasSignature ? 'with signature' : 'without signature', signatureInfo.isReusedSignature ? '(REUSED)' : '(ORIGINAL)');

                return signatureInfo;
            } catch (error) {
                console.error('❌ ERROR GETTING SIGNATURE INFO:', error);
                return {
                    signerName: 'Unknown',
                    signerRole: 'Unknown',
                    signDate: null,
                    hasSignature: false,
                    signatureType: null,
                    isReusedSignature: false
                };
            }
        }



        // Debug chữ ký
        async function debugSignature(attendanceId) {
            try {
                const response = await fetch(`/api/signature/debug/${attendanceId}`);
                const data = await response.json();

                if (data.error) {
                    showToast(data.error, 'error');
                    return;
                }

                // Hiển thị thông tin debug trong modal
                const debugHtml = `
                    <div style="text-align: left; max-width: 600px;">
                        <h5>Thông tin chữ ký cho bản ghi #${data.attendance_id}</h5>
                        
                        <div style="margin: 15px 0;">
                            <h6>Chữ ký nhân viên:</h6>
                            <ul>
                                <li>Tồn tại: ${data.employee_signature.exists ? 'Có' : 'Không'}</li>
                                <li>Độ dài: ${data.employee_signature.length}</li>
                                <li>Kiểu dữ liệu: ${data.employee_signature.type || 'N/A'}</li>
                                <li>Bắt đầu với data:image: ${data.employee_signature.starts_with_data_image ? 'Có' : 'Không'}</li>
                                <li>Xử lý thành công: ${data.employee_signature.processed ? 'Có' : 'Không'}</li>
                            </ul>
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <h6>Chữ ký trưởng nhóm:</h6>
                            <ul>
                                <li>Tồn tại: ${data.team_leader_signature.exists ? 'Có' : 'Không'}</li>
                                <li>Độ dài: ${data.team_leader_signature.length}</li>
                                <li>Kiểu dữ liệu: ${data.team_leader_signature.type || 'N/A'}</li>
                                <li>Bắt đầu với data:image: ${data.team_leader_signature.starts_with_data_image ? 'Có' : 'Không'}</li>
                                <li>Xử lý thành công: ${data.team_leader_signature.processed ? 'Có' : 'Không'}</li>
                            </ul>
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <h6>Chữ ký quản lý:</h6>
                            <ul>
                                <li>Tồn tại: ${data.manager_signature.exists ? 'Có' : 'Không'}</li>
                                <li>Độ dài: ${data.manager_signature.length}</li>
                                <li>Kiểu dữ liệu: ${data.manager_signature.type || 'N/A'}</li>
                                <li>Bắt đầu với data:image: ${data.manager_signature.starts_with_data_image ? 'Có' : 'Không'}</li>
                                <li>Xử lý thành công: ${data.manager_signature.processed ? 'Có' : 'Không'}</li>
                            </ul>
                        </div>
                    </div>
                `;

                Swal.fire({
                    title: 'Debug Chữ ký',
                    html: debugHtml,
                    width: 700,
                    confirmButtonText: 'Đóng',
                    showCloseButton: true
                });

            } catch (error) {
                console.error('Error debugging signature:', error);
                showToast('Lỗi khi debug chữ ký', 'error');
            }
        }

        // Hàm test hiển thị chữ ký
        async function testSignatureDisplay() {
            try {
                // Lấy chữ ký cá nhân từ session hoặc tạo chữ ký mẫu
                let employeeSignature = '';
                let teamLeaderSignature = '';
                let managerSignature = '';

                // Thử lấy chữ ký cá nhân từ user
                const currentUser = {
                    name: '{{ session.get("name", "Test User") }}',
                    employee_id: '{{ session.get("employee_id", "TEST001") }}',
                    department: '{{ session.get("department", "TEST") }}'
                };

                // Tạo chữ ký mẫu đơn giản
                const sampleSignature = createSampleSignature();

                // Sử dụng chữ ký mẫu cho cả 3 vai trò
                employeeSignature = sampleSignature;
                teamLeaderSignature = sampleSignature;
                managerSignature = sampleSignature;

                // Tạo form data
                const formData = new FormData();
                formData.append('employee_signature', employeeSignature);
                formData.append('team_leader_signature', teamLeaderSignature);
                formData.append('manager_signature', managerSignature);
                formData.append('test_date', new Date().toISOString().split('T')[0]);
                formData.append('test_note', 'Test hiển thị chữ ký từ form phê duyệt');
                formData.append('user_name', currentUser.name);
                formData.append('user_employee_id', currentUser.employee_id);
                formData.append('user_department', currentUser.department);

                // Gửi request tạo PDF
                const response = await fetch('/signature-test/download-pdf', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'test_chu_ky_phieu_duyet_' + new Date().toISOString().split('T')[0] + '.pdf';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    showToast('Đã tạo PDF test chữ ký thành công!', 'success');
                } else {
                    const errorText = await response.text();
                    throw new Error('Server error: ' + errorText);
                }

            } catch (error) {
                console.error('Error testing signature display:', error);
                showToast('Có lỗi khi tạo PDF test: ' + error.message, 'error');
            }
        }

        // Hàm tạo chữ ký mẫu
        function createSampleSignature() {
            const canvas = document.createElement('canvas');
            canvas.width = 200;
            canvas.height = 100;
            const ctx = canvas.getContext('2d');

            // Vẽ nền trắng
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, 200, 100);

            // Vẽ chữ ký mẫu
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(20, 50);
            ctx.lineTo(40, 30);
            ctx.lineTo(60, 70);
            ctx.lineTo(80, 40);
            ctx.lineTo(100, 60);
            ctx.lineTo(120, 35);
            ctx.lineTo(140, 65);
            ctx.lineTo(160, 45);
            ctx.lineTo(180, 55);
            ctx.stroke();

            return canvas.toDataURL();
        }

        // Kiểm tra chữ ký cá nhân khi load trang
        document.addEventListener('DOMContentLoaded', function () {
            // Kiểm tra xem user đã có chữ ký cá nhân chưa (đọc từ script[type=application/json])
            let hasSignature = false;
            try {
                const el = document.getElementById('has-signature-data');
                if (el && el.textContent && el.textContent.trim()) {
                    hasSignature = JSON.parse(el.textContent.trim());
                }
            } catch (error) {
                console.warn('Error parsing has-signature-data:', error);
                hasSignature = false;
            }

            if (!hasSignature) {
                // Hiển thị thông báo yêu cầu tạo chữ ký - BẮT BUỘC
                Swal.fire({
                    title: 'Thiết lập chữ ký cá nhân',
                    html: `
                        <div style="text-align: center;">
                            <i class="fas fa-signature" style="font-size: 3rem; color: #e74c3c; margin-bottom: 1rem;"></i>
                            <p style="font-size: 1.1rem; margin-bottom: 1rem; color: #2c3e50;">
                                <strong>Bạn chưa có chữ ký cá nhân!</strong>
                            </p>
                            <p style="font-size: 1rem; margin-bottom: 1rem; color: #34495e;">
                                Chữ ký này sẽ được sử dụng khi bạn đăng ký chấm công hoặc phê duyệt các bản ghi chấm công.
                            </p>
                            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 15px 0;">
                                <p style="margin: 0; color: #856404; font-weight: 600;">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Vui lòng thiết lập chữ ký ngay để có thể sử dụng đầy đủ chức năng của hệ thống.
                                </p>
                            </div>
                        </div>
                    `,
                    icon: 'warning',
                    showCancelButton: false,
                    confirmButtonText: 'Thiết lập ngay',
                    confirmButtonColor: '#e74c3c',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                }).then((result) => {
                    // Chuyển hướng đến trang settings
                    window.location.href = '/settings';
                });
            }
        });

        // Hàm cập nhật số lượng đơn nghỉ phép cần phê duyệt
        async function updatePendingLeaveCount() {
            try {
                const response = await fetch('/api/pending-leave-count');
                if (response.ok) {
                    const data = await response.json();
                    const pendingCount = data.count || 0;
                    const badge = document.getElementById('pendingLeaveCount');

                    if (badge) {
                        if (pendingCount > 0) {
                            badge.textContent = pendingCount;
                            badge.style.display = 'inline-block';
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                }
            } catch (error) {
                console.error('Error updating pending leave count:', error);
            }
        }

        // ========== TOKEN STATUS MANAGEMENT (Admin Only) ==========
        let tokenStatus = null;
        let tokenEventSource = null;
        let isAdmin = false;

        // Kiểm tra xem user có phải admin không
        function checkIfAdmin() {
            const roleSelect = document.getElementById('role-select');
            if (roleSelect) {
                isAdmin = roleSelect.value === 'ADMIN';
                return isAdmin;
            }
            // Fallback: check from JSON data block
            const adminCheckEl = document.getElementById('admin-check-data');
            if (adminCheckEl) {
                try {
                    isAdmin = JSON.parse(adminCheckEl.textContent.trim());
                } catch (e) {
                    isAdmin = false;
                }
            }
            return isAdmin;
        }

        // Cập nhật UI dựa trên token status
        function updateTokenStatusUI(status) {
            tokenStatus = status;
            const isLicenseWarning = status && typeof status.message === 'string' &&
                (status.message.includes('ỨNG DỤNG CHẤM CÔNG') || status.message.includes('LICENSE'));

            const banner = document.getElementById('tokenStatusBanner');
            const alert = document.getElementById('tokenStatusAlert');
            const title = document.getElementById('tokenStatusTitle');
            const message = document.getElementById('tokenStatusMessage');
            const icon = document.getElementById('tokenStatusIcon');
            const refreshBtn = document.getElementById('btnRefreshToken');

            if (!banner) {
                console.warn('Token status banner not found');
                return;
            }

            // Nếu là cảnh báo LICENSE và user vừa tắt banner trong vòng 60s thì không hiển thị lại
            if (isLicenseWarning) {
                try {
                    const lastDismiss = localStorage.getItem('licenseBannerDismissedAt');
                    const lastTs = lastDismiss ? parseInt(lastDismiss, 10) : 0;
                    const now = Date.now();
                    if (lastTs && (now - lastTs) < 60000) {
                        banner.style.display = 'none';
                        return;
                    }
                } catch (e) {
                    console.warn('Could not read license banner dismiss state:', e);
                }

                // Trường hợp cảnh báo LICENSE: hiển thị cho TẤT CẢ người dùng, không khóa chức năng
                banner.style.display = 'block';
                alert.className = 'alert alert-warning alert-dismissible fade show shadow-sm';
                icon.className = 'fas fa-exclamation-circle me-2';
                icon.style.color = '#856404';
                title.textContent = '⚠️ Ứng dụng sắp hết hạn LICENSE';
                title.style.color = '#856404';

                const rawMsg = status.message || '';
                // Giữ xuống dòng đẹp mắt
                message.innerHTML = rawMsg.replace(/\n/g, '<br>');
                message.style.color = '#856404';

                // Ẩn hoàn toàn nút Refresh Token vì đây là cảnh báo LICENSE, không phải lỗi token Google
                if (refreshBtn) {
                    refreshBtn.style.display = 'none';
                }

                // Không vô hiệu hóa các nút phê duyệt cho cảnh báo license sắp hết hạn
                return;
            }

            // Các trường hợp TOKEN GOOGLE khác: chỉ dành cho admin như cũ
            if (!isAdmin) {
                banner.style.display = 'none';
                return;
            }

            const isValid = status.valid && status.can_approve;
            const needsReauth = status.needs_reauth;

            if (!isValid) {
                // Token hết hạn hoặc không hợp lệ - HIỂN THỊ banner
                banner.style.display = 'block';
                alert.className = 'alert alert-danger alert-dismissible fade show shadow-sm';
                icon.className = 'fas fa-exclamation-triangle me-2';
                icon.style.color = '#dc3545';
                title.textContent = '⚠️ Token Google API hết hạn';
                title.style.color = '#721c24';
                message.textContent = status.message || 'Token không hợp lệ. Vui lòng refresh token trước khi phê duyệt.';
                message.style.color = '#721c24';
                // CHỈ hiển thị nút refresh khi token hết hạn
                if (refreshBtn) {
                    refreshBtn.style.display = 'inline-flex';
                    refreshBtn.className = 'btn btn-sm btn-primary';
                    refreshBtn.disabled = false;
                    console.log('[TokenStatus] Refresh button shown and enabled');
                } else {
                    console.warn('[TokenStatus] Refresh button not found when trying to show it');
                }

                // Vô hiệu hóa các nút phê duyệt
                disableApprovalButtons(true);
            } else {
                // Token hợp lệ - ẨN banner hoàn toàn
                banner.style.display = 'none';

                // Kích hoạt lại các nút phê duyệt
                disableApprovalButtons(false);
            }
        }

        // Vô hiệu hóa/kích hoạt các nút phê duyệt
        function disableApprovalButtons(disable) {
            const approveButtons = document.querySelectorAll('.approve-attendance-btn, #btnBulkApprove');
            approveButtons.forEach(btn => {
                if (disable) {
                    btn.disabled = true;
                    btn.classList.add('disabled');
                    btn.title = 'Token Google API hết hạn. Vui lòng refresh token trước khi phê duyệt.';
                } else {
                    btn.disabled = false;
                    btn.classList.remove('disabled');
                    btn.title = btn.getAttribute('data-original-title') || 'Phê duyệt';
                }
            });
        }

        // Kết nối SSE để nhận cập nhật token status real-time
        function connectTokenStatusSSE() {
            if (tokenEventSource) {
                tokenEventSource.close();
            }

            tokenEventSource = new EventSource('/sse/token-status');

            tokenEventSource.addEventListener('token_status', function (event) {
                try {
                    const status = JSON.parse(event.data);
                    updateTokenStatusUI(status);
                } catch (error) {
                    console.error('Error parsing token status:', error);
                }
            });

            tokenEventSource.onerror = function (error) {
                console.error('SSE connection error:', error);
                // Thử kết nối lại sau 5 giây
                setTimeout(connectTokenStatusSSE, 5000);
            };
        }

        // Lấy token status ban đầu
        async function fetchTokenStatus(force = false) {
            // Kiểm tra lại admin status
            checkIfAdmin();

            if (!isAdmin) {
                const banner = document.getElementById('tokenStatusBanner');
                if (banner) {
                    banner.style.display = 'none';
                }
                return;
            }

            // Không hiển thị banner khi đang loading, chỉ hiển thị khi có kết quả
            const banner = document.getElementById('tokenStatusBanner');
            if (banner && isAdmin) {
                // Ẩn banner khi đang loading
                banner.style.display = 'none';
            }

            try {
                const url = force ? '/api/token/status?force=1' : '/api/token/status';
                const response = await fetch(url);
                if (response.ok) {
                    const status = await response.json();
                    console.log('Token status received:', status);
                    updateTokenStatusUI(status);
                } else {
                    // Nếu API lỗi, hiển thị cảnh báo
                    updateTokenStatusUI({
                        valid: false,
                        can_approve: false,
                        needs_reauth: true,
                        message: 'Không thể kiểm tra trạng thái token. Vui lòng thử lại.'
                    });
                }
            } catch (error) {
                console.error('Error fetching token status:', error);
                // Hiển thị lỗi
                updateTokenStatusUI({
                    valid: false,
                    can_approve: false,
                    needs_reauth: true,
                    message: 'Lỗi kết nối khi kiểm tra token. Vui lòng thử lại.'
                });
            }
        }

        // Refresh token - Mở Chrome để ủy quyền
        async function refreshToken() {
            console.log('[RefreshToken] Function called');
            console.log('[RefreshToken] Current tokenStatus:', tokenStatus);

            // Kiểm tra token status trước khi mở Chrome
            if (tokenStatus && tokenStatus.valid && tokenStatus.can_approve) {
                console.log('[RefreshToken] Token still valid, skipping');
                if (typeof showToast === 'function') {
                    showToast('Token vẫn còn hiệu lực, không cần refresh.', 'info');
                } else {
                    alert('Token vẫn còn hiệu lực, không cần refresh.');
                }
                return;
            }

            const refreshBtn = document.getElementById('btnRefreshToken');
            console.log('[RefreshToken] Refresh button:', refreshBtn);
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Đang mở Chrome...';
            }

            try {
                // Lấy CSRF token
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                console.log('[RefreshToken] CSRF token:', csrfToken ? 'Found' : 'Not found');

                console.log('[RefreshToken] Calling /api/token/authorize...');
                // Gọi API để mở Chrome cho OAuth authorization
                const response = await fetch('/api/token/authorize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                });

                console.log('[RefreshToken] Response status:', response.status);
                console.log('[RefreshToken] Response ok:', response.ok);

                // Kiểm tra content-type trước khi parse JSON
                const contentType = response.headers.get('content-type');
                let data;

                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Non-JSON response:', text.substring(0, 200));
                    throw new Error('Server trả về response không hợp lệ. Vui lòng thử lại.');
                }

                console.log('[RefreshToken] Response data:', data);

                if (response.ok && data.success) {
                    console.log('[RefreshToken] Success! Auth URL:', data.auth_url);
                    if (typeof showToast === 'function') {
                        showToast(data.message || 'Đã mở Chrome để ủy quyền. Vui lòng hoàn tất quá trình ủy quyền trong Chrome.', 'info');
                    } else {
                        alert(data.message || 'Đã mở Chrome để ủy quyền. Vui lòng hoàn tất quá trình ủy quyền trong Chrome.');
                    }

                    // Nếu có URL, mở trong tab mới
                    if (data.auth_url) {
                        console.log('[RefreshToken] Opening URL in new tab:', data.auth_url);
                        window.open(data.auth_url, '_blank');
                    } else {
                        console.warn('[RefreshToken] No auth_url in response');
                    }

                    // Sau khi mở Chrome, đợi một chút rồi check lại status (force)
                    setTimeout(async () => {
                        console.log('[RefreshToken] Checking token status after 3 seconds (force)...');
                        await fetchTokenStatus(true);
                    }, 3000);
                } else {
                    console.error('[RefreshToken] API returned error:', data);
                    const errorMsg = data.message || data.error || 'Không thể mở Chrome để ủy quyền. Vui lòng thử lại.';
                    if (typeof showToast === 'function') {
                        showToast(errorMsg, 'error');
                    } else {
                        alert(errorMsg);
                    }
                }
            } catch (error) {
                console.error('[RefreshToken] Error opening Chrome for authorization:', error);
                console.error('[RefreshToken] Error stack:', error.stack);
                const errorMsg = error.message || 'Lỗi khi mở Chrome để ủy quyền. Vui lòng thử lại.';
                if (typeof showToast === 'function') {
                    showToast(errorMsg, 'error');
                } else {
                    alert(errorMsg);
                }
            } finally {
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Refresh Token';
                }
            }
        }

        // Khởi tạo token status management khi trang load
        document.addEventListener('DOMContentLoaded', function () {
            // Ẩn banner mặc định
            const banner = document.getElementById('tokenStatusBanner');
            if (banner) {
                banner.style.display = 'none';
            }

            // Kiểm tra admin ngay khi load
            checkIfAdmin();

            // 0) Áp dụng trạng thái LICENSE được preload từ server (nếu có) để hiển thị banner gần như ngay lập tức
            try {
                const initEl = document.getElementById('license-warning-init');
                if (initEl && initEl.textContent.trim()) {
                    const initState = JSON.parse(initEl.textContent);
                    if (initState && initState.active && initState.payload) {
                        updateTokenStatusUI(initState.payload);
                    }
                }
            } catch (e) {
                console.warn('Could not apply preloaded license warning state:', e);
            }

            // 1) Luôn kết nối SSE CHO TẤT CẢ USER để mọi người đều nhận được cảnh báo LICENSE realtime
            // Kết nối SSE CHO TẤT CẢ USER để mọi người đều nhận được cảnh báo LICENSE
            connectTokenStatusSSE();

            // 2) Gọi API lấy trạng thái LICENSE gần nhất để hiển thị NGAY khi load (không đợi SSE)
            (async function initLicenseWarning() {
                try {
                    const resp = await fetch('/api/license/warning-status');
                    if (!resp.ok) return;
                    const data = await resp.json();
                    if (data && data.active && data.payload) {
                        updateTokenStatusUI(data.payload);
                    }
                } catch (e) {
                    console.warn('Could not fetch initial license warning status:', e);
                }
            })();

            if (isAdmin) {
                console.log('Admin detected, initializing token status management...');
                // Fetch token status ban đầu (chỉ admin mới cần check token Google)
                fetchTokenStatus();

                // Lắng nghe sự kiện refresh token button
                const refreshBtn = document.getElementById('btnRefreshToken');
                console.log('[TokenStatus] Setting up refresh button listener, button found:', !!refreshBtn);
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', function (e) {
                        console.log('[TokenStatus] Refresh button clicked!');
                        e.preventDefault();
                        e.stopPropagation();
                        refreshToken();
                    });
                    console.log('[TokenStatus] Refresh button listener attached');
                } else {
                    console.warn('[TokenStatus] Refresh button not found!');
                }

                // Lắng nghe postMessage từ tab ủy quyền (local server success page)
                window.addEventListener('message', async (event) => {
                    if (event?.data?.type === 'token_authorized') {
                        console.log('[TokenStatus] Received token_authorized message. Forcing status refresh...');
                        await fetchTokenStatus(true);
                    }
                });

                // Fallback: poll trạng thái token mỗi 10 giây nếu SSE bị ngắt
                setInterval(() => {
                    fetchTokenStatus();
                }, 10000);
            }

            // 3) Khi người dùng bấm nút đóng (X), lưu thời gian để ẩn banner trong 60 giây
            const closeBtn = document.querySelector('#tokenStatusBanner .btn-close');
            if (closeBtn) {
                closeBtn.addEventListener('click', function () {
                    try {
                        // Lưu thời gian user tắt banner
                        localStorage.setItem('licenseBannerDismissedAt', Date.now().toString());
                    } catch (e) {
                        console.warn('Could not store license banner dismiss time:', e);
                    }

                    // Sau 60 giây, tự động gọi lại updateTokenStatusUI với trạng thái mới nhất
                    // để banner có cơ hội xuất hiện lại nếu LICENSE vẫn sắp hết hạn.
                    setTimeout(function () {
                        try {
                            // Hết 60s thì xoá trạng thái dismiss để không bị chặn nữa
                            localStorage.removeItem('licenseBannerDismissedAt');
                            if (tokenStatus) {
                                updateTokenStatusUI(tokenStatus);
                            }
                        } catch (e) {
                            console.warn('Could not re-show license banner after 60s:', e);
                        }
                    }, 60000);
                });
            }

            // Lắng nghe thay đổi role để ẩn/hiện banner
            const roleSelect = document.getElementById('role-select');
            if (roleSelect) {
                roleSelect.addEventListener('change', function () {
                    const wasAdmin = isAdmin;
                    checkIfAdmin();
                    if (!isAdmin && wasAdmin) {
                        // Không còn là admin, ẩn banner và đóng SSE
                        const banner = document.getElementById('tokenStatusBanner');
                        if (banner) banner.style.display = 'none';
                        if (tokenEventSource) {
                            tokenEventSource.close();
                            tokenEventSource = null;
                        }
                    } else if (isAdmin && !wasAdmin) {
                        // Trở thành admin, hiển thị banner và kết nối SSE
                        console.log('Role changed to ADMIN, initializing token status...');
                        fetchTokenStatus();
                        connectTokenStatusSSE();
                    } else if (isAdmin) {
                        // Vẫn là admin, refresh status
                        fetchTokenStatus();
                    } else {
                        // Không phải admin, ẩn banner
                        const banner = document.getElementById('tokenStatusBanner');
                        if (banner) banner.style.display = 'none';
                    }
                });
            }
        });

        // Cleanup khi trang đóng
        window.addEventListener('beforeunload', function () {
            if (tokenEventSource) {
                tokenEventSource.close();
            }
        });

    </script>
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <script>showToast("{{ message }}", "{{ category }}");</script>
    {% endfor %}
    {% endif %}
    {% endwith %}
</body>

</html>