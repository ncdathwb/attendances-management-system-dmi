<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <script>
        console.log('DEBUG: CSRF Token from template:', '{{ csrf_token() }}');
    </script>
    <!-- Data block for admin check - prevents VS Code Jinja2 syntax errors -->
    <script type="application/json"
        id="admin-check-data">{{ 'true' if 'ADMIN' in session.get('roles', []) else 'false' }}</script>
    <!-- Preloaded LICENSE warning state to show banner immediately on first load -->
    <script type="application/json" id="license-warning-init">
        {{ license_warning_state_json | safe }}
    </script>
    <title>Dashboard - H·ªá th·ªëng Ch·∫•m c√¥ng</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- SweetAlert2 -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <!-- Enhanced Error Handler -->
    <script src="{{ url_for('static', filename='js/error-handler.js') }}"></script>
    <!-- Global Email Notification -->
    <script src="{{ url_for('static', filename='js/global-email-notification.js') }}"></script>
    <!-- Th√™m flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Role Switch Controls CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/role-switch-controls.css') }}?v=20250107003">
    <!-- Search Filter CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/search-filter.css') }}">
    <!-- Dashboard CSS (includes sidebar styles) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <!-- Global Icon Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/icons.css') }}">
</head>

<body>
    <!-- Mobile Menu Toggle Button -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="M·ªü menu">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <!-- Close button for mobile -->
        <button class="sidebar-close" id="sidebarClose" aria-label="ƒê√≥ng menu">
            <i class="fas fa-times"></i>
        </button>
        <div class="sidebar-header">
            <h3><i class="fas fa-clock"></i>Ch·∫•m c√¥ng</h3>
        </div>
        <div class="user-profile">
            <div class="user-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="user-info">
                <h4>{{ user.name }}</h4>
                <p>M√£ NV: {{ user.employee_id }}</p>
                <p>{{ user.department }}</p>
                <!-- Hidden element for JavaScript to get current user name -->
                <span id="current-user-name" style="display: none;">{{ user.name }}</span>
                <div class="role-switcher" style="margin-top:10px;">
                    <label for="role-select" style="font-weight:500;">Vai tr√≤ hi·ªán t·∫°i:</label>
                    <select id="role-select" class="form-select form-select-sm" style="margin-top:4px;">
                        {% set current_role = session.get('current_role', user.roles.split(',')[0]) %}
                        <!-- DEBUG: current_role = {{ current_role }}, user.roles = {{ user.roles }} -->
                        {% for role in user.roles.split(',') %}
                        <option value="{{ role }}" {% if role==current_role %}selected{% endif %}>
                            {% if role == 'EMPLOYEE' %}Nh√¢n vi√™n{% elif role == 'TEAM_LEADER' %}Tr∆∞·ªüng nh√≥m{% elif role
                            == 'MANAGER' %}Qu·∫£n l√Ω{% elif role == 'ADMIN' %}Qu·∫£n tr·ªã vi√™n{% else %}{{ role }}{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="#" class="nav-link active">
                    <i class="fas fa-home"></i>
                    Trang ch·ªß
                </a>
            </li>
            {% if 'ADMIN' in session.get('roles', []) %}
            <li class="nav-item" id="adminUsersMenu" style="display: none;">
                <a href="{{ url_for('admin_users') }}" class="nav-link">
                    <i class="fas fa-users"></i>
                    Qu·∫£n l√Ω ng∆∞·ªùi d√πng
                </a>
            </li>
            <li class="nav-item" id="adminHolidaysMenu" style="display: none;">
                <a href="{{ url_for('admin_holidays') }}" class="nav-link">
                    <i class="fas fa-calendar-alt"></i>
                    Qu·∫£n l√Ω ng√†y l·ªÖ
                </a>
            </li>
            <li class="nav-item" id="adminLeaveHistoryAllMenu" style="display: none;">
                <a href="{{ url_for('leave_history') }}" class="nav-link">
                    <i class="fas fa-clipboard-list"></i>
                    L·ªãch s·ª≠ ngh·ªâ ph√©p
                </a>
            </li>
            {% endif %}
            <li class="nav-item" id="attendanceHistoryMenuWrapper" style="display: none;">
                <a href="#" class="nav-link" id="attendanceHistoryMenu">
                    <i class="fas fa-calendar-alt"></i>
                    L·ªãch s·ª≠ ch·∫•m c√¥ng
                </a>
            </li>
            <!-- Menu ngh·ªâ ph√©p cho nh√¢n vi√™n -->
            <li class="nav-item" id="employeeLeaveMenu" style="display: none;">
                <a href="{{ url_for('leave_request_form') }}" class="nav-link">
                    <i class="fas fa-calendar-plus"></i>
                    ƒêƒÉng k√Ω ngh·ªâ ph√©p
                </a>
            </li>
            <li class="nav-item position-relative" id="employeeLeaveStatusMenu" style="display: none;">
                <a href="{{ url_for('leave_requests_list') }}" class="nav-link">
                    <i class="fas fa-list-alt"></i>
                    Theo d√µi t√¨nh tr·∫°ng
                    {% if leave_requests %}
                    {% set rejected_count_sidebar = leave_requests|selectattr('status','equalto','rejected')|list|length
                    %}
                    {% if rejected_count_sidebar > 0 %}
                    <span class="badge bg-danger position-absolute" style="right: 12px; top: 8px;">{{
                        rejected_count_sidebar }}</span>
                    {% endif %}
                    {% endif %}
                </a>
            </li>
            <li class="nav-item" id="employeeLeaveHistoryMenu" style="display: none;">
                <a href="{{ url_for('leave_history') }}" class="nav-link">
                    <i class="fas fa-history"></i>
                    L·ªãch s·ª≠ ngh·ªâ ph√©p
                </a>
            </li>

            <!-- Menu ngh·ªâ ph√©p c·∫ßn ph√™ duy·ªát cho tr∆∞·ªüng nh√≥m/qu·∫£n l√Ω/qu·∫£n tr·ªã vi√™n -->
            <li class="nav-item" id="managerLeaveMenu" style="display: none;">
                <a href="{{ url_for('leave_requests_list') }}" class="nav-link position-relative">
                    <i class="fas fa-calendar-check"></i>
                    Ngh·ªâ ph√©p c·∫ßn ph√™ duy·ªát
                    <span id="pendingLeaveCount"
                        class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                        style="display: none;">
                        0
                    </span>
                </a>
            </li>

            <!-- Menu danh s√°ch ƒë∆°n ngh·ªâ ph√©p v√† b√°o c√°o ƒë√£ ƒë∆∞·ª£c ·∫©n theo y√™u c·∫ßu -->
            {# Menu C√†i ƒë·∫∑t - s·∫Ω ƒë∆∞·ª£c JavaScript ƒëi·ªÅu khi·ªÉn hi·ªÉn th·ªã/·∫©n d·ª±a tr√™n role #}
            <li class="nav-item" id="settingsMenu">
                <a href="{{ url_for('settings') }}" class="nav-link">
                    <i class="fas fa-user-cog"></i>
                    C√†i ƒë·∫∑t
                </a>
            </li>





            <li class="nav-item">
                <a href="/logout" class="nav-link">
                    <i class="fas fa-sign-out-alt"></i>
                    ƒêƒÉng xu·∫•t
                </a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container-fluid p-0">
            <div class="page-header">
                <h1 class="page-title">B·∫£ng ƒëi·ªÅu khi·ªÉn</h1>
            </div>

            <!-- Token Status Banner (Admin Only) -->
            <div id="tokenStatusBanner"
                style="display: none; margin: 20px 15px; position: sticky; top: 10px; z-index: 1000;">
                <div class="alert alert-info alert-dismissible fade show shadow-sm" role="alert" id="tokenStatusAlert"
                    style="margin-bottom: 0;">
                    <div class="d-flex align-items-center flex-wrap">
                        <i class="fas fa-spinner fa-spin me-2" id="tokenStatusIcon" style="font-size: 1.2rem;"></i>
                        <div class="flex-grow-1 me-3">
                            <strong id="tokenStatusTitle" style="font-size: 1rem;">ƒêang ki·ªÉm tra tr·∫°ng th√°i Token Google
                                API...</strong>
                            <div id="tokenStatusMessage" class="mt-1" style="font-size: 0.9rem;">Vui l√≤ng ƒë·ª£i trong gi√¢y
                                l√°t...</div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            {#
                            N√∫t Refresh Token ch·ªâ xu·∫•t hi·ªán khi:
                            - ƒêANG ·ªû VAI TR√í ADMIN (current_role == 'ADMIN')
                            - V√† ·ªü ph√≠a JS, ch·ªâ hi·ªÉn th·ªã khi token Google h·∫øt h·∫°n / kh√¥ng h·ª£p l·ªá.
                            ƒêi·ªÅu n√†y gi·ªØ nguy√™n logic c≈©: nh√¢n vi√™n ho·∫∑c khi token c√≤n h·∫°n s·∫Ω kh√¥ng th·∫•y n√∫t.
                            #}
                            {% if current_role == 'ADMIN' %}
                            <button type="button" class="btn btn-sm btn-primary" id="btnRefreshToken"
                                style="display: none; white-space: nowrap;">
                                <i class="fas fa-sync-alt me-1"></i>Refresh Token
                            </button>
                            {% endif %}
                            <button type="button" class="btn-close" aria-label="Close"></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-cards" style="display:none;">
                <div class="stat-card">
                    <div class="icon" style="background-color: rgba(52, 152, 219, 0.1); color: var(--accent-color);">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="title">Ng√†y l√†m vi·ªác trong th√°ng</div>
                    <div class="value">22</div>
                </div>
                <div class="stat-card">
                    <div class="icon" style="background-color: rgba(46, 204, 113, 0.1); color: var(--success-color);">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="title">Gi·ªù l√†m vi·ªác trong th√°ng</div>
                    <div class="value">176</div>
                </div>
                <div class="stat-card">
                    <div class="icon" style="background-color: rgba(241, 196, 15, 0.1); color: var(--warning-color);">
                        <i class="fas fa-calendar-minus"></i>
                    </div>
                    <div class="title">Ng√†y ngh·ªâ c√≤n l·∫°i</div>
                    <div class="value">12</div>
                </div>
            </div>

            <!-- Attendance Form - Hi·ªÉn th·ªã ƒë·ªông theo vai tr√≤ -->
            <div class="attendance-form" id="attendanceFormSection" style="display: none;">
                <h4 class="mb-4"><i class="fas fa-clock me-2"></i>ƒêƒÉng k√Ω ch·∫•m c√¥ng</h4>
                <form id="attendanceForm">
                    <div class="row g-3 align-items-end">
                        <div class="col-6 col-md">
                            <label for="attendanceDate" class="form-label">
                                <i class="fas fa-calendar me-1"></i>Ng√†y v√†o
                            </label>
                            <input type="text" class="form-control form-control-sm" id="attendanceDate" required>
                        </div>

                        <div class="col-6 col-md">
                            <label for="dayType" class="form-label">
                                <i class="fas fa-calendar-day me-1"></i>Lo·∫°i ng√†y
                            </label>
                            <select class="form-control form-control-sm" id="dayType">
                                <option value="" selected>-- Ch·ªçn lo·∫°i ng√†y --</option>
                                <option value="normal">Ng√†y th∆∞·ªùng</option>
                                <option value="weekend">Cu·ªëi tu·∫ßn</option>
                                <option value="vietnamese_holiday">L·ªÖ Vi·ªát Nam</option>
                                <option value="japanese_holiday">L·ªÖ Nh·∫≠t B·∫£n</option>
                            </select>
                        </div>
                        <div class="col-4 col-md">
                            <label for="shiftSelect" class="form-label">
                                <i class="fas fa-calendar-alt me-1"></i>Ca
                            </label>
                            <select class="form-control form-control-sm" id="shiftSelect">
                                <option value="">-- Ch·ªçn ca --</option>
                                <option value="1">Ca 1 (07:30 - 16:30)</option>
                                <option value="2">Ca 2 (09:00 - 18:00)</option>
                                <option value="3">Ca 3 (11:00 - 20:00)</option>
                                <option value="4">Ca 4 (08:00 - 17:00)</option>
                                <option value="5">Ca t·ª± do</option>
                            </select>
                        </div>
                        <div class="col-6 col-md">
                            <label for="checkInTime" class="form-label">
                                <i class="fas fa-sign-in-alt me-1"></i>Gi·ªù v√†o <small class="text-muted">(SA/AM:
                                    00:00-11:59)</small>
                            </label>
                            <input type="time" class="form-control form-control-sm" id="checkInTime" required>
                        </div>
                        <div class="col-6 col-md">
                            <label for="checkOutTime" class="form-label">
                                <i class="fas fa-clock me-1"></i>Gi·ªù ra <small class="text-muted">(CH/PM:
                                    12:00-23:59)</small>
                            </label>
                            <div class="input-group input-group-sm">
                                <!-- Explicit Date Input -->
                                <input type="text" class="form-control bg-white" id="checkoutDate"
                                    placeholder="dd/mm/yyyy" required style="flex: 1.3;">
                                <!-- Time Input -->
                                <input type="time" class="form-control" id="checkOutTime" required>
                            </div>
                        </div>
                        <div class="col-6 col-md">
                            <label for="breakTime" class="form-label">
                                <i class="fas fa-coffee me-1"></i>Gi·ªù ngh·ªâ
                            </label>
                            <input type="text" class="form-control form-control-sm" id="breakTime" value="01:00"
                                required pattern="^\\d{1,2}:[0-5]\\d$" inputmode="numeric" placeholder="HH:MM"
                                title="ƒê·ªãnh d·∫°ng HH:MM">
                        </div>
                        <div class="col-6 col-md">
                            <label for="compTimeType" class="form-label">
                                <i class="fas fa-exchange-alt me-1"></i>Lo·∫°i ƒë·ªëi ·ª©ng
                            </label>
                            <select id="compTimeType" class="form-control form-control-sm">
                                <option value="">-- Ch·ªçn lo·∫°i ƒë·ªëi ·ª©ng --</option>
                                <option value="regular">Trong ca l√†m vi·ªác</option>
                                <option value="ot_before">TƒÉng ca tr∆∞·ªõc 22h</option>
                                <option value="ot_after">TƒÉng ca sau 22h</option>
                            </select>
                        </div>
                        <div class="col-6 col-md comp-group comp-regular" style="display: none;">
                            <label for="compTimeRegular" class="form-label">
                                <i class="fas fa-clock me-1"></i>ƒê·ªëi ·ª©ng trong ca
                            </label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="compTimeRegular" value="00:00"
                                    pattern="^\\d{1,2}:[0-5]\\d$" inputmode="numeric" placeholder="HH:MM"
                                    title="ƒê·ªãnh d·∫°ng HH:MM">
                                <div class="input-group-append">
                                    <span class="input-group-text">
                                        <i class="fas fa-hourglass-half"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md comp-group comp-ot-before" style="display: none;">
                            <label for="compTimeBefore22" class="form-label">
                                <i class="fas fa-sun me-1"></i>ƒê·ªëi ·ª©ng tr∆∞·ªõc 22h
                            </label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="compTimeBefore22" value="00:00"
                                    pattern="^\\d{1,2}:[0-5]\\d$" inputmode="numeric" placeholder="HH:MM"
                                    title="ƒê·ªãnh d·∫°ng HH:MM">
                                <div class="input-group-append">
                                    <span class="input-group-text">
                                        <i class="fas fa-hourglass-start"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md comp-group comp-ot-after" style="display: none;">
                            <label for="compTimeAfter22" class="form-label">
                                <i class="fas fa-moon me-1"></i>ƒê·ªëi ·ª©ng sau 22h
                            </label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="compTimeAfter22" value="00:00"
                                    pattern="^\\d{1,2}:[0-5]\\d$" inputmode="numeric" placeholder="HH:MM"
                                    title="ƒê·ªãnh d·∫°ng HH:MM">
                                <div class="input-group-append">
                                    <span class="input-group-text">
                                        <i class="fas fa-hourglass-end"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <label for="attendanceNote" class="form-label">
                                <i class="fas fa-sticky-note me-1"></i>Ghi ch√∫
                            </label>
                            <textarea class="form-control" id="attendanceNote" rows="3"
                                placeholder="Nh·∫≠p ghi ch√∫ c·ªßa b·∫°n (t√πy ch·ªçn)...">Ch∆∞a ho√†n th√†nh c√¥ng vi·ªác</textarea>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-info border-0 shadow-sm" role="alert"
                                style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-signature me-2 text-primary" style="font-size: 1.2rem;"></i>
                                    <div>
                                        <strong class="text-primary">Ch·ªØ k√Ω t·ª± ƒë·ªông:</strong>
                                        <span class="text-muted">H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông s·ª≠ d·ª•ng ch·ªØ k√Ω c√≥ s·∫µn t·ª´ database
                                            c·ªßa b·∫°n.</span>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" name="signature" id="signature-input">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary btn-lg shadow-sm"
                                        id="saveAttendanceBtn" style="min-width: 140px;">
                                        <i class="fas fa-save me-2"></i>
                                        <span class="fw-semibold">L∆∞u ƒëƒÉng k√Ω</span>
                                    </button>
                                    <button type="button" id="cancelEditBtn" onclick="resetForm()"
                                        style="display: none !important;" class="btn btn-danger btn-lg shadow-sm">
                                        <i class="fas fa-times me-2"></i>
                                        <span class="fw-semibold">H·ªßy s·ª≠a</span>
                                    </button>
                                </div>
                                <div class="text-muted small">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <span>H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t√≠nh to√°n gi·ªù l√†m vi·ªác</span>
                                </div>
                                <input type="hidden" id="editAttendanceId">
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Attendance History - Hi·ªÉn th·ªã ƒë·ªông theo vai tr√≤ -->
            <div class="attendance-history" id="attendanceHistorySection" style="display: none;">
                <h4 class="mb-4"><i class="fas fa-history me-2"></i>L·ªãch s·ª≠ ƒëƒÉng k√Ω ch·∫•m c√¥ng th√°ng <span
                        id="currentMonth">6</span></h4>
                <div class="table-responsive" style="max-width: 100%; overflow-x: auto;">
                    <table class="table table-striped" style="table-layout: fixed;">
                        <thead>
                            <tr>
                                <th style="width: 70px;">Ng√†y</th>
                                <th style="width: 55px;">Gi·ªù v√†o</th>
                                <th style="width: 55px;">Gi·ªù ra</th>
                                <th style="width: 40px;">Ca</th>
                                <th style="width: 36px;">Ngh·ªâ</th>
                                <th style="width: 50px;">ƒê·ªëi ·ª©ng</th>
                                <th style="width: 60px;">T·ªïng gi·ªù l√†m</th>
                                <th style="width: 50px;">Gi·ªù c√¥ng</th>
                                <th style="width: 50px;">TƒÉng ca<br />tr∆∞·ªõc 22h</th>
                                <th style="width: 50px;">TƒÉng ca<br />sau 22h</th>
                                <th style="width: 80px;">Lo·∫°i ng√†y</th>
                                <th style="width: 80px;">Tr·∫°ng th√°i</th>
                                <th style="width: 120px;">Thao t√°c</th>
                                <th style="width: 120px;">Ghi ch√∫</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceHistory">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <nav>
                    <ul class="pagination justify-content-center" id="attendancePagination"></ul>
                </nav>
            </div>

            <!-- Section: L·ªãch s·ª≠ ch·∫•m c√¥ng to√†n b·ªô (ch·ªâ ADMIN) -->
            <div class="attendance-history" id="allAttendanceHistorySection" style="display:none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4><i class="fas fa-history me-2"></i>L·ªãch s·ª≠ ch·∫•m c√¥ng ƒë√£ ph√™ duy·ªát</h4>
                    <div>
                        <button class="btn btn-success btn-sm me-2" id="btnBulkRecreate" data-bs-toggle="modal"
                            data-bs-target="#bulkRecreateModal">
                            <i class="fas fa-redo me-2"></i>T·∫°o l·∫°i b·∫£n ghi
                        </button>
                        <button class="btn btn-secondary btn-sm" id="btnBackToDashboard">
                            <i class="fas fa-arrow-left me-2"></i>Tr·ªü v·ªÅ
                        </button>
                    </div>
                </div>
                <!-- Filter Section -->
                <div class="row mb-3">
                    <div class="col-auto">
                        <input type="text" id="allHistorySearchName" class="form-control form-control-sm"
                            placeholder="T√¨m theo m√£ nh√¢n vi√™n...">
                    </div>
                    <div class="col-auto">
                        <select id="allHistoryDepartment" class="form-select form-select-sm">
                            <option value="">-- Ph√≤ng ban --</option>
                            <option value="BUD A">BUD A</option>
                            <option value="BUD B">BUD B</option>
                            <option value="BUD C">BUD C</option>
                            <option value="SCOPE">SCOPE</option>
                            <option value="KIRI">KIRI</option>
                            <option value="CREEK&RIVER">CREEK&RIVER</option>
                            <option value="COMO">COMO</option>
                            <option value="OFFICE">OFFICE</option>
                            <option value="YORK">YORK</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <input type="text" id="allHistoryDateFrom" class="form-control form-control-sm"
                            placeholder="T·ª´ ng√†y">
                    </div>
                    <div class="col-auto">
                        <input type="text" id="allHistoryDateTo" class="form-control form-control-sm"
                            placeholder="ƒê·∫øn ng√†y">
                    </div>
                    <div class="col-auto">
                        <select id="allHistoryMonthFrom" class="form-select form-select-sm">
                            <option value="">Th√°ng t·ª´</option>
                            {% for m in range(1,13) %}
                            <option value="{{m}}">Th√°ng {{m}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-auto">
                        <select id="allHistoryMonthTo" class="form-select form-select-sm">
                            <option value="">Th√°ng ƒë·∫øn</option>
                            {% for m in range(1,13) %}
                            <option value="{{m}}">Th√°ng {{m}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-auto">
                        <input type="number" id="allHistoryYearFrom" class="form-control form-control-sm"
                            placeholder="NƒÉm t·ª´" min="2000" max="2100" style="width: 90px;">
                    </div>
                    <div class="col-auto">
                        <input type="number" id="allHistoryYearTo" class="form-control form-control-sm"
                            placeholder="NƒÉm ƒë·∫øn" min="2000" max="2100" style="width: 90px;">
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-primary btn-sm" id="btnAllHistoryFilter">L·ªçc</button>
                        <button class="btn btn-secondary btn-sm" id="btnAllHistoryReset">ƒê·∫∑t l·∫°i</button>
                    </div>
                </div>
                <!-- Bulk Export Section -->
                <div class="row mb-3" id="bulkExportSection" style="display: none;">
                    <div class="col-12">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-download me-2"></i>Xu·∫•t tƒÉng ca h√†ng lo·∫°t</h6>
                            </div>
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-3 d-flex gap-2">
                                        <button class="btn btn-success btn-sm" id="btnBulkExport">
                                            <i class="fas fa-file-archive me-2"></i>T·∫£i ZIP
                                        </button>
                                        <button class="btn btn-primary btn-sm" id="btnExportAttendanceExcel">
                                            <i class="fas fa-file-excel me-2"></i>T·∫£i Excel
                                        </button>
                                        <button class="btn btn-info btn-sm" id="btnExportAttendanceExcelFull">
                                            <i class="fas fa-file-excel me-2"></i>T·∫£i Excel Full
                                        </button>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            <span id="bulkExportDescription">
                                                Xu·∫•t tƒÉng ca theo <strong>b·ªô l·ªçc ph√≠a tr√™n</strong>
                                                (T·ª´ ng√†y/ƒê·∫øn ng√†y ho·∫∑c Th√°ng t·ª´/Th√°ng ƒë·∫øn, NƒÉm t·ª´/NƒÉm ƒë·∫øn).
                                                N·∫øu kh√¥ng ch·ªçn g√¨, h·ªá th·ªëng s·∫Ω xu·∫•t t·∫•t c·∫£ b·∫£n ghi ƒë√£ ph√™ duy·ªát.
                                            </span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive" style="max-width: 100%; overflow-x: auto;">
                    <table class="table table-striped" style="table-layout: auto;">
                        <thead>
                            <tr>
                                <th style="width: 70px;">Ng√†y</th>
                                <th style="width: 55px;">Gi·ªù v√†o</th>
                                <th style="width: 55px;">Gi·ªù ra</th>
                                <th style="width: 36px;">Ngh·ªâ</th>
                                <th style="width: 50px;">ƒê·ªëi ·ª©ng</th>
                                <th style="width: 60px;">T·ªïng gi·ªù l√†m</th>
                                <th style="width: 50px;">Gi·ªù c√¥ng</th>
                                <th style="width: 50px;">TƒÉng ca<br />tr∆∞·ªõc 22h</th>
                                <th style="width: 50px;">TƒÉng ca<br />sau 22h</th>
                                <th style="width: 80px;">Lo·∫°i ng√†y</th>
                                <th style="width: 80px;">Nh√¢n vi√™n</th>
                                <th style="width: 80px;">Ph√≤ng ban</th>
                                <th style="width: 80px;">Tr·∫°ng th√°i</th>
                                <th style="width: 100px;">Ch·ªØ k√Ω</th>
                                <th style="width: 120px;">Thao t√°c</th>
                                <th style="width: 120px;">Ghi ch√∫</th>
                            </tr>
                        </thead>
                        <tbody id="allAttendanceHistoryBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <nav>
                    <ul class="pagination justify-content-center" id="allAttendancePagination"></ul>
                </nav>
            </div>

            <!-- Approval Section - Hi·ªÉn th·ªã ƒë·ªông theo vai tr√≤ -->
            <div class="attendance-history" id="approvalSection" style="display: none;">
                <h4 class="mb-4"><i class="fas fa-user-check me-2"></i>Ph√™ duy·ªát ch·∫•m c√¥ng</h4>
                <div class="filter-row row mb-3 g-3 align-items-center">
                    <div class="col-auto">
                        <div class="search-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="approvalSearchName" class="form-control modern-search"
                                placeholder="T√¨m theo m√£ NV, t√™n...">
                        </div>
                    </div>
                    <div class="col-auto" id="departmentFilterContainer" style="display: none;">
                        <select id="approvalDepartment" class="form-select modern-select">
                            <option value="">üè¢ T·∫•t c·∫£ ph√≤ng ban</option>
                            <option value="BUD A">BUD A</option>
                            <option value="BUD B">BUD B</option>
                            <option value="BUD C">BUD C</option>
                            <option value="SCOPE">SCOPE</option>
                            <option value="KIRI">KIRI</option>
                            <option value="CREEK&RIVER">CREEK&RIVER</option>
                            <option value="COMO">COMO</option>
                            <option value="OFFICE">OFFICE</option>
                            <option value="YORK">YORK</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <input type="text" id="approvalDateFrom" class="form-control modern-date"
                            placeholder="üìÖ T·ª´ ng√†y">
                    </div>
                    <div class="col-auto">
                        <input type="text" id="approvalDateTo" class="form-control modern-date"
                            placeholder="üìÖ ƒê·∫øn ng√†y">
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-primary btn-search" id="btnApprovalFilter">
                            <i class="fas fa-filter me-1"></i>L·ªçc
                        </button>
                        <button class="btn btn-outline-secondary" id="btnApprovalReset">
                            <i class="fas fa-redo me-1"></i>ƒê·∫∑t l·∫°i
                        </button>
                    </div>
                    <div class="col-auto d-flex align-items-center" id="bulkApprovalContainer"
                        style="display: none !important;">
                        <button class="btn btn-success" id="btnBulkApprove" title="Ph√™ duy·ªát t·∫•t c·∫£ b·∫£n ghi ƒëang ch·ªù">
                            <i class="fas fa-check-double me-2"></i>Ph√™ duy·ªát t·∫•t c·∫£
                        </button>
                    </div>
                </div>
                <div class="table-responsive" style="max-width: 100%; overflow-x: auto;">
                    <table class="table table-striped" style="table-layout: fixed;">
                        <thead>
                            <tr>
                                <th style="width: 70px;">Ng√†y</th>
                                <th style="width: 55px;">Gi·ªù v√†o</th>
                                <th style="width: 55px;">Gi·ªù ra</th>
                                <th style="width: 36px;">Ngh·ªâ</th>
                                <th style="width: 50px;">ƒê·ªëi ·ª©ng</th>
                                <th style="width: 60px;">T·ªïng gi·ªù l√†m</th>
                                <th style="width: 50px;">Gi·ªù c√¥ng</th>
                                <th style="width: 50px;">TƒÉng ca<br />tr∆∞·ªõc 22h</th>
                                <th style="width: 50px;">TƒÉng ca<br />sau 22h</th>
                                <th style="width: 80px;">Lo·∫°i ng√†y</th>
                                <th style="width: 80px;">Nh√¢n vi√™n</th>
                                <th style="width: 80px;">Ph√≤ng ban</th>
                                <th style="width: 80px;">Tr·∫°ng th√°i</th>
                                <th style="width: 100px;">Ch·ªØ k√Ω</th>
                                <th style="width: 120px;">Thao t√°c</th>
                                <th style="width: 120px;">Ghi ch√∫</th>
                            </tr>
                        </thead>
                        <tbody id="approvalAttendanceBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <nav>
                    <ul class="pagination justify-content-center" id="approvalPagination"></ul>
                </nav>

                <!-- N√∫t Test hi·ªÉn th·ªã ch·ªØ k√Ω - ch·ªâ hi·ªÉn th·ªã cho nh√¢n vi√™n -->
                <div class="mt-3 text-end" id="testSignatureButtonContainer" style="display: none;">
                    <button type="button" class="btn btn-info btn-sm" onclick="testSignatureDisplay()">
                        <i class="fas fa-vial me-2"></i>Test hi·ªÉn th·ªã ch·ªØ k√Ω
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js?v=1.0.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11?v=1.0.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr?v=1.0.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/vn.js?v=1.0.2"></script>
    <!-- Custom Dashboard JS with cache busting -->
    <script src="{{ url_for('static', filename='js/dashboard.js') }}?v=20250107001"></script>
    <!-- Role Switch Optimizer for real-time updates -->
    <script src="{{ url_for('static', filename='js/role-switch-optimizer.js') }}?v=20250107002"></script>
    <!-- Smooth Transitions for better UX -->
    <script src="{{ url_for('static', filename='js/smooth-transitions.js') }}?v=20250107004"></script>
    <!-- Signature pad script for approval only -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>

    <!-- Embedded data for JS (avoids template braces inside JS code) -->
    <script id="has-signature-data" type="application/json">{{ (has_signature | default(false) | tojson) }}</script>
    <script id="session-user-data" type="application/json">{{ {
        "name": session.get("name", "Test User"),
        "employee_id": session.get("employee_id", "TEST001"),
        "department": session.get("department", "TEST")
    } | tojson }}</script>
    <script>
        // Checkout date auto-suggestion functionality
        document.addEventListener('DOMContentLoaded', function () {
            const attendanceDateInput = document.getElementById('attendanceDate');
            const checkoutDateInput = document.getElementById('checkoutDate');
            const checkInTimeInput = document.getElementById('checkInTime');
            const checkOutTimeInput = document.getElementById('checkOutTime');

            // Auto-suggest checkout date when check-out time changes
            function suggestCheckoutDate() {
                const checkInTime = checkInTimeInput?.value;
                const checkOutTime = checkOutTimeInput?.value;
                const attendanceDate = attendanceDateInput?.value;

                if (checkInTime && checkOutTime && attendanceDate && checkoutDateInput) {
                    // If checkout time < check-in time, suggest next day
                    if (checkOutTime < checkInTime) {
                        const [day, month, year] = attendanceDate.split('/');
                        const dateObj = new Date(year, month - 1, day);
                        dateObj.setDate(dateObj.getDate() + 1);

                        const newDay = String(dateObj.getDate()).padStart(2, '0');
                        const newMonth = String(dateObj.getMonth() + 1).padStart(2, '0');
                        const newYear = dateObj.getFullYear();

                        checkoutDateInput.value = `${newDay}/${newMonth}/${newYear}`;
                        console.log('‚úÖ T·ª± ƒë·ªông ƒëi·ªÅn ng√†y ra = ng√†y mai (gi·ªù ra < gi·ªù v√†o)');
                    } else {
                        // Same day
                        checkoutDateInput.value = attendanceDate;
                    }
                }
            }

            // Default checkout date = attendance date
            if (attendanceDateInput && checkoutDateInput) {
                attendanceDateInput.addEventListener('change', function () {
                    // Ch\u1ec9 auto-sync n\u1ebfu KH\u00d4NG \u0111ang \u1edf ch\u1ebf \u0111\u1ed9 edit
                    const editIdInput = document.getElementById('editAttendanceId');
                    const isEditMode = editIdInput && editIdInput.value;

                    if (!isEditMode && !checkoutDateInput.value) {
                        // Auto-sync: Ng\u00e0y ra = Ng\u00e0y v\u00e0o (m\u1eb7c \u0111\u1ecbnh)
                        checkoutDateInput.value = this.value;
                    }
                });
            }

            // Auto-suggest when times change
            if (checkOutTimeInput) {
                checkOutTimeInput.addEventListener('change', suggestCheckoutDate);
            }
            if (checkInTimeInput) {
                checkInTimeInput.addEventListener('change', suggestCheckoutDate);
            }
        });

        // Auto signature feature - no manual signature pad needed for registration
        // Signature will be automatically retrieved from database

        function clearSignature() {
            // This function is no longer needed but kept for compatibility
            console.log('Auto signature feature: clearSignature() called but not needed');
        }

        // Form submission is handled in dashboard.js to avoid conflicts

        // Function to show toast notification
        function showToast(message, type = 'success') {
            console.log('Showing toast:', message, type);  // Debug log
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer)
                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                }
            });

            let icon = type;
            if (type === 'success') icon = 'success';
            else if (type === 'error') icon = 'error';
            else if (type === 'warning') icon = 'warning';
            else if (type === 'info') icon = 'info';

            Toast.fire({
                icon: icon,
                title: message
            });
        }

        // Use the same variable names as dashboard.js to avoid conflicts
        let dashboardAttendanceData = [];
        let currentPage = 1;
        const rowsPerPage = 5;
        let approvalPage = 1;
        let approvalPerPage = 10;

        // Function to get overtime print button
        function getOvertimePrintButton(attendanceId, approved, isAdmin) {
            if (!approved || !isAdmin) return '';
            return `<a href="/admin/attendance/${attendanceId}/export-overtime-pdf" class="btn btn-outline-primary btn-sm ms-1"><i class="fas fa-print"></i> In gi·∫•y tƒÉng ca</a>`;
        }

        function getOvertimeTestButton(attendanceId, approved, isAdmin) {
            if (!approved || !isAdmin) return '';
            return `<a href="/admin/attendance/${attendanceId}/test-signature-pdf" class="btn btn-outline-info btn-sm ms-1"><i class="fas fa-vial"></i> Test ch·ªØ k√Ω</a>`;
        }

        function renderAttendancePage(page) {
            console.log('üé® Rendering attendance page:', page);
            const tbody = document.getElementById('attendanceHistory');
            if (!tbody) {
                console.log('‚ùå attendanceHistory element not found, skipping render');
                return;
            }

            // L·∫•y vai tr√≤ hi·ªán t·∫°i ƒë·ªÉ ki·ªÉm tra quy·ªÅn admin
            const roleSelect = document.getElementById('role-select');
            const isAdmin = roleSelect ? roleSelect.value === 'ADMIN' : false;

            console.log('üìä Data for rendering:', {
                dataLength: dashboardAttendanceData?.length || 0,
                isAdmin: isAdmin,
                page: page
            });

            tbody.innerHTML = '';

            // ƒê·∫£m b·∫£o b·∫£ng hi·ªÉn th·ªã ƒë√∫ng c·∫•u tr√∫c
            if (tbody.parentElement) {
                tbody.parentElement.classList.add('attendance-table');
            }

            if (!dashboardAttendanceData || dashboardAttendanceData.length === 0) {
                const totalRows = rowsPerPage;
                const middleRow = Math.floor(totalRows / 2);
                for (let i = 0; i < totalRows; i++) {
                    const row = document.createElement('tr');
                    row.style.height = '50px';
                    row.className = 'empty-row';
                    if (i === middleRow) {
                        row.innerHTML = `<td colspan="14" class="no-data-row">Kh√¥ng c√≥ d·ªØ li·ªáu ch·∫•m c√¥ng</td>`;
                    } else {
                        row.innerHTML = `
                            <td style="height: 50px; width: 70px;"></td>
                            <td style="height: 50px; width: 55px;"></td>
                            <td style="height: 50px; width: 55px;"></td>
                            <td style="height: 50px; width: 40px;"></td>
                            <td style="height: 50px; width: 36px;"></td>
                            <td style="height: 50px; width: 50px;"></td>
                            <td style="height: 50px; width: 60px;"></td>
                            <td style="height: 50px; width: 50px;"></td>
                            <td style="height: 50px; width: 50px;"></td>
                            <td style="height: 50px; width: 50px;"></td>
                            <td style="height: 50px; width: 80px;"></td>
                            <td style="height: 50px; width: 80px;"></td>
                            <td style="height: 50px; width: 120px;"></td>
                            <td style="height: 50px; width: 120px;" class="note-cell"></td>
                        `;
                    }
                    tbody.appendChild(row);
                }
                return;
            }

            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = dashboardAttendanceData.slice(start, end);

            // T√≠nh s·ªë d√≤ng tr·ªëng c·∫ßn th√™m ƒë·ªÉ ƒë·∫°t ƒë·ªß 5 d√≤ng
            const emptyRowsNeeded = Math.max(0, rowsPerPage - pageData.length);

            pageData.forEach(record => {
                const row = document.createElement('tr');
                row.style.height = '50px'; // Set fixed height for all rows

                // X·ª≠ l√Ω hi·ªÉn th·ªã tr·∫°ng th√°i chi ti·∫øt d·ª±a tr√™n record.status
                let statusText = '';
                let statusClass = '';

                if (record.approved || record.status === 'approved') {
                    statusText = 'ƒê√£ ph√™ duy·ªát';
                    statusClass = 'status-approved';
                } else if (record.status === 'rejected') {
                    statusText = 'T·ª´ ch·ªëi';
                    statusClass = 'status-rejected';
                } else if (record.status === 'pending') {
                    statusText = 'Ch·ªù Tr∆∞·ªüng nh√≥m';
                    statusClass = 'status-pending';
                } else if (record.status === 'pending_manager') {
                    statusText = 'Ch·ªù Qu·∫£n l√Ω';
                    statusClass = 'status-pending-manager';
                } else if (record.status === 'pending_admin') {
                    statusText = 'Ch·ªù Admin';
                    statusClass = 'status-pending-admin';
                } else {
                    // Fallback cho c√°c tr·∫°ng th√°i kh√¥ng x√°c ƒë·ªãnh
                    statusText = 'Ch·ªù ph√™ duy·ªát';
                    statusClass = 'status-pending';
                }

                // X·ª≠ l√Ω hi·ªÉn th·ªã lo·∫°i ng√†y
                let holidayTypeText = translateHolidayType(record.holiday_type);

                // X·ª≠ l√Ω hi·ªÉn th·ªã th√¥ng tin ca
                let shiftText = '-';
                if (record.shift_code) {
                    switch (record.shift_code) {
                        case '1':
                            shiftText = 'Ca 1';
                            break;
                        case '2':
                            shiftText = 'Ca 2';
                            break;
                        case '3':
                            shiftText = 'Ca 3';
                            break;
                        case '4':
                            shiftText = 'Ca 4';
                            break;
                        case '5':
                            shiftText = 'Ca 5';
                            break;
                        default:
                            shiftText = `Ca ${record.shift_code}`;
                    }
                }

                row.innerHTML = `
                    <td style="height: 50px; width: 70px;">${formatDate(record.date)}</td>
                    <td style="height: 50px; width: 55px;">${record.check_in || '--:--'}</td>
                    <td style="height: 50px; width: 55px;">${record.check_out || '--:--'}</td>
                    <td style="height: 50px; width: 40px;">${shiftText}</td>
                    <td style="height: 50px; width: 36px;">${formatHourMinute(record.break_time) || '-'}</td>
                    <td style="height: 50px; width: 50px;">${formatHourMinute(calculateTotalCompTime(record)) || '-'}</td>
                    <td style="height: 50px; width: 60px;">${record.total_work_hours || '-'}</td>
                    <td style="height: 50px; width: 50px;">${record.work_hours_display || '-'}</td>
                    <td style="height: 50px; width: 50px;">${record.overtime_before_22 && record.overtime_before_22 !== 'NaN:NaN' ? record.overtime_before_22 : '0:00'}</td>
                    <td style="height: 50px; width: 50px;" title="${record.overtime_after_22 && record.overtime_after_22 !== 'NaN:NaN' ? `Gi√° tr·ªã g·ªëc: ${record.overtime_after_22}` : '0 gi·ªù'}">${record.overtime_after_22 && record.overtime_after_22 !== 'NaN:NaN' ? record.overtime_after_22 : '0:00'}</td>
                    <td style="height: 50px; width: 80px;">${holidayTypeText}</td>
                    <td style="height: 50px; width: 80px;">
                        <span class="${statusClass}">${statusText}</span>
                    </td>
                    <td style="height: 50px; width: 120px; padding: 0 !important;">
                        <div class="action-container">
                        ${!record.approved ? `
                            <div class="btn-action-container">
                                <button class='btn btn-warning btn-sm edit-attendance-btn' data-id='${record.id}'>
                                    <i class='fas fa-edit me-1'></i>S·ª≠a
                                </button>
                                <button class='btn btn-danger btn-sm delete-attendance-btn' data-id='${record.id}'>
                                    <i class='fas fa-trash me-1'></i>X√≥a
                                </button>
                            </div>
                        ` : `
                            <div class="btn-action-container">
                                ${getOvertimePrintButton(record.id, record.approved, isAdmin)}
                                ${getOvertimeTestButton(record.id, record.approved, isAdmin)}
                            </div>
                        `}
                        </div>
                    </td>
                    <td style="height: 50px;" class="note-cell" data-full-note="${record.note || ''}">
                        ${record.note || '-'}
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Th√™m c√°c d√≤ng tr·ªëng n·∫øu c·∫ßn ƒë·ªÉ ƒë·ªß 5 d√≤ng
            for (let i = 0; i < emptyRowsNeeded; i++) {
                const emptyRow = document.createElement('tr');
                emptyRow.className = 'empty-row';
                emptyRow.innerHTML = `
                    <td style="height: 50px; width: 70px;"></td>
                    <td style="height: 50px; width: 55px;"></td>
                    <td style="height: 50px; width: 55px;"></td>
                    <td style="height: 50px; width: 40px;"></td>
                    <td style="height: 50px; width: 36px;"></td>
                    <td style="height: 50px; width: 50px;"></td>
                    <td style="height: 50px; width: 60px;"></td>
                    <td style="height: 50px; width: 50px;"></td>
                    <td style="height: 50px; width: 50px;"></td>
                    <td style="height: 50px; width: 50px;"></td>
                    <td style="height: 50px; width: 80px;"></td>
                    <td style="height: 50px; width: 80px;"></td>
                    <td style="height: 50px; width: 120px;"></td>
                    <td style="height: 50px; width: 120px;" class="note-cell"></td>
                `;
                tbody.appendChild(emptyRow);
            }

            // G·∫Øn l·∫°i s·ª± ki·ªán cho n√∫t s·ª≠a v√† x√≥a
            document.querySelectorAll('.edit-attendance-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    handleEditAttendance(this.getAttribute('data-id'));
                });
            });

            document.querySelectorAll('.delete-attendance-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    const id = this.getAttribute('data-id');
                    Swal.fire({
                        title: 'X√°c nh·∫≠n x√≥a',
                        text: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·∫£n ghi ch·∫•m c√¥ng n√†y?',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'X√≥a',
                        cancelButtonText: 'H·ªßy'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            deleteAttendance(id);
                        }
                    });
                });
            });

            // G√°n s·ª± ki·ªán click cho note-cell
            bindNoteCellClick();
        }

        function renderAttendancePagination() {
            const totalPages = Math.ceil(dashboardAttendanceData.length / rowsPerPage);
            const pagination = document.getElementById('attendancePagination');
            if (!pagination) {
                console.log('attendancePagination element not found, skipping pagination render');
                return;
            }

            pagination.innerHTML = '';
            function createPageItem(i, active = false) {
                const li = document.createElement('li');
                li.className = 'page-item' + (active ? ' active' : '');
                const a = document.createElement('a');
                a.className = 'page-link';
                a.href = '#';
                a.textContent = i;
                a.addEventListener('click', function (e) {
                    e.preventDefault();
                    currentPage = i;
                    renderAttendancePage(currentPage);
                    renderAttendancePagination();
                });
                li.appendChild(a);
                pagination.appendChild(li);
            }
            if (totalPages <= 7) {
                for (let i = 1; i <= totalPages; i++) createPageItem(i, i === currentPage);
            } else {
                createPageItem(1, currentPage === 1);
                if (currentPage > 4) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(li);
                }
                for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) {
                    createPageItem(i, i === currentPage);
                }
                if (currentPage < totalPages - 3) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(li);
                }
                createPageItem(totalPages, currentPage === totalPages);
            }
        }

        // Bi·∫øn ƒë·ªÉ tr√°nh g·ªçi API tr√πng l·∫∑p
        let isUpdatingAttendance = false;
        let lastUpdateTime = 0;
        const UPDATE_THROTTLE_MS = 1000; // Ch·ªâ cho ph√©p g·ªçi API m·ªói 1 gi√¢y

        function updateAttendanceHistory(forceUpdate = false) {
            // Ki·ªÉm tra xem c√≥ ƒëang update kh√¥ng v√† th·ªùi gian t·ª´ l·∫ßn update cu·ªëi
            const now = Date.now();
            if (!forceUpdate && (isUpdatingAttendance || (now - lastUpdateTime) < UPDATE_THROTTLE_MS)) {
                console.log('Skipping duplicate updateAttendanceHistory call');
                return;
            }

            console.log('üîÑ Fetching attendance history...', forceUpdate ? '(forced)' : '');  // Debug log

            // Ki·ªÉm tra xem element attendanceHistory c√≥ t·ªìn t·∫°i v√† hi·ªÉn th·ªã kh√¥ng
            const attendanceHistoryElement = document.getElementById('attendanceHistory');
            const attendanceHistorySection = document.getElementById('attendanceHistorySection');

            console.log('üîç Element check:', {
                attendanceHistoryElement: !!attendanceHistoryElement,
                attendanceHistorySection: !!attendanceHistorySection,
                sectionDisplay: attendanceHistorySection ? attendanceHistorySection.style.display : 'not found'
            });

            if (!attendanceHistoryElement) {
                console.log('‚ùå attendanceHistory element not found, skipping update');
                return;
            }

            // Khi forceUpdate=true, kh√¥ng ki·ªÉm tra section display ƒë·ªÉ ƒë·∫£m b·∫£o d·ªØ li·ªáu ƒë∆∞·ª£c load
            if (!forceUpdate && attendanceHistorySection && attendanceHistorySection.style.display === 'none') {
                console.log('‚ùå attendanceHistorySection is hidden, skipping update');
                return;
            }

            // ƒê√°nh d·∫•u ƒëang update
            isUpdatingAttendance = true;
            lastUpdateTime = Date.now();

            // L·∫•y th√°ng v√† nƒÉm hi·ªán t·∫°i
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth() + 1; // Th√°ng trong JS b·∫Øt ƒë·∫ßu t·ª´ 0
            const currentYear = currentDate.getFullYear();

            fetch(`/api/attendance/history?month=${currentMonth}&year=${currentYear}`)
                .then(response => {
                    console.log('üì° Response status:', response.status);  // Debug log
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('üìä Received data:', data);  // Debug log
                    if (data.error) {
                        console.error('‚ùå API Error:', data.error);
                        showToast(data.error, 'error');
                        return;
                    }
                    dashboardAttendanceData = data;
                    console.log('‚úÖ Data processed, length:', dashboardAttendanceData?.length || 0);
                    // Gi·ªØ nguy√™n trang hi·ªán t·∫°i n·∫øu c√≤n h·ª£p l·ªá
                    const totalPages = Math.max(1, Math.ceil((dashboardAttendanceData?.length || 0) / (rowsPerPage || 5)));
                    if (!currentPage || currentPage < 1) currentPage = 1;
                    if (currentPage > totalPages) currentPage = totalPages;
                    console.log('üìÑ Rendering page:', currentPage, 'of', totalPages);
                    renderAttendancePage(currentPage);
                    renderAttendancePagination();
                })
                .catch(error => {
                    console.error('‚ùå Error fetching attendance history:', error);
                    showToast('Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ ch·∫•m c√¥ng. Vui l√≤ng th·ª≠ l·∫°i sau.', 'error');
                })
                .finally(() => {
                    // ƒê√°nh d·∫•u ƒë√£ update xong
                    isUpdatingAttendance = false;
                });
        }

        // Function to handle edit attendance - moved to dashboard.js to avoid conflicts

        // Function to format date for display (DD/MM/YYYY) - moved to dashboard.js to avoid conflicts

        // Function to format time for input - moved to dashboard.js to avoid conflicts

        // Export h√†m updateAttendanceHistory ra window ƒë·ªÉ dashboard.js c√≥ th·ªÉ g·ªçi
        window.updateAttendanceHistory = updateAttendanceHistory;

        // Event listeners - ƒê√£ ƒë∆∞·ª£c x·ª≠ l√Ω trong dashboard.js
        // document.getElementById('saveAttendanceBtn')?.addEventListener('click', handleAttendanceSubmit);
        // document.getElementById('cancelEditBtn')?.addEventListener('click', resetForm);

        // X·ª≠ l√Ω s·ª± ki·ªán khi ch·ªçn ca l√†m vi·ªác
        document.getElementById('shiftSelect')?.addEventListener('change', function () {
            const shiftValue = this.value;

            if (shiftValue === '1') {
                // Ca 1: 7:30 - 16:30
                document.getElementById('checkInTime').value = '07:30';
                document.getElementById('checkOutTime').value = '16:30';
            }
            else if (shiftValue === '2') {
                // Ca 2: 9:00 - 18:00
                document.getElementById('checkInTime').value = '09:00';
                document.getElementById('checkOutTime').value = '18:00';
            }
            else if (shiftValue === '3') {
                // Ca 3: 11:00 - 20:00
                document.getElementById('checkInTime').value = '11:00';
                document.getElementById('checkOutTime').value = '20:00';
            }
            else if (shiftValue === '4') {
                // Ca 4: 8:00 - 17:00
                document.getElementById('checkInTime').value = '08:00';
                document.getElementById('checkOutTime').value = '17:00';
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM loaded - initializing...');

            // X·ª≠ l√Ω khi ng∆∞·ªùi d√πng nh·∫≠p gi·ªù ngh·ªâ v√† focus ra - h·ªó tr·ª£ nh·∫≠p nhanh
            const breakTimeInput = document.getElementById('breakTime');
            if (breakTimeInput) {
                breakTimeInput.addEventListener('blur', function () {
                    let value = this.value.trim();

                    // N·∫øu r·ªóng ho·∫∑c ch·ªâ c√≥ kho·∫£ng tr·∫Øng, set v·ªÅ 00:00
                    if (!value || value === '') {
                        this.value = '00:00';
                        return;
                    }

                    // N·∫øu ƒë√£ ƒë√∫ng ƒë·ªãnh d·∫°ng HH:MM ho·∫∑c H:MM, format l·∫°i cho chu·∫©n
                    const hhmmPattern = /^(\d{1,2}):([0-5]?\d)$/;
                    if (hhmmPattern.test(value)) {
                        const match = value.match(hhmmPattern);
                        let hours = parseInt(match[1], 10);
                        let minutes = parseInt(match[2] || '0', 10);

                        // ƒê·∫£m b·∫£o gi·ªù v√† ph√∫t h·ª£p l·ªá
                        if (hours > 23) hours = 23;
                        if (minutes > 59) minutes = 59;

                        this.value = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                        return;
                    }

                    // Ki·ªÉm tra xem c√≥ space ho·∫∑c d·∫•u hai ch·∫•m kh√¥ng (∆∞u ti√™n x·ª≠ l√Ω tr∆∞·ªõc)
                    // V√≠ d·ª•: "2 45", "12 5", "12:05", "2:45"
                    if (/[\s:]/.test(value)) {
                        const parts = value.split(/[\s:]+/).filter(p => p);
                        if (parts.length === 2) {
                            let hours = parseInt(parts[0], 10);
                            let minutes = parseInt(parts[1], 10);

                            if (isNaN(hours)) hours = 0;
                            if (isNaN(minutes)) minutes = 0;

                            if (hours > 23) hours = 23;
                            if (minutes > 59) minutes = 59;

                            this.value = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                            return;
                        }
                    }

                    // X·ª≠ l√Ω c√°c tr∆∞·ªùng h·ª£p nh·∫≠p nhanh ch·ªâ c√≥ s·ªë
                    // Lo·∫°i b·ªè t·∫•t c·∫£ k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
                    const numbersOnly = value.replace(/[^\d]/g, '');

                    if (numbersOnly === '0' || numbersOnly === '') {
                        // Nh·∫≠p "0" ‚Üí "00:00"
                        this.value = '00:00';
                    } else if (numbersOnly.length === 1 || numbersOnly.length === 2) {
                        // Nh·∫≠p 1-2 ch·ªØ s·ªë ‚Üí coi nh∆∞ ph√∫t (v√≠ d·ª•: "45" ‚Üí "00:45", "1" ‚Üí "00:01", "01" ‚Üí "00:01")
                        const minutes = parseInt(numbersOnly, 10);
                        if (minutes > 59) {
                            // N·∫øu > 59, coi nh∆∞ gi·ªù:ph√∫t (v√≠ d·ª•: "60" ‚Üí "06:00")
                            this.value = `${numbersOnly.padStart(2, '0')}:00`;
                        } else {
                            this.value = `00:${minutes.toString().padStart(2, '0')}`;
                        }
                    } else if (numbersOnly.length === 3) {
                        // Nh·∫≠p 3 ch·ªØ s·ªë ‚Üí coi nh∆∞ H:MM (v√≠ d·ª•: "245" ‚Üí "02:45")
                        const hours = parseInt(numbersOnly[0], 10);
                        const minutes = parseInt(numbersOnly.substring(1), 10);
                        if (minutes > 59) {
                            // N·∫øu ph√∫t > 59, coi nh∆∞ HH:MM (v√≠ d·ª•: "260" ‚Üí "02:60" kh√¥ng h·ª£p l·ªá, n√™n coi nh∆∞ "26:00")
                            this.value = `${numbersOnly.substring(0, 2).padStart(2, '0')}:00`;
                        } else {
                            this.value = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                        }
                    } else if (numbersOnly.length === 4) {
                        // Nh·∫≠p 4 ch·ªØ s·ªë ‚Üí coi nh∆∞ HH:MM (v√≠ d·ª•: "1245" ‚Üí "12:45")
                        const hours = parseInt(numbersOnly.substring(0, 2), 10);
                        const minutes = parseInt(numbersOnly.substring(2), 10);
                        if (hours > 23) hours = 23;
                        if (minutes > 59) minutes = 59;
                        this.value = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                    } else {
                        // Kh√¥ng parse ƒë∆∞·ª£c, set v·ªÅ 00:00
                        this.value = '00:00';
                    }
                });
            }

            // X·ª≠ l√Ω logic AM/PM t·ª± ƒë·ªông cho Gi·ªù v√†o v√† Gi·ªù ra
            const checkInTimeInput = document.getElementById('checkInTime');
            const checkOutTimeInput = document.getElementById('checkOutTime');

            // Gi·ªù v√†o: M·∫∑c ƒë·ªãnh l√† S√ÅNG (AM) - Gi·ªØ nguy√™n 01:00-11:00
            if (checkInTimeInput) {
                checkInTimeInput.addEventListener('blur', function () {
                    const value = this.value;
                    if (!value) return;

                    const match = value.match(/^(\d{1,2}):(\d{2})$/);
                    if (match) {
                        let hours = parseInt(match[1], 10);
                        const minutes = match[2];

                        // N·∫øu gi·ªù t·ª´ 1-11 ‚Üí Gi·ªØ nguy√™n (coi nh∆∞ s√°ng)
                        // N·∫øu gi·ªù 0 ‚Üí Gi·ªØ nguy√™n 00:xx
                        // N·∫øu gi·ªù >= 12 ‚Üí Gi·ªØ nguy√™n (ƒë√£ ƒë√∫ng ƒë·ªãnh d·∫°ng 24h)

                        // ƒê·∫£m b·∫£o format chu·∫©n
                        this.value = `${String(hours).padStart(2, '0')}:${minutes}`;
                    }
                });
            }

            // Gi·ªù ra: Gi·ªØ nguy√™n gi√° tr·ªã ng∆∞·ªùi d√πng nh·∫≠p, ch·ªâ format chu·∫©n + validate
            if (checkOutTimeInput) {
                checkOutTimeInput.addEventListener('blur', function () {
                    const value = this.value;
                    if (!value) return;

                    const match = value.match(/^(\d{1,2}):(\d{2})$/);
                    if (match) {
                        const hours = parseInt(match[1], 10);
                        const minutes = match[2];

                        // Ch·ªâ format chu·∫©n, kh√¥ng t·ª± ƒë·ªông chuy·ªÉn ƒë·ªïi AM/PM
                        // Ng∆∞·ªùi d√πng ƒë√£ ch·ªçn ƒë√∫ng gi·ªù t·ª´ time picker
                        this.value = `${String(hours).padStart(2, '0')}:${minutes}`;
                    }

                    // Validate: Gi·ªù v√†o >= Gi·ªù ra khi c√πng ng√†y
                    const checkInTime = document.getElementById('checkInTime')?.value;
                    const checkOutTime = this.value;
                    const attendanceDate = document.getElementById('attendanceDate')?.value;
                    const checkoutDateInput = document.getElementById('checkoutDate');
                    let checkoutDate = checkoutDateInput?._flatpickr?.selectedDates[0]
                        ? checkoutDateInput._flatpickr.formatDate(checkoutDateInput._flatpickr.selectedDates[0], 'Y-m-d')
                        : checkoutDateInput?.value || '';

                    // Convert checkoutDate t·ª´ DD/MM/YYYY sang YYYY-MM-DD n·∫øu c·∫ßn
                    if (checkoutDate && checkoutDate.includes('/')) {
                        const [d, m, y] = checkoutDate.split('/');
                        checkoutDate = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
                    }

                    // Convert attendanceDate t·ª´ DD/MM/YYYY sang YYYY-MM-DD n·∫øu c·∫ßn
                    let entryDate = attendanceDate || '';
                    if (entryDate && entryDate.includes('/')) {
                        const [d, m, y] = entryDate.split('/');
                        entryDate = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
                    }

                    if (checkInTime && checkOutTime && entryDate && checkoutDate && entryDate === checkoutDate) {
                        const [inH, inM] = checkInTime.split(':').map(Number);
                        const [outH, outM] = checkOutTime.split(':').map(Number);
                        const inMinutes = inH * 60 + inM;
                        const outMinutes = outH * 60 + outM;

                        if (inMinutes >= outMinutes) {
                            showAlert('Gi·ªù v√†o ph·∫£i nh·ªè h∆°n gi·ªù ra khi c√πng ng√†y. N·∫øu l√†m ca ƒë√™m (SA/AM), vui l√≤ng ch·ªçn ng√†y ra l√† ng√†y h√¥m sau.', 'warning');
                        }
                    }
                });
            }

            // ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë∆∞·ª£c render ho√†n to√†n
            setTimeout(function () {
                // L·∫•y vai tr√≤ hi·ªán t·∫°i
                const roleSelect = document.getElementById('role-select');
                const currentRole = roleSelect ? roleSelect.value : 'EMPLOYEE';
                console.log('DEBUG JS: roleSelect.value =', roleSelect ? roleSelect.value : 'null');
                console.log('DEBUG JS: currentRole =', currentRole);

                // C·∫≠p nh·∫≠t giao di·ªán theo vai tr√≤ hi·ªán t·∫°i
                console.log('üöÄ Initial role setup - currentRole:', currentRole);
                updateUIForRole(currentRole);

                // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng ƒë∆°n ngh·ªâ ph√©p c·∫ßn ph√™ duy·ªát n·∫øu l√† qu·∫£n l√Ω
                if (['TEAM_LEADER', 'MANAGER', 'ADMIN'].includes(currentRole)) {
                    updatePendingLeaveCount();
                }

                // Handler cho n√∫t ph√™ duy·ªát h√†ng lo·∫°t
                const btnBulkApprove = document.getElementById('btnBulkApprove');
                if (btnBulkApprove) {
                    btnBulkApprove.addEventListener('click', async function () {
                        const currentRole = document.getElementById('role-select')?.value || 'EMPLOYEE';

                        // Ki·ªÉm tra token n·∫øu l√† ADMIN
                        if (currentRole === 'ADMIN' && tokenStatus && !tokenStatus.valid) {
                            Swal.fire({
                                title: '‚ö†Ô∏è Token Google API h·∫øt h·∫°n',
                                html: `
                                <div style="text-align: center;">
                                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #e74c3c; margin-bottom: 1rem;"></i>
                                    <p style="font-size: 1.1rem; margin-bottom: 1rem; color: #2c3e50;">
                                        <strong>Token Google API ƒë√£ h·∫øt h·∫°n!</strong>
                                    </p>
                                    <p style="font-size: 1rem; margin-bottom: 1rem; color: #34495e;">
                                        ${tokenStatus.message || 'Vui l√≤ng refresh token tr∆∞·ªõc khi ph√™ duy·ªát.'}
                                    </p>
                                </div>
                            `,
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonText: 'Refresh Token',
                                cancelButtonText: 'H·ªßy',
                                confirmButtonColor: '#3498db'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    refreshToken();
                                }
                            });
                            return;
                        }

                        // X√°c nh·∫≠n ph√™ duy·ªát h√†ng lo·∫°t
                        const { isConfirmed } = await Swal.fire({
                            title: 'X√°c nh·∫≠n ph√™ duy·ªát h√†ng lo·∫°t',
                            text: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ph√™ duy·ªát t·∫•t c·∫£ c√°c b·∫£n ghi ƒëang ch·ªù?',
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonText: 'Ph√™ duy·ªát',
                            cancelButtonText: 'H·ªßy',
                            confirmButtonColor: '#28a745'
                        });

                        if (!isConfirmed) return;

                        // G·ªçi API ph√™ duy·ªát h√†ng lo·∫°t
                        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                        Swal.fire({
                            title: 'ƒêang x·ª≠ l√Ω...',
                            html: '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang ph√™ duy·ªát h√†ng lo·∫°t',
                            allowOutsideClick: false,
                            allowEscapeKey: false,
                            showConfirmButton: false
                        });

                        try {
                            const response = await fetch('/api/attendance/approve-all', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': csrfToken
                                },
                                body: JSON.stringify({ action: 'approve' })
                            });

                            const data = await response.json();
                            Swal.close();

                            if (data.error) {
                                if (data.error_code === 'token_expired') {
                                    Swal.fire({
                                        title: '‚ö†Ô∏è Token Google API h·∫øt h·∫°n',
                                        html: `
                                        <div style="text-align: center;">
                                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #e74c3c; margin-bottom: 1rem;"></i>
                                            <p style="font-size: 1.1rem; margin-bottom: 1rem; color: #2c3e50;">
                                                <strong>Token Google API ƒë√£ h·∫øt h·∫°n!</strong>
                                            </p>
                                            <p style="font-size: 1rem; margin-bottom: 1rem; color: #34495e;">
                                                ${data.error}
                                            </p>
                                        </div>
                                    `,
                                        icon: 'warning',
                                        showCancelButton: true,
                                        confirmButtonText: 'Refresh Token',
                                        cancelButtonText: 'H·ªßy',
                                        confirmButtonColor: '#3498db'
                                    }).then((result) => {
                                        if (result.isConfirmed) {
                                            refreshToken();
                                        }
                                    });
                                } else {
                                    showToast(data.error, 'error');
                                }
                            } else {
                                showToast(data.message || 'Ph√™ duy·ªát h√†ng lo·∫°t th√†nh c√¥ng!', 'success');
                                loadApprovalAttendance();
                            }
                        } catch (error) {
                            console.error('Error in bulk approval:', error);
                            Swal.close();
                            showToast('ƒê√£ x·∫£y ra l·ªói khi ph√™ duy·ªát h√†ng lo·∫°t', 'error');
                        }
                    });
                }

                // C·∫≠p nh·∫≠t th√°ng hi·ªán t·∫°i trong ti√™u ƒë·ªÅ
                const currentMonthElement = document.getElementById('currentMonth');
                if (currentMonthElement) {
                    const currentMonth = new Date().getMonth() + 1; // Th√°ng trong JS b·∫Øt ƒë·∫ßu t·ª´ 0
                    currentMonthElement.textContent = currentMonth;
                }

                // ƒê·∫£m b·∫£o n√∫t h·ªßy s·ª≠a lu√¥n ·∫©n khi m·ªõi load trang
                const cancelEditBtn = document.getElementById('cancelEditBtn');
                if (cancelEditBtn) {
                    cancelEditBtn.style.cssText = "display: none !important;";
                }

                const dateInput = document.getElementById('attendanceDate');

                // Kh·ªüi t·∫°o flatpickr cho input ng√†y v·ªõi ƒë·ªãnh d·∫°ng Vi·ªát Nam
                if (dateInput) {
                    // H√†m x√°c ƒë·ªãnh lo·∫°i ng√†y (t√°ch ra ƒë·ªÉ t√°i s·ª≠ d·ª•ng)
                    async function determineDayType(dateStr) {
                        if (!dateStr) return;

                        try {
                            const url = `/api/get-day-type?date=${dateStr}`;
                            console.log(`üîç G·ªçi API: ${url}`);

                            const response = await fetch(url, {
                                method: 'GET',
                                headers: {
                                    'Accept': 'application/json',
                                    'Content-Type': 'application/json'
                                },
                                credentials: 'same-origin'
                            });

                            console.log(`üì° Response status: ${response.status}, Content-Type: ${response.headers.get('content-type')}`);

                            // Ki·ªÉm tra content-type ƒë·ªÉ ƒë·∫£m b·∫£o l√† JSON
                            const contentType = response.headers.get('content-type');
                            if (!contentType || !contentType.includes('application/json')) {
                                // Th·ª≠ ƒë·ªçc response text ƒë·ªÉ debug
                                const text = await response.text();
                                console.warn('‚ö†Ô∏è API tr·∫£ v·ªÅ kh√¥ng ph·∫£i JSON:', {
                                    status: response.status,
                                    contentType: contentType,
                                    responsePreview: text.substring(0, 200)
                                });
                                return;
                            }

                            if (response.ok) {
                                const data = await response.json();
                                console.log('‚úÖ API response:', data);
                                const dayTypeSelect = document.getElementById('dayType');
                                if (dayTypeSelect && data.day_type) {
                                    dayTypeSelect.value = data.day_type;
                                    // Trigger change event ƒë·ªÉ c·∫≠p nh·∫≠t UI
                                    dayTypeSelect.dispatchEvent(new Event('change', { bubbles: true }));

                                    // Hi·ªÉn th·ªã th√¥ng b√°o n·∫øu c√≥
                                    if (data.reason) {
                                        const reasonText = data.holiday_name
                                            ? `${data.reason}: ${data.holiday_name}`
                                            : data.reason;
                                        console.log(`‚úÖ ƒê√£ t·ª± ƒë·ªông ch·ªçn lo·∫°i ng√†y: ${reasonText}`);
                                    }
                                }
                            } else {
                                // X·ª≠ l√Ω l·ªói t·ª´ server
                                try {
                                    const errorData = await response.json();
                                    console.warn('‚ö†Ô∏è L·ªói khi l·∫•y lo·∫°i ng√†y:', response.status, errorData);
                                } catch (e) {
                                    const text = await response.text();
                                    console.warn('‚ö†Ô∏è L·ªói khi l·∫•y lo·∫°i ng√†y (kh√¥ng ph·∫£i JSON):', response.status, text.substring(0, 200));
                                }
                            }
                        } catch (error) {
                            console.error('‚ùå L·ªói khi l·∫•y lo·∫°i ng√†y:', error);
                        }
                    }


                    const flatpickrInstance = flatpickr("#attendanceDate", {
                        dateFormat: "Y-m-d", // Format backend c·∫ßn
                        locale: "vn",
                        allowInput: false, // NgƒÉn ng∆∞·ªùi d√πng nh·∫≠p tay
                        altInput: true,
                        altFormat: "d/m/Y",
                        placeholder: "Ch·ªçn ng√†y...",
                        defaultDate: new Date(), // <-- t·ª± ƒë·ªông set ng√†y h√¥m nay
                        onChange: async function (selectedDates, dateStr, instance) {
                            if (dateStr === '') {
                                instance.input.placeholder = 'Ch·ªçn ng√†y...';
                                return;
                            }

                            // Khi ƒëang edit (b·∫•m S·ª≠a), form s·∫Ω ƒë∆∞·ª£c set dayType/shift t·ª´ backend.
                            // Tr√°nh auto-detect dayType (async) g√¢y race-condition v√† ghi ƒë√® ca/ng√†y ra.
                            if (window.__suppressDayTypeDetect) return;

                            // T·ª± ƒë·ªông x√°c ƒë·ªãnh lo·∫°i ng√†y khi ch·ªçn ng√†y
                            await determineDayType(dateStr);

                            // AUTO-SYNC: C·∫≠p nh·∫≠t ng√†y ra = ng√†y v√†o khi ng∆∞·ªùi d√πng ch·ªçn ng√†y v√†o
                            // Gi√∫p gi·∫£m thao t√°c cho c√°c ca th√¥ng th∆∞·ªùng (c√πng ng√†y)
                            // NOTE: Khi ƒëang "S·ª≠a" b·∫£n ghi, checkout_date s·∫Ω ƒë∆∞·ª£c set t·ª´ backend.
                            // Tr√°nh async onChange ghi ƒë√® checkout_date (race condition).
                            if (window.__suppressCheckoutDateSync) return;
                            const checkoutFp = document.getElementById('checkoutDate')._flatpickr;
                            if (checkoutFp) {
                                checkoutFp.setDate(dateStr, true);

                                // Logic validation/highlighting
                                const entryDate = selectedDates[0];
                                const checkoutDate = checkoutFp.selectedDates[0];

                                if (entryDate && checkoutDate) {
                                    const entryDateOnly = new Date(entryDate.getFullYear(), entryDate.getMonth(), entryDate.getDate());
                                    const checkoutDateOnly = new Date(checkoutDate.getFullYear(), checkoutDate.getMonth(), checkoutDate.getDate());

                                    // N·∫øu ng√†y ra < ng√†y v√†o m·ªõi ‚Üí reset ng√†y ra v·ªÅ ng√†y v√†o
                                    if (checkoutDateOnly < entryDateOnly) {
                                        checkoutFp.setDate(entryDate, true);
                                    }

                                    // C·∫≠p nh·∫≠t highlight
                                    const altInput = checkoutFp.altInput;
                                    if (altInput) {
                                        const newCheckoutDate = checkoutFp.selectedDates[0];
                                        const newCheckoutDateOnly = new Date(newCheckoutDate.getFullYear(), newCheckoutDate.getMonth(), newCheckoutDate.getDate());

                                        if (newCheckoutDateOnly.getTime() !== entryDateOnly.getTime()) {
                                            altInput.style.backgroundColor = '#fff3cd';
                                            altInput.style.borderColor = '#ffc107';
                                            altInput.style.fontWeight = 'bold';
                                            altInput.title = 'Ca qua ƒë√™m: Ng√†y ra kh√°c ng√†y v√†o';
                                        } else {
                                            altInput.style.backgroundColor = '';
                                            altInput.style.borderColor = '';
                                            altInput.style.fontWeight = '';
                                            altInput.title = '';
                                        }
                                    }
                                }
                            }
                        }
                    });

                    // Initialize flatpickr for checkoutDate (Ng√†y ra)
                    const checkoutDateFlatpickr = flatpickr("#checkoutDate", {
                        dateFormat: "Y-m-d", // Format backend c·∫ßn
                        locale: "vn",
                        allowInput: false,
                        altInput: true,
                        altFormat: "d/m/Y", // Hi·ªÉn th·ªã DD/MM/YYYY
                        placeholder: "Ch·ªçn ng√†y ra...",
                        defaultDate: new Date(), // M·∫∑c ƒë·ªãnh c√πng ng√†y
                        onChange: function (selectedDates, dateStr, instance) {
                            // L·∫•y ng√†y v√†o t·ª´ flatpickr
                            const attendanceDateInput = document.getElementById('attendanceDate');
                            const entryDate = attendanceDateInput?._flatpickr?.selectedDates[0];
                            const checkoutDate = selectedDates[0];

                            if (entryDate && checkoutDate) {
                                // Reset time ƒë·ªÉ so s√°nh ch·ªâ ng√†y
                                const entryDateOnly = new Date(entryDate.getFullYear(), entryDate.getMonth(), entryDate.getDate());
                                const checkoutDateOnly = new Date(checkoutDate.getFullYear(), checkoutDate.getMonth(), checkoutDate.getDate());

                                // Validate: Ng√†y ra kh√¥ng ƒë∆∞·ª£c nh·ªè h∆°n ng√†y v√†o
                                if (checkoutDateOnly < entryDateOnly) {
                                    showAlert('Ng√†y ra kh√¥ng ƒë∆∞·ª£c nh·ªè h∆°n ng√†y v√†o!', 'warning');
                                    // Reset v·ªÅ ng√†y v√†o
                                    instance.setDate(entryDate, true);
                                    return;
                                }

                                // Highlight n·∫øu ng√†y ra kh√°c ng√†y v√†o (ca qua ƒë√™m)
                                const altInput = instance.altInput;
                                if (altInput) {
                                    if (checkoutDateOnly.getTime() !== entryDateOnly.getTime()) {
                                        // Ng√†y kh√°c nhau ‚Üí highlight
                                        altInput.style.backgroundColor = '#fff3cd';
                                        altInput.style.borderColor = '#ffc107';
                                        altInput.style.fontWeight = 'bold';
                                        altInput.title = 'Ca qua ƒë√™m: Ng√†y ra kh√°c ng√†y v√†o';
                                    } else {
                                        // C√πng ng√†y ‚Üí b·ªè highlight
                                        altInput.style.backgroundColor = '';
                                        altInput.style.borderColor = '';
                                        altInput.style.fontWeight = '';
                                        altInput.title = '';
                                    }
                                }
                            }
                        }
                    });

                    // T·ª± ƒë·ªông x√°c ƒë·ªãnh lo·∫°i ng√†y cho ng√†y m·∫∑c ƒë·ªãnh (h√¥m nay)
                    // S·ª≠ d·ª•ng setTimeout ƒë·ªÉ ƒë·∫£m b·∫£o flatpickr ƒë√£ kh·ªüi t·∫°o xong
                    setTimeout(() => {
                        if (flatpickrInstance.selectedDates.length > 0) {
                            const today = flatpickrInstance.selectedDates[0];
                            const todayStr = flatpickrInstance.formatDate(today, 'Y-m-d');
                            // G·ªçi h√†m x√°c ƒë·ªãnh lo·∫°i ng√†y
                            determineDayType(todayStr);
                        }
                    }, 100);
                }

                // Kh·ªüi t·∫°o flatpickr cho c√°c √¥ l·ªçc ng√†y trong ph·∫ßn ph√™ duy·ªát
                flatpickr("#approvalDateFrom", {
                    altInput: true,
                    altFormat: "d/m/Y",
                    dateFormat: "Y-m-d",
                    locale: "vn",
                    placeholder: "T·ª´ ng√†y"
                });

                flatpickr("#approvalDateTo", {
                    altInput: true,
                    altFormat: "d/m/Y",
                    dateFormat: "Y-m-d",
                    locale: "vn",
                    placeholder: "ƒê·∫øn ng√†y"
                });

                // Kh·ªüi t·∫°o flatpickr cho c√°c √¥ l·ªçc ng√†y trong ph·∫ßn l·ªãch s·ª≠ ch·∫•m c√¥ng ƒë√£ ph√™ duy·ªát
                flatpickr("#allHistoryDateFrom", {
                    altInput: true,
                    altFormat: "d/m/Y",
                    dateFormat: "Y-m-d",
                    locale: "vn",
                    placeholder: "T·ª´ ng√†y"
                });

                flatpickr("#allHistoryDateTo", {
                    altInput: true,
                    altFormat: "d/m/Y",
                    dateFormat: "Y-m-d",
                    locale: "vn",
                    placeholder: "ƒê·∫øn ng√†y"
                });

                // Initial load of attendance history (ch·ªâ khi l√† nh√¢n vi√™n)
                if (currentRole === 'EMPLOYEE') {
                    console.log('üöÄ Initial load for EMPLOYEE role');
                    // ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë∆∞·ª£c render ho√†n to√†n
                    setTimeout(() => {
                        console.log('üîÑ Initial load timeout triggered');
                        const attendanceHistoryElement = document.getElementById('attendanceHistory');
                        if (attendanceHistoryElement) {
                            console.log('‚úÖ Initial load: attendanceHistory element found');
                            // Ch·ªâ g·ªçi API n·∫øu ch∆∞a c√≥ d·ªØ li·ªáu
                            if (!dashboardAttendanceData || dashboardAttendanceData.length === 0) {
                                console.log('üì° Initial load: calling updateAttendanceHistory()');
                                updateAttendanceHistory();
                            } else {
                                console.log('üìä Initial load: data already exists');
                            }
                        } else {
                            console.log('‚ùå Initial load: attendanceHistory element not found');
                            // Force reload after another delay
                            setTimeout(() => {
                                console.log('üîÑ Force reload attempt');
                                updateAttendanceHistory();
                            }, 200);
                        }
                    }, 150); // TƒÉng th·ªùi gian ch·ªù ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë∆∞·ª£c c·∫≠p nh·∫≠t
                }

                // Setup form event listeners
                if (typeof setupFormEventListeners === 'function') {
                    setupFormEventListeners();
                }

                // ƒê·∫£m b·∫£o "Lo·∫°i ƒë·ªëi ·ª©ng" lu√¥n m·∫∑c ƒë·ªãnh l√† "-- ch·ªçn lo·∫°i ƒë·ªëi ·ª©ng --"
                const compTimeTypeSelect = document.getElementById('compTimeType');
                if (compTimeTypeSelect) {
                    compTimeTypeSelect.value = '';
                }

                // Initialize tooltips
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });

                if (roleSelect) {
                    roleSelect.addEventListener('change', function (e) {
                        // Disable select during role switch to prevent rapid changes
                        roleSelect.disabled = true;

                        // Use optimized role switch
                        if (typeof window.roleSwitchOptimizer !== 'undefined') {
                            window.roleSwitchOptimizer.switchRole(e.target.value);
                        } else {
                            switchRole(e.target.value);
                        }

                        // Re-enable select after optimized delay
                        setTimeout(() => {
                            roleSelect.disabled = false;
                        }, 1200); // Reduced from 2000ms to 1200ms for better UX
                    });
                }

                // Kh·ªüi t·∫°o nƒÉm cho filter
                const yearSelect = document.getElementById('filterYear');
                if (yearSelect) {
                    // Th√™m t√πy ch·ªçn placeholder
                    const placeholder = document.createElement('option');
                    placeholder.value = '';
                    placeholder.textContent = '-- NƒÉm --';
                    yearSelect.appendChild(placeholder);

                    const currentYear = new Date().getFullYear();
                    for (let year = currentYear; year >= currentYear - 5; year--) {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        yearSelect.appendChild(option);
                    }
                }
            }, 100); // ƒê·ª£i 100ms ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë∆∞·ª£c render ho√†n to√†n
        });
        // Function to delete attendance
        function deleteAttendance(id) {
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
            fetch(`/api/attendance/${id}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
                .then(response => {
                    const contentType = response.headers.get('content-type') || '';
                    if (contentType.includes('application/json')) {
                        return response.json();
                    } else {
                        return response.text().then(text => { throw new Error('Server tr·∫£ v·ªÅ d·ªØ li·ªáu kh√¥ng ph·∫£i JSON: ' + text); });
                    }
                })
                .then(data => {
                    if (data.error) {
                        showToast(data.error, 'error');
                    } else {
                        showToast('ƒê√£ x√≥a th√†nh c√¥ng!', 'success');
                        // Ch·ªâ c·∫≠p nh·∫≠t n·∫øu ƒëang ·ªü trang l·ªãch s·ª≠ ch·∫•m c√¥ng
                        const currentRole = document.getElementById('role-select')?.value || 'EMPLOYEE';
                        if (currentRole === 'EMPLOYEE') {
                            updateAttendanceHistory();
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('L·ªói server khi x√≥a! ' + error.message, 'error');
                });
        }

        function bindNoteCellClick() {
            document.querySelectorAll('.note-cell').forEach(function (cell) {
                cell.addEventListener('click', function (e) {
                    const note = this.dataset.fullNote;
                    if (note && note.trim() !== '') {
                        Swal.fire({
                            title: 'Ghi ch√∫',
                            html: `<div style='text-align:left;max-width:400px;word-break:break-word;'>${note}</div>`,
                            confirmButtonText: 'ƒê√≥ng',
                            width: 500
                        });
                    }
                });
            });
        }

        // ·∫®n toast l·ªói khi ng∆∞·ªùi d√πng b·∫Øt ƒë·∫ßu nh·∫≠p l·∫°i gi·ªù v√†o/ra
        document.getElementById('checkInTime')?.addEventListener('input', function () {
            Swal.close(); // ƒê√≥ng toast n·∫øu ƒëang hi·ªÉn th·ªã
        });
        document.getElementById('checkOutTime')?.addEventListener('input', function () {
            Swal.close(); // ƒê√≥ng toast n·∫øu ƒëang hi·ªÉn th·ªã
        });

        // S·ª± ki·ªán b·∫•m v√†o menu L·ªãch s·ª≠ ch·∫•m c√¥ng
        document.getElementById('attendanceHistoryMenu')?.addEventListener('click', function (e) {
            e.preventDefault();
            const roleSelect = document.getElementById('role-select');
            const currentRole = roleSelect ? roleSelect.value : 'EMPLOYEE';

            // Ch·ªâ ADMIN m·ªõi c√≥ th·ªÉ xem l·ªãch s·ª≠ to√†n b·ªô
            if (currentRole === 'ADMIN') {
                // ·∫®n c√°c section kh√°c v√† ch·ªâ hi·ªÉn th·ªã l·ªãch s·ª≠ to√†n b·ªô
                const attendanceFormSection = document.getElementById('attendanceFormSection');
                const attendanceHistorySection = document.getElementById('attendanceHistorySection');
                const approvalSection = document.getElementById('approvalSection');
                const allAttendanceHistorySection = document.getElementById('allAttendanceHistorySection');

                if (attendanceFormSection) attendanceFormSection.style.display = 'none';
                if (attendanceHistorySection) attendanceHistorySection.style.display = 'none';
                if (approvalSection) approvalSection.style.display = 'none';
                if (allAttendanceHistorySection) allAttendanceHistorySection.style.display = 'block';

                // M·∫∑c ƒë·ªãnh l√† th√°ng v√† nƒÉm hi·ªán t·∫°i khi v√†o
                const filterMonth = document.getElementById('filterMonth');
                const filterYear = document.getElementById('filterYear');
                const filterDate = new Date();

                if (filterMonth) filterMonth.value = filterDate.getMonth() + 1;
                if (filterYear) filterYear.value = filterDate.getFullYear();

                loadAllAttendanceHistory();
            } else {
                showToast('Ch·ªâ qu·∫£n tr·ªã vi√™n m·ªõi c√≥ th·ªÉ xem l·ªãch s·ª≠ ch·∫•m c√¥ng ƒë√£ ph√™ duy·ªát', 'warning');
            }
        });

        // S·ª± ki·ªán b·∫•m v√†o menu Trang ch·ªß
        document.getElementById('homeMenu')?.addEventListener('click', function (e) {
            e.preventDefault();
            const roleSelect = document.getElementById('role-select');
            const currentRole = roleSelect ? roleSelect.value : 'EMPLOYEE';

            // Load l·∫°i dashboard theo vai tr√≤ hi·ªán t·∫°i
            updateUIForRole(currentRole);

            // Reset form n·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô edit
            const editIdInput = document.getElementById('editAttendanceId');
            if (editIdInput && editIdInput.value) {
                resetForm();
            }

            // C·∫≠p nh·∫≠t active state cho menu
            const menuItems = document.querySelectorAll('.nav-link');
            menuItems.forEach(item => {
                item.classList.remove('active');
            });
            this.classList.add('active');

            showToast('ƒê√£ t·∫£i l·∫°i trang ch·ªß', 'success');
        });

        // Ph√¢n trang cho l·ªãch s·ª≠ to√†n b·ªô (ch·ªâ ADMIN)
        let allAttendanceData = [];
        let allCurrentPage = 1;
        const allRowsPerPage = 10;

        // Function t√≠nh t·ªïng th·ªùi gian ƒë·ªëi ·ª©ng - LOGIC M·ªöI: C·ªòNG T·∫§T C·∫¢ C√ÅC LO·∫†I ƒê·ªêI ·ª®NG
        function calculateTotalCompTime(record) {
            // Debug: Log d·ªØ li·ªáu ƒë·∫ßu v√†o - S·ª¨ D·ª§NG C·ªòT MINUTES M·ªöI
            console.log('üîç DEBUG calculateTotalCompTime - Input record:', {
                comp_time_regular: record.comp_time_regular,
                comp_time_overtime: record.comp_time_overtime,
                comp_time_ot_before_22: record.comp_time_ot_before_22,
                comp_time_ot_after_22: record.comp_time_ot_after_22
            });

            // C·ªông t·∫•t c·∫£ ƒë·ªëi ·ª©ng theo PH√öT ƒë·ªÉ tr√°nh s·ªë th·∫≠p ph√¢n
            function parseTimeToMinutes(v) {
                if (!v || v === '0:00' || v === 'NaN:NaN') return 0;
                if (typeof v === 'string' && v.includes(':')) {
                    const [h, m] = v.split(':').map(Number);
                    return (isNaN(h) ? 0 : h) * 60 + (isNaN(m) ? 0 : m);
                }
                const f = parseFloat(v);
                return isNaN(f) ? 0 : Math.round(f * 60);
            }
            function minutesToHHMM(mins) {
                const m = Math.max(0, Math.round(mins || 0));
                const h = Math.floor(m / 60);
                const mm = m % 60;
                return `${h}:${String(mm).padStart(2, '0')}`;
            }
            const totalMinutes =
                parseTimeToMinutes(record.comp_time_regular) +
                parseTimeToMinutes(record.comp_time_overtime) +
                parseTimeToMinutes(record.comp_time_ot_before_22) +
                parseTimeToMinutes(record.comp_time_ot_after_22);
            console.log('üîç DEBUG calculateTotalCompTime - Total minutes:', totalMinutes, '=>', minutesToHHMM(totalMinutes));
            return minutesToHHMM(totalMinutes);
        }

        function loadAllAttendanceHistory(page = 1) {
            const tbody = document.getElementById('allAttendanceHistoryBody');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="16">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

            // L·∫•y c√°c filter
            const search = document.getElementById('allHistorySearchName')?.value || '';
            const department = document.getElementById('allHistoryDepartment')?.value || '';
            const dateFrom = document.getElementById('allHistoryDateFrom')?.value || '';
            const dateTo = document.getElementById('allHistoryDateTo')?.value || '';
            const monthFrom = document.getElementById('allHistoryMonthFrom')?.value || '';
            const monthTo = document.getElementById('allHistoryMonthTo')?.value || '';
            const yearFrom = document.getElementById('allHistoryYearFrom')?.value || '';
            const yearTo = document.getElementById('allHistoryYearTo')?.value || '';

            // C·∫£nh b√°o nhanh n·∫øu kho·∫£ng ng√†y kh√¥ng h·ª£p l·ªá
            if (dateFrom && dateTo && new Date(dateFrom) > new Date(dateTo)) {
                showToast('Ng√†y b·∫Øt ƒë·∫ßu ph·∫£i nh·ªè h∆°n ho·∫∑c b·∫±ng ng√†y k·∫øt th√∫c', 'warning');
                tbody.innerHTML = '<tr><td colspan="16" class="no-data-row">Kho·∫£ng ng√†y kh√¥ng h·ª£p l·ªá</td></tr>';
                return;
            }

            let url = `/api/attendance/history?all=1&page=${page}&per_page=10`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (department) url += `&department=${encodeURIComponent(department)}`;
            if (dateFrom) url += `&date_from=${encodeURIComponent(dateFrom)}`;
            if (dateTo) url += `&date_to=${encodeURIComponent(dateTo)}`;
            if (monthFrom) url += `&month_from=${encodeURIComponent(monthFrom)}`;
            if (monthTo) url += `&month_to=${encodeURIComponent(monthTo)}`;
            if (yearFrom) url += `&year_from=${encodeURIComponent(yearFrom)}`;
            if (yearTo) url += `&year_to=${encodeURIComponent(yearTo)}`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data.data && data.data.length > 0) {
                        tbody.innerHTML = '';
                        data.data.forEach(record => {
                            // Debug logging ƒë·ªÉ ki·ªÉm tra d·ªØ li·ªáu
                            console.log('Debug - Processing record:', record);
                            console.log('Debug - Comp time fields:', {
                                comp_time_regular: record.comp_time_regular,
                                comp_time_overtime: record.comp_time_overtime,
                                comp_time_ot_before_22: record.comp_time_ot_before_22,
                                comp_time_ot_after_22: record.comp_time_ot_after_22
                            });

                            const totalCompTime = calculateTotalCompTime(record);
                            console.log('Debug - Total comp time for display:', totalCompTime);

                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${formatDate(record.date) || '-'}</td>
                                <td>${record.check_in || '--:--'}</td>
                                <td>${record.check_out || '--:--'}</td>
                                <td>${formatHourMinute(record.break_time) || '-'}</td>
                                <td>${formatHourMinute(totalCompTime) || '-'}</td>
                                <td>${record.total_work_hours || '-'}</td>
                                <td>${record.work_hours_display || '-'}</td>
                                <td>${record.overtime_before_22 || '-'}</td>
                                <td>${record.overtime_after_22 || '-'}</td>
                                <td>${translateHolidayType(record.holiday_type)}</td>
                                <td>${record.user_name || '-'}</td>
                                <td>${record.department || '-'}</td>
                                <td>${translateStatus(record.status) || '-'}</td>
                                <td>${record.signature ? '<i class="fas fa-check text-success"></i> C√≥' : '<i class="fas fa-times text-muted"></i> Kh√¥ng'}</td>
                                <td><a href="/admin/attendance/${record.id}/export-overtime-pdf" class="btn btn-outline-primary btn-sm ms-1"><i class="fas fa-print"></i> In gi·∫•y tƒÉng ca</a></td>
                                <td>${record.note || '-'}</td>
                            `;
                            tbody.appendChild(row);
                        });

                        // C·∫≠p nh·∫≠t ph√¢n trang
                        if (data.total && data.total > 0) {
                            const totalPages = Math.ceil(data.total / 10);
                            renderAllAttendancePagination(page, totalPages);
                        }
                    } else {
                        tbody.innerHTML = '<tr><td colspan="16" class="no-data-row">Kh√¥ng c√≥ d·ªØ li·ªáu ch·∫•m c√¥ng ƒë√£ ph√™ duy·ªát</td></tr>';
                        renderAllAttendancePagination(1, 1);
                    }
                })
                .catch(() => {
                    tbody.innerHTML = '<tr><td colspan="16" class="no-data-row">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>';
                });
        }

        function renderAllAttendancePagination(currentPage, totalPages) {
            const pagination = document.getElementById('allAttendancePagination');
            pagination.innerHTML = '';

            function createPageItem(i, active = false) {
                const li = document.createElement('li');
                li.className = 'page-item' + (active ? ' active' : '');
                const a = document.createElement('a');
                a.className = 'page-link';
                a.href = '#';
                a.textContent = i;
                a.addEventListener('click', function (e) {
                    e.preventDefault();
                    allCurrentPage = i;
                    loadAllAttendanceHistory(allCurrentPage);
                });
                li.appendChild(a);
                pagination.appendChild(li);
            }

            if (totalPages <= 7) {
                for (let i = 1; i <= totalPages; i++) createPageItem(i, i === currentPage);
            } else {
                createPageItem(1, currentPage === 1);
                if (currentPage > 4) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(li);
                }
                for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) {
                    createPageItem(i, i === currentPage);
                }
                if (currentPage < totalPages - 3) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(li);
                }
                createPageItem(totalPages, currentPage === totalPages);
            }
        }

        function renderAllAttendancePage(pageData) {
            const tbody = document.getElementById('allAttendanceHistoryBody');
            tbody.innerHTML = '';
            if (!pageData || pageData.length === 0) {
                const totalRows = allRowsPerPage;
                const middleRow = Math.floor(totalRows / 2);
                for (let i = 0; i < totalRows; i++) {
                    const emptyRow = document.createElement('tr');
                    emptyRow.className = 'empty-row';
                    if (i === middleRow) {
                        emptyRow.innerHTML = `<td colspan="12" class="no-data-row">Kh√¥ng c√≥ d·ªØ li·ªáu ch·∫•m c√¥ng</td>`;
                    } else {
                        emptyRow.innerHTML = `
                            <td style="height: 50px;"></td> <td style="height: 50px;"></td> <td style="height: 50px;"></td>
                            <td style="height: 50px;"></td> <td style="height: 50px;"></td> <td style="height: 50px;"></td>
                            <td style="height: 50px;"></td> <td style="height: 50px;"></td> <td style="height: 50px;"></td>
                            <td style="height: 50px;"></td> <td style="height: 50px;"></td> <td style="height: 50px;"></td>
                            <td style="height: 50px;"></td>
                        `;
                    }
                    tbody.appendChild(emptyRow);
                }
                return;
            }

            pageData.forEach(record => {
                let statusText = record.approved ? 'ƒê√£ ph√™ duy·ªát' : 'Ch·ªù ph√™ duy·ªát';
                if (record.status === 'rejected') statusText = 'T·ª´ ch·ªëi';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(record.date)}</td>
                    <td>${record.check_in || '--:--'}</td>
                    <td>${record.check_out || '--:--'}</td>
                    <td>${formatHourMinute(record.break_time) || '-'}</td>
                                                    <td>${formatHourMinute(calculateTotalCompTime(record)) || '-'}</td>
                    <td>${formatHourMinute(record.comp_time_overtime) || '-'}</td>
                    <td>${record.total_work_hours || '-'}</td>
                    <td>${record.work_hours_display || '-'}</td>
                    <td>${record.overtime_before_22 || '0:00'}</td>
                    <td>${record.overtime_after_22 || '0:00'}</td>
                    <td>${translateHolidayType(record.holiday_type)}</td>
                    <td>${record.user_name || '-'}</td>
                    <td>${record.department || '-'}</td>
                    <td>${statusText}</td>
                    <td style="height: 50px; width: 200px; padding: 0 !important;">
                        <div class="action-container">
                            ${(() => {
                        const adminNow = document.getElementById('role-select')?.value === 'ADMIN';
                        let buttons = '';
                        if (record.approved && adminNow) {
                            buttons += `<a href="/admin/attendance/${record.id}/export-overtime-pdf" class="btn btn-outline-primary btn-sm ms-1"><i class='fas fa-print'></i> In gi·∫•y tƒÉng ca</a>`;
                            buttons += `<button class="btn btn-outline-success btn-sm ms-1 duplicate-attendance-btn" data-id="${record.id}" data-date="${record.date}" data-user="${record.user_name || ''}" title="T·∫°o l·∫°i b·∫£n ghi ch·∫•m c√¥ng n√†y ƒë·ªÉ ph√™ duy·ªát l·∫°i t·ª´ ƒë·∫ßu">
                                        <i class="fas fa-copy"></i> T·∫°o l·∫°i
                                    </button>`;
                        }
                        return buttons;
                    })()}
                        </div>
                    </td>
                    <td class="note-cell" data-full-note="${record.note || ''}">${record.note || '-'}</td>
                `;
                tbody.appendChild(row);
            });

            const emptyRowsNeeded = Math.max(0, allRowsPerPage - pageData.length);
            for (let i = 0; i < emptyRowsNeeded; i++) {
                const emptyRow = document.createElement('tr');
                emptyRow.className = 'empty-row';
                emptyRow.innerHTML = `
                    <td style="height: 50px;"></td> <td style="height: 50px;"></td> <td style="height: 50px;"></td>
                    <td style="height: 50px;"></td> <td style="height: 50px;"></td> <td style="height: 50px;"></td>
                    <td style="height: 50px;"></td> <td style="height: 50px;"></td> <td style="height: 50px;"></td>
                    <td style="height: 50px;"></td> <td style="height: 50px;"></td> <td style="height: 50px;"></td>
                    <td style="height: 50px;"></td>
                `;
                tbody.appendChild(emptyRow);
            }

            // G·∫Øn event listener cho c√°c n√∫t "T·∫°o l·∫°i"
            document.querySelectorAll('.duplicate-attendance-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const attendanceId = this.getAttribute('data-id');
                    const date = this.getAttribute('data-date');
                    const userName = this.getAttribute('data-user');
                    duplicateAttendance(attendanceId, date, userName);
                });
            });
        }

        // H√†m duplicate attendance
        async function duplicateAttendance(attendanceId, date, userName) {
            const result = await Swal.fire({
                title: 'X√°c nh·∫≠n t·∫°o l·∫°i',
                html: `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën t·∫°o l·∫°i b·∫£n ghi ch·∫•m c√¥ng?<br><br>
                       <strong>Ng√†y:</strong> ${date}<br>
                       <strong>Nh√¢n vi√™n:</strong> ${userName}<br><br>
                       <small class="text-muted">B·∫£n ghi m·ªõi s·∫Ω ·ªü tr·∫°ng th√°i "Ch·ªù ph√™ duy·ªát" v√† b·∫°n c√≥ th·ªÉ ph√™ duy·ªát l·∫°i t·ª´ ƒë·∫ßu.</small>`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'T·∫°o l·∫°i',
                cancelButtonText: 'H·ªßy',
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d'
            });

            if (!result.isConfirmed) {
                return;
            }

            // Hi·ªÉn th·ªã loading
            Swal.fire({
                title: 'ƒêang x·ª≠ l√Ω...',
                html: '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang t·∫°o l·∫°i b·∫£n ghi ch·∫•m c√¥ng',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false
            });

            try {
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                const response = await fetch(`/api/attendance/${attendanceId}/duplicate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    Swal.fire({
                        title: 'Th√†nh c√¥ng!',
                        html: `${data.message}<br><br>
                               <strong>ID b·∫£n ghi m·ªõi:</strong> ${data.new_attendance_id}<br>
                               <strong>Ng√†y:</strong> ${data.date}<br>
                               <strong>Nh√¢n vi√™n:</strong> ${data.user_name}`,
                        icon: 'success',
                        confirmButtonText: 'ƒê√≥ng'
                    });

                    // Reload l·∫°i danh s√°ch
                    loadAllAttendanceHistory(allCurrentPage);
                } else {
                    Swal.fire({
                        title: 'L·ªói',
                        text: data.error || 'ƒê√£ x·∫£y ra l·ªói khi t·∫°o l·∫°i b·∫£n ghi ch·∫•m c√¥ng',
                        icon: 'error',
                        confirmButtonText: 'ƒê√≥ng'
                    });
                }
            } catch (error) {
                console.error('Error duplicating attendance:', error);
                Swal.fire({
                    title: 'L·ªói',
                    text: 'ƒê√£ x·∫£y ra l·ªói khi t·∫°o l·∫°i b·∫£n ghi ch·∫•m c√¥ng. Vui l√≤ng th·ª≠ l·∫°i sau.',
                    icon: 'error',
                    confirmButtonText: 'ƒê√≥ng'
                });
            }
        }

        function getApprovalFilters() {
            return {
                search: document.getElementById('approvalSearchName')?.value || '',
                department: document.getElementById('approvalDepartment')?.value || '',
                date_from: document.getElementById('approvalDateFrom')?.value || '',
                date_to: document.getElementById('approvalDateTo')?.value || ''
            };
        }
        async function loadApprovalAttendance(page = 1) {
            const approvalBody = document.getElementById('approvalAttendanceBody');
            if (!approvalBody) return;
            approvalBody.innerHTML = '<tr><td colspan="16" class="no-data-row">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

            // L·∫•y vai tr√≤ hi·ªán t·∫°i ƒë·ªÉ ki·ªÉm tra quy·ªÅn admin
            const roleSelect = document.getElementById('role-select');
            const isAdmin = roleSelect ? roleSelect.value === 'ADMIN' : false;

            const filters = getApprovalFilters();
            let url = `/api/attendance/pending?page=${page}&per_page=${approvalPerPage}`;
            if (filters.search) url += `&search=${encodeURIComponent(filters.search)}`;
            if (filters.department) url += `&department=${encodeURIComponent(filters.department)}`;
            if (filters.date_from) url += `&date_from=${encodeURIComponent(filters.date_from)}`;
            if (filters.date_to) url += `&date_to=${encodeURIComponent(filters.date_to)}`;
            try {
                const response = await fetch(url);
                const result = await response.json();
                approvalBody.innerHTML = '';
                if (!result.data || result.data.length === 0) {
                    approvalBody.innerHTML = '<tr><td colspan="16" class="no-data-row">Kh√¥ng c√≥ b·∫£n ghi ch·∫•m c√¥ng ch·ªù ph√™ duy·ªát</td></tr>';
                    renderApprovalPagination(1, 1);
                    // Hide bulk approval button
                    const bulkContainer = document.getElementById('bulkApprovalContainer');
                    if (bulkContainer) bulkContainer.style.setProperty('display', 'none', 'important');
                    return;
                }

                // Show bulk approval button if there is data
                const bulkContainer = document.getElementById('bulkApprovalContainer');
                if (bulkContainer) bulkContainer.style.removeProperty('display');
                result.data.forEach(record => {
                    const row = document.createElement('tr');

                    row.innerHTML = `
                        <td>${formatDate(record.date)}</td>
                        <td>${record.check_in || '--:--'}</td>
                        <td>${record.check_out || '--:--'}</td>
                        <td>${formatHourMinute(record.break_time) || '-'}</td>
                        <td>${formatHourMinute(calculateTotalCompTime(record)) || '-'}</td>
                        <td>${record.total_work_hours || '-'}</td>
                        <td>${record.work_hours_display || '-'}</td>
                        <td>${record.overtime_before_22 || '0:00'}</td>
                        <td>${record.overtime_after_22 || '0:00'}</td>
                        <td>${translateHolidayType(record.holiday_type)}</td>
                        <td>${record.user_name || '-'}</td>
                        <td>${record.department || '-'}</td>
                        <td>${translateStatus(record.status)}</td>
                        <td style="height: 50px; width: 100px; text-align: center;">
                            <div class="signature-status">
                                ${getSignatureStatus(record)}
                            </div>
                        </td>
                        <td style="height: 50px; width: 120px; padding: 0 !important;">
                            <div class="action-container">
                            ${['pending', 'pending_manager', 'pending_admin'].includes(record.status) ? `
                                    <div class="btn-action-container">
                                        <button class='btn btn-success btn-sm approve-attendance-btn' data-id='${record.id}' title="Ph√™ duy·ªát">
                                            <i class='fas fa-check me-1'></i>Ph√™ duy·ªát
                                        </button>
                                        <button class='btn btn-danger btn-sm reject-attendance-btn' data-id='${record.id}' title="T·ª´ ch·ªëi">
                                            <i class='fas fa-times me-1'></i>T·ª´ ch·ªëi
                                        </button>
                            ` : `
                                <div class="btn-action-container">
                                    ${getOvertimePrintButton(record.id, record.approved, isAdmin)}
                                    ${getOvertimeTestButton(record.id, record.approved, isAdmin)}
                                    ${isAdmin ? `<button class='btn btn-info btn-sm debug-signature-btn' data-id='${record.id}' title="Debug ch·ªØ k√Ω"><i class='fas fa-bug me-1'></i>Debug</button>` : ''}
                                </div>
                            `}
                            </div>
                        </td>
                        <td style="height: 50px; width: 120px;" class="note-cell" data-full-note="${record.note || ''}">
                            ${record.note || '-'}
                        </td>
                    `;
                    approvalBody.appendChild(row);
                });
                bindNoteCellClick(); // K√≠ch ho·∫°t popup cho ghi ch√∫
                renderApprovalPagination(result.page, Math.ceil(result.total / result.per_page));

                // G·∫Øn event listeners cho c√°c n√∫t ph√™ duy·ªát v√† t·ª´ ch·ªëi
                document.querySelectorAll('.approve-attendance-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const id = this.getAttribute('data-id');
                        approveAttendance(id, 'approve');
                    });
                });

                document.querySelectorAll('.reject-attendance-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const id = this.getAttribute('data-id');
                        approveAttendance(id, 'reject');
                    });
                });

                // G·∫Øn event listeners cho n√∫t debug ch·ªØ k√Ω
                document.querySelectorAll('.debug-signature-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const id = this.getAttribute('data-id');
                        debugSignature(id);
                    });
                });
            } catch (e) {
                approvalBody.innerHTML = '<tr><td colspan="16" class="no-data-row">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>';
                renderApprovalPagination(1, 1);
            }
        }
        function renderApprovalPagination(current, total) {
            const pag = document.getElementById('approvalPagination');
            pag.innerHTML = '';
            if (total <= 1) return;
            function createPageItem(i, active = false) {
                const li = document.createElement('li');
                li.className = 'page-item' + (active ? ' active' : '');
                const a = document.createElement('a');
                a.className = 'page-link';
                a.href = '#';
                a.textContent = i;
                a.addEventListener('click', function (e) {
                    e.preventDefault();
                    approvalPage = i;
                    loadApprovalAttendance(approvalPage);
                });
                li.appendChild(a);
                pag.appendChild(li);
            }
            if (total <= 7) {
                for (let i = 1; i <= total; i++) createPageItem(i, i === current);
            } else {
                createPageItem(1, current === 1);
                if (current > 4) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = '<span class="page-link">...</span>';
                    pag.appendChild(li);
                }
                for (let i = Math.max(2, current - 1); i <= Math.min(total - 1, current + 1); i++) {
                    createPageItem(i, i === current);
                }
                if (current < total - 3) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = '<span class="page-link">...</span>';
                    pag.appendChild(li);
                }
                createPageItem(total, current === total);
            }
        }

        function translateHolidayType(holidayType) {
            if (!holidayType) return '-';
            const types = {
                'Ng√†y th∆∞·ªùng': 'Ng√†y th∆∞·ªùng',
                'Cu·ªëi tu·∫ßn': 'Cu·ªëi tu·∫ßn',
                'L·ªÖ Vi·ªát Nam': 'L·ªÖ Vi·ªát Nam',
                'L·ªÖ Nh·∫≠t B·∫£n': 'L·ªÖ Nh·∫≠t B·∫£n',
                'normal': 'Ng√†y th∆∞·ªùng',
                'weekend': 'Cu·ªëi tu·∫ßn',
                'vietnamese_holiday': 'L·ªÖ Vi·ªát Nam',
                'japanese_holiday': 'L·ªÖ Nh·∫≠t B·∫£n'
            };
            return types[holidayType] || holidayType;
        }

        function translateStatus(status) {
            const translations = {
                'approved': 'ƒê√£ ph√™ duy·ªát',
                'pending': 'Ch·ªù ph√™ duy·ªát',
                'pending_manager': 'Ch·ªù qu·∫£n l√Ω duy·ªát',
                'pending_admin': 'Ch·ªù admin duy·ªát',
                'rejected': 'T·ª´ ch·ªëi'
            };
            return translations[status] || status;
        }

        function getSignatureStatus(record) {
            // 3 tr·∫°ng th√°i: NV, TL, QL
            const hasEmployeeSignature = record.signature && record.signature.trim() !== '';
            // Ch·ªâ hi·ªÉn th·ªã d·∫•u V khi th·ª±c s·ª± ƒë√£ ph√™ duy·ªát, kh√¥ng ch·ªâ d·ª±a v√†o c√≥ ch·ªØ k√Ω
            const hasTeamLeaderApproved = (record.team_leader_signature && record.team_leader_signature.trim() !== '') &&
                !['pending'].includes(record.status);
            const hasManagerApproved = (record.manager_signature && record.manager_signature.trim() !== '') &&
                !['pending', 'pending_manager'].includes(record.status);

            // M√†u: xanh l√° #219653 (ƒë√£ k√Ω), x√°m #888 (ch∆∞a k√Ω)
            const circles = [
                {
                    signed: hasEmployeeSignature,
                    label: 'Nh√¢n vi√™n',
                    tooltip: hasEmployeeSignature ? 'Nh√¢n vi√™n ƒë√£ k√Ω' : 'Nh√¢n vi√™n ch∆∞a k√Ω',
                    icon: hasEmployeeSignature ? 'fa-check' : 'fa-clock'
                },
                {
                    signed: hasTeamLeaderApproved,
                    label: 'Tr∆∞·ªüng nh√≥m',
                    tooltip: hasTeamLeaderApproved ? 'Tr∆∞·ªüng nh√≥m ƒë√£ ph√™ duy·ªát' : 'Tr∆∞·ªüng nh√≥m ch∆∞a ph√™ duy·ªát',
                    icon: hasTeamLeaderApproved ? 'fa-check' : 'fa-clock'
                },
                {
                    signed: hasManagerApproved,
                    label: 'Qu·∫£n l√Ω',
                    tooltip: hasManagerApproved ? 'Qu·∫£n l√Ω ƒë√£ ph√™ duy·ªát' : 'Qu·∫£n l√Ω ch∆∞a ph√™ duy·ªát',
                    icon: hasManagerApproved ? 'fa-check' : 'fa-clock'
                }
            ];
            let html = '<div class="signature-circles-row">';
            circles.forEach(c => {
                html += `<span class="signature-circle${c.signed ? ' signed' : ''}" title="${c.tooltip}"><i class="fas ${c.icon}"></i></span>`;
            });
            html += '</div>';
            return html;
        }

        // G·ªçi khi trang load n·∫øu c√≥ approval section
        if (document.getElementById('approvalAttendanceBody')) {
            loadApprovalAttendance();
        }
        document.getElementById('btnApprovalFilter')?.addEventListener('click', function () {
            approvalPage = 1;
            loadApprovalAttendance(approvalPage);
        });
        document.getElementById('btnApprovalReset')?.addEventListener('click', function () {
            document.getElementById('approvalSearchName').value = '';
            if (document.getElementById('approvalDepartment')) document.getElementById('approvalDepartment').value = '';
            document.getElementById('approvalDateFrom').value = '';
            document.getElementById('approvalDateTo').value = '';
            approvalPage = 1;
            loadApprovalAttendance(approvalPage);
        });

        // X·ª≠ l√Ω s·ª± ki·ªán cho c√°c n√∫t filter trong l·ªãch s·ª≠ to√†n b·ªô
        document.getElementById('btnFilterAttendance')?.addEventListener('click', function () {
            loadAllAttendanceHistory(1);
        });

        document.getElementById('btnResetFilter')?.addEventListener('click', function () {
            document.getElementById('filterMonth').value = '';
            document.getElementById('filterYear').value = '';
            loadAllAttendanceHistory();
        });

        // X·ª≠ l√Ω n√∫t "Tr·ªü v·ªÅ" t·ª´ l·ªãch s·ª≠ to√†n b·ªô
        document.getElementById('btnBackToDashboard')?.addEventListener('click', function () {
            const roleSelect = document.getElementById('role-select');
            const currentRole = roleSelect ? roleSelect.value : 'EMPLOYEE';

            if (currentRole === 'ADMIN') {
                // Hi·ªÉn th·ªã l·∫°i giao di·ªán qu·∫£n tr·ªã vi√™n m·∫∑c ƒë·ªãnh
                updateUIForRole(currentRole);
            }
        });

        function switchRole(role) {
            // L·∫•y CSRF token
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

            fetch('/switch-role', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ role })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        showToast(data.error, 'error');
                    } else {
                        // Tr√°nh hi·ªÉn th·ªã toast ·ªü ƒë√¢y v√¨ role-switch-optimizer ƒë√£ hi·ªÉn th·ªã
                        updateUIForRole(role);
                    }
                })
                .catch(error => {
                    console.error('Error switching role:', error);
                    showToast('L·ªói khi chuy·ªÉn vai tr√≤', 'error');
                });
        }

        function updateUIForRole(role) {
            console.log('üîç updateUIForRole called with role:', role);

            const attendanceFormSection = document.getElementById('attendanceFormSection');
            const attendanceHistorySection = document.getElementById('attendanceHistorySection');
            const approvalSection = document.getElementById('approvalSection');
            const allAttendanceHistorySection = document.getElementById('allAttendanceHistorySection');
            const departmentFilterContainer = document.getElementById('departmentFilterContainer');
            const adminUsersMenu = document.getElementById('adminUsersMenu');
            const adminHolidaysMenu = document.getElementById('adminHolidaysMenu');
            const adminLeaveHistoryAllMenu = document.getElementById('adminLeaveHistoryAllMenu');
            const attendanceHistoryMenuWrapper = document.getElementById('attendanceHistoryMenuWrapper');
            const settingsMenu = document.getElementById('settingsMenu');

            console.log('üîç Admin menu elements found:', {
                adminUsersMenu: !!adminUsersMenu,
                adminHolidaysMenu: !!adminHolidaysMenu,
                adminLeaveHistoryAllMenu: !!adminLeaveHistoryAllMenu,
                attendanceHistoryMenuWrapper: !!attendanceHistoryMenuWrapper
            });

            // Menu ngh·ªâ ph√©p
            const employeeLeaveMenu = document.getElementById('employeeLeaveMenu');
            const employeeLeaveStatusMenu = document.getElementById('employeeLeaveStatusMenu');
            const employeeLeaveHistoryMenu = document.getElementById('employeeLeaveHistoryMenu');
            const managerLeaveMenu = document.getElementById('managerLeaveMenu');

            const testSignatureButtonContainer = document.getElementById('testSignatureButtonContainer');
            const pageTitle = document.querySelector('.page-title');

            // ·∫®n t·∫•t c·∫£ c√°c section tr∆∞·ªõc
            if (attendanceFormSection) attendanceFormSection.style.display = 'none';
            if (attendanceHistorySection) attendanceHistorySection.style.display = 'none';
            if (approvalSection) approvalSection.style.display = 'none';
            if (allAttendanceHistorySection) allAttendanceHistorySection.style.display = 'none';

            // ·∫®n filter ph√≤ng ban m·∫∑c ƒë·ªãnh
            if (departmentFilterContainer) departmentFilterContainer.style.display = 'none';

            // ·∫®n menu qu·∫£n l√Ω users m·∫∑c ƒë·ªãnh
            console.log('üîç Hiding admin menus by default');
            if (adminUsersMenu) {
                adminUsersMenu.style.display = 'none';
                console.log('‚úÖ adminUsersMenu hidden');
            } else {
                console.log('‚ùå adminUsersMenu not found for hiding');
            }
            if (adminHolidaysMenu) {
                adminHolidaysMenu.style.display = 'none';
                console.log('‚úÖ adminHolidaysMenu hidden');
            } else {
                console.log('‚ùå adminHolidaysMenu not found for hiding');
            }
            if (adminLeaveHistoryAllMenu) {
                adminLeaveHistoryAllMenu.style.display = 'none';
                console.log('‚úÖ adminLeaveHistoryAllMenu hidden');
            } else {
                console.log('‚ùå adminLeaveHistoryAllMenu not found for hiding');
            }
            // ·∫®n menu l·ªãch s·ª≠ ch·∫•m c√¥ng m·∫∑c ƒë·ªãnh
            if (attendanceHistoryMenuWrapper) attendanceHistoryMenuWrapper.style.display = 'none';

            // ·∫®n menu ngh·ªâ ph√©p m·∫∑c ƒë·ªãnh
            if (employeeLeaveMenu) employeeLeaveMenu.style.display = 'none';
            if (employeeLeaveStatusMenu) employeeLeaveStatusMenu.style.display = 'none';
            if (employeeLeaveHistoryMenu) employeeLeaveHistoryMenu.style.display = 'none';
            if (managerLeaveMenu) managerLeaveMenu.style.display = 'none';

            // ·∫®n menu C√†i ƒë·∫∑t cho ADMIN, MANAGER, TEAM_LEADER (ch·ªâ EMPLOYEE m·ªõi th·∫•y)
            if (settingsMenu && (role === 'ADMIN' || role === 'MANAGER' || role === 'TEAM_LEADER')) {
                settingsMenu.style.display = 'none';
            } else if (settingsMenu) {
                settingsMenu.style.display = 'block';
            }

            // ·∫®n n√∫t test ch·ªØ k√Ω m·∫∑c ƒë·ªãnh
            if (testSignatureButtonContainer) testSignatureButtonContainer.style.display = 'none';

            if (role === 'EMPLOYEE') {
                // Hi·ªÉn th·ªã form ch·∫•m c√¥ng v√† l·ªãch s·ª≠ cho nh√¢n vi√™n
                if (attendanceFormSection) attendanceFormSection.style.display = 'block';
                if (attendanceHistorySection) attendanceHistorySection.style.display = 'block';
                // Hi·ªÉn th·ªã n√∫t test ch·ªØ k√Ω cho nh√¢n vi√™n
                if (testSignatureButtonContainer) testSignatureButtonContainer.style.display = 'block';
                // Hi·ªÉn th·ªã menu ƒëƒÉng k√Ω ngh·ªâ ph√©p cho nh√¢n vi√™n
                if (employeeLeaveMenu) employeeLeaveMenu.style.display = 'block';
                if (employeeLeaveStatusMenu) employeeLeaveStatusMenu.style.display = 'block';
                if (employeeLeaveHistoryMenu) employeeLeaveHistoryMenu.style.display = 'block';
                // Hi·ªÉn th·ªã menu C√†i ƒë·∫∑t cho nh√¢n vi√™n
                if (settingsMenu) settingsMenu.style.display = 'block';

                // ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë∆∞·ª£c c·∫≠p nh·∫≠t tr∆∞·ªõc khi g·ªçi API
                setTimeout(() => {
                    console.log('üîÑ Attempting to load attendance history for EMPLOYEE role');
                    const attendanceHistoryElement = document.getElementById('attendanceHistory');
                    if (attendanceHistoryElement) {
                        console.log('‚úÖ attendanceHistory element found');
                        // Ch·ªâ g·ªçi API n·∫øu ch∆∞a c√≥ d·ªØ li·ªáu ho·∫∑c d·ªØ li·ªáu c≈©
                        if (!dashboardAttendanceData || dashboardAttendanceData.length === 0) {
                            console.log('üì° Calling updateAttendanceHistory()');
                            updateAttendanceHistory();
                        } else {
                            console.log('üìä Data already exists, length:', dashboardAttendanceData.length);
                        }
                    } else {
                        console.log('‚ùå attendanceHistory element not found, retrying...');
                        // N·∫øu element ch∆∞a s·∫µn s√†ng, th·ª≠ l·∫°i sau 100ms
                        setTimeout(() => {
                            const retryElement = document.getElementById('attendanceHistory');
                            if (retryElement) {
                                console.log('‚úÖ Retry successful, element found');
                                if (!dashboardAttendanceData || dashboardAttendanceData.length === 0) {
                                    console.log('üì° Calling updateAttendanceHistory() on retry');
                                    updateAttendanceHistory();
                                }
                            } else {
                                console.log('‚ùå Retry failed, element still not found');
                            }
                        }, 100);
                    }
                }, 50);
                if (pageTitle) pageTitle.textContent = 'B·∫£ng ƒëi·ªÅu khi·ªÉn';
            } else if (['TEAM_LEADER', 'MANAGER', 'ADMIN'].includes(role)) {
                // Hi·ªÉn th·ªã ph·∫ßn ph√™ duy·ªát cho qu·∫£n l√Ω v√† admin
                if (approvalSection) approvalSection.style.display = 'block';
                // Hi·ªÉn th·ªã filter ph√≤ng ban cho MANAGER v√† ADMIN
                if (['MANAGER', 'ADMIN'].includes(role) && departmentFilterContainer) {
                    departmentFilterContainer.style.display = 'block';
                }
                // Ch·ªâ hi·ªÉn th·ªã menu qu·∫£n l√Ω users cho ADMIN
                if (role === 'ADMIN') {
                    console.log('üîç Setting ADMIN menus to visible');
                    if (adminUsersMenu) {
                        adminUsersMenu.style.display = 'block';
                        console.log('‚úÖ adminUsersMenu set to block');
                    } else {
                        console.log('‚ùå adminUsersMenu not found');
                    }
                    if (adminHolidaysMenu) {
                        adminHolidaysMenu.style.display = 'block';
                        console.log('‚úÖ adminHolidaysMenu set to block');
                    } else {
                        console.log('‚ùå adminHolidaysMenu not found');
                    }
                    if (adminLeaveHistoryAllMenu) {
                        adminLeaveHistoryAllMenu.style.display = 'block';
                        console.log('‚úÖ adminLeaveHistoryAllMenu set to block');
                    } else {
                        console.log('‚ùå adminLeaveHistoryAllMenu not found');
                    }
                } else {
                    console.log('üîç Not ADMIN role, hiding admin menus. Current role:', role);
                }
                // Ch·ªâ hi·ªÉn th·ªã menu l·ªãch s·ª≠ ch·∫•m c√¥ng cho ADMIN
                if (role === 'ADMIN' && attendanceHistoryMenuWrapper) {
                    attendanceHistoryMenuWrapper.style.display = 'block';
                }
                // ·∫®n menu C√†i ƒë·∫∑t cho ADMIN, MANAGER, TEAM_LEADER (ch·ªâ EMPLOYEE m·ªõi th·∫•y)
                if ((role === 'ADMIN' || role === 'MANAGER' || role === 'TEAM_LEADER') && settingsMenu) {
                    settingsMenu.style.display = 'none';
                } else if (settingsMenu) {
                    // Hi·ªÉn th·ªã menu C√†i ƒë·∫∑t cho EMPLOYEE
                    settingsMenu.style.display = 'block';
                }
                // Hi·ªÉn th·ªã menu ngh·ªâ ph√©p c·∫ßn ph√™ duy·ªát cho tr∆∞·ªüng nh√≥m/qu·∫£n l√Ω/qu·∫£n tr·ªã vi√™n
                if (managerLeaveMenu) managerLeaveMenu.style.display = 'block';
                // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng ƒë∆°n ngh·ªâ ph√©p c·∫ßn ph√™ duy·ªát
                updatePendingLeaveCount();

                // Hi·ªÉn th·ªã bulk export section cho ADMIN
                const bulkExportSection = document.getElementById('bulkExportSection');
                if (role === 'ADMIN' && bulkExportSection) {
                    bulkExportSection.style.display = 'block';
                } else if (bulkExportSection) {
                    bulkExportSection.style.display = 'none';
                }
                // Load d·ªØ li·ªáu ph√™ duy·ªát
                loadApprovalAttendance();
                if (pageTitle) pageTitle.textContent = 'Qu·∫£n l√Ω ch·∫•m c√¥ng';

                // Hi·ªÉn th·ªã n√∫t ph√™ duy·ªát h√†ng lo·∫°t
                if (typeof toggleBulkApprovalButton === 'function') {
                    toggleBulkApprovalButton();
                }
            }

            // C·∫≠p nh·∫≠t active state cho menu
            updateMenuActiveState(role);
        }

        function updateMenuActiveState(role) {
            // C·∫≠p nh·∫≠t active state cho c√°c menu item
            const menuItems = document.querySelectorAll('.nav-link');
            menuItems.forEach(item => {
                item.classList.remove('active');
            });

            // Set active cho menu ph√π h·ª£p
            if (role === 'EMPLOYEE') {
                const homeMenu = document.querySelector('.nav-link');
                if (homeMenu) homeMenu.classList.add('active');
            } else {
                // T√¨m menu ph√™ duy·ªát ho·∫∑c t·∫°o m·ªõi
                const approvalMenu = document.querySelector('.nav-link[data-role="approval"]');
                if (approvalMenu) {
                    approvalMenu.classList.add('active');
                } else {
                    // N·∫øu kh√¥ng c√≥ menu ph√™ duy·ªát, set active cho trang ch·ªß
                    const homeMenu = document.querySelector('.nav-link');
                    if (homeMenu) homeMenu.classList.add('active');
                }
            }
        }

        // H√†m ph√™ duy·ªát ch·∫•m c√¥ng v·ªõi h·ªá th·ªëng ch·ªØ k√Ω th√¥ng minh
        async function approveAttendance(attendanceId, action) {
            console.log('approveAttendance called with:', { attendanceId, action });

            // L·∫•y CSRF token
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
            console.log('CSRF Token:', csrfToken);

            if (action === 'approve') {
                console.log('Processing approval...');

                // Ki·ªÉm tra tr·∫°ng th√°i ch·ªØ k√Ω tr∆∞·ªõc
                const signatureStatus = await checkSignatureStatus(attendanceId);
                console.log('Signature status:', signatureStatus);

                if (!signatureStatus) {
                    console.error('Signature status check failed - API returned null');
                    showToast('L·ªói ki·ªÉm tra tr·∫°ng th√°i ch·ªØ k√Ω', 'error');
                    return;
                }

                if (signatureStatus.is_admin) {
                    // Admin kh√¥ng c·∫ßn ch·ªØ k√Ω, ph√™ duy·ªát tr·ª±c ti·∫øp
                    await processApproval(attendanceId, '', 'admin');
                    return;
                }

                // Ki·ªÉm tra xem c√≥ c·∫ßn ch·ªØ k√Ω kh√¥ng
                if (signatureStatus.need_signature) {
                    console.log('‚ùå SIGNATURE REQUIRED: User needs to set up personal signature');
                    Swal.fire({
                        title: 'Thi·∫øt l·∫≠p ch·ªØ k√Ω c√° nh√¢n',
                        html: `
                            <div style="text-align: center;">
                                <i class="fas fa-signature" style="font-size: 3rem; color: #e74c3c; margin-bottom: 1rem;"></i>
                                <p style="font-size: 1.1rem; margin-bottom: 1rem; color: #2c3e50;">
                                    <strong>B·∫°n ch∆∞a c√≥ ch·ªØ k√Ω c√° nh√¢n!</strong>
                                </p>
                                <p style="font-size: 1rem; margin-bottom: 1rem; color: #34495e;">
                                    Ch·ªØ k√Ω c√° nh√¢n l√† b·∫Øt bu·ªôc ƒë·ªÉ ph√™ duy·ªát c√°c b·∫£n ghi ch·∫•m c√¥ng.
                                </p>
                                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 15px 0;">
                                    <p style="margin: 0; color: #856404; font-weight: 600;">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        Vui l√≤ng thi·∫øt l·∫≠p ch·ªØ k√Ω ngay ƒë·ªÉ c√≥ th·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng ph√™ duy·ªát.
                                    </p>
                                </div>
                            </div>
                        `,
                        icon: 'warning',
                        showCancelButton: false,
                        confirmButtonText: 'Thi·∫øt l·∫≠p ngay',
                        confirmButtonColor: '#e74c3c',
                        allowOutsideClick: false,
                        allowEscapeKey: false
                    }).then((result) => {
                        // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang settings
                        window.location.href = '/settings';
                    });
                    return;
                }

                // X·ª≠ l√Ω ch·ªØ k√Ω cho non-admin users
                const signature = await handleSignatureFlow(signatureStatus, attendanceId);
                if (signature !== false) { // false means user cancelled
                    await processApproval(attendanceId, signature, 'user');
                }
            } else if (action === 'reject') {
                // X·ª≠ l√Ω t·ª´ ch·ªëi
                await handleRejection(attendanceId);
            }
        }

        // Ki·ªÉm tra tr·∫°ng th√°i ch·ªØ k√Ω
        async function checkSignatureStatus(attendanceId) {
            try {
                // Th·ª≠ nhi·ªÅu c√°ch ƒë·ªÉ l·∫•y CSRF token
                let csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                if (!csrfToken) {
                    csrfToken = document.querySelector('input[name="csrf_token"]')?.value || '';
                }
                console.log('DEBUG: CSRF Token for signature check:', csrfToken);

                const response = await fetch('/api/signature/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ attendance_id: attendanceId })
                });

                // Ki·ªÉm tra response type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.error('API returned non-JSON response:', contentType);
                    return { need_signature: true, is_admin: false };
                }

                const data = await response.json();
                console.log('Signature status:', data);
                console.log('DEBUG: Signature status details:', {
                    need_signature: data.need_signature,
                    is_admin: data.is_admin,
                    has_session_signature: data.has_session_signature,
                    has_db_signature: data.has_db_signature,
                    should_use_session: data.should_use_session,
                    session_signature_available: data.session_signature_available,
                    is_reused_signature: data.is_reused_signature,
                    message: data.message
                });
                return data;
            } catch (error) {
                console.error('Error checking signature status:', error);
                return { need_signature: true, is_admin: false };
            }
        }

        // X·ª≠ l√Ω lu·ªìng ch·ªØ k√Ω th√¥ng minh
        async function handleSignatureFlow(signatureStatus, attendanceId) {
            const {
                has_personal_signature,
                has_session_signature,
                should_use_session,
                has_db_signature,
                session_signature_available,
                is_reused_signature,
                message
            } = signatureStatus;

            console.log('DEBUG: handleSignatureFlow called with:', {
                has_personal_signature,
                has_session_signature,
                should_use_session,
                has_db_signature,
                session_signature_available,
                is_reused_signature,
                message,
                attendanceId
            });

            // L·∫•y th√¥ng tin ng∆∞·ªùi d√πng hi·ªán t·∫°i
            const currentRole = document.getElementById('role-select')?.value || 'EMPLOYEE';
            const currentUserName = document.getElementById('current-user-name')?.textContent || 'Unknown User';
            console.log('DEBUG: Current user info:', { role: currentRole, name: currentUserName });

            // ∆Øu ti√™n 1: Ch·ªØ k√Ω c√° nh√¢n - t·ª± ƒë·ªông s·ª≠ d·ª•ng
            if (has_personal_signature) {
                console.log('‚úÖ PERSONAL SIGNATURE: User', currentUserName, `(${currentRole}) using personal signature automatically`);
                return 'personal_signature';
            }

            // N·∫øu kh√¥ng c√≥ ch·ªØ k√Ω c√° nh√¢n, kh√¥ng th·ªÉ ti·∫øp t·ª•c
            console.log('‚ùå NO PERSONAL SIGNATURE: User', currentUserName, `(${currentRole}) has no personal signature`);
            return false;



            // ∆Øu ti√™n 2: Ch·ªØ k√Ω t·ª´ session (n·∫øu c√≥ v√† ƒë∆∞·ª£c ph√©p s·ª≠ d·ª•ng)
            if (session_signature_available) {
                console.log('DEBUG: Session signature available, showing reuse dialog');
                console.log('üîç SIGNATURE REUSE INFO: User', currentUserName, `(${currentRole}) is reusing signature from current session`);
                const useSession = await Swal.fire({
                    title: '<i class="fas fa-signature me-2"></i>S·ª≠ d·ª•ng ch·ªØ k√Ω ƒë√£ l∆∞u',
                    html: `
                        <div style="text-align: center;">
                            <p>B·∫°n c√≥ mu·ªën s·ª≠ d·ª•ng l·∫°i ch·ªØ k√Ω ƒë√£ k√Ω trong phi√™n n√†y kh√¥ng?</p>
                            <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #2196f3;">
                                <small style="color: #1976d2;">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Ch·ªØ k√Ω c·ªßa: <strong>${currentUserName}</strong> (${currentRole})
                                </small>
                            </div>
                            <div style="margin-top: 15px;">
                                <label style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <input type="checkbox" id="dont-ask-again" style="margin: 0;">
                                    <span>Kh√¥ng h·ªèi l·∫°i trong phi√™n n√†y</span>
                                </label>
                            </div>
                        </div>
                    `,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'C√≥, s·ª≠ d·ª•ng',
                    cancelButtonText: 'Kh√¥ng, k√Ω l·∫°i',
                    reverseButtons: true
                });

                if (useSession.isConfirmed) {
                    console.log('DEBUG: User confirmed using session signature');
                    console.log('‚úÖ SIGNATURE REUSE CONFIRMED: User', currentUserName, `(${currentRole}) confirmed reusing session signature`);
                    const dontAskAgain = document.getElementById('dont-ask-again').checked;
                    // L∆∞u flag kh√¥ng h·ªèi l·∫°i
                    if (dontAskAgain) {
                        await saveSignatureToSession('', 'session_reused', true);
                    }
                    return 'session_reused';
                }
            }

            // ∆Øu ti√™n 3: Ch·ªØ k√Ω t·ª´ database (bao g·ªìm c·∫£ ch·ªØ k√Ω t·ª´ vai tr√≤ th·∫•p h∆°n)
            if (has_db_signature) {
                console.log('DEBUG: DB signature available, showing reuse dialog');
                console.log('üîç SIGNATURE REUSE INFO: User', currentUserName, `(${currentRole}) found saved signature in database`);

                // T·∫°o message ph√π h·ª£p d·ª±a tr√™n vi·ªác c√≥ ph·∫£i ch·ªØ k√Ω t√°i s·ª≠ d·ª•ng kh√¥ng
                let reuseMessage = 'B·∫°n c√≥ mu·ªën s·ª≠ d·ª•ng l·∫°i ch·ªØ k√Ω ƒë√£ l∆∞u tr∆∞·ªõc ƒë√≥ kh√¥ng?';
                let infoBoxStyle = 'background: #fff3e0; padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #ff9800;';
                let infoBoxColor = 'color: #e65100;';
                let infoIcon = 'fas fa-database';

                if (is_reused_signature) {
                    reuseMessage = 'B·∫°n c√≥ mu·ªën s·ª≠ d·ª•ng l·∫°i ch·ªØ k√Ω t·ª´ vai tr√≤ th·∫•p h∆°n kh√¥ng?';
                    infoBoxStyle = 'background: #e8f5e8; padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #4caf50;';
                    infoBoxColor = 'color: #2e7d32;';
                    infoIcon = 'fas fa-recycle';
                }

                const useDbSignature = await Swal.fire({
                    title: '<i class="fas fa-database me-2"></i>Ch·ªØ k√Ω ƒë√£ l∆∞u',
                    html: `
                        <div style="text-align: center;">
                            <p>${reuseMessage}</p>
                            <div style="${infoBoxStyle}">
                                <small style="${infoBoxColor}">
                                    <i class="${infoIcon} me-1"></i>
                                    ${message}
                                </small>
                            </div>
                            <div style="margin-top: 15px;">
                                <label style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <input type="checkbox" id="dont-ask-again" style="margin: 0;">
                                    <span>Kh√¥ng h·ªèi l·∫°i trong phi√™n n√†y</span>
                                </label>
                            </div>
                        </div>
                    `,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'C√≥, s·ª≠ d·ª•ng',
                    cancelButtonText: 'Kh√¥ng, k√Ω m·ªõi',
                    reverseButtons: true
                });

                if (useDbSignature.isConfirmed) {
                    const dontAskAgain = document.getElementById('dont-ask-again').checked;
                    console.log('DEBUG: User confirmed using DB signature');
                    console.log('‚úÖ SIGNATURE REUSE CONFIRMED: User', currentUserName, `(${currentRole}) confirmed reusing database signature`);

                    // L·∫•y ch·ªØ k√Ω t·ª´ database
                    const dbSignature = await getSignatureFromDatabase(attendanceId);
                    console.log('DEBUG: DB signature result:', dbSignature ? 'Found' : 'Not found');
                    if (dbSignature) {
                        console.log('DEBUG: Saving DB signature to session...');
                        const signatureType = is_reused_signature ? 'role_reused' : 'database_reused';
                        await saveSignatureToSession(dbSignature, signatureType, dontAskAgain);
                        console.log('DEBUG: Returning DB signature for approval');
                        return dbSignature;
                    } else {
                        console.log('DEBUG: No DB signature found, will show signature modal');
                    }
                }
            }

            // ∆Øu ti√™n 4: K√Ω m·ªõi
            console.log('DEBUG: No reusable signature found, showing signature modal');
            console.log('üÜï NEW SIGNATURE: User', currentUserName, `(${currentRole}) will create new signature`);
            return await showSignatureModal(attendanceId);
        }

        // L·∫•y ch·ªØ k√Ω t·ª´ database
        async function getSignatureFromDatabase(attendanceId) {
            try {
                console.log('DEBUG: Getting signature from database for attendance:', attendanceId);
                const response = await fetch(`/api/attendance/${attendanceId}`);
                const data = await response.json();
                console.log('DEBUG: Attendance data:', data);

                const currentRole = document.getElementById('role-select')?.value || 'EMPLOYEE';
                console.log('DEBUG: Current role:', currentRole);

                let signature = null;
                let signatureSource = null;

                // Logic t√°i s·ª≠ d·ª•ng ch·ªØ k√Ω t·ª´ vai tr√≤ th·∫•p h∆°n
                if (currentRole === 'TEAM_LEADER') {
                    // Ki·ªÉm tra ch·ªØ k√Ω team leader tr∆∞·ªõc
                    if (data.team_leader_signature) {
                        signature = data.team_leader_signature;
                        signatureSource = 'team_leader_original';
                        console.log('DEBUG: Team leader signature (original): Found');
                    } else if (data.signature) {
                        // S·ª≠ d·ª•ng ch·ªØ k√Ω employee (vai tr√≤ th·∫•p h∆°n)
                        signature = data.signature;
                        signatureSource = 'employee_reused';
                        console.log('DEBUG: Employee signature (reused): Found');
                    }
                } else if (currentRole === 'MANAGER') {
                    // Ki·ªÉm tra ch·ªØ k√Ω manager tr∆∞·ªõc
                    if (data.manager_signature) {
                        signature = data.manager_signature;
                        signatureSource = 'manager_original';
                        console.log('DEBUG: Manager signature (original): Found');
                    } else if (data.team_leader_signature) {
                        // S·ª≠ d·ª•ng ch·ªØ k√Ω team leader (vai tr√≤ th·∫•p h∆°n)
                        signature = data.team_leader_signature;
                        signatureSource = 'team_leader_reused';
                        console.log('DEBUG: Team leader signature (reused): Found');
                    } else if (data.signature) {
                        // S·ª≠ d·ª•ng ch·ªØ k√Ω employee (vai tr√≤ th·∫•p nh·∫•t)
                        signature = data.signature;
                        signatureSource = 'employee_reused';
                        console.log('DEBUG: Employee signature (reused): Found');
                    }
                } else {
                    // EMPLOYEE - ch·ªâ s·ª≠ d·ª•ng ch·ªØ k√Ω employee
                    signature = data.signature;
                    signatureSource = 'employee_original';
                    console.log('DEBUG: Employee signature (original):', signature ? 'Found' : 'Not found');
                }

                console.log('DEBUG: Final signature result:', signature ? 'Found' : 'Not found', 'Source:', signatureSource);
                return signature;
            } catch (error) {
                console.error('Error getting signature from database:', error);
                return null;
            }
        }

        // L·∫•y ch·ªØ k√Ω t·ª´ session
        async function getSignatureFromSession() {
            try {
                // Th·ª≠ nhi·ªÅu c√°ch ƒë·ªÉ l·∫•y CSRF token
                let csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                if (!csrfToken) {
                    csrfToken = document.querySelector('input[name="csrf_token"]')?.value || '';
                }
                console.log('DEBUG: CSRF Token for getSignatureFromSession:', csrfToken);

                const response = await fetch('/api/signature/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ check_session: true })
                });

                // Ki·ªÉm tra response type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.error('API returned non-JSON response:', contentType);
                    return null;
                }

                const data = await response.json();
                return data.session_signature || null;
            } catch (error) {
                console.error('Error getting signature from session:', error);
                return null;
            }
        }

        // L∆∞u ch·ªØ k√Ω v√†o session
        async function saveSignatureToSession(signature, type, dontAskAgain = false) {
            try {
                // N·∫øu signature qu√° l·ªõn, ch·ªâ l∆∞u flag thay v√¨ to√†n b·ªô ch·ªØ k√Ω
                let signatureToSave = signature;
                if (signature && signature.length > 1000) {
                    // T·∫°o hash ƒë∆°n gi·∫£n cho ch·ªØ k√Ω l·ªõn
                    signatureToSave = 'signature_hash_' + btoa(signature.substring(0, 100)).replace(/[^a-zA-Z0-9]/g, '');
                }

                const response = await fetch('/api/signature/save-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                    },
                    body: JSON.stringify({
                        signature: signatureToSave,
                        type: type,
                        dont_ask_again: dontAskAgain
                    })
                });

                const data = await response.json();
                if (data.success) {
                    console.log(`‚úÖ SIGNATURE SAVED: ${type} signature saved to session${dontAskAgain ? ' with dont_ask_again flag' : ''}`);
                } else {
                    console.error('‚ùå SIGNATURE SAVE FAILED:', data.error);
                }
                return data.success;
            } catch (error) {
                console.error('‚ùå ERROR SAVING SIGNATURE:', error);
                return false;
            }
        }

        // Hi·ªÉn th·ªã modal k√Ω t√™n
        async function showSignatureModal(attendanceId) {
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
            const { value: signature } = await Swal.fire({
                title: '<i class="fas fa-signature me-2"></i>K√Ω t√™n ph√™ duy·ªát',
                html: `
                        <div style="text-align: center;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <p style="margin: 0; font-weight: 600; color: #495057;">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Vui l√≤ng k√Ω t√™n ƒë·ªÉ x√°c nh·∫≠n ph√™ duy·ªát b·∫£n ghi ch·∫•m c√¥ng
                                </p>
                            </div>
                            <div style="border: 2px dashed #dee2e6; border-radius: 8px; padding: 10px; margin-bottom: 15px;">
                                <canvas id="approval-signature-pad" width="400" height="200" style="border: 1px solid #ccc; border-radius: 5px; background: #fff;"></canvas>
                            </div>
                            <div style="display: flex; justify-content: center; gap: 10px;">
                                <button type="button" id="clear-approval-signature" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-eraser me-1"></i>X√≥a ch·ªØ k√Ω
                                </button>
                                <button type="button" id="preview-approval-signature" class="btn btn-outline-info btn-sm">
                                    <i class="fas fa-eye me-1"></i>Xem ch·ªØ k√Ω
                                </button>
                            </div>
                            <div id="signature-preview" style="display: none; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                <img id="preview-image" style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 3px;">
                            </div>
                        </div>
                    `,
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-check me-2"></i>Ph√™ duy·ªát',
                cancelButtonText: '<i class="fas fa-times me-2"></i>H·ªßy',
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                width: '500px',
                allowOutsideClick: false,
                allowEscapeKey: false,
                didOpen: () => {
                    // Kh·ªüi t·∫°o signature pad
                    const canvas = document.getElementById('approval-signature-pad');
                    const signaturePad = new SignaturePad(canvas, {
                        backgroundColor: 'rgb(255, 255, 255)',
                        penColor: 'rgb(0, 0, 0)',
                        minWidth: 1,
                        maxWidth: 2.5
                    });

                    // X·ª≠ l√Ω n√∫t x√≥a ch·ªØ k√Ω
                    document.getElementById('clear-approval-signature').addEventListener('click', () => {
                        signaturePad.clear();
                        document.getElementById('signature-preview').style.display = 'none';
                    });

                    // X·ª≠ l√Ω n√∫t xem ch·ªØ k√Ω
                    document.getElementById('preview-approval-signature').addEventListener('click', () => {
                        if (!signaturePad.isEmpty()) {
                            const previewDiv = document.getElementById('signature-preview');
                            const previewImg = document.getElementById('preview-image');
                            previewImg.src = signaturePad.toDataURL();
                            previewDiv.style.display = 'block';
                        } else {
                            Swal.showValidationMessage('Ch∆∞a c√≥ ch·ªØ k√Ω ƒë·ªÉ xem!');
                        }
                    });

                    // L∆∞u signature pad ƒë·ªÉ s·ª≠ d·ª•ng sau
                    window.approvalSignaturePad = signaturePad;

                    // Th√™m h∆∞·ªõng d·∫´n s·ª≠ d·ª•ng
                    setTimeout(() => {
                        Swal.showValidationMessage('Vui l√≤ng k√Ω t√™n v√†o √¥ b√™n tr√™n ƒë·ªÉ ti·∫øp t·ª•c');
                    }, 100);
                },
                preConfirm: () => {
                    const signaturePad = window.approvalSignaturePad;
                    if (signaturePad.isEmpty()) {
                        Swal.showValidationMessage('<i class="fas fa-exclamation-triangle me-2"></i>Vui l√≤ng k√Ω t√™n ƒë·ªÉ x√°c nh·∫≠n ph√™ duy·ªát!');
                        return false;
                    }
                    return signaturePad.toDataURL();
                }
            });

            if (signature) {
                // L∆∞u ch·ªØ k√Ω v√†o session n·∫øu l√† k√Ω m·ªõi
                await saveSignatureToSession(signature, 'new');
                return signature;
            }
            return false; // User cancelled
        }


        // X·ª≠ l√Ω ph√™ duy·ªát
        async function processApproval(attendanceId, signature, userType) {
            console.log('DEBUG: processApproval called with:', { attendanceId, signature, userType });
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

            // L·∫•y th√¥ng tin ng∆∞·ªùi d√πng hi·ªán t·∫°i
            const currentRole = document.getElementById('role-select')?.value || 'EMPLOYEE';
            const currentUserName = document.getElementById('current-user-name')?.textContent || 'Unknown User';

            // Ki·ªÉm tra token n·∫øu l√† ADMIN
            if (currentRole === 'ADMIN' && tokenStatus && !tokenStatus.valid) {
                Swal.fire({
                    title: '‚ö†Ô∏è Token Google API h·∫øt h·∫°n',
                    html: `
                        <div style="text-align: center;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #e74c3c; margin-bottom: 1rem;"></i>
                            <p style="font-size: 1.1rem; margin-bottom: 1rem; color: #2c3e50;">
                                <strong>Token Google API ƒë√£ h·∫øt h·∫°n!</strong>
                            </p>
                            <p style="font-size: 1rem; margin-bottom: 1rem; color: #34495e;">
                                ${tokenStatus.message || 'Vui l√≤ng refresh token tr∆∞·ªõc khi ph√™ duy·ªát.'}
                            </p>
                        </div>
                    `,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Refresh Token',
                    cancelButtonText: 'H·ªßy',
                    confirmButtonColor: '#3498db'
                }).then((result) => {
                    if (result.isConfirmed) {
                        refreshToken();
                    }
                });
                return;
            }

            // X·ª≠ l√Ω ch·ªØ k√Ω t·ª´ session
            let finalSignature = signature;
            let signatureSource = 'new';

            if (signature === 'personal_signature') {
                console.log('‚úÖ SIGNATURE SOURCE: User', currentUserName, `(${currentRole}) is using personal signature`);
                signatureSource = 'personal_signature';
                // Backend s·∫Ω t·ª± ƒë·ªông l·∫•y ch·ªØ k√Ω c√° nh√¢n
                finalSignature = null;
            } else if (signature === 'session_reused') {
                console.log('DEBUG: Getting signature from session...');
                console.log('üîÑ SIGNATURE SOURCE: User', currentUserName, `(${currentRole}) is reusing signature from current session`);
                const sessionSignature = await getSignatureFromSession();
                console.log('DEBUG: Session signature result:', sessionSignature ? 'Found' : 'Not found');
                finalSignature = sessionSignature;
                signatureSource = 'session_reused';
            } else if (signature && signature.startsWith('data:image')) {
                console.log('üÜï SIGNATURE SOURCE: User', currentUserName, `(${currentRole}) is using newly created signature`);
                signatureSource = 'new';
            } else if (signature) {
                console.log('üîÑ SIGNATURE SOURCE: User', currentUserName, `(${currentRole}) is reusing signature from database`);
                signatureSource = 'database_reused';
            } else if (userType === 'admin') {
                console.log('üëë SIGNATURE SOURCE: Admin', currentUserName, `(${currentRole}) - no signature required`);
                signatureSource = 'admin_no_signature';
            }

            console.log('DEBUG: Final signature for approval:', finalSignature ? 'Has signature' : 'No signature');
            console.log('üìù APPROVAL SUMMARY: User', currentUserName, `(${currentRole}) approving attendance ${attendanceId} with signature source: ${signatureSource}`);

            // Hi·ªÉn th·ªã loading
            Swal.fire({
                title: 'ƒêang x·ª≠ l√Ω...',
                html: '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang g·ª≠i y√™u c·∫ßu ph√™ duy·ªát',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false
            });

            try {
                const response = await fetch(`/api/attendance/${attendanceId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        action: 'approve',
                        reason: '',
                        signature: finalSignature
                    })
                });

                const data = await response.json();
                Swal.close(); // ƒê√≥ng loading

                if (data.error) {
                    console.log('‚ùå APPROVAL FAILED: User', currentUserName, `(${currentRole}) failed to approve attendance ${attendanceId}:`, data.error);

                    // Ki·ªÉm tra token expired
                    if (data.error_code === 'token_expired' || (data.error && data.error.includes('Token Google API h·∫øt h·∫°n'))) {
                        // C·∫≠p nh·∫≠t token status
                        if (tokenStatus) {
                            tokenStatus.valid = false;
                            tokenStatus.can_approve = false;
                            updateTokenStatusUI(tokenStatus);
                        }
                        Swal.fire({
                            title: '‚ö†Ô∏è Token Google API h·∫øt h·∫°n',
                            html: `
                                <div style="text-align: center;">
                                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #e74c3c; margin-bottom: 1rem;"></i>
                                    <p style="font-size: 1.1rem; margin-bottom: 1rem; color: #2c3e50;">
                                        <strong>Token Google API ƒë√£ h·∫øt h·∫°n!</strong>
                                    </p>
                                    <p style="font-size: 1rem; margin-bottom: 1rem; color: #34495e;">
                                        ${data.error}
                                    </p>
                                </div>
                            `,
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Refresh Token',
                            cancelButtonText: 'H·ªßy',
                            confirmButtonColor: '#3498db'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                refreshToken();
                            }
                        });
                        return;
                    }

                    // Ki·ªÉm tra xem c√≥ c·∫ßn chuy·ªÉn h∆∞·ªõng ƒë·∫øn settings kh√¥ng
                    if (data.redirect_to_settings) {
                        Swal.fire({
                            title: 'Thi·∫øt l·∫≠p ch·ªØ k√Ω c√° nh√¢n',
                            html: `
                                <div style="text-align: center;">
                                    <i class="fas fa-signature" style="font-size: 3rem; color: #e74c3c; margin-bottom: 1rem;"></i>
                                    <p style="font-size: 1.1rem; margin-bottom: 1rem; color: #2c3e50;">
                                        <strong>B·∫°n ch∆∞a c√≥ ch·ªØ k√Ω c√° nh√¢n!</strong>
                                    </p>
                                    <p style="font-size: 1rem; margin-bottom: 1rem; color: #34495e;">
                                        ${data.error}
                                    </p>
                                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 15px 0;">
                                        <p style="margin: 0; color: #856404; font-weight: 600;">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            Vui l√≤ng thi·∫øt l·∫≠p ch·ªØ k√Ω ngay ƒë·ªÉ c√≥ th·ªÉ ph√™ duy·ªát c√°c b·∫£n ghi ch·∫•m c√¥ng.
                                        </p>
                                    </div>
                                </div>
                            `,
                            icon: 'warning',
                            showCancelButton: false,
                            confirmButtonText: 'Thi·∫øt l·∫≠p ngay',
                            confirmButtonColor: '#e74c3c',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        }).then((result) => {
                            // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang settings
                            window.location.href = '/settings';
                        });
                    } else {
                        showToast(data.error, 'error');
                    }
                } else {
                    console.log('‚úÖ APPROVAL SUCCESS: User', currentUserName, `(${currentRole}) successfully approved attendance ${attendanceId} with signature source: ${signatureSource}`);
                    showToast(data.message, 'success');
                    // Refresh danh s√°ch ph√™ duy·ªát v√† l·ªãch s·ª≠ nh√¢n vi√™n ƒë·ªÉ lo·∫°i b·ªè "Ch·ªù ph√™ duy·ªát" ngay l·∫≠p t·ª©c
                    loadApprovalAttendance();
                    try { updateAttendanceHistory(); } catch (e) { /* ignore */ }
                }
            } catch (error) {
                console.error('Error:', error);
                console.log('‚ùå APPROVAL ERROR: User', currentUserName, `(${currentRole}) encountered error while approving attendance ${attendanceId}:`, error);
                Swal.close(); // ƒê√≥ng loading
                showToast('ƒê√£ x·∫£y ra l·ªói khi ph√™ duy·ªát', 'error');
            }
        }

        // X·ª≠ l√Ω t·ª´ ch·ªëi
        async function handleRejection(attendanceId) {
            console.log('Processing rejection...');
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
            // Hi·ªÉn th·ªã popup ƒë·ªÉ nh·∫≠p l√Ω do t·ª´ ch·ªëi
            const { value: reason } = await Swal.fire({
                title: '<i class="fas fa-times-circle me-2"></i>X√°c nh·∫≠n t·ª´ ch·ªëi',
                html: `
                        <div style="text-align: center;">
                            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ffeaa7;">
                                <p style="margin: 0; font-weight: 600; color: #856404;">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Vui l√≤ng nh·∫≠p l√Ω do t·ª´ ch·ªëi b·∫£n ghi ch·∫•m c√¥ng
                                </p>
                            </div>
                            <div style="text-align: left;">
                                <label for="reject-reason" style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                                    <i class="fas fa-comment me-2"></i>L√Ω do t·ª´ ch·ªëi:
                                </label>
                                <textarea id="reject-reason" 
                                          style="width: 100%; min-height: 120px; padding: 12px; border: 1px solid #ced4da; border-radius: 5px; font-size: 14px; resize: vertical;"
                                          placeholder="Nh·∫≠p l√Ω do t·ª´ ch·ªëi chi ti·∫øt ·ªü ƒë√¢y..."></textarea>
                            </div>
                        </div>
                    `,
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-check me-2"></i>X√°c nh·∫≠n t·ª´ ch·ªëi',
                cancelButtonText: '<i class="fas fa-times me-2"></i>H·ªßy',
                confirmButtonColor: '#e74c3c',
                cancelButtonColor: '#6c757d',
                width: '500px',
                allowOutsideClick: false,
                allowEscapeKey: false,
                didOpen: () => {
                    // Focus v√†o textarea
                    document.getElementById('reject-reason').focus();
                },
                preConfirm: () => {
                    const reason = document.getElementById('reject-reason').value.trim();
                    if (!reason) {
                        Swal.showValidationMessage('<i class="fas fa-exclamation-triangle me-2"></i>Vui l√≤ng nh·∫≠p l√Ω do t·ª´ ch·ªëi!');
                        return false;
                    }
                    // Ch·ªâ y√™u c·∫ßu c√≥ n·ªôi dung, kh√¥ng b·∫Øt bu·ªôc t·ªëi thi·ªÉu 10 k√Ω t·ª±
                    return reason;
                }
            });

            if (reason) {
                console.log('Sending rejection with reason:', reason);
                // Hi·ªÉn th·ªã loading
                Swal.fire({
                    title: 'ƒêang x·ª≠ l√Ω...',
                    html: '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang g·ª≠i y√™u c·∫ßu t·ª´ ch·ªëi',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showConfirmButton: false
                });

                // G·ª≠i y√™u c·∫ßu t·ª´ ch·ªëi v·ªõi l√Ω do
                fetch(`/api/attendance/${attendanceId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ action: 'reject', reason: reason })
                })
                    .then(response => {
                        console.log('Rejection response status:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Rejection response data:', data);
                        Swal.close(); // ƒê√≥ng loading
                        if (data.error) {
                            showToast(data.error, 'error');
                        } else {
                            showToast(data.message, 'success');
                            loadApprovalAttendance();
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.close(); // ƒê√≥ng loading
                        showToast('ƒê√£ x·∫£y ra l·ªói khi t·ª´ ch·ªëi', 'error');
                    });
            }
        }


        window.switchRole = switchRole;
        window.approveAttendance = approveAttendance;

        // Set default value for attendanceDate to today - handled by flatpickr

        // Function formatHourMinute is defined below

        function extractTime(str) {
            if (!str) return '--:--';
            // H·ªó tr·ª£ c·∫£ d·∫°ng 'YYYY-MM-DD HH:MM:SS' v√† 'YYYY-MM-DDTHH:MM:SS'
            const match = str.match(/T?(\d{2}:\d{2})/);
            return match ? match[1] : '--:--';
        }

        function formatHourMinute(hours) {
            if (hours == null || hours === '') return '';
            if (typeof hours === 'string' && hours.includes(':')) return hours;
            let h = Math.floor(Number(hours));
            let m = Math.round((Number(hours) - h) * 60);
            if (m === 60) { h += 1; m = 0; }
            return `${h}:${m.toString().padStart(2, '0')}`;
        }

        // Function to format date consistently
        function formatDate(dateString) {
            if (!dateString) return '--/--/----';
            // N·∫øu l√† d·∫°ng DD/MM/YYYY th√¨ parse th·ªß c√¥ng
            if (typeof dateString === 'string' && dateString.includes('/')) {
                const [d, m, y] = dateString.split('/');
                return `${d.padStart(2, '0')}/${m.padStart(2, '0')}/${y}`;
            }
            // N·∫øu l√† d·∫°ng ISO ho·∫∑c object Date
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '--/--/----';
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Event listeners cho filter l·ªãch s·ª≠ ch·∫•m c√¥ng ƒë√£ ph√™ duy·ªát
        document.addEventListener('DOMContentLoaded', function () {
            // Filter button
            const btnAllHistoryFilter = document.getElementById('btnAllHistoryFilter');
            if (btnAllHistoryFilter) {
                btnAllHistoryFilter.addEventListener('click', function () {
                    allCurrentPage = 1;
                    loadAllAttendanceHistory(allCurrentPage);
                });
            }

            // Reset button
            const btnAllHistoryReset = document.getElementById('btnAllHistoryReset');
            if (btnAllHistoryReset) {
                btnAllHistoryReset.addEventListener('click', function () {
                    // Reset c√°c filter
                    const fieldsToClear = [
                        'allHistorySearchName',
                        'allHistoryDepartment',
                        'allHistoryDateFrom',
                        'allHistoryDateTo',
                        'allHistoryMonthFrom',
                        'allHistoryMonthTo',
                        'allHistoryYearFrom',
                        'allHistoryYearTo'
                    ];
                    fieldsToClear.forEach(id => {
                        const el = document.getElementById(id);
                        if (!el) return;
                        el.value = '';
                        // ƒê·∫£m b·∫£o flatpickr (n·∫øu c√≥) c≈©ng ƒë∆∞·ª£c clear ƒë·ªÉ UI hi·ªÉn th·ªã tr·ªëng
                        if (el._flatpickr) {
                            el._flatpickr.clear();
                        }
                    });

                    // Reload d·ªØ li·ªáu
                    allCurrentPage = 1;
                    loadAllAttendanceHistory(allCurrentPage);
                });
            }

            // Enter key trong √¥ t√¨m ki·∫øm
            const allHistorySearchName = document.getElementById('allHistorySearchName');
            if (allHistorySearchName) {
                allHistorySearchName.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        allCurrentPage = 1;
                        loadAllAttendanceHistory(allCurrentPage);
                    }
                });
            }

            // Kh·ªüi t·∫°o nƒÉm cho dropdown (t·ª´ 2020 ƒë·∫øn nƒÉm hi·ªán t·∫°i + 1)
            const currentYear = new Date().getFullYear();
            const yearSelects = ['recreateYearFrom', 'recreateYearTo'];
            yearSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    for (let year = 2020; year <= currentYear + 1; year++) {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        select.appendChild(option);
                    }
                    // M·∫∑c ƒë·ªãnh ch·ªçn nƒÉm hi·ªán t·∫°i
                    select.value = currentYear;
                }
            });

            // X·ª≠ l√Ω n√∫t t·∫°o l·∫°i h√†ng lo·∫°t
            const btnConfirmBulkRecreate = document.getElementById('btnConfirmBulkRecreate');
            if (btnConfirmBulkRecreate) {
                btnConfirmBulkRecreate.addEventListener('click', async function () {
                    // Ki·ªÉm tra tab ƒëang active - ∆∞u ti√™n ki·ªÉm tra tab link active, sau ƒë√≥ ki·ªÉm tra pane visible
                    const activeTabLink = document.querySelector('#recreateTabs .nav-link.active');
                    let activePaneId = null;

                    if (activeTabLink) {
                        const target = activeTabLink.getAttribute('data-bs-target') || activeTabLink.getAttribute('href');
                        if (target) {
                            activePaneId = target.startsWith('#') ? target : '#' + target;
                        }
                    }

                    // Fallback: ki·ªÉm tra pane n√†o ƒëang visible
                    if (!activePaneId) {
                        const dateRangePane = document.getElementById('dateRangePane');
                        const monthRangePane = document.getElementById('monthRangePane');
                        const specificDatePane = document.getElementById('specificDatePane');

                        if (dateRangePane && (dateRangePane.classList.contains('show') || dateRangePane.classList.contains('active'))) {
                            activePaneId = '#dateRangePane';
                        } else if (monthRangePane && (monthRangePane.classList.contains('show') || monthRangePane.classList.contains('active'))) {
                            activePaneId = '#monthRangePane';
                        } else if (specificDatePane && (specificDatePane.classList.contains('show') || specificDatePane.classList.contains('active'))) {
                            activePaneId = '#specificDatePane';
                        } else {
                            // M·∫∑c ƒë·ªãnh s·ª≠ d·ª•ng tab ƒë·∫ßu ti√™n (Kho·∫£ng ng√†y) n·∫øu kh√¥ng ph√°t hi·ªán ƒë∆∞·ª£c tab n√†o
                            activePaneId = '#dateRangePane';
                        }
                    }

                    let requestData = {};

                    // X·ª≠ l√Ω theo tab ƒëang active
                    if (activePaneId === '#dateRangePane') {
                        // Kho·∫£ng ng√†y
                        const dateFrom = document.getElementById('recreateDateFrom').value;
                        const dateTo = document.getElementById('recreateDateTo').value;

                        if (!dateFrom || !dateTo) {
                            showToast('Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß t·ª´ ng√†y v√† ƒë·∫øn ng√†y', 'error');
                            return;
                        }

                        if (new Date(dateFrom) > new Date(dateTo)) {
                            showToast('Ng√†y b·∫Øt ƒë·∫ßu ph·∫£i nh·ªè h∆°n ho·∫∑c b·∫±ng ng√†y k·∫øt th√∫c', 'error');
                            return;
                        }

                        requestData = {
                            date_from: dateFrom,
                            date_to: dateTo
                        };
                    } else if (activePaneId === '#monthRangePane') {
                        // Kho·∫£ng th√°ng
                        const monthFrom = document.getElementById('recreateMonthFrom').value;
                        const yearFrom = document.getElementById('recreateYearFrom').value;
                        const monthTo = document.getElementById('recreateMonthTo').value;
                        const yearTo = document.getElementById('recreateYearTo').value;

                        if (!monthFrom || !yearFrom || !monthTo || !yearTo) {
                            showToast('Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß th√°ng v√† nƒÉm', 'error');
                            return;
                        }

                        requestData = {
                            month_from: parseInt(monthFrom),
                            year_from: parseInt(yearFrom),
                            month_to: parseInt(monthTo),
                            year_to: parseInt(yearTo)
                        };
                    } else if (activePaneId === '#specificDatePane') {
                        // Ng√†y c·ª• th·ªÉ
                        const specificDate = document.getElementById('recreateSpecificDate').value;

                        if (!specificDate) {
                            showToast('Vui l√≤ng ch·ªçn ng√†y', 'error');
                            return;
                        }

                        requestData = {
                            specific_date: specificDate
                        };
                    } else {
                        showToast('Vui l√≤ng ch·ªçn m·ªôt ph∆∞∆°ng th·ª©c t·∫°o l·∫°i', 'error');
                        return;
                    }

                    // X√°c nh·∫≠n tr∆∞·ªõc khi th·ª±c hi·ªán
                    const confirmResult = await Swal.fire({
                        title: 'X√°c nh·∫≠n t·∫°o l·∫°i',
                        html: `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën t·∫°o l·∫°i c√°c b·∫£n ghi ch·∫•m c√¥ng?<br>
                               <small class="text-muted">C√°c b·∫£n ghi m·ªõi s·∫Ω ·ªü tr·∫°ng th√°i "Ch·ªù ph√™ duy·ªát"</small>`,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#28a745',
                        cancelButtonColor: '#6c757d',
                        confirmButtonText: 'X√°c nh·∫≠n',
                        cancelButtonText: 'H·ªßy'
                    });

                    if (!confirmResult.isConfirmed) {
                        return;
                    }

                    // Disable n√∫t trong khi x·ª≠ l√Ω
                    btnConfirmBulkRecreate.disabled = true;
                    btnConfirmBulkRecreate.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang x·ª≠ l√Ω...';

                    try {
                        const response = await fetch('/api/attendance/bulk-recreate', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content ||
                                    document.querySelector('input[name="csrf_token"]')?.value || ''
                            },
                            body: JSON.stringify(requestData)
                        });

                        const result = await response.json();

                        if (response.ok && result.success) {
                            // ƒê√≥ng modal
                            const modal = bootstrap.Modal.getInstance(document.getElementById('bulkRecreateModal'));
                            if (modal) modal.hide();

                            // Reset form
                            document.getElementById('recreateDateFrom').value = '';
                            document.getElementById('recreateDateTo').value = '';
                            document.getElementById('recreateMonthFrom').value = '';
                            document.getElementById('recreateMonthTo').value = '';
                            document.getElementById('recreateSpecificDate').value = '';

                            // Hi·ªÉn th·ªã k·∫øt qu·∫£
                            let message = result.message;
                            if (result.recreated_count > 0) {
                                message += `<br><strong>ƒê√£ t·∫°o l·∫°i: ${result.recreated_count} b·∫£n ghi</strong>`;
                            }
                            if (result.skipped_count > 0) {
                                message += `<br>B·ªè qua: ${result.skipped_count} b·∫£n ghi (ƒë√£ t·ªìn t·∫°i)`;
                            }
                            if (result.error_count > 0) {
                                message += `<br>C√≥ l·ªói: ${result.error_count} b·∫£n ghi`;
                            }

                            await Swal.fire({
                                title: 'Th√†nh c√¥ng',
                                html: message,
                                icon: 'success',
                                confirmButtonText: 'OK'
                            });

                            // Reload l·ªãch s·ª≠ ch·∫•m c√¥ng
                            if (allCurrentPage) {
                                loadAllAttendanceHistory(allCurrentPage);
                            }
                        } else {
                            showToast(result.error || 'ƒê√£ x·∫£y ra l·ªói khi t·∫°o l·∫°i b·∫£n ghi', 'error');
                        }
                    } catch (error) {
                        console.error('Error bulk recreating attendance:', error);
                        showToast('ƒê√£ x·∫£y ra l·ªói khi t·∫°o l·∫°i b·∫£n ghi: ' + error.message, 'error');
                    } finally {
                        // Enable l·∫°i n√∫t
                        btnConfirmBulkRecreate.disabled = false;
                        btnConfirmBulkRecreate.innerHTML = '<i class="fas fa-redo me-2"></i>X√°c nh·∫≠n t·∫°o l·∫°i';
                    }
                });
            }
        });

        // L·∫•y th√¥ng tin chi ti·∫øt v·ªÅ ch·ªØ k√Ω trong database
        async function getSignatureInfoFromDatabase(attendanceId) {
            try {
                console.log('DEBUG: Getting signature info from database for attendance:', attendanceId);
                const response = await fetch(`/api/attendance/${attendanceId}`);
                const data = await response.json();

                const currentRole = document.getElementById('role-select')?.value || 'EMPLOYEE';
                const currentUserName = document.getElementById('current-user-name')?.textContent || 'Unknown User';

                let signatureInfo = {
                    signerName: currentUserName,
                    signerRole: currentRole,
                    signDate: null,
                    hasSignature: false,
                    signatureType: null,
                    isReusedSignature: false,
                    userInfo: data.user_name ? {
                        name: data.user_name,
                        employee_id: data.user_employee_id,
                        department: data.user_department
                    } : null,
                    approverInfo: data.approver_info
                };

                // X√°c ƒë·ªãnh lo·∫°i ch·ªØ k√Ω v√† th√¥ng tin ng∆∞·ªùi k√Ω
                if (currentRole === 'TEAM_LEADER') {
                    // Ki·ªÉm tra ch·ªØ k√Ω team leader tr∆∞·ªõc
                    if (data.team_leader_signature) {
                        signatureInfo.hasSignature = true;
                        signatureInfo.signatureType = 'team_leader_signature';
                        signatureInfo.isReusedSignature = false;
                        // N·∫øu c√≥ th√¥ng tin ng∆∞·ªùi ph√™ duy·ªát v√† l√† TEAM_LEADER, l·∫•y th√¥ng tin ƒë√≥
                        if (data.approver_info && data.approver_info.roles && data.approver_info.roles.includes('TEAM_LEADER')) {
                            signatureInfo.signerName = data.approver_info.name;
                            signatureInfo.signerRole = 'TEAM_LEADER';
                            signatureInfo.signerEmployeeId = data.approver_info.employee_id;
                            signatureInfo.signerDepartment = data.approver_info.department;
                        }
                    } else if (data.signature) {
                        // S·ª≠ d·ª•ng ch·ªØ k√Ω employee (vai tr√≤ th·∫•p h∆°n)
                        signatureInfo.hasSignature = true;
                        signatureInfo.signatureType = 'employee_signature';
                        signatureInfo.isReusedSignature = true;
                        signatureInfo.signerName = data.user_name || currentUserName;
                        signatureInfo.signerRole = 'EMPLOYEE';
                        signatureInfo.signerEmployeeId = data.user_employee_id;
                        signatureInfo.signerDepartment = data.user_department;
                    }
                } else if (currentRole === 'MANAGER') {
                    // Ki·ªÉm tra ch·ªØ k√Ω manager tr∆∞·ªõc
                    if (data.manager_signature) {
                        signatureInfo.hasSignature = true;
                        signatureInfo.signatureType = 'manager_signature';
                        signatureInfo.isReusedSignature = false;
                        // N·∫øu c√≥ th√¥ng tin ng∆∞·ªùi ph√™ duy·ªát v√† l√† MANAGER, l·∫•y th√¥ng tin ƒë√≥
                        if (data.approver_info && data.approver_info.roles && data.approver_info.roles.includes('MANAGER')) {
                            signatureInfo.signerName = data.approver_info.name;
                            signatureInfo.signerRole = 'MANAGER';
                            signatureInfo.signerEmployeeId = data.approver_info.employee_id;
                            signatureInfo.signerDepartment = data.approver_info.department;
                        }
                    } else if (data.team_leader_signature) {
                        // S·ª≠ d·ª•ng ch·ªØ k√Ω team leader (vai tr√≤ th·∫•p h∆°n)
                        signatureInfo.hasSignature = true;
                        signatureInfo.signatureType = 'team_leader_signature';
                        signatureInfo.isReusedSignature = true;
                        signatureInfo.signerName = data.approver_info?.name || currentUserName;
                        signatureInfo.signerRole = 'TEAM_LEADER';
                        signatureInfo.signerEmployeeId = data.approver_info?.employee_id;
                        signatureInfo.signerDepartment = data.approver_info?.department;
                    } else if (data.signature) {
                        // S·ª≠ d·ª•ng ch·ªØ k√Ω employee (vai tr√≤ th·∫•p nh·∫•t)
                        signatureInfo.hasSignature = true;
                        signatureInfo.signatureType = 'employee_signature';
                        signatureInfo.isReusedSignature = true;
                        signatureInfo.signerName = data.user_name || currentUserName;
                        signatureInfo.signerRole = 'EMPLOYEE';
                        signatureInfo.signerEmployeeId = data.user_employee_id;
                        signatureInfo.signerDepartment = data.user_department;
                    }
                } else {
                    // EMPLOYEE - ch·ªâ s·ª≠ d·ª•ng ch·ªØ k√Ω employee
                    signatureInfo.hasSignature = !!data.signature;
                    signatureInfo.signatureType = 'employee_signature';
                    signatureInfo.isReusedSignature = false;
                    // ƒê·ªëi v·ªõi EMPLOYEE, l·∫•y th√¥ng tin t·ª´ user
                    if (data.user_name) {
                        signatureInfo.signerName = data.user_name;
                        signatureInfo.signerRole = 'EMPLOYEE';
                        signatureInfo.signerEmployeeId = data.user_employee_id;
                        signatureInfo.signerDepartment = data.user_department;
                    }
                }

                // L·∫•y th·ªùi gian ph√™ duy·ªát n·∫øu c√≥
                if (data.approved_at) {
                    const approvedDate = new Date(data.approved_at);
                    signatureInfo.signDate = approvedDate.toLocaleDateString('vi-VN') + ' ' + approvedDate.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                }

                console.log('DEBUG: Signature info result:', signatureInfo);
                console.log('üîç SIGNATURE DETAILS: Found signature for', signatureInfo.signerName, `(${signatureInfo.signerRole})`, signatureInfo.hasSignature ? 'with signature' : 'without signature', signatureInfo.isReusedSignature ? '(REUSED)' : '(ORIGINAL)');

                return signatureInfo;
            } catch (error) {
                console.error('‚ùå ERROR GETTING SIGNATURE INFO:', error);
                return {
                    signerName: 'Unknown',
                    signerRole: 'Unknown',
                    signDate: null,
                    hasSignature: false,
                    signatureType: null,
                    isReusedSignature: false
                };
            }
        }



        // Debug ch·ªØ k√Ω
        async function debugSignature(attendanceId) {
            try {
                const response = await fetch(`/api/signature/debug/${attendanceId}`);
                const data = await response.json();

                if (data.error) {
                    showToast(data.error, 'error');
                    return;
                }

                // Hi·ªÉn th·ªã th√¥ng tin debug trong modal
                const debugHtml = `
                    <div style="text-align: left; max-width: 600px;">
                        <h5>Th√¥ng tin ch·ªØ k√Ω cho b·∫£n ghi #${data.attendance_id}</h5>
                        
                        <div style="margin: 15px 0;">
                            <h6>Ch·ªØ k√Ω nh√¢n vi√™n:</h6>
                            <ul>
                                <li>T·ªìn t·∫°i: ${data.employee_signature.exists ? 'C√≥' : 'Kh√¥ng'}</li>
                                <li>ƒê·ªô d√†i: ${data.employee_signature.length}</li>
                                <li>Ki·ªÉu d·ªØ li·ªáu: ${data.employee_signature.type || 'N/A'}</li>
                                <li>B·∫Øt ƒë·∫ßu v·ªõi data:image: ${data.employee_signature.starts_with_data_image ? 'C√≥' : 'Kh√¥ng'}</li>
                                <li>X·ª≠ l√Ω th√†nh c√¥ng: ${data.employee_signature.processed ? 'C√≥' : 'Kh√¥ng'}</li>
                            </ul>
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <h6>Ch·ªØ k√Ω tr∆∞·ªüng nh√≥m:</h6>
                            <ul>
                                <li>T·ªìn t·∫°i: ${data.team_leader_signature.exists ? 'C√≥' : 'Kh√¥ng'}</li>
                                <li>ƒê·ªô d√†i: ${data.team_leader_signature.length}</li>
                                <li>Ki·ªÉu d·ªØ li·ªáu: ${data.team_leader_signature.type || 'N/A'}</li>
                                <li>B·∫Øt ƒë·∫ßu v·ªõi data:image: ${data.team_leader_signature.starts_with_data_image ? 'C√≥' : 'Kh√¥ng'}</li>
                                <li>X·ª≠ l√Ω th√†nh c√¥ng: ${data.team_leader_signature.processed ? 'C√≥' : 'Kh√¥ng'}</li>
                            </ul>
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <h6>Ch·ªØ k√Ω qu·∫£n l√Ω:</h6>
                            <ul>
                                <li>T·ªìn t·∫°i: ${data.manager_signature.exists ? 'C√≥' : 'Kh√¥ng'}</li>
                                <li>ƒê·ªô d√†i: ${data.manager_signature.length}</li>
                                <li>Ki·ªÉu d·ªØ li·ªáu: ${data.manager_signature.type || 'N/A'}</li>
                                <li>B·∫Øt ƒë·∫ßu v·ªõi data:image: ${data.manager_signature.starts_with_data_image ? 'C√≥' : 'Kh√¥ng'}</li>
                                <li>X·ª≠ l√Ω th√†nh c√¥ng: ${data.manager_signature.processed ? 'C√≥' : 'Kh√¥ng'}</li>
                            </ul>
                        </div>
                    </div>
                `;

                Swal.fire({
                    title: 'Debug Ch·ªØ k√Ω',
                    html: debugHtml,
                    width: 700,
                    confirmButtonText: 'ƒê√≥ng',
                    showCloseButton: true
                });

            } catch (error) {
                console.error('Error debugging signature:', error);
                showToast('L·ªói khi debug ch·ªØ k√Ω', 'error');
            }
        }

        // H√†m test hi·ªÉn th·ªã ch·ªØ k√Ω
        async function testSignatureDisplay() {
            try {
                // L·∫•y ch·ªØ k√Ω c√° nh√¢n t·ª´ session ho·∫∑c t·∫°o ch·ªØ k√Ω m·∫´u
                let employeeSignature = '';
                let teamLeaderSignature = '';
                let managerSignature = '';

                // Th·ª≠ l·∫•y ch·ªØ k√Ω c√° nh√¢n t·ª´ user - s·ª≠ d·ª•ng data bridge
                const sessionUserData = JSON.parse(document.getElementById('session-user-data')?.textContent || '{}');
                const currentUser = {
                    name: sessionUserData.name || 'Test User',
                    employee_id: sessionUserData.employee_id || 'TEST001',
                    department: sessionUserData.department || 'TEST'
                };

                // T·∫°o ch·ªØ k√Ω m·∫´u ƒë∆°n gi·∫£n
                const sampleSignature = createSampleSignature();

                // S·ª≠ d·ª•ng ch·ªØ k√Ω m·∫´u cho c·∫£ 3 vai tr√≤
                employeeSignature = sampleSignature;
                teamLeaderSignature = sampleSignature;
                managerSignature = sampleSignature;

                // T·∫°o form data
                const formData = new FormData();
                formData.append('employee_signature', employeeSignature);
                formData.append('team_leader_signature', teamLeaderSignature);
                formData.append('manager_signature', managerSignature);
                formData.append('test_date', new Date().toISOString().split('T')[0]);
                formData.append('test_note', 'Test hi·ªÉn th·ªã ch·ªØ k√Ω t·ª´ form ph√™ duy·ªát');
                formData.append('user_name', currentUser.name);
                formData.append('user_employee_id', currentUser.employee_id);
                formData.append('user_department', currentUser.department);

                // G·ª≠i request t·∫°o PDF
                const response = await fetch('/signature-test/download-pdf', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'test_chu_ky_phieu_duyet_' + new Date().toISOString().split('T')[0] + '.pdf';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    showToast('ƒê√£ t·∫°o PDF test ch·ªØ k√Ω th√†nh c√¥ng!', 'success');
                } else {
                    const errorText = await response.text();
                    throw new Error('Server error: ' + errorText);
                }

            } catch (error) {
                console.error('Error testing signature display:', error);
                showToast('C√≥ l·ªói khi t·∫°o PDF test: ' + error.message, 'error');
            }
        }

        // H√†m t·∫°o ch·ªØ k√Ω m·∫´u
        function createSampleSignature() {
            const canvas = document.createElement('canvas');
            canvas.width = 200;
            canvas.height = 100;
            const ctx = canvas.getContext('2d');

            // V·∫Ω n·ªÅn tr·∫Øng
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, 200, 100);

            // V·∫Ω ch·ªØ k√Ω m·∫´u
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(20, 50);
            ctx.lineTo(40, 30);
            ctx.lineTo(60, 70);
            ctx.lineTo(80, 40);
            ctx.lineTo(100, 60);
            ctx.lineTo(120, 35);
            ctx.lineTo(140, 65);
            ctx.lineTo(160, 45);
            ctx.lineTo(180, 55);
            ctx.stroke();

            return canvas.toDataURL();
        }

        // Ki·ªÉm tra ch·ªØ k√Ω c√° nh√¢n khi load trang
        document.addEventListener('DOMContentLoaded', function () {
            // Ki·ªÉm tra xem user ƒë√£ c√≥ ch·ªØ k√Ω c√° nh√¢n ch∆∞a (ƒë·ªçc t·ª´ script[type=application/json])
            let hasSignature = false;
            try {
                const el = document.getElementById('has-signature-data');
                if (el && el.textContent && el.textContent.trim()) {
                    hasSignature = JSON.parse(el.textContent.trim());
                }
            } catch (error) {
                console.warn('Error parsing has-signature-data:', error);
                hasSignature = false;
            }

            if (!hasSignature) {
                // Hi·ªÉn th·ªã th√¥ng b√°o y√™u c·∫ßu t·∫°o ch·ªØ k√Ω - B·∫ÆT BU·ªòC
                Swal.fire({
                    title: 'Thi·∫øt l·∫≠p ch·ªØ k√Ω c√° nh√¢n',
                    html: `
                        <div style="text-align: center;">
                            <i class="fas fa-signature" style="font-size: 3rem; color: #e74c3c; margin-bottom: 1rem;"></i>
                            <p style="font-size: 1.1rem; margin-bottom: 1rem; color: #2c3e50;">
                                <strong>B·∫°n ch∆∞a c√≥ ch·ªØ k√Ω c√° nh√¢n!</strong>
                            </p>
                            <p style="font-size: 1rem; margin-bottom: 1rem; color: #34495e;">
                                Ch·ªØ k√Ω n√†y s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng khi b·∫°n ƒëƒÉng k√Ω ch·∫•m c√¥ng ho·∫∑c ph√™ duy·ªát c√°c b·∫£n ghi ch·∫•m c√¥ng.
                            </p>
                            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 15px 0;">
                                <p style="margin: 0; color: #856404; font-weight: 600;">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Vui l√≤ng thi·∫øt l·∫≠p ch·ªØ k√Ω ngay ƒë·ªÉ c√≥ th·ªÉ s·ª≠ d·ª•ng ƒë·∫ßy ƒë·ªß ch·ª©c nƒÉng c·ªßa h·ªá th·ªëng.
                                </p>
                            </div>
                        </div>
                    `,
                    icon: 'warning',
                    showCancelButton: false,
                    confirmButtonText: 'Thi·∫øt l·∫≠p ngay',
                    confirmButtonColor: '#e74c3c',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                }).then((result) => {
                    // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang settings
                    window.location.href = '/settings';
                });
            }
        });

        // H√†m c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng ƒë∆°n ngh·ªâ ph√©p c·∫ßn ph√™ duy·ªát
        async function updatePendingLeaveCount() {
            try {
                const response = await fetch('/api/pending-leave-count');
                if (response.ok) {
                    const data = await response.json();
                    const pendingCount = data.count || 0;
                    const badge = document.getElementById('pendingLeaveCount');

                    if (badge) {
                        if (pendingCount > 0) {
                            badge.textContent = pendingCount;
                            badge.style.display = 'inline-block';
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                }
            } catch (error) {
                console.error('Error updating pending leave count:', error);
            }
        }

        // ========== TOKEN STATUS MANAGEMENT (Admin Only) ==========
        let tokenStatus = null;
        let tokenEventSource = null;
        let isAdmin = false;

        // Ki·ªÉm tra xem user c√≥ ph·∫£i admin kh√¥ng
        function checkIfAdmin() {
            const roleSelect = document.getElementById('role-select');
            if (roleSelect) {
                isAdmin = roleSelect.value === 'ADMIN';
                return isAdmin;
            }
            // Fallback: check from JSON data block
            const adminCheckEl = document.getElementById('admin-check-data');
            if (adminCheckEl) {
                try {
                    isAdmin = JSON.parse(adminCheckEl.textContent.trim());
                } catch (e) {
                    isAdmin = false;
                }
            }
            return isAdmin;
        }

        // C·∫≠p nh·∫≠t UI d·ª±a tr√™n token status
        function updateTokenStatusUI(status) {
            // C·∫≠p nh·∫≠t l·∫°i tr·∫°ng th√°i admin tr∆∞·ªõc khi ki·ªÉm tra
            checkIfAdmin();

            tokenStatus = status;
            const isLicenseWarning = status && typeof status.message === 'string' &&
                (status.message.includes('·ª®NG D·ª§NG CH·∫§M C√îNG') || status.message.includes('LICENSE'));

            const banner = document.getElementById('tokenStatusBanner');
            const alert = document.getElementById('tokenStatusAlert');
            const title = document.getElementById('tokenStatusTitle');
            const message = document.getElementById('tokenStatusMessage');
            const icon = document.getElementById('tokenStatusIcon');
            const refreshBtn = document.getElementById('btnRefreshToken');

            if (!banner) {
                console.warn('Token status banner not found');
                return;
            }

            // N·∫øu l√† c·∫£nh b√°o LICENSE v√† user v·ª´a t·∫Øt banner trong v√≤ng 60s th√¨ kh√¥ng hi·ªÉn th·ªã l·∫°i
            if (isLicenseWarning) {
                try {
                    const lastDismiss = localStorage.getItem('licenseBannerDismissedAt');
                    const lastTs = lastDismiss ? parseInt(lastDismiss, 10) : 0;
                    const now = Date.now();
                    if (lastTs && (now - lastTs) < 60000) {
                        banner.style.display = 'none';
                        return;
                    }
                } catch (e) {
                    console.warn('Could not read license banner dismiss state:', e);
                }

                // Tr∆∞·ªùng h·ª£p c·∫£nh b√°o LICENSE: hi·ªÉn th·ªã cho T·∫§T C·∫¢ ng∆∞·ªùi d√πng, kh√¥ng kh√≥a ch·ª©c nƒÉng
                banner.style.display = 'block';
                alert.className = 'alert alert-warning alert-dismissible fade show shadow-sm';
                icon.className = 'fas fa-exclamation-circle me-2';
                icon.style.color = '#856404';
                title.textContent = '‚ö†Ô∏è ·ª®ng d·ª•ng s·∫Øp h·∫øt h·∫°n LICENSE';
                title.style.color = '#856404';

                const rawMsg = status.message || '';
                // Gi·ªØ xu·ªëng d√≤ng ƒë·∫πp m·∫Øt
                message.innerHTML = rawMsg.replace(/\n/g, '<br>');
                message.style.color = '#856404';

                // ·∫®n ho√†n to√†n n√∫t Refresh Token v√¨ ƒë√¢y l√† c·∫£nh b√°o LICENSE, kh√¥ng ph·∫£i l·ªói token Google
                if (refreshBtn) {
                    refreshBtn.style.display = 'none';
                }

                // Kh√¥ng v√¥ hi·ªáu h√≥a c√°c n√∫t ph√™ duy·ªát cho c·∫£nh b√°o license s·∫Øp h·∫øt h·∫°n
                return;
            }

            // C√°c tr∆∞·ªùng h·ª£p TOKEN GOOGLE kh√°c: ch·ªâ d√†nh cho admin nh∆∞ c≈©
            if (!isAdmin) {
                banner.style.display = 'none';
                return;
            }

            const isValid = status.valid && status.can_approve;
            const needsReauth = status.needs_reauth;

            if (!isValid) {
                // Token h·∫øt h·∫°n ho·∫∑c kh√¥ng h·ª£p l·ªá - HI·ªÇN TH·ªä banner
                banner.style.display = 'block';
                alert.className = 'alert alert-danger alert-dismissible fade show shadow-sm';
                icon.className = 'fas fa-exclamation-triangle me-2';
                icon.style.color = '#dc3545';
                title.textContent = '‚ö†Ô∏è Token Google API h·∫øt h·∫°n';
                title.style.color = '#721c24';
                message.textContent = status.message || 'Token kh√¥ng h·ª£p l·ªá. Vui l√≤ng refresh token tr∆∞·ªõc khi ph√™ duy·ªát.';
                message.style.color = '#721c24';
                // CH·ªà hi·ªÉn th·ªã n√∫t refresh khi token h·∫øt h·∫°n
                if (refreshBtn) {
                    refreshBtn.style.display = 'inline-flex';
                    refreshBtn.className = 'btn btn-sm btn-primary';
                    refreshBtn.disabled = false;
                    console.log('[TokenStatus] Refresh button shown and enabled');
                } else {
                    console.warn('[TokenStatus] Refresh button not found when trying to show it');
                }

                // V√¥ hi·ªáu h√≥a c√°c n√∫t ph√™ duy·ªát
                disableApprovalButtons(true);
            } else {
                // Token h·ª£p l·ªá - ·∫®N banner ho√†n to√†n
                banner.style.display = 'none';

                // K√≠ch ho·∫°t l·∫°i c√°c n√∫t ph√™ duy·ªát
                disableApprovalButtons(false);
            }
        }

        // V√¥ hi·ªáu h√≥a/k√≠ch ho·∫°t c√°c n√∫t ph√™ duy·ªát
        function disableApprovalButtons(disable) {
            const approveButtons = document.querySelectorAll('.approve-attendance-btn, #btnBulkApprove');
            approveButtons.forEach(btn => {
                if (disable) {
                    btn.disabled = true;
                    btn.classList.add('disabled');
                    btn.title = 'Token Google API h·∫øt h·∫°n. Vui l√≤ng refresh token tr∆∞·ªõc khi ph√™ duy·ªát.';
                } else {
                    btn.disabled = false;
                    btn.classList.remove('disabled');
                    btn.title = btn.getAttribute('data-original-title') || 'Ph√™ duy·ªát';
                }
            });
        }

        // K·∫øt n·ªëi SSE ƒë·ªÉ nh·∫≠n c·∫≠p nh·∫≠t token status real-time
        function connectTokenStatusSSE() {
            if (tokenEventSource) {
                tokenEventSource.close();
            }

            tokenEventSource = new EventSource('/sse/token-status');

            tokenEventSource.addEventListener('token_status', function (event) {
                try {
                    const status = JSON.parse(event.data);
                    updateTokenStatusUI(status);
                } catch (error) {
                    console.error('Error parsing token status:', error);
                }
            });

            tokenEventSource.onerror = function (error) {
                console.error('SSE connection error:', error);
                // Th·ª≠ k·∫øt n·ªëi l·∫°i sau 5 gi√¢y
                setTimeout(connectTokenStatusSSE, 5000);
            };
        }

        // L·∫•y token status ban ƒë·∫ßu
        async function fetchTokenStatus(force = false) {
            // Ki·ªÉm tra l·∫°i admin status
            checkIfAdmin();

            if (!isAdmin) {
                const banner = document.getElementById('tokenStatusBanner');
                if (banner) {
                    banner.style.display = 'none';
                }
                return;
            }

            // Kh√¥ng hi·ªÉn th·ªã banner khi ƒëang loading, ch·ªâ hi·ªÉn th·ªã khi c√≥ k·∫øt qu·∫£
            const banner = document.getElementById('tokenStatusBanner');
            if (banner && isAdmin) {
                // ·∫®n banner khi ƒëang loading
                banner.style.display = 'none';
            }

            try {
                const url = force ? '/api/token/status?force=1' : '/api/token/status';
                const response = await fetch(url);
                if (response.ok) {
                    const status = await response.json();
                    console.log('Token status received:', status);
                    updateTokenStatusUI(status);
                } else {
                    // N·∫øu API l·ªói, hi·ªÉn th·ªã c·∫£nh b√°o
                    updateTokenStatusUI({
                        valid: false,
                        can_approve: false,
                        needs_reauth: true,
                        message: 'Kh√¥ng th·ªÉ ki·ªÉm tra tr·∫°ng th√°i token. Vui l√≤ng th·ª≠ l·∫°i.'
                    });
                }
            } catch (error) {
                console.error('Error fetching token status:', error);
                // Hi·ªÉn th·ªã l·ªói
                updateTokenStatusUI({
                    valid: false,
                    can_approve: false,
                    needs_reauth: true,
                    message: 'L·ªói k·∫øt n·ªëi khi ki·ªÉm tra token. Vui l√≤ng th·ª≠ l·∫°i.'
                });
            }
        }

        // Refresh token - M·ªü Chrome ƒë·ªÉ ·ªßy quy·ªÅn
        async function refreshToken() {
            console.log('[RefreshToken] Function called');
            console.log('[RefreshToken] Current tokenStatus:', tokenStatus);

            // Ki·ªÉm tra token status tr∆∞·ªõc khi m·ªü Chrome
            if (tokenStatus && tokenStatus.valid && tokenStatus.can_approve) {
                console.log('[RefreshToken] Token still valid, skipping');
                if (typeof showToast === 'function') {
                    showToast('Token v·∫´n c√≤n hi·ªáu l·ª±c, kh√¥ng c·∫ßn refresh.', 'info');
                } else {
                    alert('Token v·∫´n c√≤n hi·ªáu l·ª±c, kh√¥ng c·∫ßn refresh.');
                }
                return;
            }

            const refreshBtn = document.getElementById('btnRefreshToken');
            console.log('[RefreshToken] Refresh button:', refreshBtn);
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang m·ªü Chrome...';
            }

            try {
                // L·∫•y CSRF token
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                console.log('[RefreshToken] CSRF token:', csrfToken ? 'Found' : 'Not found');

                console.log('[RefreshToken] Calling /api/token/authorize...');
                // G·ªçi API ƒë·ªÉ m·ªü Chrome cho OAuth authorization
                const response = await fetch('/api/token/authorize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                });

                console.log('[RefreshToken] Response status:', response.status);
                console.log('[RefreshToken] Response ok:', response.ok);

                // Ki·ªÉm tra content-type tr∆∞·ªõc khi parse JSON
                const contentType = response.headers.get('content-type');
                let data;

                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Non-JSON response:', text.substring(0, 200));
                    throw new Error('Server tr·∫£ v·ªÅ response kh√¥ng h·ª£p l·ªá. Vui l√≤ng th·ª≠ l·∫°i.');
                }

                console.log('[RefreshToken] Response data:', data);

                if (response.ok && data.success) {
                    console.log('[RefreshToken] Success! Auth URL:', data.auth_url);
                    if (typeof showToast === 'function') {
                        showToast(data.message || 'ƒê√£ m·ªü Chrome ƒë·ªÉ ·ªßy quy·ªÅn. Vui l√≤ng ho√†n t·∫•t qu√° tr√¨nh ·ªßy quy·ªÅn trong Chrome.', 'info');
                    } else {
                        alert(data.message || 'ƒê√£ m·ªü Chrome ƒë·ªÉ ·ªßy quy·ªÅn. Vui l√≤ng ho√†n t·∫•t qu√° tr√¨nh ·ªßy quy·ªÅn trong Chrome.');
                    }

                    // N·∫øu c√≥ URL, m·ªü trong tab m·ªõi
                    if (data.auth_url) {
                        console.log('[RefreshToken] Opening URL in new tab:', data.auth_url);
                        window.open(data.auth_url, '_blank');
                    } else {
                        console.warn('[RefreshToken] No auth_url in response');
                    }

                    // Sau khi m·ªü Chrome, ƒë·ª£i m·ªôt ch√∫t r·ªìi check l·∫°i status (force)
                    setTimeout(async () => {
                        console.log('[RefreshToken] Checking token status after 3 seconds (force)...');
                        await fetchTokenStatus(true);
                    }, 3000);
                } else {
                    console.error('[RefreshToken] API returned error:', data);
                    const errorMsg = data.message || data.error || 'Kh√¥ng th·ªÉ m·ªü Chrome ƒë·ªÉ ·ªßy quy·ªÅn. Vui l√≤ng th·ª≠ l·∫°i.';
                    if (typeof showToast === 'function') {
                        showToast(errorMsg, 'error');
                    } else {
                        alert(errorMsg);
                    }
                }
            } catch (error) {
                console.error('[RefreshToken] Error opening Chrome for authorization:', error);
                console.error('[RefreshToken] Error stack:', error.stack);
                const errorMsg = error.message || 'L·ªói khi m·ªü Chrome ƒë·ªÉ ·ªßy quy·ªÅn. Vui l√≤ng th·ª≠ l·∫°i.';
                if (typeof showToast === 'function') {
                    showToast(errorMsg, 'error');
                } else {
                    alert(errorMsg);
                }
            } finally {
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Refresh Token';
                }
            }
        }

        // Kh·ªüi t·∫°o token status management khi trang load
        document.addEventListener('DOMContentLoaded', function () {
            // ·∫®n banner m·∫∑c ƒë·ªãnh
            const banner = document.getElementById('tokenStatusBanner');
            if (banner) {
                banner.style.display = 'none';
            }

            // Ki·ªÉm tra admin ngay khi load
            checkIfAdmin();

            // 0) √Åp d·ª•ng tr·∫°ng th√°i LICENSE ƒë∆∞·ª£c preload t·ª´ server (n·∫øu c√≥) ƒë·ªÉ hi·ªÉn th·ªã banner g·∫ßn nh∆∞ ngay l·∫≠p t·ª©c
            try {
                const initEl = document.getElementById('license-warning-init');
                if (initEl && initEl.textContent.trim()) {
                    const initState = JSON.parse(initEl.textContent);
                    if (initState && initState.active && initState.payload) {
                        updateTokenStatusUI(initState.payload);
                    }
                }
            } catch (e) {
                console.warn('Could not apply preloaded license warning state:', e);
            }

            // 1) Lu√¥n k·∫øt n·ªëi SSE CHO T·∫§T C·∫¢ USER ƒë·ªÉ m·ªçi ng∆∞·ªùi ƒë·ªÅu nh·∫≠n ƒë∆∞·ª£c c·∫£nh b√°o LICENSE realtime
            // K·∫øt n·ªëi SSE CHO T·∫§T C·∫¢ USER ƒë·ªÉ m·ªçi ng∆∞·ªùi ƒë·ªÅu nh·∫≠n ƒë∆∞·ª£c c·∫£nh b√°o LICENSE
            connectTokenStatusSSE();

            // 2) G·ªçi API l·∫•y tr·∫°ng th√°i LICENSE g·∫ßn nh·∫•t ƒë·ªÉ hi·ªÉn th·ªã NGAY khi load (kh√¥ng ƒë·ª£i SSE)
            (async function initLicenseWarning() {
                try {
                    const resp = await fetch('/api/license/warning-status');
                    if (!resp.ok) return;
                    const data = await resp.json();
                    if (data && data.active && data.payload) {
                        updateTokenStatusUI(data.payload);
                    }
                } catch (e) {
                    console.warn('Could not fetch initial license warning status:', e);
                }
            })();

            if (isAdmin) {
                console.log('Admin detected, initializing token status management...');
                // Fetch token status ban ƒë·∫ßu (ch·ªâ admin m·ªõi c·∫ßn check token Google)
                fetchTokenStatus();

                // L·∫Øng nghe s·ª± ki·ªán refresh token button
                const refreshBtn = document.getElementById('btnRefreshToken');
                console.log('[TokenStatus] Setting up refresh button listener, button found:', !!refreshBtn);
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', function (e) {
                        console.log('[TokenStatus] Refresh button clicked!');
                        e.preventDefault();
                        e.stopPropagation();
                        refreshToken();
                    });
                    console.log('[TokenStatus] Refresh button listener attached');
                } else {
                    console.warn('[TokenStatus] Refresh button not found!');
                }

                // L·∫Øng nghe postMessage t·ª´ tab ·ªßy quy·ªÅn (local server success page)
                window.addEventListener('message', async (event) => {
                    if (event?.data?.type === 'token_authorized') {
                        console.log('[TokenStatus] Received token_authorized message. Forcing status refresh...');
                        await fetchTokenStatus(true);
                    }
                });

                // Fallback: poll tr·∫°ng th√°i token m·ªói 10 gi√¢y n·∫øu SSE b·ªã ng·∫Øt
                setInterval(() => {
                    fetchTokenStatus();
                }, 10000);
            }

            // 3) Khi ng∆∞·ªùi d√πng b·∫•m n√∫t ƒë√≥ng (X), l∆∞u th·ªùi gian ƒë·ªÉ ·∫©n banner trong 60 gi√¢y
            const closeBtn = document.querySelector('#tokenStatusBanner .btn-close');
            if (closeBtn) {
                closeBtn.addEventListener('click', function () {
                    try {
                        // L∆∞u th·ªùi gian user t·∫Øt banner
                        localStorage.setItem('licenseBannerDismissedAt', Date.now().toString());
                    } catch (e) {
                        console.warn('Could not store license banner dismiss time:', e);
                    }

                    // Sau 60 gi√¢y, t·ª± ƒë·ªông g·ªçi l·∫°i updateTokenStatusUI v·ªõi tr·∫°ng th√°i m·ªõi nh·∫•t
                    // ƒë·ªÉ banner c√≥ c∆° h·ªôi xu·∫•t hi·ªán l·∫°i n·∫øu LICENSE v·∫´n s·∫Øp h·∫øt h·∫°n.
                    setTimeout(function () {
                        try {
                            // H·∫øt 60s th√¨ xo√° tr·∫°ng th√°i dismiss ƒë·ªÉ kh√¥ng b·ªã ch·∫∑n n·ªØa
                            localStorage.removeItem('licenseBannerDismissedAt');
                            if (tokenStatus) {
                                updateTokenStatusUI(tokenStatus);
                            }
                        } catch (e) {
                            console.warn('Could not re-show license banner after 60s:', e);
                        }
                    }, 60000);
                });
            }

            // L·∫Øng nghe thay ƒë·ªïi role ƒë·ªÉ ·∫©n/hi·ªán banner
            const roleSelect = document.getElementById('role-select');
            if (roleSelect) {
                roleSelect.addEventListener('change', function () {
                    const wasAdmin = isAdmin;
                    checkIfAdmin();
                    if (!isAdmin && wasAdmin) {
                        // Kh√¥ng c√≤n l√† admin, ·∫©n banner v√† ƒë√≥ng SSE
                        const banner = document.getElementById('tokenStatusBanner');
                        if (banner) banner.style.display = 'none';
                        if (tokenEventSource) {
                            tokenEventSource.close();
                            tokenEventSource = null;
                        }
                    } else if (isAdmin && !wasAdmin) {
                        // Tr·ªü th√†nh admin, hi·ªÉn th·ªã banner v√† k·∫øt n·ªëi SSE
                        console.log('Role changed to ADMIN, initializing token status...');
                        fetchTokenStatus();
                        connectTokenStatusSSE();
                    } else if (isAdmin) {
                        // V·∫´n l√† admin, refresh status
                        fetchTokenStatus();
                    } else {
                        // Kh√¥ng ph·∫£i admin, ·∫©n banner
                        const banner = document.getElementById('tokenStatusBanner');
                        if (banner) banner.style.display = 'none';
                    }
                });
            }
        });

        // Cleanup khi trang ƒë√≥ng
        window.addEventListener('beforeunload', function () {
            if (tokenEventSource) {
                tokenEventSource.close();
            }
        });

    </script>
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <script>showToast("{{ message }}", "{{ category }}");</script>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- Modal: T·∫°o l·∫°i b·∫£n ghi ch·∫•m c√¥ng h√†ng lo·∫°t -->
    <div class="modal fade" id="bulkRecreateModal" tabindex="-1" aria-labelledby="bulkRecreateModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="bulkRecreateModalLabel">
                        <i class="fas fa-redo me-2"></i>T·∫°o l·∫°i b·∫£n ghi ch·∫•m c√¥ng t·ª´ l·ªãch s·ª≠ ƒë√£ ph√™ duy·ªát
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        T√≠nh nƒÉng n√†y s·∫Ω t·∫°o l·∫°i c√°c b·∫£n ghi ch·∫•m c√¥ng t·ª´ c√°c b·∫£n ghi ƒë√£ ƒë∆∞·ª£c ph√™ duy·ªát.
                        C√°c b·∫£n ghi m·ªõi s·∫Ω ·ªü tr·∫°ng th√°i "Ch·ªù ph√™ duy·ªát" v√† c·∫ßn ƒë∆∞·ª£c ph√™ duy·ªát l·∫°i.
                    </div>

                    <ul class="nav nav-tabs mb-3" id="recreateTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="dateRangeTab" data-bs-toggle="tab"
                                data-bs-target="#dateRangePane" type="button" role="tab">
                                <i class="fas fa-calendar-alt me-2"></i>Kho·∫£ng ng√†y
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="monthRangeTab" data-bs-toggle="tab"
                                data-bs-target="#monthRangePane" type="button" role="tab">
                                <i class="fas fa-calendar me-2"></i>Kho·∫£ng th√°ng
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="specificDateTab" data-bs-toggle="tab"
                                data-bs-target="#specificDatePane" type="button" role="tab">
                                <i class="fas fa-calendar-day me-2"></i>Ng√†y c·ª• th·ªÉ
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="recreateTabContent">
                        <!-- Tab: Kho·∫£ng ng√†y -->
                        <div class="tab-pane fade show active" id="dateRangePane" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="recreateDateFrom" class="form-label">T·ª´ ng√†y <span
                                            class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="recreateDateFrom" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="recreateDateTo" class="form-label">ƒê·∫øn ng√†y <span
                                            class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="recreateDateTo" required>
                                </div>
                            </div>
                        </div>

                        <!-- Tab: Kho·∫£ng th√°ng -->
                        <div class="tab-pane fade" id="monthRangePane" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="recreateMonthFrom" class="form-label">T·ª´ th√°ng <span
                                            class="text-danger">*</span></label>
                                    <select class="form-select" id="recreateMonthFrom" required>
                                        <option value="">-- Ch·ªçn th√°ng --</option>
                                        <option value="1">Th√°ng 1</option>
                                        <option value="2">Th√°ng 2</option>
                                        <option value="3">Th√°ng 3</option>
                                        <option value="4">Th√°ng 4</option>
                                        <option value="5">Th√°ng 5</option>
                                        <option value="6">Th√°ng 6</option>
                                        <option value="7">Th√°ng 7</option>
                                        <option value="8">Th√°ng 8</option>
                                        <option value="9">Th√°ng 9</option>
                                        <option value="10">Th√°ng 10</option>
                                        <option value="11">Th√°ng 11</option>
                                        <option value="12">Th√°ng 12</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="recreateYearFrom" class="form-label">NƒÉm <span
                                            class="text-danger">*</span></label>
                                    <select class="form-select" id="recreateYearFrom" required>
                                        <option value="">-- Ch·ªçn nƒÉm --</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="text-muted small">ƒê·∫øn</div>
                                </div>
                                <div class="col-md-4">
                                    <label for="recreateMonthTo" class="form-label">ƒê·∫øn th√°ng <span
                                            class="text-danger">*</span></label>
                                    <select class="form-select" id="recreateMonthTo" required>
                                        <option value="">-- Ch·ªçn th√°ng --</option>
                                        <option value="1">Th√°ng 1</option>
                                        <option value="2">Th√°ng 2</option>
                                        <option value="3">Th√°ng 3</option>
                                        <option value="4">Th√°ng 4</option>
                                        <option value="5">Th√°ng 5</option>
                                        <option value="6">Th√°ng 6</option>
                                        <option value="7">Th√°ng 7</option>
                                        <option value="8">Th√°ng 8</option>
                                        <option value="9">Th√°ng 9</option>
                                        <option value="10">Th√°ng 10</option>
                                        <option value="11">Th√°ng 11</option>
                                        <option value="12">Th√°ng 12</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="recreateYearTo" class="form-label">NƒÉm <span
                                            class="text-danger">*</span></label>
                                    <select class="form-select" id="recreateYearTo" required>
                                        <option value="">-- Ch·ªçn nƒÉm --</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Tab: Ng√†y c·ª• th·ªÉ -->
                        <div class="tab-pane fade" id="specificDatePane" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <label for="recreateSpecificDate" class="form-label">Ch·ªçn ng√†y <span
                                            class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="recreateSpecificDate" required>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-success" id="btnConfirmBulkRecreate">
                        <i class="fas fa-redo me-2"></i>X√°c nh·∫≠n t·∫°o l·∫°i
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chatbot AI - Widget hi·ªÉn th·ªã xuy√™n su·ªët tr√™n t·∫•t c·∫£ c√°c trang -->
    <!-- T·∫°m th·ªùi ·∫©n chatbot AI -->
    {# {% include 'chatbot_widget.html' %} #}

    <!-- Excel Full Export Button -->
    <script
        src="{{ url_for('static', filename='js/attendance_excel_full.js') }}?v={{ range(1, 99999) | random }}"></script>

    <!-- Mobile Menu Toggle Script -->
    <script>
    (function() {
        // Mobile menu functionality
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const sidebarClose = document.getElementById('sidebarClose');

        function openSidebar() {
            sidebar.classList.add('active');
            sidebarOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            mobileMenuToggle.innerHTML = '<i class="fas fa-times"></i>';
        }

        function closeSidebar() {
            sidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
            document.body.style.overflow = '';
            mobileMenuToggle.innerHTML = '<i class="fas fa-bars"></i>';
        }

        if (mobileMenuToggle) {
            mobileMenuToggle.addEventListener('click', function() {
                if (sidebar.classList.contains('active')) {
                    closeSidebar();
                } else {
                    openSidebar();
                }
            });
        }

        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', closeSidebar);
        }

        if (sidebarClose) {
            sidebarClose.addEventListener('click', closeSidebar);
        }

        // Close sidebar when clicking a nav link on mobile
        const navLinks = document.querySelectorAll('.sidebar .nav-link');
        navLinks.forEach(function(link) {
            link.addEventListener('click', function() {
                if (window.innerWidth <= 768) {
                    closeSidebar();
                }
            });
        });

        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                closeSidebar();
            }
        });

        // Keyboard accessibility - close on Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && sidebar.classList.contains('active')) {
                closeSidebar();
            }
        });
    })();
    </script>
</body>

</html>